# マイグレーションガイド

このガイドでは、Supabaseのマイグレーションを実行する方法について説明します。

## 前提条件

- Node.js がインストールされていること
- Supabase CLI がインストールされていること
- プロジェクトのルートディレクトリに `.env.local` ファイルが存在し、以下の環境変数が設定されていること:
  - `SUPABASE_URL`
  - `SUPABASE_ANON_KEY`

## マイグレーションの実行方法

### 1. package.jsonにスクリプトを追加

以下のコマンドを実行して、package.jsonにマイグレーション用のスクリプトを追加します。

```bash
npm pkg set scripts.migrate="node scripts/run-migration.js"
```

または、package.jsonファイルを手動で編集して、以下のスクリプトを追加します:

```json
{
  "scripts": {
    "migrate": "node scripts/run-migration.js"
  }
}
```

### 2. 依存パッケージのインストール

マイグレーションスクリプトで使用する依存パッケージをインストールします。

```bash
npm install dotenv --save-dev
```

### 3. マイグレーションの実行

以下のコマンドを実行して、マイグレーションを実行します。

```bash
# 新しいマイグレーションのみを適用
npm run migrate

# デバッグ情報を表示
npm run migrate -- --debug

# データベースをリセットして全てのマイグレーションを適用
npm run migrate -- --reset

# 特定のマイグレーションファイルのみを適用
npm run migrate -- --file=20250703000004_fix_sessions_foreign_key.sql
```

## マイグレーションファイルについて

マイグレーションファイルは `supabase/migrations` ディレクトリに配置されています。ファイル名は `YYYYMMDD000000_description.sql` の形式で、実行順序はファイル名の昇順で決まります。

### 今回のマイグレーション内容

依存関係の問題を回避するため、より直接的なアプローチを採用しました：

#### `20250703000003_recreate_seat_types_table.sql`

このマイグレーションでは、以下の手順で席種テーブルとその関連テーブルを再作成します：

1. 既存のデータを一時テーブルに保存
2. 依存するすべてのビューとマテリアライズドビューを削除
3. 関連テーブル（`tables`、`session_seat_events`）のデータをバックアップ
4. 関連テーブルを削除（依存関係を解消）
5. 関連テーブルを再作成（`seat_type_id`をUUID型に変更）
6. 席種テーブルを再作成（`code`を`seat_type_id`に名前変更し、主キーに設定）
7. すべてのテーブルにデータを復元
8. 外部キー制約とRLSポリシーを再作成

#### `20250703000004_fix_sessions_foreign_key.sql`

このマイグレーションでは、以下の修正を行います：

1. `sessions`テーブルの`table_id`の外部キー制約を再作成
2. 関連するトリガー関数を更新
3. テーブル更新時のトリガーを再作成

これにより、`sessions`テーブルと`tables`テーブルの間の関係が正しく設定され、アプリケーションが正常に動作するようになります。

この変更により、席種テーブルの主キーがUUID型になり、より柔軟なデータ管理が可能になります。また、席種IDはUUIDで自動生成されるようになります。

## 注意事項

- マイグレーションを実行すると、既存のデータベースがリセットされる可能性があります。本番環境で実行する前に、必ずバックアップを取ってください。
- マイグレーションファイルは一度実行すると変更できません。新しい変更を加える場合は、新しいマイグレーションファイルを作成してください。
