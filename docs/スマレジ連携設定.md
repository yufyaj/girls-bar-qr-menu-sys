# スマレジ連携設定

## 概要

本システムはスマレジと連携することで、スマレジに登録されている商品情報を自動的に取り込み、メニューとして表示することができます。
また、会計時にはスマレジに対して会計データを送信することができます。

## 前提条件

- スマレジのアカウントを持っていること
- スマレジ・デベロッパーズに登録していること
- スマレジ・アプリマーケットでアプリを作成していること

## 設定手順

### 1. スマレジ・デベロッパーズでアプリを作成する

1. [スマレジ・デベロッパーズ](https://developers.smaregi.dev/)にログインします。
2. 「アプリを作成する」をクリックします。
3. アプリ名、説明、リダイレクトURIなどを入力し、アプリを作成します。
4. 作成後、クライアントIDとクライアントシークレットが表示されるので、メモしておきます。

### 2. 店舗設定画面でスマレジ連携を有効にする

1. 管理者アカウントでログインします。
2. 店舗設定画面に移動します。
3. 「スマレジ連携」を有効にします。
4. 以下の情報を入力します：
   - クライアントID: スマレジ・デベロッパーズで作成したアプリのクライアントID
   - クライアントシークレット: スマレジ・デベロッパーズで作成したアプリのクライアントシークレット
   - 契約ID: スマレジ・デベロッパーズの左上に表示されている契約ID
5. 「保存」をクリックします。

### 3. メニュー同期を実行する

1. 管理者アカウントでログインします。
2. メニュー管理画面に移動します。
3. 「スマレジと同期」ボタンをクリックします。
4. 同期が完了すると、スマレジに登録されている商品情報がメニューとして表示されます。

## 注意事項

- スマレジの商品情報を変更した場合は、再度同期を実行する必要があります。
- スマレジの部門情報はカテゴリとして取り込まれます。
- スマレジのオプション商品は「スタッフドリンク」として扱われます。
- スマレジの商品コードは本システムの商品IDとして使用されます。
- スマレジの商品画像は `/products/images` APIエンドポイントから一括取得され、本システムの商品画像URLとして使用されます。
- スマレジAPIのレスポンスに含まれる `url` または `imageUrl` プロパティから画像URLを取得します。
- 商品画像がスマレジに登録されていない場合は、画像なしとして表示されます。
- 同じ商品に複数の画像が登録されている場合は、最初の画像が使用されます。
- スマレジの画像を表示するには、`next.config.js`ファイルの`images.domains`に`pos-cache.smaregi.dev`と`pos-cache.smaregi.jp`を追加する必要があります。

## トラブルシューティング

### 同期に失敗する場合

- クライアントIDとクライアントシークレットが正しいか確認してください。
- 契約IDが正しいか確認してください。
- スマレジ連携が有効になっているか確認してください。
- ネットワーク接続を確認してください。

### 特定の商品が同期されない場合

- スマレジ側で商品が正しく登録されているか確認してください。
- 商品コードが重複していないか確認してください。
- 商品が非表示になっていないか確認してください。

### 商品画像が表示されない場合

- スマレジ側で商品画像が正しく登録されているか確認してください。
- `next.config.js`ファイルに`pos-cache.smaregi.dev`と`pos-cache.smaregi.jp`が追加されているか確認してください。
- 設定変更後はサーバーを再起動してください。
- ブラウザのコンソールでエラーメッセージを確認してください。

## APIリファレンス

スマレジAPIの詳細については、[スマレジ・プラットフォームAPI POS仕様書](https://www1.smaregi.dev/apidoc/)を参照してください。
