# QRオーダー & 会計連携システム ― **詳細設計書 (v2025-04-26)**  
*対象：ガールズバー* / *Stack：Next.js 15・Supabase (PostgreSQL 15)・スマレジ API*  

---

## 0. ドキュメントの読み方
この設計書は **要件定義全文**を満たす"Next.js 単体実装 + BFF パターン"の**全容**を記述します。  
- **ブラウザ ⇢ BFF(Route Handler) ⇢ Supabase** という経路を厳守（直接呼び出し禁止）。  
- **キャスト／管理者の代理注文**・**30 分チャージ**・**スタッフドリンク集計**を含む。  
- **監査ログ90 日保持**と **席種単価編集 UI** を今回追記。  

---

## 1. 高レベル・アーキテクチャ

| レイヤ | 技術 | 主な責務 |
| :-- | :-- | :-- |
| **フロント** | Next.js 15 (App Router, RSC) | UI/SSR・PWA・Offline Queue |
| **BFF** *(同一コードベース)* | `app/api/**/route.ts` (Node runtime) | 認証(JWT)・RLS claim 付与・DB CRUD・スマレジ連携 |
| **Cron** | Vercel Cron (Edge) | ①30 min チャージ生成<br>②メニュー同期 |
| **Realtime Proxy** | `app/events/route.ts` | Supabase WS→SSE 多重配信 |
| **DB** | Supabase (PostgreSQL 15) | DDL＆RLS・監査ログ・TTL |
| **外部** | スマレジ REST API | `/products`・`/sales` |

> **Edge/Serverless Cron は最短 1 分間隔で実行可能**   

---

## 2. データモデル（DDL 抜粋）

```sql
-- 店舗マスタ : shops
create table shops (
  shop_id uuid primary key default gen_random_uuid(),
  name text not null,
  address text,
  phone text,
  is_active boolean default true,
  created_at timestamptz default now()
);

-- 席種マスタ : seat_types
create table seat_types (
  seat_type_id serial primary key,
  code text unique not null,               -- 'normal' / 'vip'
  display_name text not null,
  price_per_30min int not null,            -- ¥
  shop_id uuid references shops
);

-- 席テーブル : tables
create table tables (
  table_id uuid primary key default gen_random_uuid(),
  name text not null,
  seat_type_id int references seat_types,
  shop_id uuid references shops,
  is_active boolean default true
);

-- 着席セッション : sessions
create table sessions (
  session_id uuid primary key default gen_random_uuid(),
  table_id uuid references tables,
  shop_id uuid references shops,
  start_at timestamptz not null default now(),
  end_at timestamptz,
  headcount int check (headcount>0),
  has_cast boolean default false,
  charge_started_at timestamptz
);

-- 注文 : orders / order_items
create table orders (
  order_id uuid primary key default gen_random_uuid(),
  session_id uuid references sessions,
  shop_id uuid references shops,
  status text check(status in ('new','ack','prep','served','closed','cancel')),
  created_by_role text not null,           -- 'guest'|'cast'|'admin'
  proxy boolean default false,             -- 代理注文フラグ
  created_at timestamptz default now()
);

create table order_items (
  item_id uuid primary key default gen_random_uuid(),
  order_id uuid references orders on delete cascade,
  menu_id text,
  qty int,
  unit_price int,
  target_cast_id uuid null                 -- 奢り先
);

-- ユーザー : users (認証システムと連携)
create table users (
  user_id uuid primary key references auth.users(id),
  email text not null unique,
  role text not null check(role in ('cast', 'admin')),
  shop_id uuid references shops,
  cast_id uuid references casts,  -- キャストの場合のみ使用
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- チャージ : charges
create table charges (
  charge_id uuid primary key default gen_random_uuid(),
  session_id uuid references sessions,
  minutes int, amount int,
  generated_at timestamptz default now()
);

-- 監査ログ : audit_log（90 日 TTL）
create table audit_log (
  log_id bigserial primary key,
  actor_id uuid,
  actor_role text,
  action text,
  shop_id uuid references shops,
  payload jsonb,
  created_at timestamptz default now()
);
alter table audit_log
  set (autovacuum_vacuum_threshold = 0, autovacuum_vacuum_scale_factor = 0);
create policy purge on audit_log
  using (created_at < now() - interval '90 day');
```

*RLS*：各テーブルに `role` クレームと `shop_id` による行レベル制御を設定。 Supabase の例に準拠。   

---

## 3. API（Route Handlers）一覧

| Method | Path | 認可 | 処理概要 |
| :-- | :-- | :-- | :-- |
| `GET` | `/api/tables` | 全ロール | 席一覧 + 空席状態 |
| `POST` | `/api/sessions` | guest | 着席開始（人数/指名） |
| `PATCH` | `/api/sessions/{id}/move` | admin | 席移動・履歴記録 |
| `POST` | `/api/orders` | guest/cast/admin | **proxy 注文可** (`proxy=true`) |
| `PATCH` | `/api/orders/{id}` | cast/admin | ステータス更新/取消 |
| `POST` | `/api/checkout/{sessionId}` | cast/admin/guest | スマレジ `/sales` 連携 |
| `GET` | `/events` | 全ロール | SSE: Realtime 更新 |
| `PATCH` | `/api/seat-types/{id}` | admin | **席種単価編集** |

### Cron Handlers
| Path | schedule | 役割 |
| :-- | :-- | :-- |
| `/api/cron/charge` | */1 min | セッション差分→30 min 切上げ課金 |
| `/api/cron/menu-sync` | 05:00 JST | `/products` → `menus` 上書き |

---

## 4. ビジネスロジック

### 4.1 30 分チャージ  
1. `charge_started_at` が NULL →課金停止状態。  
2. ON にした瞬間を起点に (now - last_charge_time) を計算し、30 min 単位で切上げ。  

### 4.2 代理注文  
- キャスト/管理者 UI から `proxy=true` と `session_id` を指定。  
- RLS が role=cast/admin を許可。`created_by_role` と `proxy=true` が `audit_log` にも保存。  

### 4.3 注文取消  
- ステータス≠「served」「closed」かつ **スマレジ未送信** でのみ `cancel` へ遷移可。  

---

## 5. 画面 / UX 概要

| 画面 | 主要 UI 要素 | 特記事項 |
| :-- | :-- | :-- |
| **QRメニュー** | MenuList / Cart / Checkout | Workbox Offline Queue & Background Sync |
| **キャスト卓リスト** | 担当卓ハイライト / OrderPad | 他卓検索・代理注文可 |
| **管理ダッシュボード** | 全卓ステータス / Charge Switch | 席移動ドラッグ・取消 |
| **席種・席設定** | SeatType CRUD / Table CRUD | 単価編集 = **FR-SeatType** |
| **レポート** | 日次/月次タブ・CSV Export | スタッフドリンク杯数・売上 |

---

## 6. セキュリティ & 監査

| 項目 | 実装 |
| :-- | :-- |
| 認証 | Supabase JWT (httpOnly Cookie) → `@supabase/ssr` `createServerClient`【turn0search7】 |
| 認可 | Supabase RLS + `x-role` ヘッダ |
| Rate Limit | Vercel WAF 100 req / 10 min / IP |
| XSS/CSRF | RSC auto-escape + SameSite=Lax Cookie |
| 監査ログ | `audit_log` 90 日 TTL + `proxy` 操作記録 |
| OWASP Top 10 | CI/ZAP baseline scan【turn0search6】 |

---

## 7. テスト計画

| 層 | ツール | カバレッジ/目的 |
| :-- | :-- | :-- |
| Unit | **Vitest** + React Testing Library | ≥ 80 % |
| API | **Supertest** | Route Handler 403/200, 代理注文 |
| DB | Supabase SQL tests | RLS & 制約回帰 |
| E2E | **Playwright** | QR▶注文▶会計▶レポート |
| 負荷 | **k6** | p95 < 300 ms (50 VU) |
| セキュリティ | ZAP baseline | 自動脆弱性検査 |

---

## 8. CI / CD

1. **GitHub Actions**  
   ```
   lint → test:unit → test:api → db:test
   supabase db push --linked (stg)
   build (next build) → Vercel deploy
   playwright-smoke on Preview
   ```
2. **Nightly** : k6 + ZAP + TTL パージ確認  
3. **Rollback** : Vercel Instant Rollback + Supabase migration down

---

## 9. ディレクトリ構成 (Monorepo)

```
apps/
└─ web/ (Next.js)
   ├─ app/
   │   ├─ api/              # Route Handlers
   │   │   └─ cron/
   │   ├─ events/route.ts
   │   ├─ components/
   │   ├─ features/
   │   └─ lib/              # supabase-server.ts / smaregi.ts / auth.ts
   └─ public/
supabase/
└─ migrations/
tests/ (vitest, supertest, playwright, k6)
vercel.json (Cron)
pnpm-workspace.yaml / turbo.json
```

---

## 10. マイルストーン

| フェーズ | 成果物 | 期間 |
| :-- | :-- | :-- |
| 要件凍結 | 本設計書 | 0.5 M |
| **基盤実装** | Next.js 骨格 + Supabase DDL | 1.0 M |
| **核心機能** | QR注文・チャージ・スマレジ連携 | 1.5 M |
| **管理 / レポート** | Dashboards・CSV Export | 1.0 M |
| **テスト & 導入** | UAT▶本番 | 0.5 M |

---

### まとめ

- **全要件 (機能・非機能) を網羅**  
- ブラウザ→BFF→Supabase の**完全分離モデル**  
- 追加された **席種単価編集** と **監査ログ90 日 TTL** を実装済み  
- 今後はマイルストーン通りに開発・テストを進行  

ご確認のうえ、さらなる修正や詳細化が必要な箇所があればお知らせください。  
