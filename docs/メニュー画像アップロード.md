# メニュー画像アップロード機能

## 概要

メニュー（商品）の新規作成・編集画面から画像をアップロードし、Supabaseのストレージに保存する機能です。

## 機能詳細

1. メニュー編集画面で「画像を選択」ボタンをクリックすると、ファイル選択ダイアログが表示されます。
2. 画像ファイル（JPEG、PNG、WebP、GIF）を選択すると、自動的に適切なサイズにリサイズされます。
3. リサイズ後の画像がプレビュー表示されます（この時点ではまだアップロードされません）。
4. フォームの「追加」または「更新」ボタンをクリックすると、画像がアップロードされます。
5. 「画像を削除」ボタンをクリックすると、画像がクリアされます（ストレージからは削除されません）。

## 技術仕様

### 画像リサイズ

- 最大サイズ: 幅800px × 高さ800px
- アスペクト比: 元の画像のアスペクト比を維持
- 処理方法: クライアント側でCanvas APIを使用してリサイズ
- 画質: 90%（JPEG/WebPの場合）

### ストレージ設定

- バケット名: `menu-images`
- アクセス権限:
  - 閲覧: 誰でも可能
  - アップロード: 管理者のみ
  - 更新: 管理者のみ
  - 削除: 管理者のみ
- ファイル制限:
  - 最大サイズ: 5MB
  - 許可形式: JPEG, PNG, WebP, GIF

### APIエンドポイント

- URL: `/api/upload/menu-image`
- メソッド: POST
- リクエスト形式: multipart/form-data
- パラメータ:
  - `file`: アップロードする画像ファイル
- レスポンス:
  - 成功時: `{ url: "画像の公開URL" }`
  - エラー時: `{ error: "エラーメッセージ" }`

### ファイル命名規則

アップロードされたファイルは以下の命名規則で保存されます:

```
{store_id}/{uuid}.{extension}
```

- `store_id`: 店舗ID（UUID）
- `uuid`: ランダムに生成されたUUID（v4）
- `extension`: 元のファイルの拡張子（jpg, png, webp, gif など）

## 初期設定

### Supabaseストレージバケットの作成

初回利用時には、Supabaseのストレージバケットを作成する必要があります。APIは自動的にバケットの作成を試みますが、権限の問題で失敗する場合は手動で作成してください。

#### 手動でのバケット作成方法

1. Supabaseのダッシュボード（https://app.supabase.com）にログインします
2. プロジェクトを選択します
3. 左側のメニューから「Storage」を選択します
4. 「New Bucket」ボタンをクリックします
5. バケット名に「menu-images」を入力します
6. 「Public」チェックボックスをオンにします（公開バケットとして設定）
7. 「Create bucket」ボタンをクリックします

#### RLSポリシーの設定

バケットを作成した後、以下のRLSポリシーを設定します：

1. 作成したバケットの「Policies」タブをクリックします
2. 以下のポリシーを追加します：

- **閲覧ポリシー**:
  - 名前: メニュー画像は誰でも閲覧可能
  - 対象: SELECT
  - ポリシー: `true`（誰でも閲覧可能）

- **アップロードポリシー**:
  - 名前: 管理者のみメニュー画像をアップロード可能
  - 対象: INSERT
  - ポリシー: `EXISTS (SELECT 1 FROM public.store_users WHERE user_id = auth.uid() AND role = 'admin')`

- **更新ポリシー**:
  - 名前: 管理者のみメニュー画像を更新可能
  - 対象: UPDATE
  - ポリシー: `EXISTS (SELECT 1 FROM public.store_users WHERE user_id = auth.uid() AND role = 'admin')`

- **削除ポリシー**:
  - 名前: 管理者のみメニュー画像を削除可能
  - 対象: DELETE
  - ポリシー: `EXISTS (SELECT 1 FROM public.store_users WHERE user_id = auth.uid() AND role = 'admin')`

## 注意事項

1. 画像ファイルは5MB以下である必要があります。
2. 許可されているファイル形式は JPEG, PNG, WebP, GIF のみです。
3. 画像を削除してもストレージからは自動的に削除されません。不要な画像は定期的に管理者がクリーンアップする必要があります。
4. 初回利用時にバケットが存在しない場合、APIは自動的にバケットの作成を試みますが、権限の問題で失敗する場合があります。その場合は上記の手順でバケットを手動で作成してください。

## 今後の拡張予定

1. 不要画像の自動クリーンアップ
2. 画像の一括アップロード機能
3. 画像のクロップ・編集機能
4. 画像のリサイズサイズをユーザーが選択できる機能
