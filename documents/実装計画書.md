# QRオーダー & 会計連携システム ― **実装計画書 (フル版 v2025-04-26)**  
*対象店舗：ガールズバー*  
*主要技術：Next.js 15 · Supabase (PostgreSQL 15) · スマレジ API*  

---

## 0. プロジェクト前提

| 項目 | 内容 |
| :-- | :-- |
| **目標** | QR オーダー／30 分チャージ／スマレジ連携を MVP → 本番導入 |
| **期間** | 2025-05-06 〜 2025-11-14（26 週） |
| **チーム構成** | PM 1 / FE 2 / BE 2 / QA 1 / デザイナ 1 / Infra 1 |
| **開発手法** | 2 週間スプリント・GitHub Projects Kanban・EVM (Burn-down) |
| **本番環境** | Vercel（Next App + Cron） / Supabase (Tokyo) / スマレジ Sandbox→本番 |

---

## 1. ロードマップ

| 期間 (週) | フェーズ | 主要成果物 |
| :-: | :-- | :-- |
| **W-01 – W-02** | ❶ 要件確定 | 要件・詳細設計承認 |
| **W-03 – W-06** | ❷ **基盤実装 & サンプルデータ** | Repo/CI/CD、Supabase DDL、Next.js Skeleton、シードスクリプト |
| **W-07 – W-12** | ❸ 核心機能 | QR注文・代理注文・30 分チャージ・スマレジ `/sales` |
| **W-13 – W-18** | ❹ 管理 UI & レポート | ダッシュボード・席/席種 CRUD・日次/月次集計 |
| **W-19 – W-22** | ❺ E2E & Hardening | 負荷試験・セキュリティ対策・DR |
| **W-23 – W-26** | ❻ UAT → 本番 | 店舗テスト・データ移行・Go-Live・初期 KPI レポート |

---

## 2. 詳細タスク WBS

### 2.1 基盤実装 (❷ W-03 – W-06)

| ID | タスク | 担当 | 開始 | 期限 | 完了条件 |
| :-: | :-- | :-- | :-- | :-- | :-- |
| **B-01** | Monorepo + Turborepo 設定 | Infra | 05-06 | 05-10 | `pnpm dev` で FE/BE 起動 |
| **B-02** | Supabase Local + CLI 導入 | BE-1 | 05-06 | 05-13 | `supabase start` 可 |
| **B-03** | JWT Auth (`createServerClient`) | BE-2 | 05-06 | 05-13 | 401/200 Pass |
| **B-04** | GitHub Actions: Lint/Test | Infra | 05-08 | 05-17 | PR 自動実行 |
| **B-05** | Vercel Preview & Cron 雛形 | Infra | 05-10 | 05-17 | `/api/cron/ping` 動作 |
| **B-06** | **サンプルデータ Seed** | BE-1 | 05-08 | 05-15 | `pnpm run seed` で:<br>・メニュー50<br>・席20(通常/VIP)<br>・キャスト10 追加 |
| **B-07** | Realtime Proxy `/events` SSE | BE-1 | 05-15 | 05-24 | FE で live 更新 |
| **B-08** | PWA Offline Queue 雛形 | FE-2 | 05-15 | 05-24 | no-network 動作 |

> **シード実装例**  
> `apps/web/scripts/seed.ts`  
> ```ts
> import { createClient } from '@supabase/supabase-js';
> const client = createClient(process.env.SEED_URL!, process.env.SEED_KEY!);
> await client.from('menus').insert(sampleMenus);
> ...
> ```  
> - `supabase db reset --include-seed` を CI で呼び出しローカル自動ロード。  
> - 管理者 UI に `/admin/import` ボタンも提供。

### 2.2 核心機能 (❸ W-07 – W-12)

| ID | タスク | 担当 | 期限 | Done 条件 |
| :-: | :-- | :-- | :-- | :-- |
| C-01 | `sessions` CRUD + RLS | BE-1 | 06-07 | Supertest OK |
| C-02 | MenuList & Cart UI | FE-1 | 06-07 | Lighthouse ≥90 |
| C-03 | `orders` + **代理注文** | BE-2 | 06-21 | Proxy=true 通過 |
| C-04 | 30 min チャージ Cron | BE-1 | 06-21 | k6 < 30 s |
| C-05 | `/checkout` スマレジ連携 | BE-2 | 06-28 | Sandbox success |
| C-06 | PWA Offline 完成 | FE-2 | 06-28 | Queue 再送 OK |

### 2.3 管理 UI & レポート (❹ W-13 – W-18)

| ID | タスク | 担当 | 期限 | 完了条件 |
| :-: | :-- | :-- | :-- | :-- |
| M-01 | 管理ダッシュボード | FE-2 | 07-26 | p95 <300 ms |
| M-02 | **席種単価 CRUD** | FE-2/BE-1 | 07-26 | Cron 金額更新 |
| M-03 | 席移動ドラッグ UI | FE-1 | 07-26 | Playwright Pass |
| M-04 | 日次/月次集計 Job | BE-2 | 08-23 | 集計誤差 ≤1 % |
| M-05 | CSV Export | FE-1 | 08-23 | DL OK |

### 2.4 E2E & Hardening (❺ W-19 – W-22)

| ID | タスク | 担当 | 期限 | 完了条件 |
| :-: | :-- | :-- | :-- | :-- |
| H-01 | Playwright 全シナリオ | QA | 09-13 | 100 % Pass |
| H-02 | k6 負荷試験 (50 VU) | QA/Infra | 09-13 | p95<300 ms |
| H-03 | ZAP OWASP スキャン | QA | 09-13 | High=0 |
| H-04 | **監査ログ TTL 90 d** | BE-1 | 09-27 | 91 d データ無 |
| H-05 | DR & Backup 手順書 | Infra | 09-27 | レビュー済 |

### 2.5 UAT → Go-Live (❻ W-23 – W-26)

| ID | タスク | 担当 | 期限 | 完了条件 |
| :-: | :-- | :-- | :-- | :-- |
| U-01 | スタッフ研修 | PM | 10-04 | Manual 配布 |
| U-02 | UAT バグ修正 | 全員 | 10-18 | Sev-1 = 0 |
| U-03 | 本番データ移行 | BE-2 | 10-25 | メニュー確定 |
| U-04 | Go-Live & 監視 | Infra | 11-01 | アラート 0 |
| U-05 | KPI レポート | PM | 11-14 | 客単価／杯数報告 |

---

## 3. 進捗チェック表

| ✅ | ID | タスク概要 | 担当 | 開始 | 期限 | 状態 |
| :-: | :-: | :-- | :-- | :-- | :-- | :-- |
| ☐ | B-01 | Monorepo & Turborepo | Infra | 05-06 | 05-10 | Not-Started |
| ☐ | B-02 | Supabase Local & CLI | BE-1 | 05-06 | 05-13 | — |
| ☐ | **B-06** | **サンプルデータ Seed** | BE-1 | 05-08 | 05-15 | — |
| ☐ | … | … | … | … | … | … |

> `☐`→`☑` で更新。GitHub Projects Issue と連動してバーンダウンを自動生成。

---

## 4. サンプルデータ仕様

| エンティティ | 件数 | フィールド例 |
| :-- | :-: | :-- |
| **menus** | 50 | `id, name, category, price, is_hidden=false` |
| **seat_types** | 2 | normal ¥3 000／vip ¥5 000 |
| **tables** | 20 | 1–15 = normal / 16–20 = vip |
| **casts** | 10 | `id, name, is_active=true` |
| **users (admin)** | 2 | `admin@example.com` / `password` |

Seed スクリプトは **TypeScript + supabase-js** で実装し、CI／Preview／Staging 環境で自動投入。  

---

## 5. リスク管理

| リスク | 影響 | 優先度 | 軽減策 |
| :-- | :-- | :-- | :-- |
| スマレジ API 制限 | 会計遅延 | 高 | 連携キュー & リトライ |
| Cron 処理30 s超過 | チャージ漏れ | 中 | 差分バッチ・ID 分割 |
| 端末帯域低下 | 注文遅延 | 中 | SSE メッセージ圧縮 |
| PWA 二重送信 | 売上誤計上 | 低 | clientUUID+idempotentキー |

---

## 6. テストマトリクス

| 層 | ツール | カバー率 | 週次レポート |
| :-- | :-- | :-- | :-- |
| Unit | Vitest | ≥80 % | Sprint Review |
| API | Supertest | 全ルート | Sprint Review |
| DB | Supabase SQL tests | 全 RLS | Daily |
| E2E | Playwright | 全フロー | CI Preview |
| 負荷 | k6 | p95<300 ms | Nightly |
| セキュリティ | ZAP / SCA | High=0 | Nightly |

---

## 7. CI / CD フロー (概要)

1. **Lint → Unit → API → DB**  
2. `supabase db push --linked` (staging)  
3. **`next build` & Vercel Deploy**（Preview URL）  
4. **Playwright Smoke** → pass で Production Promote  
5. Nightly: k6 + ZAP + `audit_log TTL` 検証  

---

## 8. 完了定義 (Definition of Done)

| 観点 | DoD |
| :-- | :-- |
| コード | Lint Error 0・Unit ≥80 %・TypeCheck pass |
| テスト | CI 100 % Green・Playwright pass |
| ドキュメント | PR に ADR / 更新設計書付き |
| セキュリティ | OWASP High リスク 0・依存 CVE Critical 0 |
| リリース | Tag + Changelog + GitHub Release |

---

## 9. 承認

| 役割 | 氏名 | 日付 | 署名 |
| :-- | :-- | :-- | :-- |
| プロジェクトマネージャ | | | |
| プロダクトオーナー | | | |
| 技術リード | | | |
| QA マネージャ | | | |

---