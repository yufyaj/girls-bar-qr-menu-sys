This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
4. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

<additional_info>

</additional_info>

</file_summary>

<directory_structure>
__tests__/api/menu-categories/delete.test.ts
.augment-guidelines
.cursorrules
.env.example
.gitignore
app/api/auth/login/route.ts
app/api/auth/user/route.ts
app/api/casts/[id]/route.ts
app/api/casts/route.ts
app/api/checkout/[session_id]/route.ts
app/api/dashboard/sessions/route.ts
app/api/logout/route.ts
app/api/menu-categories/[category_id]/route.ts
app/api/menu-categories/route.ts
app/api/menus/[id]/route.ts
app/api/menus/route.ts
app/api/order-items/[order_item_id]/route.ts
app/api/order-items/[order_item_id]/status/route.ts
app/api/orders/[order_id]/items/route.ts
app/api/orders/[order_id]/status/route.ts
app/api/orders/active-items/route.ts
app/api/orders/active/route.ts
app/api/orders/route.ts
app/api/proxy-order/active-tables/route.ts
app/api/seat-types/[id]/route.ts
app/api/seat-types/route.ts
app/api/sessions/[session_id]/calculate-charge/route.ts
app/api/sessions/[session_id]/move/route.ts
app/api/sessions/[session_id]/orders/route.ts
app/api/sessions/[session_id]/route.ts
app/api/sessions/[session_id]/store-info/route.ts
app/api/sessions/active/route.ts
app/api/smaregi-products/route.ts
app/api/smaregi-sync/route.ts
app/api/stores/[store_id]/route.ts
app/api/stores/route.ts
app/api/stores/settings/route.ts
app/api/stores/settings/smaregi-status/route.ts
app/api/tables/[table_id]/menus/route.ts
app/api/tables/[table_id]/route.ts
app/api/tables/[table_id]/sessions/[session_id]/pause/route.ts
app/api/tables/[table_id]/sessions/[session_id]/resume/route.ts
app/api/tables/[table_id]/sessions/[session_id]/route.ts
app/api/tables/[table_id]/sessions/route.ts
app/api/tables/route.ts
app/api/upload/menu-image/route.ts
app/globals.css
app/layout.tsx
app/login/[store_code]/login-form.tsx
app/login/[store_code]/page.tsx
app/menu/[table_id]/cart-context.tsx
app/menu/[table_id]/cart-display.tsx
app/menu/[table_id]/cart-modal.tsx
app/menu/[table_id]/cast-select-modal.tsx
app/menu/[table_id]/cast-selection.tsx
app/menu/[table_id]/checkout-complete.tsx
app/menu/[table_id]/checkout-display.tsx
app/menu/[table_id]/checkout-modal.tsx
app/menu/[table_id]/client-customer-selection.tsx
app/menu/[table_id]/client-menu-page.tsx
app/menu/[table_id]/customer-type-selection.tsx
app/menu/[table_id]/header-with-menu-button.tsx
app/menu/[table_id]/menu-display.tsx
app/menu/[table_id]/menu-page-wrapper.tsx
app/menu/[table_id]/modal.tsx
app/menu/[table_id]/page.tsx
app/menu/[table_id]/seat-selection.tsx
app/page.tsx
app/portal/casts/[id]/edit/page.tsx
app/portal/casts/cast-form.tsx
app/portal/casts/delete-button.tsx
app/portal/casts/new/page.tsx
app/portal/casts/page.tsx
app/portal/components/header.tsx
app/portal/components/layout-wrapper.tsx
app/portal/components/side-menu.tsx
app/portal/dashboard/dashboard-client.tsx
app/portal/dashboard/page.tsx
app/portal/layout.tsx
app/portal/menu-categories/category-list.tsx
app/portal/menu-categories/page.tsx
app/portal/menus/[id]/edit/page.tsx
app/portal/menus/menu-form.tsx
app/portal/menus/menu-list.tsx
app/portal/menus/new/page.tsx
app/portal/menus/page.tsx
app/portal/menus/smaregi-sync-button.tsx
app/portal/order-board/order-board-client.tsx
app/portal/order-board/order-board.tsx
app/portal/order-board/page.tsx
app/portal/proxy-order/cart.tsx
app/portal/proxy-order/cast-select-modal.tsx
app/portal/proxy-order/menu-display.tsx
app/portal/proxy-order/page.tsx
app/portal/proxy-order/table-selector.tsx
app/portal/seat-types/_components/seat-type-form.tsx
app/portal/seat-types/[id]/edit/page.tsx
app/portal/seat-types/new/page.tsx
app/portal/seat-types/page.tsx
app/portal/store-settings/page.tsx
app/portal/store-settings/settings-form.tsx
app/portal/tables/_components/charge-control-button.tsx
app/portal/tables/_components/table-form.tsx
app/portal/tables/_components/table-move-button.tsx
app/portal/tables/[table_id]/edit/page.tsx
app/portal/tables/new/page.tsx
app/portal/tables/page.tsx
app/portal/tables/tables-client.tsx
docs/migration-guide.md
docs/ã‚¹ãƒãƒ¬ã‚¸é€£æºè¨­å®š.md
docs/ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰.md
docs/å®Ÿè£…è¨ˆç”»æ›¸.md
docs/é€²æ—ç®¡ç†.md
docs/è¨­è¨ˆæ›¸.md
docs/è¦ä»¶å®šç¾©æ›¸.md
fix_next_event_after_move_null.sql
fix_next_event_after_move_property_access.sql
lib/auth.ts
lib/charge.ts
lib/database.types.ts
lib/smaregi.ts
lib/supabase-realtime.ts
lib/supabase.ts
middleware.ts
next-env.d.ts
next.config.js
package.json
postcss.config.js
scripts/run-migration.js
scripts/seed.ts
supabase/.temp/cli-latest
supabase/.temp/gotrue-version
supabase/.temp/pooler-url
supabase/.temp/postgres-version
supabase/.temp/project-ref
supabase/.temp/rest-version
supabase/.temp/storage-version
supabase/config.toml
supabase/migrations/20250428000000_initial_schema.sql
supabase/migrations/20250428000001_rls_policies.sql
supabase/migrations/20250428000002_charge_functions.sql
supabase/migrations/20250428000003_audit_triggers.sql
supabase/migrations/20250428000004_report_views.sql
supabase/migrations/20250428000007_audit_triggers_fix.sql
supabase/migrations/20250428000008_audit_triggers_toggle.sql
supabase/migrations/20250430000000_add_store_id_to_seat_types.sql
supabase/migrations/20250501000000_add_store_settings.sql
supabase/migrations/20250502000000_add_display_name_to_store_users.sql
supabase/migrations/20250503000000_add_smaregi_keys.sql
supabase/migrations/20250504000000_add_smaregi_contract_id.sql
supabase/migrations/20250601000000_add_menu_categories.sql
supabase/migrations/20250601000001_migrate_menu_categories.sql
supabase/migrations/20250602000000_remove_staff_drink.sql
supabase/migrations/20250603000000_add_smaregi_category_id.sql
supabase/migrations/20250604000000_add_category_treat_cast_flag.sql
supabase/migrations/20250610000000_add_menu_images_bucket.sql
supabase/migrations/20250701000000_add_status_to_order_items.sql
supabase/migrations/20250702000000_update_seat_types_code_to_uuid.sql
supabase/migrations/20250703000003_recreate_seat_types_table.sql
supabase/migrations/20250703000004_fix_sessions_foreign_key.sql
supabase/migrations/20250704000000_add_time_unit_minutes_to_seat_types.sql
supabase/migrations/20250705000000_rename_price_per_30min_to_price_per_unit.sql
supabase/migrations/20250706000000_update_charge_functions.sql
supabase/migrations/20250707000000_update_charge_functions_time_unit.sql
supabase/migrations/20250707000001_update_table_usage_view.sql
supabase/migrations/20250708000000_update_sessions_table.sql
supabase/migrations/20250801000000_add_charge_pause.sql
supabase/migrations/20250802000000_add_table_move_charge.sql
supabase/migrations/20250803000000_fix_table_move_charge_calculation.sql
supabase/migrations/20250804000000_fix_charge_calculation_for_short_time.sql
supabase/migrations/20250805000000_fix_table_move_charge_calculation.sql
supabase/migrations/20250806000000_fix_double_charge_calculation.sql
supabase/migrations/20250807000000_fix_table_move_zero_minute_charge.sql
supabase/migrations/20250808000000_fix_table_move_immediate_charge.sql
supabase/migrations/20250809000000_fix_table_move_charge_calculation_final.sql
supabase/migrations/20250810000000_fix_table_move_minimum_charge.sql
supabase/migrations/20250811000000_fix_table_move_time_progression.sql
supabase/migrations/20250812000000_fix_next_event_after_move_null.sql
supabase/migrations/20250813000000_fix_next_event_after_move_null_robust.sql
supabase/migrations/20250814000000_fix_next_event_after_move_property_access.sql
supabase/migrations/20250815000000_add_smaregi_product_id_to_seat_types.sql
supabase/migrations/20250816000000_add_tax_rate_to_stores.sql
tailwind.config.js
tsconfig.json
tsconfig.scripts.json
vitest.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/api/sessions/[session_id]/store-info/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ session_id: string }> }
) {
  try {
    const { session_id } = await params;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    const { data: session, error: sessionError } = await supabase
      .from('sessions')
      .select('store_id')
      .eq('session_id', session_id)
      .single();

    if (sessionError || !session) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store, error: storeError } = await supabase
      .from('stores')
      .select('store_id, name, tax_rate')
      .eq('store_id', session.store_id)
      .single();

    if (storeError || !store) {
      console.error('åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', storeError);
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    return NextResponse.json(store);
  } catch (error) {
    console.error('åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/smaregi-products/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient } from '@/lib/supabase';
import { getSmaregiAccessToken, fetchSmaregiProducts } from '@/lib/smaregi';

export async function GET(request: NextRequest) {
  try {
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store, error: storeError } = await supabase
      .from('stores')
      .select('enable_smaregi_integration, smaregi_client_id, smaregi_client_secret, smaregi_contract_id')
      .eq('store_id', storeId)
      .single();

    if (storeError) {
      console.error('åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', storeError);
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒç„¡åŠ¹ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!store.enable_smaregi_integration) {
      return NextResponse.json(
        { error: 'ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™' },
        { status: 403 }
      );
    }

    // ã‚¹ãƒãƒ¬ã‚¸APIã®èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!store.smaregi_client_id || !store.smaregi_client_secret || !store.smaregi_contract_id) {
      return NextResponse.json(
        { error: 'ã‚¹ãƒãƒ¬ã‚¸APIã®èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // ã‚¹ãƒãƒ¬ã‚¸APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const accessToken = await getSmaregiAccessToken(
      store.smaregi_client_id,
      store.smaregi_client_secret,
      store.smaregi_contract_id
    );

    // ã‚¹ãƒãƒ¬ã‚¸APIã‹ã‚‰å•†å“æƒ…å ±ã‚’å–å¾—
    const products = await fetchSmaregiProducts(accessToken, store.smaregi_contract_id);

    // å•†å“æƒ…å ±ã‚’æ•´å½¢
    const formattedProducts = products.map(product => ({
      productId: product.productCode,
      name: product.productName,
      price: parseInt(product.price, 10)
    }));

    return NextResponse.json({
      products: formattedProducts
    });
  } catch (error) {
    console.error('ã‚¹ãƒãƒ¬ã‚¸å•†å“å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/stores/settings/smaregi-status/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(request: NextRequest) {
  try {
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store, error: storeError } = await supabase
      .from('stores')
      .select('enable_smaregi_integration')
      .eq('store_id', storeId)
      .single();

    if (storeError) {
      console.error('åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', storeError);
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      enabled: store.enable_smaregi_integration
    });
  } catch (error) {
    console.error('ã‚¹ãƒãƒ¬ã‚¸é€£æºçŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/portal/store-settings/page.tsx">
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';
import SettingsForm from './settings-form';

export default async function StoreSettingsPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    redirect('/login');
  }

  // åº—èˆ—æƒ…å ±ã‚’å–å¾—
  const storeResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/stores/${storeId}`, {
    cache: 'no-store'
  });

  if (!storeResponse.ok) {
    console.error('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await storeResponse.text());
    return <div>åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>;
  }

  const store = await storeResponse.json();

  return (
    <div className="py-6">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-2xl font-semibold text-gray-900">åº—èˆ—è¨­å®š</h1>
      </div>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div className="bg-white shadow overflow-hidden sm:rounded-lg">
          <div className="px-4 py-5 sm:p-6">
            <SettingsForm
              storeId={store.store_id}
              enableSmaregiIntegration={store.enable_smaregi_integration}
              smaregiClientId={store.smaregi_client_id || ''}
              smaregiClientSecret={store.smaregi_client_secret || ''}
              smaregiContractId={store.smaregi_contract_id || ''}
              taxRate={store.tax_rate || 10.0}
            />
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/store-settings/settings-form.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

interface SettingsFormProps {
  storeId: string;
  enableSmaregiIntegration: boolean;
  smaregiClientId?: string;
  smaregiClientSecret?: string;
  smaregiContractId?: string;
  taxRate?: number;
}

export default function SettingsForm({
  storeId,
  enableSmaregiIntegration,
  smaregiClientId = '',
  smaregiClientSecret = '',
  smaregiContractId = '',
  taxRate = 10.0,
}: SettingsFormProps) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  const [settings, setSettings] = useState({
    enableSmaregiIntegration,
    smaregiClientId,
    smaregiClientSecret,
    smaregiContractId,
    taxRate,
  });

  const handleToggle = () => {
    setSettings({
      ...settings,
      enableSmaregiIntegration: !settings.enableSmaregiIntegration,
    });
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;

    // æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã¯æ•°å€¤ã«å¤‰æ›
    if (name === 'taxRate') {
      const numValue = parseFloat(value);
      if (!isNaN(numValue)) {
        setSettings({
          ...settings,
          [name]: numValue,
        });
      }
    } else {
      setSettings({
        ...settings,
        [name]: value,
      });
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);
    setSuccess(null);

    try {
      // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ãªå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€å¥‘ç´„IDãŒå¿…è¦
      if (settings.enableSmaregiIntegration &&
          (!settings.smaregiClientId || !settings.smaregiClientSecret || !settings.smaregiContractId)) {
        setError('ã‚¹ãƒãƒ¬ã‚¸é€£æºã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€å¥‘ç´„IDãŒå¿…è¦ã§ã™');
        setIsLoading(false);
        return;
      }

      // æ¶ˆè²»ç¨ç‡ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (settings.taxRate < 0 || settings.taxRate > 100) {
        setError('æ¶ˆè²»ç¨ç‡ã¯0ã€œ100ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        setIsLoading(false);
        return;
      }

      const response = await fetch('/api/stores/settings', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          enable_smaregi_integration: settings.enableSmaregiIntegration,
          smaregi_client_id: settings.smaregiClientId,
          smaregi_client_secret: settings.smaregiClientSecret,
          smaregi_contract_id: settings.smaregiContractId,
          tax_rate: settings.taxRate,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      setSuccess('è¨­å®šãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {error && (
        <div className="rounded-md bg-red-50 p-4">
          <div className="flex">
            <div className="flex-shrink-0">
              <svg className="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
              </svg>
            </div>
            <div className="ml-3">
              <h3 className="text-sm font-medium text-red-800">ã‚¨ãƒ©ãƒ¼</h3>
              <div className="mt-2 text-sm text-red-700">
                <p>{error}</p>
              </div>
            </div>
          </div>
        </div>
      )}

      {success && (
        <div className="rounded-md bg-green-50 p-4">
          <div className="flex">
            <div className="flex-shrink-0">
              <svg className="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              </svg>
            </div>
            <div className="ml-3">
              <p className="text-sm font-medium text-green-800">{success}</p>
            </div>
          </div>
        </div>
      )}

      <div>
        <h2 className="text-lg font-medium text-gray-900">åŸºæœ¬è¨­å®š</h2>
        <div className="mt-4">
          <label htmlFor="taxRate" className="block text-sm font-medium text-gray-700">
            æ¶ˆè²»ç¨ç‡ (%)
          </label>
          <div className="mt-1 relative rounded-md shadow-sm w-32">
            <input
              type="number"
              name="taxRate"
              id="taxRate"
              min="0"
              max="100"
              step="0.1"
              value={settings.taxRate}
              onChange={handleInputChange}
              className="focus:ring-blue-500 focus:border-blue-500 block w-full pr-8 sm:text-sm border-gray-300 rounded-md"
            />
            <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              <span className="text-gray-500 sm:text-sm">%</span>
            </div>
          </div>
          <p className="mt-1 text-sm text-gray-500">
            ä¼šè¨ˆæ™‚ã«é©ç”¨ã•ã‚Œã‚‹æ¶ˆè²»ç¨ç‡ã‚’è¨­å®šã—ã¾ã™ã€‚
          </p>
        </div>
      </div>

      <div className="pt-6 border-t border-gray-200 mt-6">
        <h2 className="text-lg font-medium text-gray-900">ã‚¹ãƒãƒ¬ã‚¸é€£æºè¨­å®š</h2>
        <div className="mt-4 space-y-4">
          <div className="flex items-start">
            <div className="flex items-center h-5">
              <input
                id="enableSmaregiIntegration"
                name="enableSmaregiIntegration"
                type="checkbox"
                checked={settings.enableSmaregiIntegration}
                onChange={handleToggle}
                className="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
              />
            </div>
            <div className="ml-3 text-sm">
              <label htmlFor="enableSmaregiIntegration" className="font-medium text-gray-700">
                ã‚¹ãƒãƒ¬ã‚¸é€£æº
              </label>
              <p className="text-gray-500">
                ã‚¹ãƒãƒ¬ã‚¸ã¨ã®é€£æºæ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚ç„¡åŠ¹ã«ã™ã‚‹ã¨ã€ã‚¹ãƒãƒ¬ã‚¸ã¸ã®ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿é€ä¿¡ãŒè¡Œã‚ã‚Œãªããªã‚Šã¾ã™ã€‚
              </p>
            </div>
          </div>

          {settings.enableSmaregiIntegration && (
            <div className="mt-6 pl-7">
              <div className="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                <div className="sm:col-span-3">
                  <label htmlFor="smaregiClientId" className="block text-sm font-medium text-gray-700">
                    ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
                  </label>
                  <div className="mt-1">
                    <input
                      type="text"
                      name="smaregiClientId"
                      id="smaregiClientId"
                      value={settings.smaregiClientId}
                      onChange={handleInputChange}
                      className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                      placeholder="ã‚¹ãƒãƒ¬ã‚¸ã‹ã‚‰æä¾›ã•ã‚ŒãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID"
                    />
                  </div>
                </div>

                <div className="sm:col-span-3">
                  <label htmlFor="smaregiClientSecret" className="block text-sm font-medium text-gray-700">
                    ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
                  </label>
                  <div className="mt-1">
                    <input
                      type="password"
                      name="smaregiClientSecret"
                      id="smaregiClientSecret"
                      value={settings.smaregiClientSecret}
                      onChange={handleInputChange}
                      className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                      placeholder="ã‚¹ãƒãƒ¬ã‚¸ã‹ã‚‰æä¾›ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ"
                    />
                  </div>
                </div>

                <div className="sm:col-span-3">
                  <label htmlFor="smaregiContractId" className="block text-sm font-medium text-gray-700">
                    å¥‘ç´„ID
                  </label>
                  <div className="mt-1">
                    <input
                      type="text"
                      name="smaregiContractId"
                      id="smaregiContractId"
                      value={settings.smaregiContractId}
                      onChange={handleInputChange}
                      className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                      placeholder="ã‚¹ãƒãƒ¬ã‚¸ã®å¥‘ç´„ID"
                    />
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      <div className="pt-5">
        <div className="flex justify-end">
          <button
            type="button"
            onClick={() => router.back()}
            className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            disabled={isLoading}
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            type="submit"
            className="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            disabled={isLoading}
          >
            {isLoading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
          </button>
        </div>
      </div>
    </form>
  );
}
</file>

<file path="docs/ã‚¹ãƒãƒ¬ã‚¸é€£æºè¨­å®š.md">
# ã‚¹ãƒãƒ¬ã‚¸é€£æºè¨­å®š

## æ¦‚è¦

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã‚¹ãƒãƒ¬ã‚¸ã¨é€£æºã™ã‚‹ã“ã¨ã§ã€ã‚¹ãƒãƒ¬ã‚¸ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å•†å“æƒ…å ±ã‚’è‡ªå‹•çš„ã«å–ã‚Šè¾¼ã¿ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸã€ä¼šè¨ˆæ™‚ã«ã¯ã‚¹ãƒãƒ¬ã‚¸ã«å¯¾ã—ã¦ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å‰ææ¡ä»¶

- ã‚¹ãƒãƒ¬ã‚¸ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã£ã¦ã„ã‚‹ã“ã¨
- ã‚¹ãƒãƒ¬ã‚¸ãƒ»ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚ºã«ç™»éŒ²ã—ã¦ã„ã‚‹ã“ã¨
- ã‚¹ãƒãƒ¬ã‚¸ãƒ»ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚±ãƒƒãƒˆã§ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ã„ã‚‹ã“ã¨

## è¨­å®šæ‰‹é †

### 1. ã‚¹ãƒãƒ¬ã‚¸ãƒ»ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚ºã§ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹

1. [ã‚¹ãƒãƒ¬ã‚¸ãƒ»ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚º](https://developers.smaregi.dev/)ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
2. ã€Œã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
3. ã‚¢ãƒ—ãƒªåã€èª¬æ˜ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIãªã©ã‚’å…¥åŠ›ã—ã€ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
4. ä½œæˆå¾Œã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚

### 2. åº—èˆ—è¨­å®šç”»é¢ã§ã‚¹ãƒãƒ¬ã‚¸é€£æºã‚’æœ‰åŠ¹ã«ã™ã‚‹

1. ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
2. åº—èˆ—è¨­å®šç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚
3. ã€Œã‚¹ãƒãƒ¬ã‚¸é€£æºã€ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚
4. ä»¥ä¸‹ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã™ï¼š
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID: ã‚¹ãƒãƒ¬ã‚¸ãƒ»ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚ºã§ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ: ã‚¹ãƒãƒ¬ã‚¸ãƒ»ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚ºã§ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
   - å¥‘ç´„ID: ã‚¹ãƒãƒ¬ã‚¸ãƒ»ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚ºã®å·¦ä¸Šã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¥‘ç´„ID
5. ã€Œä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

### 3. ãƒ¡ãƒ‹ãƒ¥ãƒ¼åŒæœŸã‚’å®Ÿè¡Œã™ã‚‹

1. ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚
3. ã€Œã‚¹ãƒãƒ¬ã‚¸ã¨åŒæœŸã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
4. åŒæœŸãŒå®Œäº†ã™ã‚‹ã¨ã€ã‚¹ãƒãƒ¬ã‚¸ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å•†å“æƒ…å ±ãŒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

## æ³¨æ„äº‹é …

- ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã€ã‚«ãƒ†ã‚´ãƒªã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ ã¯æœ¬ã‚·ã‚¹ãƒ†ãƒ ä¸Šã§ã¯ã§ãã¾ã›ã‚“ã€‚ã‚«ãƒ†ã‚´ãƒªã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€ã‚¹ãƒãƒ¬ã‚¸å´ã§éƒ¨é–€ã‚„å•†å“ã‚’ç™»éŒ²ã—ãŸå¾Œã€ã€Œã‚¹ãƒãƒ¬ã‚¸ã¨åŒæœŸã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
- ã‚¹ãƒãƒ¬ã‚¸ã®å•†å“æƒ…å ±ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯ã€å†åº¦åŒæœŸã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- ã‚¹ãƒãƒ¬ã‚¸ã®éƒ¨é–€æƒ…å ±ã¯ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦å–ã‚Šè¾¼ã¾ã‚Œã¾ã™ã€‚
- ã‚¹ãƒãƒ¬ã‚¸ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å•†å“ã¯ã€Œã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ã€ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚
- ã‚¹ãƒãƒ¬ã‚¸ã®å•†å“ã‚³ãƒ¼ãƒ‰ã¯æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®å•†å“IDã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- ã‚¹ãƒãƒ¬ã‚¸ã®å•†å“ç”»åƒã¯ `/products/images` APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ä¸€æ‹¬å–å¾—ã•ã‚Œã€æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®å•†å“ç”»åƒURLã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- ã‚¹ãƒãƒ¬ã‚¸APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹ `url` ã¾ãŸã¯ `imageUrl` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ç”»åƒURLã‚’å–å¾—ã—ã¾ã™ã€‚
- å•†å“ç”»åƒãŒã‚¹ãƒãƒ¬ã‚¸ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ç”»åƒãªã—ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
- åŒã˜å•†å“ã«è¤‡æ•°ã®ç”»åƒãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€æœ€åˆã®ç”»åƒãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- ã‚¹ãƒãƒ¬ã‚¸ã®ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€`next.config.js`ãƒ•ã‚¡ã‚¤ãƒ«ã®`images.domains`ã«`pos-cache.smaregi.dev`ã¨`pos-cache.smaregi.jp`ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### åŒæœŸã«å¤±æ•—ã™ã‚‹å ´åˆ

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- å¥‘ç´„IDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ç‰¹å®šã®å•†å“ãŒåŒæœŸã•ã‚Œãªã„å ´åˆ

- ã‚¹ãƒãƒ¬ã‚¸å´ã§å•†å“ãŒæ­£ã—ãç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- å•†å“ã‚³ãƒ¼ãƒ‰ãŒé‡è¤‡ã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- å•†å“ãŒéè¡¨ç¤ºã«ãªã£ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### å•†å“ç”»åƒãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆ

- ã‚¹ãƒãƒ¬ã‚¸å´ã§å•†å“ç”»åƒãŒæ­£ã—ãç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- `next.config.js`ãƒ•ã‚¡ã‚¤ãƒ«ã«`pos-cache.smaregi.dev`ã¨`pos-cache.smaregi.jp`ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- è¨­å®šå¤‰æ›´å¾Œã¯ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚
- ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

ã‚¹ãƒãƒ¬ã‚¸APIã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[ã‚¹ãƒãƒ¬ã‚¸ãƒ»ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ API POSä»•æ§˜æ›¸](https://www1.smaregi.dev/apidoc/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
</file>

<file path="docs/ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰.md">
# ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

## æ¦‚è¦

ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå•†å“ï¼‰ã®æ–°è¦ä½œæˆãƒ»ç·¨é›†ç”»é¢ã‹ã‚‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€Supabaseã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

## æ©Ÿèƒ½è©³ç´°

1. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç·¨é›†ç”»é¢ã§ã€Œç”»åƒã‚’é¸æŠã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
2. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJPEGã€PNGã€WebPã€GIFï¼‰ã‚’é¸æŠã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«é©åˆ‡ãªã‚µã‚¤ã‚ºã«ãƒªã‚µã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚
3. ãƒªã‚µã‚¤ã‚ºå¾Œã®ç”»åƒãŒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆã“ã®æ™‚ç‚¹ã§ã¯ã¾ã ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚
4. ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œè¿½åŠ ã€ã¾ãŸã¯ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚
5. ã€Œç”»åƒã‚’å‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ç”»åƒãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚

## æŠ€è¡“ä»•æ§˜

### ç”»åƒãƒªã‚µã‚¤ã‚º

- æœ€å¤§ã‚µã‚¤ã‚º: å¹…800px Ã— é«˜ã•800px
- ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”: å…ƒã®ç”»åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒ
- å‡¦ç†æ–¹æ³•: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§Canvas APIã‚’ä½¿ç”¨ã—ã¦ãƒªã‚µã‚¤ã‚º
- ç”»è³ª: 90%ï¼ˆJPEG/WebPã®å ´åˆï¼‰

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®š

- ãƒã‚±ãƒƒãƒˆå: `menu-images`
- ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™:
  - é–²è¦§: èª°ã§ã‚‚å¯èƒ½
  - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: ç®¡ç†è€…ã®ã¿
  - æ›´æ–°: ç®¡ç†è€…ã®ã¿
  - å‰Šé™¤: ç®¡ç†è€…ã®ã¿
- ãƒ•ã‚¡ã‚¤ãƒ«åˆ¶é™:
  - æœ€å¤§ã‚µã‚¤ã‚º: 5MB
  - è¨±å¯å½¢å¼: JPEG, PNG, WebP, GIF

### APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

- URL: `/api/upload/menu-image`
- ãƒ¡ã‚½ãƒƒãƒ‰: POST
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼: multipart/form-data
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
  - `file`: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
  - æˆåŠŸæ™‚: `{ url: "ç”»åƒã®å…¬é–‹URL" }`
  - ã‚¨ãƒ©ãƒ¼æ™‚: `{ error: "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" }`

### ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®å‘½åè¦å‰‡ã§ä¿å­˜ã•ã‚Œã¾ã™:

```
{store_id}/{uuid}.{extension}
```

- `store_id`: åº—èˆ—IDï¼ˆUUIDï¼‰
- `uuid`: ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã•ã‚ŒãŸUUIDï¼ˆv4ï¼‰
- `extension`: å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­ï¼ˆjpg, png, webp, gif ãªã©ï¼‰

## åˆæœŸè¨­å®š

### Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆã®ä½œæˆ

åˆå›åˆ©ç”¨æ™‚ã«ã¯ã€Supabaseã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚APIã¯è‡ªå‹•çš„ã«ãƒã‚±ãƒƒãƒˆã®ä½œæˆã‚’è©¦ã¿ã¾ã™ãŒã€æ¨©é™ã®å•é¡Œã§å¤±æ•—ã™ã‚‹å ´åˆã¯æ‰‹å‹•ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

#### æ‰‹å‹•ã§ã®ãƒã‚±ãƒƒãƒˆä½œæˆæ–¹æ³•

1. Supabaseã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆhttps://app.supabase.comï¼‰ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¾ã™
3. å·¦å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒStorageã€ã‚’é¸æŠã—ã¾ã™
4. ã€ŒNew Bucketã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
5. ãƒã‚±ãƒƒãƒˆåã«ã€Œmenu-imagesã€ã‚’å…¥åŠ›ã—ã¾ã™
6. ã€ŒPublicã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚ªãƒ³ã«ã—ã¾ã™ï¼ˆå…¬é–‹ãƒã‚±ãƒƒãƒˆã¨ã—ã¦è¨­å®šï¼‰
7. ã€ŒCreate bucketã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

#### RLSãƒãƒªã‚·ãƒ¼ã®è¨­å®š

ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ãŸå¾Œã€ä»¥ä¸‹ã®RLSãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¾ã™ï¼š

1. ä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆã®ã€ŒPoliciesã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
2. ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ï¼š

- **é–²è¦§ãƒãƒªã‚·ãƒ¼**:
  - åå‰: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½
  - å¯¾è±¡: SELECT
  - ãƒãƒªã‚·ãƒ¼: `true`ï¼ˆèª°ã§ã‚‚é–²è¦§å¯èƒ½ï¼‰

- **ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼**:
  - åå‰: ç®¡ç†è€…ã®ã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½
  - å¯¾è±¡: INSERT
  - ãƒãƒªã‚·ãƒ¼: `EXISTS (SELECT 1 FROM public.store_users WHERE user_id = auth.uid() AND role = 'admin')`

- **æ›´æ–°ãƒãƒªã‚·ãƒ¼**:
  - åå‰: ç®¡ç†è€…ã®ã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚’æ›´æ–°å¯èƒ½
  - å¯¾è±¡: UPDATE
  - ãƒãƒªã‚·ãƒ¼: `EXISTS (SELECT 1 FROM public.store_users WHERE user_id = auth.uid() AND role = 'admin')`

- **å‰Šé™¤ãƒãƒªã‚·ãƒ¼**:
  - åå‰: ç®¡ç†è€…ã®ã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚’å‰Šé™¤å¯èƒ½
  - å¯¾è±¡: DELETE
  - ãƒãƒªã‚·ãƒ¼: `EXISTS (SELECT 1 FROM public.store_users WHERE user_id = auth.uid() AND role = 'admin')`

## æ³¨æ„äº‹é …

1. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯5MBä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
2. è¨±å¯ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¯ JPEG, PNG, WebP, GIF ã®ã¿ã§ã™ã€‚
3. ç”»åƒã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚ä¸è¦ãªç”»åƒã¯å®šæœŸçš„ã«ç®¡ç†è€…ãŒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
4. åˆå›åˆ©ç”¨æ™‚ã«ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã€APIã¯è‡ªå‹•çš„ã«ãƒã‚±ãƒƒãƒˆã®ä½œæˆã‚’è©¦ã¿ã¾ã™ãŒã€æ¨©é™ã®å•é¡Œã§å¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ä¸Šè¨˜ã®æ‰‹é †ã§ãƒã‚±ãƒƒãƒˆã‚’æ‰‹å‹•ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

## ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

1. ä¸è¦ç”»åƒã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
2. ç”»åƒã®ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
3. ç”»åƒã®ã‚¯ãƒ­ãƒƒãƒ—ãƒ»ç·¨é›†æ©Ÿèƒ½
4. ç”»åƒã®ãƒªã‚µã‚¤ã‚ºã‚µã‚¤ã‚ºã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã§ãã‚‹æ©Ÿèƒ½
</file>

<file path="docs/å®Ÿè£…è¨ˆç”»æ›¸.md">
# QRã‚ªãƒ¼ãƒ€ãƒ¼ & ä¼šè¨ˆé€£æºã‚·ã‚¹ãƒ†ãƒ   
## **å®Ÿè£…è¨ˆç”»æ›¸** â€• *v 2025-04-28 (Rev 1)*  
> å¯¾è±¡ï¼šè©³ç´°è¨­è¨ˆæ›¸ *Rev 6.2* ã«åŸºã¥ãå®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º  
> æ–¹é‡ï¼š**ã€Œæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã‚‰ç›´å¾Œã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒŸãƒƒãƒˆã€** ã‚’å¾¹åº•ã—ã€CI ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§é †æ¬¡è‡ªå‹•æ¤œè¨¼ã™ã‚‹ã€‚  

---

## 1. é–‹ç™ºãƒ¢ãƒ‡ãƒ«æ¦‚è¦

| é …ç›® | æ¡ç”¨æ–¹é‡ |
| :-- | :-- |
| **ãƒªãƒã‚¸ãƒˆãƒª** | GitHub (monorepo) |
| **ãƒ–ãƒ©ãƒ³ãƒé‹ç”¨** | <br>1. `main` â€¦ å¸¸æ™‚ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½<br>2. `dev` â€¦ ã‚¹ãƒ—ãƒªãƒ³ãƒˆçµ±åˆ (é€±æ¬¡)<br>3. `feature/**` â€¦ 1 Issue = 1 PR |
| **ã‚³ãƒ¼ãƒ‰è¦ç´„** | ESLint + Prettier + Husky pre-commit |
| **CI** | GitHub Actions (lint â†’ unit â†’ api â†’ e2e smoke) |
| **CD** | Vercel Preview (è‡ªå‹•) â†’ `main` ãƒãƒ¼ã‚¸ã§ Prod |
| **ãƒ†ã‚¹ãƒˆå¿…é ˆåŒ–** | **PR ãŒé€šã‚‹æ¡ä»¶**<br>â€ *æ–°è¦ï¼å¤‰æ›´ã‚³ãƒ¼ãƒ‰* ã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹<br>â€ ã‚«ãƒãƒ¬ãƒƒã‚¸å·®åˆ†ãŒä½ä¸‹ã—ãªã„ |

---

## 2. å½¹å‰²åˆ†æ‹…

| ãƒ­ãƒ¼ãƒ« | ä¸»æ‹…å½“ | å‚™è€ƒ |
| :-- | :-- | :-- |
| **Tech Lead** | åŠ è—¤ã•ã‚“ | ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹é‡ï¼CI è¨­è¨ˆ |
| **Backend** | A ã•ã‚“ | Supabase SQL & Route Handlers |
| **Frontend** | B ã•ã‚“ | RSC / Portal & Menu UI |
| **QA** | C ã•ã‚“ | Playwright ã‚·ãƒŠãƒªã‚ªï¼è² è·è©¦é¨“ |
| **DevOps** | D ã•ã‚“ | GitHub Actions / Vercel ç’°å¢ƒ |

---

## 3. ã‚¹ãƒ—ãƒªãƒ³ãƒˆäºˆå®š (2 é€±é–“ï¼10 å–¶æ¥­æ—¥)

| Sprint | ä¸»è¦æˆæœç‰© | æ—¥ç¨‹ | å®Œäº†åˆ¤å®š |
| :-: | :-- | :-- | :-- |
| **S0** | é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—<br>CI / lint / test é››å½¢ | 4-28 â€“ 5-02 | `main` ã« CI ã‚°ãƒªãƒ¼ãƒ³ |
| **S1** | âš™ï¸ **Auth & RLS åŸºç›¤**<br> `/login/{store_code}` ç”»é¢ | 5-05 â€“ 5-16 | QA: RLS 403/200 ãƒ†ã‚¹ãƒˆå®Œ |
| **S2** | ğŸª‘ **ãƒ†ãƒ¼ãƒ–ãƒ« CRUD + QR** (`/portal/tables`) | 5-19 â€“ 5-30 | QR ç”»åƒç”Ÿæˆ E2E é€šé |
| **S3** | ğŸ£ **QRãƒ¡ãƒ‹ãƒ¥ãƒ¼ v1** (`/menu/[table]`)<br> ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é–²è¦§ | 6-02 â€“ 6-13 | Workbox offline test |
| **S4** | ğŸ“¦ **æ³¨æ–‡ãƒ•ãƒ­ãƒ¼ & Kanban** | 6-16 â€“ 6-27 | 2 ãƒ–ãƒ©ã‚¦ã‚¶åŒæœŸ < 1 s |
| **S5** | ğŸ’° **ãƒãƒ£ãƒ¼ã‚¸ & ä¼šè¨ˆ**<br> (`fn_calc_total_charge`) | 6-30 â€“ 7-11 | é‡‘é¡å¢ƒç•Œå€¤ UT 100 % |
| **S6** | ğŸ“ˆ **ãƒ¬ãƒãƒ¼ãƒˆ & ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ** | 7-14 â€“ 7-25 | CSV å½¢å¼ QA æ‰¿èª |
| **S7** | ğŸ”’ **è² è· & ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ hardening** | 7-28 â€“ 8-08 | k6 p95<300 ms / ZAP 0 é«˜ |
| **S8** | ğŸš€ UAT & æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ | 8-11 â€“ 8-22 | UAT sign-off + Prod cut-over |

*ãƒãƒƒãƒ•ã‚¡*ï¼š8-25 â€“ 8-29ï¼ˆç·Šæ€¥ä¿®æ­£ & ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ï¼‰

---

## 4. æ©Ÿèƒ½åˆ¥ã‚¿ã‚¹ã‚¯â€ãƒ†ã‚¹ãƒˆå¯¾å¿œè¡¨

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« / ç”»é¢ | å®Ÿè£…ã‚¿ã‚¹ã‚¯ (PR) | **ç›´å¾Œã«æ›¸ããƒ†ã‚¹ãƒˆ** |
| :-- | :-- | :-- |
| **Auth** | `route.ts(login)` / `/api/login` | Supertest: æ­£å¸¸/403ã€CSRF |
| **StoreGuard** | Portal layout | Vitest: `hasRole()` å˜ä½“ |
| **SeatTypeForm** | CRUD UI + PATCH API | RTL + Vitest: ãƒãƒªãƒ‡ãƒ»ä¾¡æ ¼æ›´æ–° |
| **Table QR** | QR PNG ç”Ÿæˆ | Playwright: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯å¦ |
| **Menu PWA** | `menu/layout.tsx` (SW) | Workbox integration test |
| **OrderBoard** | Kanban DnD + WS | Playwright: DnD â†’ status å¤‰åŒ– |
| **Charge Logic** | `charge.ts` + SQL é–¢æ•° | Vitest: 0,29,30,31 åˆ†å¢ƒç•Œ |
| **Checkout** | `/api/checkout` + `/sales` | Supertest: 201 / Retry 3 |
| **Reports** | SQL View + CSV | Vitest: é›†è¨ˆåˆè¨ˆã€åˆ—é † |

---

## 5. 1 PR ã®æµã‚Œï¼ˆå…±é€šãƒ•ãƒ­ãƒ¼ï¼‰

```mermaid
graph TD
  A(Fork feature/**) --> B(å®Ÿè£…)
  B --> C(å˜ä½“ãƒ†ã‚¹ãƒˆè¿½åŠ )
  C --> D(API/E2E ãƒ†ã‚¹ãƒˆè¿½åŠ )
  D --> E(Push â†’ PR)
  E --> F(CI: lint & å…¨ãƒ†ã‚¹ãƒˆ)
  F -->|Green| G(ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼)
  G -->|Approve| H(Merge â†’ Preview)
  H --> I(QA smoke) -->|OK| J(main ãƒãƒ¼ã‚¸)
```

---

## 6. ã‚«ãƒãƒ¬ãƒƒã‚¸ã¨å“è³ªã‚²ãƒ¼ãƒˆ

| ãƒ†ã‚¹ãƒˆå±¤ | ãƒ„ãƒ¼ãƒ« | æœ€ä½ãƒ©ã‚¤ãƒ³ (main) |
| :-- | :-- | :-- |
| Unit + API | Vitest + Supertest | **80 % line** |
| E2E | Playwright | ã‚³ã‚¢ã‚·ãƒŠãƒªã‚ª 100 % é€šé |
| Perf | k6 | p95 < 300 ms |
| Sec | ZAP Baseline | High 0 / Medium 0 |

*Codecov â‡¢ GitHub PR status ã§ â€œ80 % æœªæº€ãªã‚‰ merge ç¦æ­¢â€ã€‚*

---

## 7. ãƒªã‚¹ã‚¯ & å¯¾ç­–

| ãƒªã‚¹ã‚¯ | ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ | å¯¾ç­– |
| :-- | :-- | :-- |
| Broadcast é…å»¶ > 1 s | æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®é£Ÿã„é•ã„ | k6 + WebSocket è² è·ãƒ†ã‚¹ãƒˆ / å†é€ ACK |
| `session_seat_events` å¤§é‡åŒ– | ä¼šè¨ˆ SQL é…å»¶ | è¤‡åˆ INDEX ï¼† ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æ¤œè¨¼ |
| ã‚¹ãƒãƒ¬ã‚¸ API éšœå®³ | ä¼šè¨ˆé€£æºåœæ­¢ | Retry 3 â†’ Dead-letter + ç®¡ç†UI ã‚¨ãƒ©ãƒ¼è¡¨ç¤º |

---

## 8. ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³

- **ãƒ‡ã‚¤ãƒªãƒ¼ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒƒãƒ—**ï¼šSlack huddle (15 min)  
- **ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼**ï¼šé‡‘æ›œåˆå¾Œãƒ»`dev` â†’ `main` ãƒãƒ¼ã‚¸åˆ¤æ–­  
- **ä»•æ§˜å¤‰æ›´**ï¼šIssue â†’ è¨­è¨ˆæ›¸ Rev æ›´æ–° â†’ å½±éŸ¿åˆ†æ â†’ åˆæ„å¾Œç€æ‰‹  

---

## 9. ä»˜éŒ²ï¼šãƒ©ãƒ™ãƒ«é‹ç”¨

| ãƒ©ãƒ™ãƒ« | æ„å‘³ |
| :-- | :-- |
| `feat` | æ–°æ©Ÿèƒ½ |
| `fix` | ãƒã‚°ä¿®æ­£ |
| `test` | ãƒ†ã‚¹ãƒˆè¿½åŠ ã®ã¿ |
| `chore` | CI / ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| `blocked` | å¤–éƒ¨å¾…ã¡ |
| `urgent` | ãƒªãƒªãƒ¼ã‚¹å‰ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ« |
</file>

<file path="docs/é€²æ—ç®¡ç†.md">
### 1. ã‚¹ãƒ—ãƒªãƒ³ãƒˆå…¨ä½“ã‚µãƒãƒª

| Sprint | æœŸé–“ (2025) | ä¸»è¦æˆæœç‰© | è²¬ä»»è€… | Status | å‚™è€ƒ |
| :--: | :-- | :-- | :-- | :-- | :-- |
| S0 | 04-28 â€“ 05-02 | é–‹ç™ºç’°å¢ƒ / CI é››å½¢ | DevOps | â˜‘ In Progress | åŸºæœ¬æ§‹é€ ãƒ»DBå®Ÿè£…å®Œäº† |
| S1 | 05-05 â€“ 05-16 | Auth & RLS åŸºç›¤ | Backend | â˜‘ In Progress | èªè¨¼ãƒ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…ä¸­ |
| S2 | 05-19 â€“ 05-30 | ãƒ†ãƒ¼ãƒ–ãƒ« CRUD + QR | Frontend | â˜ Planned | ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»å¸­ç¨®ç®¡ç†å®Ÿè£… |
| S3 | 06-02 â€“ 06-13 | QR ãƒ¡ãƒ‹ãƒ¥ãƒ¼ v1 (PWA) | Frontend | â˜ Planned | PWA Shell/UIå®Ÿè£… |
| S4 | 06-16 â€“ 06-27 | æ³¨æ–‡ãƒ•ãƒ­ãƒ¼ & Kanban | Shared | â˜ Planned | æ³¨æ–‡API/UIå®Ÿè£…ä¸­ |
| S5 | 06-30 â€“ 07-11 | ãƒãƒ£ãƒ¼ã‚¸ & ä¼šè¨ˆ | Backend | â˜ Planned | åˆç®—èª²é‡‘ |
| S6 | 07-14 â€“ 07-25 | ãƒ¬ãƒãƒ¼ãƒˆ & CSV | Backend | â˜ Planned | â€“ |
| S7 | 07-28 â€“ 08-08 | è² è· & ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | QA | â˜ Planned | k6 / ZAP |
| S8 | 08-11 â€“ 08-22 | UAT & ãƒªãƒªãƒ¼ã‚¹ | å…¨å“¡ | â˜ Planned | â€“ |
| **Buffer** | 08-25 â€“ 08-29 | äºˆå‚™æœŸé–“ | â€“ | â€“ | ç·Šæ€¥ä¿®æ­£ |

---

### 2. Sprint ãƒœãƒ¼ãƒ‰ï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå½¢å¼ï¼‰

#### S0 â€” ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- [ ] **CI ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**
  - [ ] lint ã‚¸ãƒ§ãƒ–
  - [ ] unit / api ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  - [ ] Playwright smoke
- [ ] **ESLint / Prettier / Husky**
  - [ ] ESLintè¨­å®š
  - [ ] Prettierè¨­å®š
  - [ ] Huskyè¨­å®š
- [x] **DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
  - [x] ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
  - [x] RLS ãƒãƒªã‚·ãƒ¼
  - [x] ãƒãƒ£ãƒ¼ã‚¸è¨ˆç®—é–¢æ•°
  - [x] ã‚·ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- [ ] README ã«é–‹ç™ºæ‰‹é †è¿½è¨˜
- [ ] **ãƒ¬ãƒ“ãƒ¥ãƒ¼** â†’ merge â†’ `main` ã§ CI ç·‘

---

#### S1 â€” Auth & RLS

| ã‚¿ã‚¹ã‚¯ | Owener | Impl | Test | Review | Status |
| :-- | :-- | :--: | :--: | :--: | :-- |
| `/login/{code}` ç”»é¢ SSR | FE | â˜‘ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| `/api/login` Route | BE | â˜‘ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| `StoreGuard` ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ | FE | â˜‘ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| RLS ãƒãƒªã‚·ãƒ¼ (`stores`, `orders` â€¦) | BE | â˜‘ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| ãƒãƒ¼ã‚¿ãƒ«å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ | FE | â˜‘ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| Supertest: 200 / 403 | QA | â€“ | â˜ | â€“ | â€“ |

---

#### S2 â€” ãƒ†ãƒ¼ãƒ–ãƒ« CRUD + QR

| ã‚¿ã‚¹ã‚¯ | Impl | UT | E2E | Review | Status |
| :-- | :--: | :--: | :--: | :--: | :-- |
| `/portal/tables` CRUD UI | â˜‘ | â˜ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| `/portal/seat-types` CRUD UI | â˜‘ | â˜ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| QR PNG ç”Ÿæˆ (qrcode pkg) | â˜‘ | â˜ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| Playwright: DL æ¤œè¨¼ | â€“ | â€“ | â˜ | â€“ | â€“ |

---

#### S3 â€” QR ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (PWA)

- [x] `/menu/layout` PWA Shell
- [ ] Workbox SW è¨­å®š
- [ ] MenuList / Cart / Checkout UI
- [ ] RTL + Vitest ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
- [ ] Offline/Online E2E

---

#### S4 â€” æ³¨æ–‡ãƒ•ãƒ­ãƒ¼ & Kanban

| ã‚¿ã‚¹ã‚¯ | Impl | UT | API | E2E | Review | Status |
| :-- | :--: | :--: | :--: | :--: | :--: | :-- |
| `OrderBoard.tsx` (DnD) | â˜‘ | â˜ | â€“ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| `/api/orders/{id}/status` | â˜‘ | â˜ | â˜ | â€“ | â˜ | å®Ÿè£…å®Œäº† |
| `/api/orders` (POST) | â˜ | â˜ | â˜ | â€“ | â˜ | æœªå®Ÿè£… |
| `OrderCard.tsx` | â˜‘ | â˜ | â€“ | â˜ | â˜ | å®Ÿè£…å®Œäº† |
| Broadcast Channel è¨­å®š | â˜‘ | â˜ | â€“ | â˜ | â˜ | å®Ÿè£…å®Œäº† |

---

#### S5 â€” ãƒãƒ£ãƒ¼ã‚¸ & ä¼šè¨ˆ

- [ ] `fn_calc_total_charge` SQL
- [x] `charge.ts` ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- [ ] `/api/checkout` Route
- [ ] Unit: å¢ƒç•Œå€¤ 0/29/30/31 åˆ†
- [ ] Supertest: `/sales` Mock
- [ ] Playwright: å®Œå…¨ä¼šè¨ˆã‚·ãƒŠãƒªã‚ª

---

#### S6 â€” ãƒ¬ãƒãƒ¼ãƒˆ

- [ ] SQL View `v_daily_sales`
- [ ] `/portal/reports/[period]` UI
- [ ] CSV Export ãƒœã‚¿ãƒ³
- [ ] Vitest: åˆè¨ˆä¸€è‡´
- [ ] Playwright: DL & CSV æ§‹é€ 

---

#### S7 â€” Hardening

| é …ç›® | Owner | Status |
| :-- | :-- | :-- |
| k6 ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (50 VU) | QA | â˜ |
| ZAP baseline Job | QA | â˜ |
| Broadcast å†é€è©¦é¨“ | BE | â˜ |

---

### 3. ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ãƒˆãƒ©ãƒƒã‚«ãƒ¼

| é€± | Lines % | Functions % | çŠ¶æ…‹ |
| :-- | :--: | :--: | :-- |
| S0 End | â‰¥ 40 | â‰¥ 40 | â˜ |
| S2 End | â‰¥ 60 | â‰¥ 60 | â˜ |
| S4 End | â‰¥ 70 | â‰¥ 70 | â˜ |
| **S5 End** | **â‰¥ 80** | **â‰¥ 80** | â˜ *(Merge gate)* |

---

### 4. ã‚«ãƒ³ãƒãƒ³ç”¨ãƒ©ãƒ™ãƒ«æ—©è¦‹è¡¨

| ãƒ©ãƒ™ãƒ« | è‰² | ç›®çš„ |
| :-- | :-- | :-- |
| `feat` | ğŸ”µ | æ–°æ©Ÿèƒ½å®Ÿè£… |
| `test` | ğŸŸ¢ | ãƒ†ã‚¹ãƒˆè¿½åŠ ã®ã¿ |
| `review-needed` | ğŸŸ¡ | ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡ |
| `blocked` | ğŸŸ¥ | å¤–éƒ¨ä¾å­˜ã§åœæ­¢ |
| `urgent` | ğŸŸ£ | æœ¬ç•ªå‰ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ« |

---

## âœ… é‹ç”¨ãƒ¡ãƒ¢

- **æ¯æ—¥**ï¼šæ‹…å½“è€…ã¯è‡ªã‚¿ã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯ã‚’æ›´æ–°ã—ã€Slack #dev-standup ã¸å ±å‘Š
- **æ¯ PR**ï¼šãƒ†ã‚¹ãƒˆãŒæœªè¿½åŠ ãªã‚‰ `bot/test-missing` ãƒ©ãƒ™ãƒ« â†’ CI å¤±æ•—
- **ã‚¹ãƒ—ãƒªãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼**ï¼šé€²æ—è¡¨ã‚’å‚ç…§ã—æœªå®Œã‚¿ã‚¹ã‚¯ã¯ç¿Œã‚¹ãƒ—ãƒªãƒ³ãƒˆã¸ãƒªã‚¹ã‚±
</file>

<file path="docs/è¨­è¨ˆæ›¸.md">
# QRã‚ªãƒ¼ãƒ€ãƒ¼ & ä¼šè¨ˆé€£æºã‚·ã‚¹ãƒ†ãƒ 
## **è©³ç´°è¨­è¨ˆæ›¸** â€• *v 2025-08-02 Rev 7.2*

## 0  å¤‰æ›´å±¥æ­´

| Rev | æ—¥ä»˜ | ä¸»è¦å¤‰æ›´ç‚¹ |
| :-- | :-- | :-- |
| 4 | 04-28 | Kanban UIï¼Broadcastï¼ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆï¼ˆJWT claim ã‚ã‚Šï¼‰ |
| 5 | 04-28 | **å¸­ç¨®å¤‰æ›´ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆèª²é‡‘**ï¼ˆ`session_seat_events`ï¼‰ |
| 6 | 04-28 | **JWT custom claim æ’é™¤**ãƒ»æ¨©é™ã¯ DB `store_users` ç®¡ç† |
| 6.1 | 04-28 | **`/login/{store_code}`** SSR + åº—èˆ—åè¡¨ç¤ºãƒ»æ‰€å±ãƒã‚§ãƒƒã‚¯ |
| **6.2** | 04-28 | **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ Portal (åº—å´) / Menu (å®¢å´) ã«ç‰©ç†åˆ†é›¢** |
| **6.3** | 05-01 | **åº—èˆ—è¨­å®šç”»é¢è¿½åŠ **ãƒ»ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ã¨ã‚¹ãƒãƒ¬ã‚¸é€£æºã®æœ‰åŠ¹/ç„¡åŠ¹è¨­å®š |
| **6.4** | 05-01 | **ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ç”»é¢è¿½åŠ **ãƒ»ã‚¹ãƒãƒ¬ã‚¸é€£æºè¨­å®šã‚’åˆ¥ç”»é¢ã«åˆ†é›¢ |
| **6.5** | 05-02 | **ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ç”»é¢è¿½åŠ **ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®CRUDã¨ã‚¹ãƒãƒ¬ã‚¸åŒæœŸæ©Ÿèƒ½ |
| **6.6** | 05-03 | **ã‚¹ãƒãƒ¬ã‚¸é€£æºã‚­ãƒ¼ä¿å­˜æ©Ÿèƒ½è¿½åŠ **ãƒ»ã‚¹ãƒãƒ¬ã‚¸APIã‚­ãƒ¼ã®ä¿å­˜ã¨ç®¡ç† |
| **6.7** | 06-01 | **ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªç®¡ç†æ©Ÿèƒ½è¿½åŠ **ãƒ»ã‚«ãƒ†ã‚´ãƒªã®CRUDã¨è¡¨ç¤ºé †ç®¡ç† |
| **6.8** | 06-02 | **ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯æ©Ÿèƒ½å‰Šé™¤**ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯æ©Ÿèƒ½ã‚’å‰Šé™¤ |
| **6.9** | 06-10 | **QRã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ãƒ•ãƒ­ãƒ¼æ”¹å–„**ãƒ»åº§å¸­é¸æŠâ†’æ–°è¦/æŒ‡åé¸æŠâ†’ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã®æµã‚Œã‚’å®Ÿè£… |
| **7.0** | 06-15 | **ä»£ç†æ³¨æ–‡æ©Ÿèƒ½è¿½åŠ **ãƒ»ã‚­ãƒ£ã‚¹ãƒˆ/ç®¡ç†è€…ãŒæ¥åº—å®¢ã®ä»£ã‚ã‚Šã«æ³¨æ–‡ã§ãã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£… |
| **7.1** | 08-01 | **æ–™é‡‘èª²é‡‘ä¸€æ™‚åœæ­¢æ©Ÿèƒ½è¿½åŠ **ãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ç”»é¢ã‹ã‚‰æ–™é‡‘èª²é‡‘ã‚’ä¸€æ™‚åœæ­¢/å†é–‹ã§ãã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£… |
| **7.2** | 08-02 | **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°æ©Ÿèƒ½å¼·åŒ–**ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€æ³¨æ–‡ãƒœãƒ¼ãƒ‰ã€ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ç”»é¢ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’å®Ÿè£… |

---

## 1  é«˜ãƒ¬ãƒ™ãƒ«ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
Browser (PWA)
â”‚  â”œâ”€ /portal/**   â† ã‚­ãƒ£ã‚¹ãƒˆãƒ»ç®¡ç†è€…
â”‚  â””â”€ /menu/**     â† æ¥åº—å®¢ (offline capable)
â”‚
â”‚  React Server Components / SW
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â”‚ Server Actions / fetch
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€ BFF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Route Handlers      â”‚  (èªè¨¼ï¼‹RLS)
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ RPC    â”‚ Broadcast/Realtime
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Supabase (PG15)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **/menu/** å´ã®ã¿ Workbox ã§ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã€‚
- Broadcast Channel `broadcast:orders` ã§ Kanban åŒæœŸé…å»¶ â‰¤ 1 sã€‚
- Supabase Realtime ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€æ³¨æ–‡ãƒœãƒ¼ãƒ‰ã€ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ç”»é¢ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã€‚

---

## 2  èªè¨¼ãƒ»ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ

| é …ç›® | æ–¹é‡ |
| :-- | :-- |
| ãƒ­ã‚°ã‚¤ãƒ³ URL | **`/login/{store_code}`**ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¿…é ˆï¼‰ |
| è¡¨ç¤º | åº—èˆ—åã‚’ SSR ã—ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«å¤§è¦‹å‡ºã—è¡¨ç¤º |
| èªè¨¼ | Supabase Authï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ |
| æ‰€å±ç¢ºèª | `store_users` ã«è©²å½“è¡ŒãŒãªã‘ã‚Œã° **403** |
| JWT | **æ¨™æº– claim ã®ã¿**ï¼ˆcustom claim 0ï¼‰ |
| RLS | `store_id IN (SELECT store_id FROM store_users WHERE user_id = auth.uid())` |

---

## 3  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ DDLï¼ˆä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

```sql
create table stores (
  store_id    uuid primary key default gen_random_uuid(),
  store_code  text unique not null,
  name        text not null,
  enable_cast_management boolean not null default true,
  enable_smaregi_integration boolean not null default true,
  smaregi_client_id text,
  smaregi_client_secret text,
  smaregi_contract_id text
);

create table store_users (
  id        uuid primary key default gen_random_uuid(),
  store_id  uuid references stores on delete cascade,
  user_id   uuid references auth.users on delete cascade,
  role      text check (role in ('admin','cast')) not null,
  display_name text
);

create table menu_categories (
  category_id uuid primary key default gen_random_uuid(),
  store_id uuid references stores on delete cascade not null,
  name text not null,
  display_order int not null default 0,
  unique(store_id, name)
);

create table seat_types (
  seat_type_id uuid primary key default gen_random_uuid(),
  store_id uuid references stores on delete cascade not null,
  display_name text not null,
  price_per_unit int not null,
  time_unit_minutes int not null default 30,
  unique(store_id, seat_type_id)
);

create table tables (
  table_id uuid primary key default gen_random_uuid(),
  store_id uuid references stores,
  name text,
  seat_type_id uuid references seat_types
);

create table sessions (
  session_id uuid primary key default gen_random_uuid(),
  store_id uuid references stores,
  table_id uuid references tables,
  start_at timestamptz default now(),
  charge_started_at timestamptz,
  charge_paused_at timestamptz,
  selected_cast_id uuid references auth.users(id),
  is_new_customer boolean
);

create table session_seat_events (
  event_id uuid primary key default gen_random_uuid(),
  session_id uuid references sessions on delete cascade,
  seat_type_id uuid references seat_types,
  price_snapshot int not null,
  changed_at timestamptz default now()
);

create table orders (
  order_id uuid primary key default gen_random_uuid(),
  store_id uuid references stores,
  session_id uuid references sessions,
  status text check (status in ('new','ack','prep','served','closed','cancel')),
  created_by_role text,
  proxy boolean default false,
  created_at timestamptz default now()
);
```

### RLS ãƒãƒªã‚·ãƒ¼ä¾‹

```sql
create policy is_my_store on orders
  using (store_id in (select store_id from store_users where user_id = auth.uid()));

create policy seat_type_store_admin_all on seat_types
  using (store_id in (
    select store_id from store_users
    where user_id = auth.uid() and role = 'admin'
  ));

create policy seat_type_store_cast_select on seat_types
  for select
  using (store_id in (
    select store_id from store_users
    where user_id = auth.uid()
  ));
```

---

## 4  ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯

### 4.1 å¸­ç¨®å¤‰æ›´ & ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæŒ¿å…¥

1. `/portal/tables` ã§å¸­ç¨®å¤‰æ›´
2. API `PATCH /api/sessions/{id}/seat-type`
   - `sessions.seat_type_id` æ›´æ–°
   - `session_seat_events` ã« `price_snapshot` ã‚’è¿½åŠ 
   - Broadcast `session:update`

### 4.2 ä¼šè¨ˆæ™‚ã®åˆç®—ãƒãƒ£ãƒ¼ã‚¸

`fn_calc_total_charge(session_id)` ãŒ
`session_seat_events` åŒºé–“ã”ã¨ã«
1. çµŒéæ™‚é–“ã‚’ 30 åˆ†åˆ‡ä¸Šã’ï¼ˆä¸€æ™‚åœæ­¢æœŸé–“ã‚’è€ƒæ…®ï¼‰
2. `price_snapshot` ã¨ä¹—ç®—
3. åŒºé–“åˆè¨ˆã‚’ã™ã¹ã¦åŠ ç®— â†’ æˆ»ã‚Šå€¤ã‚’ã‚¹ãƒãƒ¬ã‚¸ `/sales` ã«å«ã‚ã‚‹ã€‚

### 4.3 æ–™é‡‘èª²é‡‘ã®ä¸€æ™‚åœæ­¢ã¨å†é–‹

1. ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ç”»é¢ã§ã€Œèª²é‡‘ä¸€æ™‚åœæ­¢ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. API `POST /api/tables/{table_id}/sessions/{session_id}/pause` ã‚’å‘¼ã³å‡ºã—
3. `sessions.charge_paused_at` ã«ç¾åœ¨æ™‚åˆ»ã‚’è¨˜éŒ²
4. æ–™é‡‘è¨ˆç®—æ™‚ã«ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’è€ƒæ…®ã—ã¦è¨ˆç®—
5. ã€Œèª²é‡‘å†é–‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ `charge_paused_at` ã‚’ null ã«è¨­å®š

### 4.3 QRã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒQRãƒªãƒ³ã‚¯ï¼ˆ`/menu/[table_id]`ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã«å¿œã˜ã¦ä»¥ä¸‹ã®ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ:
   - **ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆ**:
     1. ã€Œã“ã®å¸­ã«åº§ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
     2. ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«`charge_started_at`ã‚’ç¾åœ¨æ™‚åˆ»ã§è¨˜éŒ²
     3. ã€Œæ–°è¦ã€ã¾ãŸã¯ã€ŒæŒ‡åã‚ã‚Šã€ã®é¸æŠç”»é¢ã‚’è¡¨ç¤º
     4. ã€Œæ–°è¦ã€é¸æŠæ™‚ã¯`is_new_customer=true`ã‚’è¨˜éŒ²
     5. ã€ŒæŒ‡åã‚ã‚Šã€é¸æŠæ™‚ã¯ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’è¡¨ç¤ºã—ã€é¸æŠã—ãŸã‚­ãƒ£ã‚¹ãƒˆã®`selected_cast_id`ã‚’è¨˜éŒ²
     6. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’è¡¨ç¤º
   - **ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆ**:
     1. æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’è¡¨ç¤º

---

## 5  API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| Method | Path | æ¨©é™ | è¦ç‚¹ |
| :-- | :-- | :-- | :-- |
| POST | `/api/login` | â€“ | email+pass+store_code / 403 if not member |
| GET | `/api/me` | cast/admin | `[{store_id, role}]` |
| GET | `/api/orders/active` | cast/admin | store ãƒ•ã‚£ãƒ«ã‚¿ |
| PATCH | `/api/orders/{id}/status` | cast/admin | Kanban æ›´æ–° â†’ Broadcast |
| PATCH | `/api/sessions/{id}/seat-type` | admin | å¸­ç¨®å¤‰æ›´ï¼‹snapshot |
| PATCH | `/api/tables/{table_id}/sessions/{session_id}` | - | ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆåº§å¸­é¸æŠãƒ»ã‚­ãƒ£ã‚¹ãƒˆé¸æŠï¼‰ |
| POST | `/api/tables/{table_id}/sessions/{session_id}/pause` | admin | æ–™é‡‘èª²é‡‘ä¸€æ™‚åœæ­¢ |
| POST | `/api/tables/{table_id}/sessions/{session_id}/resume` | admin | æ–™é‡‘èª²é‡‘å†é–‹ |
| POST | `/api/checkout/{session}` | cast/admin | `fn_calc_total_charge` â†’ `/sales` |
| POST | `/api/smaregi-sync` | admin | ãƒ¡ãƒ‹ãƒ¥ãƒ¼åŒæœŸ |
| PATCH | `/api/stores/settings` | admin | åº—èˆ—è¨­å®šæ›´æ–° |
| GET | `/api/casts` | admin | ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§å–å¾— |
| POST | `/api/casts` | admin | ã‚­ãƒ£ã‚¹ãƒˆè¿½åŠ  |
| GET | `/api/casts/{id}` | admin | ã‚­ãƒ£ã‚¹ãƒˆè©³ç´°å–å¾— |
| PATCH | `/api/casts/{id}` | admin | ã‚­ãƒ£ã‚¹ãƒˆæ›´æ–° |
| DELETE | `/api/casts/{id}` | admin | ã‚­ãƒ£ã‚¹ãƒˆå‰Šé™¤ |
| GET | `/api/menus` | admin | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§å–å¾— |
| POST | `/api/menus` | admin | ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ  |
| GET | `/api/menus/{id}` | admin | ãƒ¡ãƒ‹ãƒ¥ãƒ¼è©³ç´°å–å¾— |
| PATCH | `/api/menus/{id}` | admin | ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–° |
| DELETE | `/api/menus/{id}` | admin | ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‰Šé™¤ |
| GET | `/api/menu-categories` | admin | ã‚«ãƒ†ã‚´ãƒªä¸€è¦§å–å¾— |
| POST | `/api/menu-categories` | admin | ã‚«ãƒ†ã‚´ãƒªè¿½åŠ  |
| PATCH | `/api/menu-categories/{id}` | admin | ã‚«ãƒ†ã‚´ãƒªæ›´æ–° |
| DELETE | `/api/menu-categories/{id}` | admin | ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤ |

---

## 6  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹æˆ

| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | ç›®çš„ | Guard |
| :-- | :-- | :-- |
| **`app/portal/`** | ã‚­ãƒ£ã‚¹ãƒˆãƒ»ç®¡ç†è€… UIï¼ˆè¦èªè¨¼ï¼‰ | `StoreGuard` |
| **`app/menu/`** | æ¥åº—å®¢ QR ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆéèªè¨¼ï¼‰ | ãªã— |
| `app/login/` | åº—èˆ—åˆ¥ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ | ãªã— |
| `components/ui/` | å…±æœ‰ Atomic UI | â€“ |
| `features/` | orders, sessions ãªã©å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯ | â€“ |
| `stores/` | Zustand stores | â€“ |

### ä¸»ãªãƒšãƒ¼ã‚¸

| ãƒ«ãƒ¼ãƒˆ | èª¬æ˜ |
| :-- | :-- |
| `/portal/dashboard` | å…¨å“çŠ¶æ³ï¼‹çµŒéã‚¿ã‚¤ãƒãƒ¼ |
| `/portal/order-board` | Kanban ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç† |
| `/portal/proxy-order` | ä»£ç†æ³¨æ–‡æ©Ÿèƒ½ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºãƒ»æ³¨æ–‡ï¼‰ |
| `/portal/tables` | ãƒ†ãƒ¼ãƒ–ãƒ« CRUD & QR ç™ºè¡Œ |
| `/portal/seat-types` | å¸­ç¨®å˜ä¾¡ç·¨é›† |
| `/portal/casts` | ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰ |
| `/portal/casts/new` | æ–°è¦ã‚­ãƒ£ã‚¹ãƒˆè¿½åŠ  |
| `/portal/casts/[id]/edit` | ã‚­ãƒ£ã‚¹ãƒˆç·¨é›† |
| `/portal/menus` | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ã‚¹ãƒãƒ¬ã‚¸åŒæœŸï¼‰ |
| `/portal/menus/new` | æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ  |
| `/portal/menus/[id]/edit` | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç·¨é›† |
| `/portal/menu-categories` | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªç®¡ç† |
| `/portal/settings` | ã‚¹ãƒãƒ¬ã‚¸é€£æºè¨­å®š |
| `/portal/reports/:period` | å£²ä¸Šãƒ»ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ CSV |
| `/menu/[table_id]` | æ¥åº—å®¢ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‹ã‚«ãƒ¼ãƒˆï¼‹ä¼šè¨ˆ |

### PWA

- `app/menu/layout.tsx` ã§ Workbox SW ç™»éŒ²
- OfflineCache: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ JSONãƒ»ç”»åƒãƒ»CSS ã‚’ precache

---

## 7  Seed ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæŠœç²‹ï¼‰

```ts
const { data: store } = await db
  .from("stores")
  .insert({ store_code: "GB001", name: "GirlsBar One" })
  .select()
  .single();

const { user } = await admin.auth.admin.createUser({
  email: "test@test.com",
  password: "testtest"
});

await db.from("store_users").insert({
  store_id: store.store_id,
  user_id: user.id,
  role: "admin"
});
```

---

## 8  ãƒ†ã‚¹ãƒˆè¨ˆç”»

| ãƒ¬ã‚¤ãƒ¤ | ãƒ„ãƒ¼ãƒ« | ä»£è¡¨ã‚±ãƒ¼ã‚¹ |
| :-- | :-- | :-- |
| Unit | Vitest | `charge.ts` åˆ‡ä¸Šã’å¢ƒç•Œå€¤ |
| API | Supertest | `/api/login` 403 / 200 |
| E2E | Playwright | â‘ æ¥åº—å®¢ `/menu` ã‚ªãƒ•ãƒ©ã‚¤ãƒ³â†’å¾©å¸°é€ä¿¡<br>â‘¡Portal Kanban 2 ãƒ–ãƒ©ã‚¦ã‚¶åŒæœŸ |
| Perf | k6 | 50 VU p95 < 300 ms |
| Sec | OWASP ZAP | è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ Gate |

---

## 9  CI / CD

1. GitHub Actions
   - lint â†’ unit â†’ api â†’ `supabase db push` (stg)
   - `next build` â†’ Vercel deploy
   - Playwright smoke on Preview
2. Nightly k6 + ZAP
3. Instant Rollback (Vercel) + `supabase migration down`

---

## 10  æ€§èƒ½ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŒ‡æ¨™

| é …ç›® | æŒ‡æ¨™ |
| :-- | :-- |
| åŒæ™‚æ¥ç¶š | 50 VU p95 < 300 ms |
| å¯ç”¨æ€§ | å–¶æ¥­æ™‚é–“ 99.9 % |
| Realtime é…å»¶ | â‰¤ 1 s |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° | Supabase Realtime + Broadcast Channel |
| ç›£æŸ»ãƒ­ã‚°ä¿æŒ | 90 æ—¥ |
| XSS/CSRF | RSC è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‹SameSite=Lax Cookie |
</file>

<file path="docs/è¦ä»¶å®šç¾©æ›¸.md">
# QRã‚ªãƒ¼ãƒ€ãƒ¼ & ä¼šè¨ˆé€£æºã‚·ã‚¹ãƒ†ãƒ 
## è¦ä»¶å®šç¾©æ›¸ â€• *v2025-08-02 Rev 7.2*

### 1  ç›®çš„ãƒ»ã‚´ãƒ¼ãƒ«
- å“ä¸Š **QR** ã‹ã‚‰æ¥åº—å®¢ã‚¹ãƒãƒ›ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–²è¦§ãƒ»æ³¨æ–‡
- ä¼šè¨ˆã¯ **ã‚¹ãƒãƒ¬ã‚¸ API** ã¸æ˜ç´°é€ä¿¡
- å®Ÿè£…ã¯ **Next.js 15 (App Routerï¼Server Actions)** å˜ä½“
- ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼ç‰¹æœ‰æ©Ÿèƒ½
  - 30 åˆ†åˆ‡ã‚Šä¸Šã’ãƒãƒ£ãƒ¼ã‚¸
  - ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆã‚­ãƒ£ã‚¹ãƒˆæŒ‡åï¼‰
  - å¸­ç§»å‹•ï¼å¸­ç¨®å¤‰æ›´
- **ç®¡ç†è€…ãƒ»ã‚­ãƒ£ã‚¹ãƒˆã¯åŒä¸€ UI**ã€‚æ©Ÿèƒ½ã¯ DB ä¸Šã®æ¨©é™ã§ ON/OFF
- åº—èˆ—ã”ã¨å®Œå…¨åˆ†é›¢ï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆï¼‰ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸé…å»¶ 1 s ä»¥å†…

---

### 2  ã‚¢ã‚¯ã‚¿ãƒ¼ & ãƒ­ãƒ¼ãƒ«

| ãƒ­ãƒ¼ãƒ« | èªè¨¼æ–¹æ³• | ä¸»ãªæ¨©é™ |
| :-- | :-- | :-- |
| æ¥åº—å®¢ | â€• | ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–²è¦§ï¼æ³¨æ–‡ï¼å–æ¶ˆï¼ä¼šè¨ˆ |
| ã‚­ãƒ£ã‚¹ãƒˆ | ãƒ¡ãƒ¼ãƒ« + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | è‡ªåº—èˆ—å“ä¸€è¦§ãƒ»ä»£ç†æ³¨æ–‡ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ»ä¼šè¨ˆ |
| ç®¡ç†è€… | ãƒ¡ãƒ¼ãƒ« + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | å…¨å“æ“ä½œãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«/ãƒ¡ãƒ‹ãƒ¥ãƒ¼/ãƒ¦ãƒ¼ã‚¶ç®¡ç†ãƒ»ãƒãƒ£ãƒ¼ã‚¸åˆ‡æ›¿ãƒ»å£²ä¸Šé–²è¦§ |
| ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…(root) | ãƒ¡ãƒ¼ãƒ« + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | è¤‡æ•°åº—èˆ—é‹ç”¨ãƒ»ãƒã‚¹ã‚¿ç®¡ç† |

- **ãƒ­ã‚°ã‚¤ãƒ³ URL**ï¼š`/login/{store_code}`ï¼ˆãƒ‘ã‚¹å¿…é ˆï¼‰
- ç”»é¢å†’é ­ã«åº—èˆ—åã‚’è¡¨ç¤ºã—èª¤æ¥ç¶šã‚’é˜²æ­¢
- ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã€`store_users(user_id, store_id)` ã«è©²å½“è¡ŒãŒç„¡ã‘ã‚Œã° **403 Forbidden**

---

### 3  æ©Ÿèƒ½è¦ä»¶

#### 3.1 å…±é€š UI / UX
| ID | å†…å®¹ |
| :- | :- |
| **FR-A01** | ã‚·ãƒ³ã‚°ãƒ« UI + æ¨©é™åˆ¶å¾¡ï¼ˆ`AuthGuard<requiredRole>`ï¼‰ |
| **FR-A02** | `/login/{store_code}` ã§åº—èˆ—åã‚’ SSR è¡¨ç¤º |
| **FR-A03** | èªè¨¼ã¯ãƒ¡ãƒ¼ãƒ« + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã¿ï¼ˆJWT ã¯æ¨™æº– claim ã®ã¿ï¼‰ |
| **FR-A04** | æ‰€å±åº—èˆ—ã«ä¸€è‡´ã—ãªã„ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã¯ 403 |

#### 3.2 ãƒ¡ãƒ‹ãƒ¥ãƒ¼ & æ³¨æ–‡
| ID | å†…å®¹ | å‚™è€ƒ |
| :- | :- | :- |
| **FR-M01** | ã‚¹ãƒãƒ¬ã‚¸ â†’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼åŒæœŸãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ï¼‰ | Cron ãªã—ãƒ»å³æ™‚åæ˜  |
| **FR-M02** | **ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªã®ç®¡ç†æ©Ÿèƒ½** | ã‚«ãƒ†ã‚´ãƒªã®CRUDãƒ»è¡¨ç¤ºé †ç®¡ç† |
| **FR-O01** | ã‚­ãƒ£ã‚¹ãƒˆï¼ç®¡ç†è€…ã¯ **æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãƒ»é–²è¦§** | Kanban DnDã€é…å»¶ < 1 s |
| **FR-O02** | ã‚­ãƒ£ã‚¹ãƒˆï¼ç®¡ç†è€…ã¯ **ä»£ç†æ³¨æ–‡æ©Ÿèƒ½ã§æ¥åº—å®¢ã®ä»£ã‚ã‚Šã«æ³¨æ–‡å¯èƒ½** | ä»£ç†æ³¨æ–‡ã¯ãƒ•ãƒ©ã‚°ä»˜ãã§è¡¨ç¤º |

#### 3.3 ãƒ†ãƒ¼ãƒ–ãƒ« & QR
| ID | å†…å®¹ |
| :- | :- |
| **FR-T01** | ãƒ†ãƒ¼ãƒ–ãƒ« CRUD + **QR è‡ªå‹•ç”Ÿæˆ** (`/menu/{table_id}`) |
| **FR-T02** | å¸­ç§»å‹•å±¥æ­´ä¿æŒãƒ»ãƒãƒ£ãƒ¼ã‚¸åˆ‡æ›¿ãƒˆã‚°ãƒ« |
| **FR-T03** | **å¸­ç¨®å˜ä¾¡ (`price_per_unit`) ã¯ç®¡ç†è€…ãŒ UI ã‹ã‚‰éšæ™‚å¤‰æ›´** |
| **FR-T04** | å¸­ç¨®å¤‰æ›´ãŒè¡Œã‚ã‚ŒãŸå ´åˆã€<br>**å¤‰æ›´å‰ã®æ³¨æ–‡ãƒ»ãƒãƒ£ãƒ¼ã‚¸é¡ï¼ˆæ—§å˜ä¾¡ï¼‰ã¨<br>å¤‰æ›´å¾Œã®æ³¨æ–‡ãƒ»ãƒãƒ£ãƒ¼ã‚¸é¡ï¼ˆæ–°å˜ä¾¡ï¼‰ã‚’åˆç®—**ã—ã¦ä¼šè¨ˆ |

#### 3.4 åº—èˆ—è¨­å®š
| ID | å†…å®¹ |
| :- | :- |
| **FR-S01** | **åº—èˆ—ã”ã¨ã«ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’è¨­å®šå¯èƒ½** |
| **FR-S02** | **åº—èˆ—ã”ã¨ã«ã‚¹ãƒãƒ¬ã‚¸é€£æºæ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’è¨­å®šå¯èƒ½** |
| **FR-S03** | **ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ãªå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šå¯èƒ½** |
| **FR-S04** | **è¨­å®šå¤‰æ›´ã¯ç®¡ç†è€…ã®ã¿å¯èƒ½** |

#### 3.5 ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†
| ID | å†…å®¹ |
| :- | :- |
| **FR-C01** | **ã‚­ãƒ£ã‚¹ãƒˆã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒå¯èƒ½** |
| **FR-C02** | **ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿åˆ©ç”¨å¯èƒ½** |
| **FR-C03** | **ç®¡ç†è€…ã®ã¿ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½** |

#### 3.6 ãƒãƒ£ãƒ¼ã‚¸
| ID | å†…å®¹ |
| :- | :- |
| **FR-CH01** | ä¼šè¨ˆç¢ºå®šæ™‚ `(now â€“ charge_started_at)` ã‚’ 30 åˆ†å˜ä½ã¸ä¸¸ã‚èª²é‡‘ï¼ˆCron ç„¡ï¼‰<br>åŒºé–“ã”ã¨ã« `session_seat_events` ã® **å˜ä¾¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ**ã‚’ä½¿ç”¨ã—åˆç®— |

#### 3.7 ã‚»ãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º
| ID | å†…å®¹ |
| :- | :- |
| **FR-T01** | ç®¡ç†è€…ãƒ»ã‚­ãƒ£ã‚¹ãƒˆã¯ **å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç€å¸­çµŒéæ™‚é–“** ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¢ºèª |
| **FR-T02** | **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€æ³¨æ–‡ãƒœãƒ¼ãƒ‰ã€ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ç”»é¢ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«æ›´æ–°** |

---

### 4  éæ©Ÿèƒ½è¦ä»¶

| åŒºåˆ† | è¦ä»¶ |
| :-- | :-- |
| ãƒ‡ãƒ—ãƒ­ã‚¤ | Vercel (Edge Runtime)ã€å˜ä¸€ `package.json` |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  | Supabase Realtime & Broadcastï¼šé…å»¶ â‰¤ 1 s |
| PWA | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–²è¦§ãƒ»å†æ¥ç¶šæ™‚è‡ªå‹•é€ä¿¡ |
| ã‚·ãƒ¼ãƒ‰ | `scripts/seed.ts`ï¼šåº—èˆ— â€œGB001â€ ã¨ç®¡ç†è€… `test@test.com / testtest` |
| ç›£æŸ»ãƒ­ã‚° | æ³¨æ–‡ï¼å–æ¶ˆï¼ä¼šè¨ˆï¼å¸­ç§»å‹• 90 æ—¥ä¿æŒ |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | Supabase RLS + JWT(æ¨™æº–)ãƒ»OWASP Top 10 å¯¾ç­– |

---

### 5  ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ¦‚è¦ï¼ˆä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

```mermaid
erDiagram
    stores {
        uuid store_id PK
        string store_code UNIQUE
        string name
        boolean enable_cast_management
        boolean enable_smaregi_integration
        string smaregi_client_id
        string smaregi_client_secret
        string smaregi_contract_id
    }
    users {
        uuid user_id PK
        string email UNIQUE
        string password_hash
    }
    store_users {
        uuid id PK
        uuid store_id FK
        uuid user_id FK
        string role "admin|cast"
        string display_name
    }
    menu_categories {
        uuid category_id PK
        uuid store_id FK
        string name
        int display_order
    }
    seat_types {
        int seat_type_id PK
        uuid store_id FK
        string code
        string display_name
        int price_per_unit
    }
    tables {
        uuid table_id PK
        uuid store_id FK
        string name
        int seat_type_id FK
    }
    sessions {
        uuid session_id PK
        uuid store_id FK
        uuid table_id FK
        timestamptz start_at
        timestamptz charge_started_at
    }
    session_seat_events {
        uuid event_id PK
        uuid session_id FK
        int seat_type_id FK
        int price_snapshot
        timestamptz changed_at
    }
    orders {
        uuid order_id PK
        uuid store_id FK
        uuid session_id FK
        string status
        string created_by_role
        bool proxy
    }
```

- **æ¨©é™ç®¡ç†ã¯ã™ã¹ã¦ `store_users` çµŒç”±**
- å„æ¥­å‹™ãƒ†ãƒ¼ãƒ–ãƒ«ã« `store_id` ã‚’ä¿æŒã—ã€RLS ã§
  `store_id âˆˆ (SELECT store_id FROM store_users WHERE user_id = auth.uid())`

---

### 6  ç”»é¢ä¸€è¦§

| ç”»é¢ | æ¥åº—å®¢ | ã‚­ãƒ£ã‚¹ãƒˆ | ç®¡ç†è€… | ä¸»ãªæ©Ÿèƒ½ |
| :-- | :--: | :--: | :--: | :-- |
| QRãƒ¡ãƒ‹ãƒ¥ãƒ¼ | âœ… | â€“ | â€“ | ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–²è¦§ï¼æ³¨æ–‡ï¼ä¼šè¨ˆ |
| æ³¨æ–‡ãƒœãƒ¼ãƒ‰ (Kanban) | â€“ | âœ… | âœ… | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ DnDï¼ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ |
| ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | â€“ | â–³ | âœ… | å…¨å“ï¼‹çµŒéã‚¿ã‚¤ãƒãƒ¼ï¼‹ãƒãƒ£ãƒ¼ã‚¸åˆ‡æ›¿ |
| ä»£ç†æ³¨æ–‡ | â€“ | âœ… | âœ… | ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠï¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºï¼ä»£ç†æ³¨æ–‡ |
| ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š & QR | â€“ | â€“ | âœ… | ãƒ†ãƒ¼ãƒ–ãƒ« CRUD + QR ç”Ÿæˆ |
| å¸­ç¨®è¨­å®š | â€“ | â€“ | âœ… | å˜ä¾¡ç·¨é›† |
| ã‚­ãƒ£ã‚¹ãƒˆç®¡ç† | â€“ | â€“ | âœ… | ã‚­ãƒ£ã‚¹ãƒˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ |
| ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç† | â€“ | â€“ | âœ… | ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ã‚¹ãƒãƒ¬ã‚¸åŒæœŸ |
| ã‚«ãƒ†ã‚´ãƒªç®¡ç† | â€“ | â€“ | âœ… | ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»è¡¨ç¤ºé †å¤‰æ›´ |
| ã‚¹ãƒãƒ¬ã‚¸é€£æºè¨­å®š | â€“ | â€“ | âœ… | ã‚¹ãƒãƒ¬ã‚¸é€£æºã®æœ‰åŠ¹/ç„¡åŠ¹è¨­å®š |
| ãƒ¬ãƒãƒ¼ãƒˆ | â€“ | â€“ | âœ… | å£²ä¸Šãƒ»ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯é›†è¨ˆ |

ï¼ˆâ–³ = èª­ã¿å–ã‚Šã®ã¿ï¼‰

---

### 7  å¤–éƒ¨é€£æºï¼ˆã‚¹ãƒãƒ¬ã‚¸ï¼‰

| é …ç›® | ä»•æ§˜ |
| :-- | :-- |
| èªè¨¼ | OAuth 2.0 |
| ãƒ¡ãƒ‹ãƒ¥ãƒ¼åŒæœŸ | `GET /products` â†’ `menus` ä¸Šæ›¸ã |
| ä¼šè¨ˆé€£æº | `POST /sales` (æ˜ç´° + ãƒãƒ£ãƒ¼ã‚¸) |
| ãƒªãƒˆãƒ©ã‚¤ | 3 å›å¤±æ•—ã§ UI ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤º |

---

### 8  å°†æ¥æ‹¡å¼µ
- ã‚­ãƒ£ã‚¹ãƒˆå‡ºé€€å‹¤é€£æº
- LINE é€šçŸ¥ï¼å¨æˆ¿ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤
- å‰²å¼•ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æ–™ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ±ºæ¸ˆã‚­ãƒ¥ãƒ¼

---

### 9  ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼ˆ1 åº—èˆ—ï¼‰

| Phase | æˆæœç‰© | æœŸé–“ (M) |
| :-- | :-- | :-- |
| è¦ä»¶ç¢ºå®š | æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | 0.5 |
| åŸºç›¤ | Next.js + Auth + RLS + Seed | 1.0 |
| ã‚³ã‚¢æ©Ÿèƒ½ | æ³¨æ–‡ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒ»ä¼šè¨ˆ | 1.5 |
| ç®¡ç†ï¼‹QR | ãƒ†ãƒ¼ãƒ–ãƒ« CRUD + QR + ãƒ¡ãƒ‹ãƒ¥ãƒ¼åŒæœŸ | 1.0 |
| ãƒ†ã‚¹ãƒˆ & å°å…¥ | Playwright E2E + UAT | 0.5 |

---

### 10  ã‚µãƒ³ãƒ—ãƒ« `.env.example`

```dotenv
NEXT_PUBLIC_SUPABASE_URL=https://xyz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=public-anon
SUPABASE_SERVICE_ROLE_KEY=service-role
NEXTAUTH_URL=https://app.example.com
NEXTAUTH_SECRET=changeme
SMARTREGISTER_CLIENT_ID=...
SMARTREGISTER_CLIENT_SECRET=...
PUBLIC_URL=https://app.example.com
```

---
</file>

<file path="supabase/migrations/20250815000000_add_smaregi_product_id_to_seat_types.sql">
-- seat_typesãƒ†ãƒ¼ãƒ–ãƒ«ã«smaregi_product_idã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.seat_types
ADD COLUMN smaregi_product_id TEXT;

-- æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¯NULLã‚’è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰

-- RLSãƒãƒªã‚·ãƒ¼ã®æ›´æ–°
CREATE POLICY "ç®¡ç†è€…ã®ã¿smaregi_product_idã‚’æ›´æ–°å¯èƒ½" ON public.seat_types
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM public.store_users
      WHERE user_id = auth.uid()
      AND store_id = seat_types.store_id
      AND role = 'admin'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.store_users
      WHERE user_id = auth.uid()
      AND store_id = seat_types.store_id
      AND role = 'admin'
    )
  );
</file>

<file path="supabase/migrations/20250816000000_add_tax_rate_to_stores.sql">
-- stores ãƒ†ãƒ¼ãƒ–ãƒ«ã« tax_rate ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.stores
ADD COLUMN tax_rate NUMERIC(5, 2) DEFAULT 10.0 NOT NULL;

-- æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¯ 10.0% ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦è¨­å®š

-- RLSãƒãƒªã‚·ãƒ¼ã®æ›´æ–°
CREATE POLICY "ç®¡ç†è€…ã®ã¿tax_rateã‚’æ›´æ–°å¯èƒ½" ON public.stores
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM public.store_users
      WHERE user_id = auth.uid()
      AND store_id = stores.store_id
      AND role = 'admin'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.store_users
      WHERE user_id = auth.uid()
      AND store_id = stores.store_id
      AND role = 'admin'
    )
  );
</file>

<file path="__tests__/api/menu-categories/delete.test.ts">
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient, createServerComponentClient } from '@/lib/supabase';
import { getUserRoleInStore } from '@/lib/auth';
import { DELETE } from '@/app/api/menu-categories/[category_id]/route';

// ãƒ¢ãƒƒã‚¯
vi.mock('next/headers', () => ({
  cookies: vi.fn(),
}));

vi.mock('@/lib/supabase', () => ({
  createServerSupabaseClient: vi.fn(),
  createServerComponentClient: vi.fn(),
}));

vi.mock('@/lib/auth', () => ({
  getUserRoleInStore: vi.fn(),
}));

describe('ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤API', () => {
  const mockCookieStore = {
    get: vi.fn(),
  };

  const mockSupabase = {
    from: vi.fn().mockReturnThis(),
    select: vi.fn().mockReturnThis(),
    eq: vi.fn().mockReturnThis(),
    gt: vi.fn().mockReturnThis(),
    delete: vi.fn().mockReturnThis(),
    update: vi.fn().mockReturnThis(),
    single: vi.fn(),
  };

  const mockAuthClient = {
    auth: {
      getUser: vi.fn(),
    },
  };

  beforeEach(() => {
    vi.clearAllMocks();
    
    // cookiesã®ãƒ¢ãƒƒã‚¯
    (cookies as any).mockReturnValue(mockCookieStore);
    mockCookieStore.get.mockReturnValue({ value: 'store-123' });
    
    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ¢ãƒƒã‚¯
    (createServerSupabaseClient as any).mockResolvedValue(mockSupabase);
    (createServerComponentClient as any).mockResolvedValue(mockAuthClient);
    
    // èªè¨¼æƒ…å ±ã®ãƒ¢ãƒƒã‚¯
    mockAuthClient.auth.getUser.mockResolvedValue({
      data: { user: { id: 'user-123' } },
    });
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ã®ãƒ¢ãƒƒã‚¯
    (getUserRoleInStore as any).mockResolvedValue('admin');
  });

  afterEach(() => {
    vi.resetAllMocks();
  });

  it('ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã€è¡¨ç¤ºé †ã‚’æ›´æ–°ã™ã‚‹', async () => {
    // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã®ãƒ¢ãƒƒã‚¯
    mockSupabase.single.mockResolvedValueOnce({
      data: {
        category_id: 'category-123',
        store_id: 'store-123',
        name: 'ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª',
        display_order: 2,
      },
    });
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°ã®ãƒ¢ãƒƒã‚¯ï¼ˆ0ä»¶ï¼‰
    mockSupabase.select.mockReturnValueOnce({
      count: 0,
      error: null,
    });
    
    // å‰Šé™¤ã®ãƒ¢ãƒƒã‚¯
    mockSupabase.delete.mockReturnValueOnce({
      error: null,
    });
    
    // è¡¨ç¤ºé †æ›´æ–°ã®ãƒ¢ãƒƒã‚¯
    mockSupabase.update.mockReturnValueOnce({
      error: null,
    });

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆ
    const request = new NextRequest('http://localhost/api/menu-categories/category-123', {
      method: 'DELETE',
    });
    
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä½œæˆ
    const params = Promise.resolve({ category_id: 'category-123' });
    
    // APIã®å®Ÿè¡Œ
    const response = await DELETE(request, { params });
    const responseData = await response.json();
    
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
    expect(response.status).toBe(200);
    expect(responseData).toEqual({ success: true });
    
    // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã®å–å¾—ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    expect(mockSupabase.from).toHaveBeenCalledWith('menu_categories');
    expect(mockSupabase.select).toHaveBeenCalledWith('*');
    expect(mockSupabase.eq).toHaveBeenCalledWith('category_id', 'category-123');
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°ã®ç¢ºèªãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    expect(mockSupabase.from).toHaveBeenCalledWith('menus');
    
    // ã‚«ãƒ†ã‚´ãƒªã®å‰Šé™¤ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    expect(mockSupabase.from).toHaveBeenCalledWith('menu_categories');
    expect(mockSupabase.delete).toHaveBeenCalled();
    expect(mockSupabase.eq).toHaveBeenCalledWith('category_id', 'category-123');
    
    // è¡¨ç¤ºé †ã®æ›´æ–°ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    expect(mockSupabase.from).toHaveBeenCalledWith('menu_categories');
    expect(mockSupabase.update).toHaveBeenCalled();
    expect(mockSupabase.eq).toHaveBeenCalledWith('store_id', 'store-123');
    expect(mockSupabase.gt).toHaveBeenCalledWith('display_order', 2);
  });

  it('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã§ããªã„', async () => {
    // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã®ãƒ¢ãƒƒã‚¯
    mockSupabase.single.mockResolvedValueOnce({
      data: {
        category_id: 'category-123',
        store_id: 'store-123',
        name: 'ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª',
        display_order: 2,
      },
    });
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°ã®ãƒ¢ãƒƒã‚¯ï¼ˆ1ä»¶ä»¥ä¸Šï¼‰
    mockSupabase.select.mockReturnValueOnce({
      count: 1,
      error: null,
    });

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆ
    const request = new NextRequest('http://localhost/api/menu-categories/category-123', {
      method: 'DELETE',
    });
    
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä½œæˆ
    const params = Promise.resolve({ category_id: 'category-123' });
    
    // APIã®å®Ÿè¡Œ
    const response = await DELETE(request, { params });
    const responseData = await response.json();
    
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
    expect(response.status).toBe(400);
    expect(responseData).toEqual({ error: 'ã“ã®ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“' });
    
    // å‰Šé™¤ãŒå‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
    expect(mockSupabase.delete).not.toHaveBeenCalled();
    
    // è¡¨ç¤ºé †ã®æ›´æ–°ãŒå‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
    expect(mockSupabase.update).not.toHaveBeenCalled();
  });
});
</file>

<file path=".augment-guidelines">
# .cursorrules â”€ QRã‚ªãƒ¼ãƒ€ãƒ¼ & ä¼šè¨ˆé€£æºã‚·ã‚¹ãƒ†ãƒ 

## 01 â€“ Authoritative Sources
- **Always cite the _latest_ Supabase docs registered in Cursor as â€œSupabaseâ€ and the newest official Next-js docs stored in Cursor.**  
- If an API isnâ€™t covered, file a â€œdoc-updateâ€ task instead of guessing.

## 02 â€“ Supabase Access
- **All Supabase calls must flow through backend Route Handlers or Server Actions.** Front-end direct calls are forbidden; flag a PR if detected.

## 03 â€“ Learning from Feedback
- Any reviewer comment that begins with `RULE:` becomes a new rule appended to this file automatically.

## 04 â€“ Component Factorisation
- Extract shared UI/logic into `/components/ui/**` or `/features/**` per Atomic + Feature-Slice.

## 05 â€“ Design Patterns
- Follow the Presentation â†’ State â†’ Domain â†’ Data â†’ Infrastructure layering.  
- Warn if a new PR skips layers.

## 06 â€“ Document & Progress Sync
- Changes that alter behaviour/public contracts **must update è¦ä»¶å®šç¾©æ›¸ & è©³ç´°è¨­è¨ˆæ›¸** in the same PR.  
- New features not in the docs require prior reviewer approval.  
- Update the **é€²æ—ç®¡ç†è¡¨** check-list whenever a task completes.

## 07 â€“ Test-First
- Every production file added/changed must ship with matching tests; block PRs that lower coverage.

## 08 â€“ Windows CLI Compatibility  â† NEW
- **All code snippets and setup commands must run on Windows (CMD or PowerShell).**  
  - Use `copy` or `xcopy` instead of `cp` :contentReference[oaicite:0]{index=0}.  
  - Use `Remove-Item` instead of `rm` :contentReference[oaicite:1]{index=1}.  
  - Show `npm install` and `node app.js` exactly as they appear in Windows docs :contentReference[oaicite:2]{index=2}.  
  - Installation/setup links should reference official Windows guides (Git for Windows, Node installer, etc.) :contentReference[oaicite:3]{index=3}.  
- If a cross-platform shell command _must_ be included, also supply the Windows variant or a PowerShell one-liner.

## 09 â€“ Lint & Style
- Enforce ESLint, Prettier; CI fails on violations.

## 10 â€“ Communication
- If unclear or conflicting, ask for clarification instead of assuming.

## 11 - Chat
- Always output in japanese.
</file>

<file path=".cursorrules">
# .cursorrules â”€ QRã‚ªãƒ¼ãƒ€ãƒ¼ & ä¼šè¨ˆé€£æºã‚·ã‚¹ãƒ†ãƒ 

## 01 â€“ Authoritative Sources
- **Always cite the _latest_ Supabase docs registered in Cursor as â€œSupabaseâ€ and the newest official Next-js docs stored in Cursor.**  
- If an API isnâ€™t covered, file a â€œdoc-updateâ€ task instead of guessing.

## 02 â€“ Supabase Access
- **All Supabase calls must flow through backend Route Handlers or Server Actions.** Front-end direct calls are forbidden; flag a PR if detected.

## 03 â€“ Learning from Feedback
- Any reviewer comment that begins with `RULE:` becomes a new rule appended to this file automatically.

## 04 â€“ Component Factorisation
- Extract shared UI/logic into `/components/ui/**` or `/features/**` per Atomic + Feature-Slice.

## 05 â€“ Design Patterns
- Follow the Presentation â†’ State â†’ Domain â†’ Data â†’ Infrastructure layering.  
- Warn if a new PR skips layers.

## 06 â€“ Document & Progress Sync
- Changes that alter behaviour/public contracts **must update è¦ä»¶å®šç¾©æ›¸ & è©³ç´°è¨­è¨ˆæ›¸** in the same PR.  
- New features not in the docs require prior reviewer approval.  
- Update the **é€²æ—ç®¡ç†è¡¨** check-list whenever a task completes.

## 07 â€“ Test-First
- Every production file added/changed must ship with matching tests; block PRs that lower coverage.

## 08 â€“ Windows CLI Compatibility  â† NEW
- **All code snippets and setup commands must run on Windows (CMD or PowerShell).**  
  - Use `copy` or `xcopy` instead of `cp` :contentReference[oaicite:0]{index=0}.  
  - Use `Remove-Item` instead of `rm` :contentReference[oaicite:1]{index=1}.  
  - Show `npm install` and `node app.js` exactly as they appear in Windows docs :contentReference[oaicite:2]{index=2}.  
  - Installation/setup links should reference official Windows guides (Git for Windows, Node installer, etc.) :contentReference[oaicite:3]{index=3}.  
- If a cross-platform shell command _must_ be included, also supply the Windows variant or a PowerShell one-liner.

## 09 â€“ Lint & Style
- Enforce ESLint, Prettier; CI fails on violations.

## 10 â€“ Communication
- If unclear or conflicting, ask for clarification instead of assuming.
</file>

<file path=".env.example">
NEXT_PUBLIC_SUPABASE_URL=https://xyz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=public-anon
SUPABASE_SERVICE_ROLE_KEY=service-role
NEXTAUTH_URL=https://app.example.com
NEXTAUTH_SECRET=changeme
PUBLIC_URL=https://app.example.com
</file>

<file path=".gitignore">
node_modules
.next
.env.local
</file>

<file path="app/api/auth/login/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { cookies } from 'next/headers';

// å…±é€šã®è¨­å®š
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;

export async function POST(request: NextRequest) {
  try {
    const { email, password, storeCode } = await request.json();

    if (!email || !password || !storeCode) {
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€åº—èˆ—ã‚³ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store, error: storeError } = await supabase
      .from('stores')
      .select('store_id, name')
      .eq('store_code', storeCode)
      .single();

    if (storeError || !store) {
      return NextResponse.json(
        { error: 'åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (authError) {
      return NextResponse.json(
        { error: 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„' },
        { status: 401 }
      );
    }

    // Cookieã‚’è¨­å®š
    const cookieStore = await cookies();

    // åº—èˆ—IDã‚’Cookieã«è¨­å®š
    cookieStore.set('store-id', store.store_id, {
      path: '/',
      maxAge: 60 * 60 * 24 * 30, // 30æ—¥é–“
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
    });

    // Supabaseã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®š
    const supabaseAuthCookie = `sb-${SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`;
    cookieStore.set(supabaseAuthCookie, JSON.stringify(authData.session), {
      path: '/',
      maxAge: 60 * 60 * 24 * 7, // 1é€±é–“
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
    });

    const allCookies = cookieStore.getAll();

    return NextResponse.json({
      success: true,
      store: {
        id: store.store_id,
        name: store.name,
      },
    });
  } catch (error) {
    console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/auth/user/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerComponentClient } from '@/lib/supabase';
import { getUserRoleInStore } from '@/lib/auth';
import { cookies } from 'next/headers';

export async function GET(request: NextRequest) {
  try {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Cookieã‚’å–å¾—
    const requestCookies = request.headers.get('cookie');


    // Cookieã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚‚å–å¾—ï¼ˆæ¯”è¼ƒç”¨ï¼‰
    const cookieStore = await cookies();
    const storeIdFromStore = cookieStore.get('store-id')?.value;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰store-idã‚’æŠ½å‡º
    const storeIdMatch = requestCookies?.match(/store-id=([^;]+)/);
    const storeIdFromHeader = storeIdMatch ? storeIdMatch[1] : null;



    // å„ªå…ˆé †ä½: ãƒ˜ãƒƒãƒ€ãƒ¼ > Cookieã‚¹ãƒˆã‚¢
    const storeId = storeIdFromHeader || storeIdFromStore;

    if (!storeId) {
      console.error('GET /api/auth/user: åº—èˆ—IDãŒCookieã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const allCookies = cookieStore.getAll();

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ä½¿ç”¨ã—ã¦Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Supabaseèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º
    const authTokenMatch = requestCookies?.match(/sb-[^-]+-auth-token=([^;]+)/);
    const authToken = authTokenMatch ? decodeURIComponent(authTokenMatch[1]) : null;



    if (!authToken) {
      console.error('GET /api/auth/user: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒCookieã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã¿ã‚‹
    try {
      // base64-ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤
      let tokenValue = authToken;
      if (tokenValue.startsWith('base64-')) {
        tokenValue = tokenValue.substring(7); // 'base64-'ã®é•·ã•ã¯7
        // base64ãƒ‡ã‚³ãƒ¼ãƒ‰
        try {
          tokenValue = Buffer.from(tokenValue, 'base64').toString();

        } catch (decodeError) {
          console.error('GET /api/auth/user: base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:', decodeError);
        }
      }

      // JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
      const parsedToken = JSON.parse(tokenValue);

    } catch (e) {
      console.error('GET /api/auth/user: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);

      // ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œã™ã‚‹
    }

    const supabase = await createServerComponentClient();


    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user }, error } = await supabase.auth.getUser();


    if (error) {
      console.error('GET /api/auth/user: èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    if (!user) {
      console.error('GET /api/auth/user: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }



    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
    const userRole = await getUserRoleInStore(user.id, storeId);

    if (!userRole) {
      console.error('GET /api/auth/user: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åº—èˆ—ã®æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“:', { userId: user.id, storeId });
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }



    return NextResponse.json({
      user: {
        id: user.id,
        email: user.email,
        role: userRole
      }
    });
  } catch (error) {
    console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/casts/[id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;
    const url = new URL(request.url);
    const queryStoreId = url.searchParams.get('storeId');

    const cookieStore = await cookies();
    const cookieStoreId = cookieStore.get('store-id')?.value;
    const cookieStoreIdLegacy = cookieStore.get('storeId')?.value;

    // å„ªå…ˆé †ä½: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ > Cookieã‚¹ãƒˆã‚¢
    const storeId = queryStoreId || cookieStoreId || cookieStoreIdLegacy;

    console.log('GET /api/casts/[id]: åº—èˆ—IDæ¯”è¼ƒ:', {
      queryStoreId,
      cookieStoreId,
      cookieStoreIdLegacy,
      finalStoreId: storeId
    });

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
      headers: {
        Cookie: request.headers.get('cookie') || ''
      }
    });

    if (!userResponse.ok) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const { user } = await userResponse.json();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (user.role !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store } = await supabase
      .from('stores')
      .select('enable_cast_management')
      .eq('store_id', storeId)
      .single();

    if (!store || !store.enable_cast_management) {
      return NextResponse.json(
        { error: 'ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™' },
        { status: 403 }
      );
    }

    // ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
    const { data: cast, error } = await supabase
      .from('store_users')
      .select(`
        id,
        role,
        user_id,
        auth.users (
          email
        )
      `)
      .eq('id', id)
      .eq('store_id', storeId)
      .eq('role', 'cast')
      .single();

    if (error) {
      console.error('ã‚­ãƒ£ã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 404 }
      );
    }

    return NextResponse.json(cast);
  } catch (error) {
    console.error('ã‚­ãƒ£ã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;
    const url = new URL(request.url);
    const queryStoreId = url.searchParams.get('storeId');

    const cookieStore = await cookies();
    const cookieStoreId = cookieStore.get('store-id')?.value;
    const cookieStoreIdLegacy = cookieStore.get('storeId')?.value;

    // å„ªå…ˆé †ä½: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ > Cookieã‚¹ãƒˆã‚¢
    const storeId = queryStoreId || cookieStoreId || cookieStoreIdLegacy;

    console.log('PATCH /api/casts/[id]: åº—èˆ—IDæ¯”è¼ƒ:', {
      queryStoreId,
      cookieStoreId,
      cookieStoreIdLegacy,
      finalStoreId: storeId
    });

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
      headers: {
        Cookie: request.headers.get('cookie') || ''
      }
    });

    if (!userResponse.ok) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const { user } = await userResponse.json();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (user.role !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store } = await supabase
      .from('stores')
      .select('enable_cast_management')
      .eq('store_id', storeId)
      .single();

    if (!store || !store.enable_cast_management) {
      return NextResponse.json(
        { error: 'ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™' },
        { status: 403 }
      );
    }

    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.email || !data.display_name) {
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨åå‰ã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    // ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
    const { data: cast, error: castError } = await supabase
      .from('store_users')
      .select('id, user_id')
      .eq('id', id)
      .eq('store_id', storeId)
      .eq('role', 'cast')
      .single();

    if (castError || !cast) {
      return NextResponse.json(
        { error: 'ã‚­ãƒ£ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
    const updateData: any = {
      email: data.email,
      email_confirm: true,
    };

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æ›´æ–°
    if (data.password) {
      updateData.password = data.password;
    }

    const { error: updateError } = await supabase.auth.admin.updateUserById(
      cast.user_id,
      updateData
    );

    if (updateError) {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // è¡¨ç¤ºåã‚’æ›´æ–°
    const { error: displayNameError } = await supabase
      .from('store_users')
      .update({ display_name: data.display_name })
      .eq('id', cast.id);

    if (displayNameError) {
      console.error('è¡¨ç¤ºåæ›´æ–°ã‚¨ãƒ©ãƒ¼:', displayNameError);
      return NextResponse.json(
        { error: 'è¡¨ç¤ºåã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('ã‚­ãƒ£ã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;
    const url = new URL(request.url);
    const queryStoreId = url.searchParams.get('storeId');

    const cookieStore = await cookies();
    const cookieStoreId = cookieStore.get('store-id')?.value;
    const cookieStoreIdLegacy = cookieStore.get('storeId')?.value;

    // å„ªå…ˆé †ä½: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ > Cookieã‚¹ãƒˆã‚¢
    const storeId = queryStoreId || cookieStoreId || cookieStoreIdLegacy;

    console.log('DELETE /api/casts/[id]: åº—èˆ—IDæ¯”è¼ƒ:', {
      queryStoreId,
      cookieStoreId,
      cookieStoreIdLegacy,
      finalStoreId: storeId
    });

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
      headers: {
        Cookie: request.headers.get('cookie') || ''
      }
    });

    if (!userResponse.ok) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const { user } = await userResponse.json();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (user.role !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store } = await supabase
      .from('stores')
      .select('enable_cast_management')
      .eq('store_id', storeId)
      .single();

    if (!store || !store.enable_cast_management) {
      return NextResponse.json(
        { error: 'ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™' },
        { status: 403 }
      );
    }

    // ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
    const { data: cast, error: castError } = await supabase
      .from('store_users')
      .select('user_id')
      .eq('id', id)
      .eq('store_id', storeId)
      .eq('role', 'cast')
      .single();

    if (castError || !cast) {
      return NextResponse.json(
        { error: 'ã‚­ãƒ£ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ä»˜ã‘ã‚’å‰Šé™¤
    const { error: deleteError } = await supabase
      .from('store_users')
      .delete()
      .eq('id', id)
      .eq('store_id', storeId);

    if (deleteError) {
      console.error('åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ä»˜ã‘å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', deleteError);
      return NextResponse.json(
        { error: 'åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ä»˜ã‘ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
    const { error: userDeleteError } = await supabase.auth.admin.deleteUser(
      cast.user_id
    );

    if (userDeleteError) {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', userDeleteError);
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¦ã‚‚ã€é–¢é€£ä»˜ã‘ã¯å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã®ã§æˆåŠŸã¨ã™ã‚‹
      console.warn('ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€é–¢é€£ä»˜ã‘ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
    }

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('ã‚­ãƒ£ã‚¹ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/casts/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient, createServerComponentClient } from '@/lib/supabase';
import { getUserRoleInStore } from '@/lib/auth';

export async function GET(request: NextRequest) {
  try {
    const url = new URL(request.url);
    const queryStoreId = url.searchParams.get('store_id');
    const queryStoreIdNew = url.searchParams.get('storeId');
    const cookieStore = await cookies();
    const cookieStoreId = cookieStore.get('store-id')?.value;
    const cookieStoreIdLegacy = cookieStore.get('storeId')?.value;

    // å„ªå…ˆé †ä½: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ > Cookieã‚¹ãƒˆã‚¢
    const storeId = queryStoreId || queryStoreIdNew || cookieStoreId || cookieStoreIdLegacy;

    console.log('GET /api/casts: åº—èˆ—IDæ¯”è¼ƒ:', {
      queryStoreId,
      queryStoreIdNew,
      cookieStoreId,
      cookieStoreIdLegacy,
      finalStoreId: storeId
    });

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§store_idã¾ãŸã¯storeIdãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
    // ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‹ã‚‰ã®ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§å–å¾—ãŒå¯èƒ½ã«ãªã‚‹
    if (!queryStoreId && !queryStoreIdNew) {
      // èªè¨¼ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
      const authClient = await createServerComponentClient();

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
      const { data: { user } } = await authClient.auth.getUser();

      if (!user) {
        return NextResponse.json(
          { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
          { status: 401 }
        );
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
      const userRole = await getUserRoleInStore(user.id, storeId);

      // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
      if (userRole !== 'admin') {
        return NextResponse.json(
          { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
          { status: 403 }
        );
      }
    }

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store } = await supabase
      .from('stores')
      .select('enable_cast_management')
      .eq('store_id', storeId)
      .single();

    if (!store || !store.enable_cast_management) {
      return NextResponse.json(
        { error: 'ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™' },
        { status: 403 }
      );
    }

    // ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’å–å¾—
    const { data: casts, error } = await supabase
      .from('store_users')
      .select(`
        id,
        role,
        user_id,
        display_name
      `)
      .eq('store_id', storeId)
      .eq('role', 'cast');

    if (error) {
      console.error('ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(casts);
  } catch (error) {
    console.error('ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // èªè¨¼ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
    const authClient = await createServerComponentClient();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user } } = await authClient.auth.getUser();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    if (!user) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
    const userRole = await getUserRoleInStore(user.id, storeId);

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (userRole !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store } = await supabase
      .from('stores')
      .select('enable_cast_management')
      .eq('store_id', storeId)
      .single();

    if (!store || !store.enable_cast_management) {
      return NextResponse.json(
        { error: 'ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™' },
        { status: 403 }
      );
    }

    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.email || !data.password || !data.store_id || !data.display_name) {
      return NextResponse.json(
        { error: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™' },
        { status: 400 }
      );
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const { data: existingUser } = await supabase
      .from('auth.users')
      .select('id')
      .eq('email', data.email)
      .maybeSingle();

    if (existingUser) {
      return NextResponse.json(
        { error: 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™' },
        { status: 409 }
      );
    }

    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
    const { data: newUser, error: userError } = await supabase.auth.admin.createUser({
      email: data.email,
      password: data.password,
      email_confirm: true,
    });

    if (userError) {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', userError);
      return NextResponse.json(
        { error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ä»˜ã‘ã‚’ä½œæˆ
    const { data: storeUser, error: storeUserError } = await supabase
      .from('store_users')
      .insert({
        store_id: data.store_id,
        user_id: newUser.user.id,
        role: 'cast',
        display_name: data.display_name
      })
      .select()
      .single();

    if (storeUserError) {
      console.error('åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ä»˜ã‘ã‚¨ãƒ©ãƒ¼:', storeUserError);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã«æˆåŠŸã—ãŸãŒé–¢é€£ä»˜ã‘ã«å¤±æ•—ã—ãŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
      await supabase.auth.admin.deleteUser(newUser.user.id);

      return NextResponse.json(
        { error: 'åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ä»˜ã‘ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(storeUser, { status: 201 });
  } catch (error) {
    console.error('ã‚­ãƒ£ã‚¹ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/checkout/[session_id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { getSmaregiAccessToken, registerSmaregiTransaction } from '@/lib/smaregi';

export async function POST(
  request: NextRequest,
  { params }: { params: { session_id: string } }
) {
  try {
    const { session_id } = params;
    const data = await request.json();
    const { table_id } = data;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    const { data: session, error: sessionError } = await supabase
      .from('sessions')
      .select(`
        session_id,
        store_id,
        table_id,
        charge_started_at,
        tables (
          table_id,
          seat_type_id,
          seat_types (
            seat_type_id,
            price_per_unit,
            time_unit_minutes
          )
        )
      `)
      .eq('session_id', session_id)
      .single();



    if (sessionError || !session) {
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ³¨æ–‡åˆè¨ˆã‚’è¨ˆç®—
    const { data: orders, error: ordersError } = await supabase
      .from('orders')
      .select(`
        order_id,
        order_items (
          order_item_id,
          price,
          quantity
        )
      `)
      .eq('session_id', session_id)
      .eq('status', 'new')
      .order('created_at', { ascending: true });



    if (ordersError) {
      console.error('æ³¨æ–‡å–å¾—ã‚¨ãƒ©ãƒ¼:', ordersError);
      return NextResponse.json(
        { error: 'æ³¨æ–‡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // æ³¨æ–‡åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
    let orderAmount = 0;
    if (orders && orders.length > 0) {
      for (const order of orders) {
        if (order.order_items && order.order_items.length > 0) {
          for (const item of order.order_items) {
            orderAmount += item.price * item.quantity;
          }
        }
      }
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã‚’è¨ˆç®—ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
    // fn_calc_total_chargeé–¢æ•°ã¯æ—¢ã«is_table_move_charge=trueã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ–™é‡‘ã‚’å«ã‚ã¦è¨ˆç®—ã—ã¦ã„ã‚‹
    const { data: chargeAmount, error: chargeError } = await supabase
      .rpc('fn_calc_total_charge', { p_session_id: session_id });

    if (chargeError) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', chargeError);
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘ã®å†…è¨³ã‚’å–å¾—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
    let moveChargeAmount = 0;
    try {
      // is_table_move_chargeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
      const { data: moveCharges, error: moveChargeError } = await supabase
        .from('session_seat_events')
        .select('price_snapshot')
        .eq('session_id', session_id)
        .eq('is_table_move_charge', true);

      if (!moveChargeError && moveCharges && moveCharges.length > 0) {
        for (const charge of moveCharges) {
          moveChargeAmount += charge.price_snapshot;
        }
      }
    } catch (error) {
      console.error('å¸­ç§»å‹•æ–™é‡‘å–å¾—ä¾‹å¤–:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
    }

    console.log('å¸­ç§»å‹•æ–™é‡‘:', moveChargeAmount);
    console.log('åˆè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘:', chargeAmount);

    // ç¨æŠœãåˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
    const subtotalAmount = orderAmount + (chargeAmount || 0);



    // åº—èˆ—æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¹ãƒãƒ¬ã‚¸é€£æºã®ç¢ºèªã¨ç¨ç‡ï¼‰
    const { data: store, error: storeError } = await supabase
      .from('stores')
      .select('enable_smaregi_integration, smaregi_client_id, smaregi_client_secret, smaregi_contract_id, tax_rate')
      .eq('store_id', session.store_id)
      .single();

    if (storeError) {
      console.error('åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', storeError);
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // åº—èˆ—ã®æ¶ˆè²»ç¨ç‡ã‚’å–å¾—
    const taxRate = store.tax_rate !== undefined ? store.tax_rate : 10.0;
    // æ¶ˆè²»ç¨é¡ã‚’è¨ˆç®—
    const taxAmount = Math.floor(subtotalAmount * (taxRate / 100));
    // ç¨è¾¼ã¿åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
    const totalAmount = subtotalAmount + taxAmount;

    // ä¼šè¨ˆæƒ…å ±ã‚’checkoutsãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
    const { data: checkout, error: checkoutError } = await supabase
      .from('checkouts')
      .insert({
        store_id: session.store_id,
        session_id: session_id,
        total_amount: totalAmount,
        charge_amount: chargeAmount,
        order_amount: orderAmount,
        status: 'pending'
      })
      .select()
      .single();

    if (checkoutError) {
      console.error('ä¼šè¨ˆæƒ…å ±ä¿å­˜ã‚¨ãƒ©ãƒ¼:', checkoutError);
      return NextResponse.json(
        { error: 'ä¼šè¨ˆæƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ãªå ´åˆã€ã‚¹ãƒãƒ¬ã‚¸APIã«ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
    if (store.enable_smaregi_integration) {
      try {
        // ã‚¹ãƒãƒ¬ã‚¸APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const accessToken = await getSmaregiAccessToken(
          store.smaregi_client_id,
          store.smaregi_client_secret,
          store.smaregi_contract_id,
          'pos.transactions:write'
        );

        // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—ï¼ˆã‚¹ãƒãƒ¬ã‚¸APIã®æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«åˆã‚ã›ã‚‹ï¼‰
        const now = new Date();
        // ã‚¹ãƒãƒ¬ã‚¸APIã®æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ISO 8601å½¢å¼ï¼ˆYYYY-MM-DDTHH:mm:ss+XX:XXï¼‰
        // ãƒŸãƒªç§’éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã€ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³éƒ¨åˆ†ã‚’èª¿æ•´
        const isoString = now.toISOString();
        const transactionDateTime = isoString.substring(0, 19) + '+09:00'; // æ—¥æœ¬æ™‚é–“ï¼ˆ+09:00ï¼‰

        // å–å¼•IDã‚’ç”Ÿæˆï¼ˆ10æ–‡å­—ä»¥ä¸‹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
        // ç§’å˜ä½ã®æ™‚é–“ï¼ˆUnixæ™‚é–“ã®ä¸‹4æ¡ï¼‰+ 3æ¡ã®ãƒ©ãƒ³ãƒ€ãƒ æ•°å­—ã§7æ¡ã®ä¸€æ„ãªIDã‚’ç”Ÿæˆ
        const timeComponent = Math.floor(now.getTime() / 1000).toString().slice(-4);
        const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        const terminalTranId = timeComponent + randomNum;

        // æ³¨æ–‡æ˜ç´°ã‚’ä½œæˆ
        const details = [];
        let detailId = 1;

        if (orders && orders.length > 0) {
          for (const order of orders) {
            if (order.order_items && order.order_items.length > 0) {
              for (const item of order.order_items) {
                // å•†å“æƒ…å ±ã‚’å–å¾—
                const { data: menuItem } = await supabase
                  .from('menus')
                  .select('product_id, name')
                  .eq('store_id', session.store_id)
                  .eq('menu_id', item.menu_id)
                  .single();

                const detailIdStr = detailId.toString().padStart(3, '0');

                // ã‚¹ãƒãƒ¬ã‚¸APIã¯productIdãŒæ•´æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹
                // product_idãŒæ•°å€¤ã§ãªã„å ´åˆã¯ã€ä¸€æ„ã®æ•°å€¤IDã‚’ç”Ÿæˆ
                let productId = "1"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                if (menuItem?.product_id) {
                  // product_idãŒæ•°å€¤ã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
                  if (/^\d+$/.test(menuItem.product_id)) {
                    productId = menuItem.product_id;
                  } else {
                    // æ•°å€¤ã§ãªã„å ´åˆã¯ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼IDã®ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰æ•°å€¤ã‚’ç”Ÿæˆ
                    // å˜ç´”ãªæ–¹æ³•ã¨ã—ã¦ã€æ–‡å­—åˆ—ã®å„æ–‡å­—ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’åˆè¨ˆ
                    const hash = Array.from(item.menu_id)
                      .reduce((sum, char) => sum + char.charCodeAt(0), 0) % 9000 + 1000;
                    productId = hash.toString();
                  }
                }

                details.push({
                  transactionDetailId: detailIdStr,
                  parentTransactionDetailId: detailIdStr,
                  transactionDetailDivision: "1", // é€šå¸¸å•†å“
                  productId: productId,
                  productName: menuItem?.name || "å•†å“åä¸æ˜",
                  printReceiptProductName: menuItem?.name || "å•†å“åä¸æ˜",
                  taxDivision: "1", // ç¨æŠœ
                  price: item.price.toString(),
                  salesPrice: item.price.toString(),
                  quantity: item.quantity.toString()
                });

                detailId++;
              }
            }
          }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã‚’è¿½åŠ ï¼ˆã‚µãƒ¼ãƒ“ã‚¹æ–™ã¨ã—ã¦ï¼‰
        if (chargeAmount && chargeAmount > 0) {
          const detailIdStr = detailId.toString().padStart(3, '0');

          // ãƒ†ãƒ¼ãƒ–ãƒ«IDã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ç”¨ã®å•†å“IDã‚’ç”Ÿæˆ
          // ãƒ†ãƒ¼ãƒ–ãƒ«IDã®ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰æ•°å€¤ã‚’ç”Ÿæˆï¼ˆ8000-8999ã®ç¯„å›²ï¼‰
          const tableHash = Array.from(table_id)
            .reduce((sum, char) => sum + char.charCodeAt(0), 0) % 1000 + 8000;

          // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—
          const { data: tableData } = await supabase
            .from('tables')
            .select('name, seat_type_id')
            .eq('table_id', table_id)
            .single();

          const tableName = tableData?.name || 'ãƒ†ãƒ¼ãƒ–ãƒ«';

          // å¸­ç¨®æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¹ãƒãƒ¬ã‚¸å•†å“IDãŒã‚ã‚Œã°ä½¿ç”¨ï¼‰
          let productId = tableHash.toString(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ†ãƒ¼ãƒ–ãƒ«ãƒãƒƒã‚·ãƒ¥
          let productName = `${tableName}æ–™é‡‘`;
          let skipTableCharge = false; // ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‹ã©ã†ã‹

          if (tableData?.seat_type_id) {
            const { data: seatTypeData } = await supabase
              .from('seat_types')
              .select('display_name, smaregi_product_id')
              .eq('seat_type_id', tableData.seat_type_id)
              .single();

            if (seatTypeData?.smaregi_product_id) {
              // å¸­ç¨®è¨­å®šã§é¸æŠã—ãŸå•†å“IDã‚’ãã®ã¾ã¾ä½¿ç”¨
              productId = seatTypeData.smaregi_product_id;
              productName = `${seatTypeData.display_name || tableName}æ–™é‡‘`;
            } else if (seatTypeData?.smaregi_product_id === '') {
              // å¸­ç¨®è¨­å®šã§å•†å“IDãŒç©ºæ–‡å­—åˆ—ã®å ´åˆï¼ˆæ˜ç¤ºçš„ã«é¸æŠè§£é™¤ã•ã‚ŒãŸå ´åˆï¼‰
              // ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
              skipTableCharge = true;
            }
          }

          // å¸­ç¨®è¨­å®šã§å•†å“IDãŒæ˜ç¤ºçš„ã«é¸æŠè§£é™¤ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã‚’è¿½åŠ 
          if (!skipTableCharge) {
            details.push({
              transactionDetailId: detailIdStr,
              parentTransactionDetailId: detailIdStr,
              transactionDetailDivision: "1", // é€šå¸¸å•†å“
              productId: productId,
              productName: productName,
              printReceiptProductName: productName,
              taxDivision: "1", // ç¨æŠœ
              price: chargeAmount.toString(),
              salesPrice: chargeAmount.toString(),
              quantity: "1"
            });
          } else {
            console.log('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã®ã‚¹ãƒãƒ¬ã‚¸é€£æºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼ˆå¸­ç¨®è¨­å®šã§å•†å“IDãŒé¸æŠè§£é™¤ã•ã‚Œã¦ã„ã¾ã™ï¼‰');
          }
        }

        // åº—èˆ—ã®æ¶ˆè²»ç¨ç‡ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯10%ï¼‰
        const smaregiTaxRate = store.tax_rate !== undefined ? store.tax_rate / 100 : 0.1;
        // æ¶ˆè²»ç¨ã‚’è¨ˆç®—
        const smaregiTaxAmount = Math.floor(subtotalAmount * smaregiTaxRate);
        // ç¨è¾¼ã¿åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
        const totalWithTax = subtotalAmount + smaregiTaxAmount;

        // ã‚¹ãƒãƒ¬ã‚¸APIã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const transactionData = {
          transactionHeadDivision: "1", // é€šå¸¸å–å¼•
          cancelDivision: "0", // å–æ¶ˆåŒºåˆ†ï¼šé€šå¸¸
          subtotal: subtotalAmount.toString(),
          taxExclude: smaregiTaxAmount.toString(), // æ¶ˆè²»ç¨
          total: totalWithTax.toString(), // ç¨è¾¼ã¿åˆè¨ˆé‡‘é¡
          storeId: "1", // åº—èˆ—IDï¼ˆã‚¹ãƒãƒ¬ã‚¸å´ã®åº—èˆ—IDï¼‰
          terminalId: "1", // ç«¯æœ«IDï¼ˆã‚¹ãƒãƒ¬ã‚¸å´ã®ç«¯æœ«IDï¼‰
          terminalTranId: terminalTranId,
          terminalTranDateTime: transactionDateTime,
          details: details
        };

        // ã‚¹ãƒãƒ¬ã‚¸APIã«å–å¼•ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        const smaregiResponse = await registerSmaregiTransaction(
          accessToken,
          store.smaregi_contract_id,
          transactionData
        );

        console.log('ã‚¹ãƒãƒ¬ã‚¸å–å¼•ç™»éŒ²ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', smaregiResponse);

        // ä¼šè¨ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å®Œäº†ã«æ›´æ–°ã—ã€ã‚¹ãƒãƒ¬ã‚¸ã®ãƒ¬ã‚·ãƒ¼ãƒˆIDã‚’ä¿å­˜
        const { error: updateError } = await supabase
          .from('checkouts')
          .update({
            status: 'completed',
            smaregi_receipt_id: smaregiResponse.id || terminalTranId
          })
          .eq('checkout_id', checkout.checkout_id);

        if (updateError) {
          console.error('ä¼šè¨ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
          return NextResponse.json(
            { error: 'ä¼šè¨ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
            { status: 500 }
          );
        }
      } catch (error) {
        console.error('ã‚¹ãƒãƒ¬ã‚¸é€£æºã‚¨ãƒ©ãƒ¼:', error);

        // ã‚¹ãƒãƒ¬ã‚¸é€£æºã«å¤±æ•—ã—ã¦ã‚‚ä¼šè¨ˆè‡ªä½“ã¯å®Œäº†ã•ã›ã‚‹
        const { error: updateError } = await supabase
          .from('checkouts')
          .update({
            status: 'completed'
          })
          .eq('checkout_id', checkout.checkout_id);

        if (updateError) {
          console.error('ä¼šè¨ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
          return NextResponse.json(
            { error: 'ä¼šè¨ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
            { status: 500 }
          );
        }
      }
    } else {
      // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒç„¡åŠ¹ã®å ´åˆã¯ã€ãã®ã¾ã¾ä¼šè¨ˆå®Œäº†ã¨ã™ã‚‹
      const { error: updateError } = await supabase
        .from('checkouts')
        .update({
          status: 'completed'
        })
        .eq('checkout_id', checkout.checkout_id);

      if (updateError) {
        console.error('ä¼šè¨ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
        return NextResponse.json(
          { error: 'ä¼šè¨ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
          { status: 500 }
        );
      }
    }

    // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆclosedã«å¤‰æ›´ï¼‰
    if (orders && orders.length > 0) {
      const orderIds = orders.map(order => order.order_id);
      const { error: orderUpdateError } = await supabase
        .from('orders')
        .update({
          status: 'closed'
        })
        .in('order_id', orderIds);

      if (orderUpdateError) {
        console.error('æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', orderUpdateError);
        // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
      }
    }

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    const responseData = {
      checkout_id: checkout.checkout_id,
      total_amount: totalAmount, // ç¨è¾¼ã¿åˆè¨ˆé‡‘é¡
      charge_amount: chargeAmount,
      order_amount: orderAmount,
      tax_amount: taxAmount,
      tax_rate: taxRate,
      subtotal_amount: subtotalAmount, // ç¨æŠœãåˆè¨ˆé‡‘é¡
      status: 'completed'
    };


    return NextResponse.json(responseData);
  } catch (error) {
    console.error('ä¼šè¨ˆAPI: äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', details: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/dashboard/sessions/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { cookies } from 'next/headers';

export async function GET(request: NextRequest) {
  try {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Cookieã‚’å–å¾—
    const requestCookies = request.headers.get('cookie');


    // Cookieã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚‚å–å¾—
    const cookieStore = await cookies();
    const storeIdFromStore = cookieStore.get('store-id')?.value;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰store-idã‚’æŠ½å‡º
    const storeIdMatch = requestCookies?.match(/store-id=([^;]+)/);
    const storeIdFromHeader = storeIdMatch ? storeIdMatch[1] : null;



    // å„ªå…ˆé †ä½: ãƒ˜ãƒƒãƒ€ãƒ¼ > Cookieã‚¹ãƒˆã‚¢
    const storeId = storeIdFromHeader || storeIdFromStore;

    if (!storeId) {
      console.error('GET /api/dashboard/sessions: åº—èˆ—IDãŒCookieã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Supabaseèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º
    const authTokenMatch = requestCookies?.match(/sb-[^-]+-auth-token=([^;]+)/);
    const authToken = authTokenMatch ? decodeURIComponent(authTokenMatch[1]) : null;



    if (!authToken) {
      // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªãã¦ã‚‚ç¶šè¡Œï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
    }

    const supabase = await createServerSupabaseClient();

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
    const { data: sessions, error } = await supabase
      .from('sessions')
      .select(`
        session_id,
        start_at,
        charge_started_at,
        charge_paused_at,
        tables (
          table_id,
          name,
          seat_types (
            seat_type_id,
            display_name,
            price_per_unit,
            time_unit_minutes
          )
        )
      `)
      .eq('store_id', storeId)
      .not('charge_started_at', 'is', null)
      .order('start_at', { ascending: false });

    if (error) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(sessions);
  } catch (error) {
    console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/logout/route.ts">
import { createServerSupabaseClient, createServerComponentClient } from '@/lib/supabase';
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';

// å…±é€šã®è¨­å®š
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;

export async function POST(request: NextRequest) {
  try {
    // Cookieãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const authClient = await createServerComponentClient();

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    await authClient.auth.signOut();

    // Cookieã®å‰Šé™¤
    const cookieStore = await cookies();

    const allCookies = cookieStore.getAll();

    // ã™ã¹ã¦ã®é–¢é€£Cookieã‚’å‰Šé™¤
    const supabaseAuthCookie = `sb-${SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`;
    cookieStore.delete(supabaseAuthCookie);
    cookieStore.delete('store-id');



    // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    return NextResponse.redirect(new URL('/', request.url));

  } catch (error) {
    console.error('Logout error:', error);
    return NextResponse.json(
      { error: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/menu-categories/[category_id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient, createServerComponentClient } from '@/lib/supabase';
import { getUserRoleInStore } from '@/lib/auth';

// ã‚«ãƒ†ã‚´ãƒªå–å¾—API
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ category_id: string }> }
) {
  try {
    const { category_id } = await params;
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
      headers: {
        Cookie: request.headers.get('cookie') || ''
      }
    });

    if (!userResponse.ok) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const { user } = await userResponse.json();

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (user.role !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: category, error } = await supabase
      .from('menu_categories')
      .select('*')
      .eq('category_id', category_id)
      .eq('store_id', storeId)
      .single();

    if (error) {
      console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 404 }
      );
    }

    return NextResponse.json(category);
  } catch (error) {
    console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

// ã‚«ãƒ†ã‚´ãƒªæ›´æ–°API
export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ category_id: string }> }
) {
  try {
    const { category_id } = await params;
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // èªè¨¼ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
    const authClient = await createServerComponentClient();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user } } = await authClient.auth.getUser();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    if (!user) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
    const userRole = await getUserRoleInStore(user.id, storeId);

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (userRole !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã‚’å–å¾—
    const { data: category } = await supabase
      .from('menu_categories')
      .select('*')
      .eq('category_id', category_id)
      .eq('store_id', storeId)
      .single();

    if (!category) {
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.name) {
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªåã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    // ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°
    const { data: updatedCategory, error: updateError } = await supabase
      .from('menu_categories')
      .update({
        name: data.name,
        display_order: data.display_order !== undefined ? data.display_order : category.display_order,
        smaregi_category_id: data.smaregi_category_id !== undefined ? data.smaregi_category_id : category.smaregi_category_id,
        allow_treat_cast: data.allow_treat_cast !== undefined ? data.allow_treat_cast : category.allow_treat_cast
      })
      .eq('category_id', category_id)
      .select()
      .single();

    if (updateError) {
      // ä¸€æ„åˆ¶ç´„é•åã®å ´åˆ
      if (updateError.code === '23505') {
        return NextResponse.json(
          { error: 'åŒã˜åå‰ã®ã‚«ãƒ†ã‚´ãƒªãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™' },
          { status: 400 }
        );
      }

      console.error('ã‚«ãƒ†ã‚´ãƒªæ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(updatedCategory);
  } catch (error) {
    console.error('ã‚«ãƒ†ã‚´ãƒªæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

// ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤API
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ category_id: string }> }
) {
  try {
    const { category_id } = await params;
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // èªè¨¼ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
    const authClient = await createServerComponentClient();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user } } = await authClient.auth.getUser();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    if (!user) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
    const userRole = await getUserRoleInStore(user.id, storeId);

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (userRole !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã‚’å–å¾—
    const { data: category } = await supabase
      .from('menu_categories')
      .select('*')
      .eq('category_id', category_id)
      .eq('store_id', storeId)
      .single();

    if (!category) {
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ã“ã®ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°ã‚’ç¢ºèª
    const { count, error: countError } = await supabase
      .from('menus')
      .select('*', { count: 'exact', head: true })
      .eq('category_id', category_id);

    if (countError) {
      console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', countError);
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ•°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤ä¸å¯
    if (count && count > 0) {
      return NextResponse.json(
        { error: 'ã“ã®ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // å‰Šé™¤å‰ã®å…¨ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    const { data: beforeCategories } = await supabase
      .from('menu_categories')
      .select('category_id, name, display_order')
      .eq('store_id', storeId)
      .order('display_order', { ascending: true });

    console.log('å‰Šé™¤å‰ã®ã‚«ãƒ†ã‚´ãƒªä¸€è¦§:', beforeCategories);

    // å‰Šé™¤ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºé †ã‚’ä¿å­˜
    const deletedCategoryOrder = category.display_order;
    console.log('å‰Šé™¤ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºé †:', deletedCategoryOrder);

    // ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤
    const { error: deleteError } = await supabase
      .from('menu_categories')
      .delete()
      .eq('category_id', category_id);

    if (deleteError) {
      console.error('ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', deleteError);
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    console.log('ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ã‚«ãƒ†ã‚´ãƒªID:', category_id);

    // å…¨ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
    const { data: allCategories, error: fetchError } = await supabase
      .from('menu_categories')
      .select('*')
      .eq('store_id', storeId)
      .order('display_order', { ascending: true });

    if (fetchError) {
      console.error('ã‚«ãƒ†ã‚´ãƒªå–å¾—ã‚¨ãƒ©ãƒ¼:', fetchError);
      // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ã€ã‚«ãƒ†ã‚´ãƒªè‡ªä½“ã¯å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã®ã§æˆåŠŸã¨ã—ã¦è¿”ã™
    } else {
      console.log('å…¨ã‚«ãƒ†ã‚´ãƒª:', allCategories);

      if (allCategories && allCategories.length > 0) {
        console.log('ã‚«ãƒ†ã‚´ãƒªæ•°:', allCategories.length);

        // æ›´æ–°ãŒå¿…è¦ãªã‚«ãƒ†ã‚´ãƒªã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        const categoriesToUpdate = [];

        for (let i = 0; i < allCategories.length; i++) {
          const category = allCategories[i];
          const newOrder = i + 1; // 1ã‹ã‚‰å§‹ã¾ã‚‹é€£ç•ª

          // è¡¨ç¤ºé †ãŒå¤‰ã‚ã‚‹å ´åˆã®ã¿ãƒªã‚¹ãƒˆã«è¿½åŠ 
          if (category.display_order !== newOrder) {
            console.log(`ã‚«ãƒ†ã‚´ãƒª "${category.name}" ã®è¡¨ç¤ºé †ã‚’ ${category.display_order} ã‹ã‚‰ ${newOrder} ã«æ›´æ–°ã—ã¾ã™`);
            categoriesToUpdate.push({
              ...category,
              display_order: newOrder
            });
          }
        }

        // æ›´æ–°ãŒå¿…è¦ãªã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚‹å ´åˆ
        if (categoriesToUpdate.length > 0) {
          console.log('æ›´æ–°ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªæ•°:', categoriesToUpdate.length);

          // ä¸€æ‹¬æ›´æ–°
          for (const category of categoriesToUpdate) {
            const { error: updateError } = await supabase
              .from('menu_categories')
              .update({ display_order: category.display_order })
              .eq('category_id', category.category_id);

            if (updateError) {
              console.error(`ã‚«ãƒ†ã‚´ãƒª "${category.name}" ã®è¡¨ç¤ºé †æ›´æ–°ã‚¨ãƒ©ãƒ¼:`, updateError);
            } else {
              console.log(`ã‚«ãƒ†ã‚´ãƒª "${category.name}" ã®è¡¨ç¤ºé †ã‚’ ${category.display_order} ã«æ›´æ–°ã—ã¾ã—ãŸ`);
            }

            // æ›´æ–°é–“éš”ã‚’ç©ºã‘ã‚‹ï¼ˆç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        } else {
          console.log('æ›´æ–°ãŒå¿…è¦ãªã‚«ãƒ†ã‚´ãƒªã¯ã‚ã‚Šã¾ã›ã‚“');
        }
      } else {
        console.log('ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“');
      }
    }

    // æ›´æ–°å¾Œã®å…¨ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    const { data: afterCategories } = await supabase
      .from('menu_categories')
      .select('category_id, name, display_order')
      .eq('store_id', storeId)
      .order('display_order', { ascending: true });

    console.log('æ›´æ–°å¾Œã®ã‚«ãƒ†ã‚´ãƒªä¸€è¦§:', afterCategories);

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/menus/[id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;

    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
      headers: {
        Cookie: request.headers.get('cookie') || ''
      }
    });

    if (!userResponse.ok) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const { user } = await userResponse.json();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (user.role !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: menu, error } = await supabase
      .from('menus')
      .select('*')
      .eq('menu_id', id)
      .eq('store_id', storeId)
      .single();

    if (error) {
      console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 404 }
      );
    }

    return NextResponse.json(menu);
  } catch (error) {
    console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;

    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
      headers: {
        Cookie: request.headers.get('cookie') || ''
      }
    });

    if (!userResponse.ok) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const { user } = await userResponse.json();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (user.role !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.name || data.price < 0) {
      return NextResponse.json(
        { error: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€ç„¡åŠ¹ãªå€¤ã§ã™' },
        { status: 400 }
      );
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const { data: existingMenu, error: checkError } = await supabase
      .from('menus')
      .select('menu_id')
      .eq('menu_id', id)
      .eq('store_id', storeId)
      .single();

    if (checkError || !existingMenu) {
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’æ›´æ–°
    const { data: updatedMenu, error: updateError } = await supabase
      .from('menus')
      .update({
        name: data.name,
        description: data.description || null,
        price: data.price,
        image_url: data.image_url || null,
        category: data.category || null,
        category_id: data.category_id || null,
        is_available: data.is_available !== false,
      })
      .eq('menu_id', id)
      .eq('store_id', storeId)
      .select()
      .single();

    if (updateError) {
      console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(updatedMenu);
  } catch (error) {
    console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;

    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
      headers: {
        Cookie: request.headers.get('cookie') || ''
      }
    });

    if (!userResponse.ok) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const { user } = await userResponse.json();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (user.role !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const { data: existingMenu, error: checkError } = await supabase
      .from('menus')
      .select('menu_id')
      .eq('menu_id', id)
      .eq('store_id', storeId)
      .single();

    if (checkError || !existingMenu) {
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤
    const { error: deleteError } = await supabase
      .from('menus')
      .delete()
      .eq('menu_id', id)
      .eq('store_id', storeId);

    if (deleteError) {
      console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', deleteError);
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/order-items/[order_item_id]/route.ts">
import { createServerSupabaseClient } from '@/lib/supabase';
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';

// æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã™ã‚‹API
export async function DELETE(
  request: NextRequest,
  context: { params: Promise<{ order_item_id: string }> }
) {
  try {
    const { order_item_id: orderItemId } = await context.params;
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const supabase = await createServerSupabaseClient();

    // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ãŒå­˜åœ¨ã—ã€æ­£ã—ã„åº—èˆ—ã«å±ã—ã¦ã„ã‚‹ã‹ç¢ºèª
    const { data: orderItem, error: orderItemError } = await supabase
      .from('order_items')
      .select(`
        order_item_id,
        orders (
          order_id,
          store_id
        )
      `)
      .eq('order_item_id', orderItemId)
      .single();

    if (orderItemError || !orderItem || !orderItem.orders || orderItem.orders.store_id !== storeId) {
      return NextResponse.json(
        { error: 'æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
    const { error: deleteError } = await supabase
      .from('order_items')
      .delete()
      .eq('order_item_id', orderItemId);

    if (deleteError) {
      return NextResponse.json(
        { error: 'æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // Broadcast Channelã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    await supabase.from('broadcast').insert({
      channel: 'broadcast:orders',
      payload: {
        type: 'order_item:delete',
        order_item_id: orderItemId,
      },
    });

    // æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
    return NextResponse.json({
      success: true,
      order_item_id: orderItemId
    });

  } catch (error) {
    console.error('Order item delete error:', error);
    return NextResponse.json(
      { error: 'æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/order-items/[order_item_id]/status/route.ts">
import { createServerSupabaseClient } from '@/lib/supabase';
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';

// PATCHãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
export async function PATCH(
  request: NextRequest,
  context: { params: Promise<{ order_item_id: string }> }
) {
  try {
    const { order_item_id: orderItemId } = await context.params;
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const formData = await request.formData();
    const status = formData.get('status') as string;

    if (!status) {
      return NextResponse.json(
        { error: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    // æœ‰åŠ¹ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ã‹ãƒã‚§ãƒƒã‚¯
    const validStatuses = ['new', 'ack', 'prep', 'served', 'closed', 'cancel'];
    if (!validStatuses.includes(status)) {
      return NextResponse.json(
        { error: 'ç„¡åŠ¹ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ã§ã™' },
        { status: 400 }
      );
    }

    const supabase = await createServerSupabaseClient();

    // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ãŒå­˜åœ¨ã—ã€æ­£ã—ã„åº—èˆ—ã«å±ã—ã¦ã„ã‚‹ã‹ç¢ºèª
    const { data: orderItem, error: orderItemError } = await supabase
      .from('order_items')
      .select(`
        order_item_id,
        orders (
          order_id,
          store_id
        )
      `)
      .eq('order_item_id', orderItemId)
      .single();

    if (orderItemError || !orderItem || !orderItem.orders || orderItem.orders.store_id !== storeId) {
      return NextResponse.json(
        { error: 'æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    console.log(`æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ  ${orderItemId} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ ${status} ã«æ›´æ–°ã—ã¾ã™`);
    const { error: updateError } = await supabase
      .from('order_items')
      .update({ status })
      .eq('order_item_id', orderItemId);

    if (updateError) {
      console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: `æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${updateError.message}` },
        { status: 500 }
      );
    }

    // Broadcast Channelã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    await supabase.from('broadcast').insert({
      channel: 'broadcast:orders',
      payload: {
        type: 'order_item:update',
        order_item_id: orderItemId,
        status,
      },
    });

    // æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
    return NextResponse.json({
      success: true,
      order_item_id: orderItemId,
      status: status
    });

  } catch (error) {
    console.error('Order item status update error:', error);
    const errorMessage = error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
    const errorStack = error instanceof Error ? error.stack : '';
    console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', errorStack);
    return NextResponse.json(
      { error: `æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${errorMessage}` },
      { status: 500 }
    );
  }
}

// POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚‚åŒã˜å‡¦ç†ã‚’è¡Œã†
export async function POST(
  request: NextRequest,
  context: { params: Promise<{ order_item_id: string }> }
) {
  return PATCH(request, context);
}
</file>

<file path="app/api/orders/[order_id]/items/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { cookies } from 'next/headers';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ order_id: string }> }
) {
  try {
    const { order_id } = await params;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // æ³¨æ–‡ãŒå­˜åœ¨ã—ã€æ­£ã—ã„åº—èˆ—ã«å±ã—ã¦ã„ã‚‹ã‹ç¢ºèª
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .select('order_id, store_id, status, created_at, created_by_role, proxy')
      .eq('order_id', order_id)
      .eq('store_id', storeId)
      .single();

    if (orderError || !order) {
      return NextResponse.json(
        { error: 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
    const { data: orderItems, error: itemsError } = await supabase
      .from('order_items')
      .select(`
        order_item_id,
        product_id,
        product_name,
        quantity,
        price,
        target_cast_id
      `)
      .eq('order_id', order_id);

    if (itemsError) {
      console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:', itemsError);
      return NextResponse.json(
        { error: 'æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ£ã‚¹ãƒˆã®æƒ…å ±ã‚’å–å¾—
    const castIds = orderItems
      .filter(item => item.target_cast_id)
      .map(item => item.target_cast_id);

    // ã‚­ãƒ£ã‚¹ãƒˆIDã¨è¡¨ç¤ºåã®ãƒãƒƒãƒ”ãƒ³ã‚°
    interface CastMap {
      [key: string]: string;
    }

    let casts: CastMap = {};

    if (castIds.length > 0) {
      // é‡è¤‡ã‚’æ’é™¤
      const uniqueCastIds = castIds.filter((id, index) => castIds.indexOf(id) === index);

      // store_usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
      const { data: castData, error: castError } = await supabase
        .from('store_users')
        .select('user_id, display_name')
        .eq('store_id', storeId)
        .eq('role', 'cast')
        .in('user_id', uniqueCastIds);

      if (!castError && castData) {
        casts = castData.reduce((acc: CastMap, cast) => {
          // display_nameãŒnullã®å ´åˆã¯ã€Œã‚­ãƒ£ã‚¹ãƒˆã€ã¨ã„ã†åå‰ã‚’ä½¿ç”¨
          acc[cast.user_id] = cast.display_name || `ã‚­ãƒ£ã‚¹ãƒˆ${cast.user_id.substring(0, 4)}`;
          return acc;
        }, {});
      } else {
        console.error('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', castError);
      }
    }

    // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ•´å½¢
    const formattedItems = orderItems.map(item => {
      return {
        order_item_id: item.order_item_id,
        product_id: item.product_id,
        name: item.product_name,
        quantity: item.quantity,
        price: item.price,
        total: item.price * item.quantity,
        target_cast_id: item.target_cast_id,
        target_cast_name: item.target_cast_id ? casts[item.target_cast_id] || 'ä¸æ˜ãªã‚­ãƒ£ã‚¹ãƒˆ' : null
      };
    });

    // åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
    const totalPrice = formattedItems.reduce((sum, item) => sum + item.total, 0);

    // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—
    const { data: orderWithSession, error: sessionError } = await supabase
      .from('orders')
      .select(`
        sessions (
          session_id,
          tables (
            table_id,
            name
          )
        )
      `)
      .eq('order_id', order_id)
      .single();

    let tableName = null;
    if (!sessionError && orderWithSession && orderWithSession.sessions && orderWithSession.sessions.tables) {
      tableName = orderWithSession.sessions.tables.name;
    }

    return NextResponse.json({
      order: {
        order_id: order.order_id,
        status: order.status,
        created_at: order.created_at,
        created_by_role: order.created_by_role,
        proxy: order.proxy,
        table_name: tableName
      },
      items: formattedItems,
      totalPrice
    });
  } catch (error) {
    console.error('æ³¨æ–‡è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/orders/[order_id]/status/route.ts">
import { createServerSupabaseClient } from '@/lib/supabase';
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';

// PATCHãƒ¡ã‚½ãƒƒãƒ‰ã¨POSTãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆ
export async function PATCH(
  request: NextRequest,
  context: { params: Promise<{ order_id: string }> }
) {
  try {
    const { order_id: orderId } = await context.params;
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const formData = await request.formData();
    const status = formData.get('status') as string;

    if (!status) {
      return NextResponse.json(
        { error: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    // æœ‰åŠ¹ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ã‹ãƒã‚§ãƒƒã‚¯
    const validStatuses = ['new', 'ack', 'prep', 'served', 'closed', 'cancel'];
    if (!validStatuses.includes(status)) {
      return NextResponse.json(
        { error: 'ç„¡åŠ¹ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ã§ã™' },
        { status: 400 }
      );
    }

    const supabase = await createServerSupabaseClient();

    // æ³¨æ–‡ãŒå­˜åœ¨ã—ã€æ­£ã—ã„åº—èˆ—ã«å±ã—ã¦ã„ã‚‹ã‹ç¢ºèª
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .select('order_id, store_id')
      .eq('order_id', orderId)
      .eq('store_id', storeId)
      .single();

    if (orderError || !order) {
      return NextResponse.json(
        { error: 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    const { error: updateError } = await supabase
      .from('orders')
      .update({ status })
      .eq('order_id', orderId);

    if (updateError) {
      return NextResponse.json(
        { error: 'æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // Broadcast Channelã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    await supabase.from('broadcast').insert({
      channel: 'broadcast:orders',
      payload: {
        type: 'order:update',
        order_id: orderId,
        status,
      },
    });

    // æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ã¯ãªãï¼‰
    return NextResponse.json({
      success: true,
      order_id: orderId,
      status: status
    });

  } catch (error) {
    console.error('Order status update error:', error);
    return NextResponse.json(
      { error: 'æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

// POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚‚åŒã˜å‡¦ç†ã‚’è¡Œã†
export async function POST(
  request: NextRequest,
  context: { params: Promise<{ order_id: string }> }
) {
  return PATCH(request, context);
}
</file>

<file path="app/api/orders/active-items/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { cookies } from 'next/headers';

export async function GET(request: NextRequest) {
  try {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Cookieã‚’å–å¾—
    const requestCookies = request.headers.get('cookie');


    // Cookieã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚‚å–å¾—ï¼ˆæ¯”è¼ƒç”¨ï¼‰
    const cookieStore = await cookies();
    const storeIdFromStore = cookieStore.get('store-id')?.value;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰store-idã‚’æŠ½å‡º
    const storeIdMatch = requestCookies?.match(/store-id=([^;]+)/);
    const storeIdFromHeader = storeIdMatch ? storeIdMatch[1] : null;



    // å„ªå…ˆé †ä½: ãƒ˜ãƒƒãƒ€ãƒ¼ > Cookieã‚¹ãƒˆã‚¢
    const storeId = storeIdFromHeader || storeIdFromStore;

    if (!storeId) {
      console.error('GET /api/orders/active-items: åº—èˆ—IDãŒCookieã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const allCookies = cookieStore.getAll();

    const supabase = await createServerSupabaseClient();

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ³¨æ–‡ã‚’å–å¾—
    const { data: orders, error } = await supabase
      .from('orders')
      .select(`
        order_id,
        status,
        created_by_role,
        proxy,
        created_at,
        sessions (
          session_id,
          tables (
            table_id,
            name
          )
        ),
        order_items (
          order_item_id,
          product_id,
          product_name,
          quantity,
          price,
          target_cast_id,
          status
        )
      `)
      .eq('store_id', storeId)
      .not('status', 'eq', 'closed')
      .not('status', 'eq', 'cancel')
      .order('created_at', { ascending: true });

    if (error) {
      console.error('æ³¨æ–‡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'æ³¨æ–‡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ£ã‚¹ãƒˆã®æƒ…å ±ã‚’å–å¾—
    const castIds = orders
      .flatMap(order => order.order_items || [])
      .filter(item => item.target_cast_id)
      .map(item => item.target_cast_id);

    // ã‚­ãƒ£ã‚¹ãƒˆIDã¨è¡¨ç¤ºåã®ãƒãƒƒãƒ”ãƒ³ã‚°
    interface CastMap {
      [key: string]: string;
    }

    let casts: CastMap = {};

    if (castIds.length > 0) {
      // é‡è¤‡ã‚’æ’é™¤
      const uniqueCastIds = castIds.filter((id, index) => castIds.indexOf(id) === index);

      // store_usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
      const { data: castData, error: castError } = await supabase
        .from('store_users')
        .select('user_id, display_name')
        .eq('store_id', storeId)
        .eq('role', 'cast')
        .in('user_id', uniqueCastIds);

      if (!castError && castData) {
        casts = castData.reduce((acc: CastMap, cast) => {
          // display_nameãŒnullã®å ´åˆã¯ã€Œã‚­ãƒ£ã‚¹ãƒˆã€ã¨ã„ã†åå‰ã‚’ä½¿ç”¨
          acc[cast.user_id] = cast.display_name || `ã‚­ãƒ£ã‚¹ãƒˆ${cast.user_id.substring(0, 4)}`;
          return acc;
        }, {});
      } else {
        console.error('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', castError);
      }
    }

    // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’å«ã‚€æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
    const formattedOrderItems = orders.flatMap(order => {
      if (!order.order_items || order.order_items.length === 0) {
        return [];
      }

      // ã™ã¹ã¦ã®æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‡¦ç†
      return order.order_items
        .map(item => {
          return {
            order_id: order.order_id,
            order_item_id: item.order_item_id,
            // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ è‡ªèº«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä½¿ç”¨ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯è¦ªæ³¨æ–‡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨ï¼‰
            status: item.status || order.status,
            created_at: order.created_at,
            created_by_role: order.created_by_role,
            proxy: order.proxy,
            table_name: order.sessions?.tables?.name || 'ä¸æ˜ãªãƒ†ãƒ¼ãƒ–ãƒ«',
            product_id: item.product_id,
            product_name: item.product_name,
            quantity: item.quantity,
            price: item.price,
            total: item.price * item.quantity,
            target_cast_id: item.target_cast_id,
            target_cast_name: item.target_cast_id ? casts[item.target_cast_id] || 'ä¸æ˜ãªã‚­ãƒ£ã‚¹ãƒˆ' : null
          };
        });
    });

    return NextResponse.json(formattedOrderItems);
  } catch (error) {
    console.error('æ³¨æ–‡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/orders/active/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { cookies } from 'next/headers';

export async function GET(request: NextRequest) {
  try {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Cookieã‚’å–å¾—
    const requestCookies = request.headers.get('cookie');


    // Cookieã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚‚å–å¾—ï¼ˆæ¯”è¼ƒç”¨ï¼‰
    const cookieStore = await cookies();
    const storeIdFromStore = cookieStore.get('store-id')?.value;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰store-idã‚’æŠ½å‡º
    const storeIdMatch = requestCookies?.match(/store-id=([^;]+)/);
    const storeIdFromHeader = storeIdMatch ? storeIdMatch[1] : null;



    // å„ªå…ˆé †ä½: ãƒ˜ãƒƒãƒ€ãƒ¼ > Cookieã‚¹ãƒˆã‚¢
    const storeId = storeIdFromHeader || storeIdFromStore;

    if (!storeId) {
      console.error('GET /api/orders/active: åº—èˆ—IDãŒCookieã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const allCookies = cookieStore.getAll();

    const supabase = await createServerSupabaseClient();

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ³¨æ–‡ã‚’å–å¾—
    const { data: orders, error } = await supabase
      .from('orders')
      .select(`
        order_id,
        status,
        created_by_role,
        proxy,
        created_at,
        sessions (
          session_id,
          tables (
            table_id,
            name
          )
        )
      `)
      .eq('store_id', storeId)
      .not('status', 'eq', 'closed')
      .not('status', 'eq', 'cancel')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('æ³¨æ–‡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'æ³¨æ–‡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(orders);
  } catch (error) {
    console.error('æ³¨æ–‡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/orders/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function POST(request: NextRequest) {
  try {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.session_id || !data.items || !Array.isArray(data.items) || data.items.length === 0) {
      return NextResponse.json(
        { error: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€ç„¡åŠ¹ãªå€¤ã§ã™' },
        { status: 400 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã—ã¦åº—èˆ—IDã‚’ç‰¹å®š
    const { data: session, error: sessionError } = await supabase
      .from('sessions')
      .select('store_id')
      .eq('session_id', data.session_id)
      .single();

    if (sessionError || !session) {
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ³¨æ–‡ã‚’ä½œæˆ
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .insert({
        store_id: session.store_id,
        session_id: data.session_id,
        status: 'new',
        created_by_role: data.created_by_role || 'customer',
        proxy: data.proxy || false
      })
      .select()
      .single();

    if (orderError) {
      console.error('æ³¨æ–‡ä½œæˆã‚¨ãƒ©ãƒ¼:', orderError);
      return NextResponse.json(
        { error: 'æ³¨æ–‡ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // æ³¨æ–‡æ˜ç´°ã‚’ä½œæˆ
    interface OrderItem {
      product_id: string;
      name: string;
      quantity: number;
      price: number;
      target_cast_id?: string | null;
    }

    const orderItems = data.items.map((item: OrderItem) => ({
      order_id: order.order_id,
      product_id: item.product_id,
      product_name: item.name,
      quantity: item.quantity,
      price: item.price,
      target_cast_id: item.target_cast_id || null,
      status: 'new' // æ–°è¦æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®š
    }));

    const { error: itemsError } = await supabase
      .from('order_items')
      .insert(orderItems);

    if (itemsError) {
      console.error('æ³¨æ–‡æ˜ç´°ä½œæˆã‚¨ãƒ©ãƒ¼:', itemsError);

      // æ³¨æ–‡æ˜ç´°ã®ä½œæˆã«å¤±æ•—ã—ãŸå ´åˆã€æ³¨æ–‡è‡ªä½“ã‚’å‰Šé™¤
      await supabase
        .from('orders')
        .delete()
        .eq('order_id', order.order_id);

      return NextResponse.json(
        { error: 'æ³¨æ–‡æ˜ç´°ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // Broadcast Channelã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    await supabase.from('broadcast').insert({
      channel: 'broadcast:orders',
      payload: {
        type: 'order:new',
        order_id: order.order_id,
        table_id: data.table_id,
        status: 'new',
      },
    });

    return NextResponse.json({
      order_id: order.order_id,
      status: order.status,
      created_at: order.created_at
    }, { status: 201 });
  } catch (error) {
    console.error('æ³¨æ–‡ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/proxy-order/active-tables/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { cookies } from 'next/headers';

export async function GET(request: NextRequest) {
  try {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Cookieã‚’å–å¾—
    const requestCookies = request.headers.get('cookie');


    // Cookieã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚‚å–å¾—ï¼ˆæ¯”è¼ƒç”¨ï¼‰
    const cookieStore = await cookies();
    const storeIdFromStore = cookieStore.get('store-id')?.value;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰store-idã‚’æŠ½å‡º
    const storeIdMatch = requestCookies?.match(/store-id=([^;]+)/);
    const storeIdFromHeader = storeIdMatch ? storeIdMatch[1] : null;



    // å„ªå…ˆé †ä½: ãƒ˜ãƒƒãƒ€ãƒ¼ > Cookieã‚¹ãƒˆã‚¢
    const storeId = storeIdFromHeader || storeIdFromStore;

    const allCookies = cookieStore.getAll();

    if (!storeId) {
      console.error('GET /api/proxy-order/active-tables: åº—èˆ—IDãŒCookieã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const supabase = await createServerSupabaseClient();

    // ã¾ãšã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
    const { data: sessions, error: sessionsError } = await supabase
      .from('sessions')
      .select('session_id, table_id, charge_started_at')
      .eq('store_id', storeId)
      .not('charge_started_at', 'is', null)
      .order('start_at', { ascending: false });

    if (sessionsError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionsError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã¯ç©ºã®é…åˆ—ã‚’è¿”ã™
    if (!sessions || sessions.length === 0) {
      return NextResponse.json([]);
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«é–¢é€£ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—
    const tableIds = sessions.map(session => session.table_id);

    const { data: tables, error: tablesError } = await supabase
      .from('tables')
      .select(`
        table_id,
        name,
        seat_type_id,
        seat_types (
          seat_type_id,
          display_name
        )
      `)
      .in('table_id', tableIds);

    if (tablesError) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', tablesError);
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«IDã‚’ã‚­ãƒ¼ã«ã—ãŸãƒãƒƒãƒ—ã‚’ä½œæˆ
    const tableMap = new Map();
    tables?.forEach(table => {
      tableMap.set(table.table_id, table);
    });

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’çµ„ã¿åˆã‚ã›ã‚‹
    const activeTables = sessions.map(session => {
      const table = tableMap.get(session.table_id);
      if (!table) return null;

      return {
        table_id: table.table_id,
        name: table.name,
        session_id: session.session_id,
        seat_type: table.seat_types?.display_name || 'ä¸æ˜'
      };
    }).filter(Boolean);

    return NextResponse.json(activeTables);
  } catch (error) {
    console.error('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/seat-types/[id]/route.ts">
import { createServerSupabaseClient } from '@/lib/supabase';
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';

export async function GET(
  request: NextRequest,
  context: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await context.params;
    // UUIDã¨ã—ã¦å‡¦ç†ï¼ˆæ•°å€¤å¤‰æ›ã¯ä¸è¦ï¼‰
    const seatTypeId = id;

    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const supabase = await createServerSupabaseClient();

    // å¸­ç¨®æƒ…å ±ã‚’å–å¾—
    const { data: seatType, error } = await supabase
      .from('seat_types')
      .select('*')
      .eq('seat_type_id', seatTypeId)
      .eq('store_id', storeId)
      .single();

    if (error || !seatType) {
      return NextResponse.json(
        { error: 'å¸­ç¨®ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    return NextResponse.json(seatType);
  } catch (error) {
    console.error('å¸­ç¨®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function PATCH(
  request: NextRequest,
  context: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await context.params;
    // UUIDã¨ã—ã¦å‡¦ç†ï¼ˆæ•°å€¤å¤‰æ›ã¯ä¸è¦ï¼‰
    const seatTypeId = id;

    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const data = await request.json();

    // ãƒ‡ãƒãƒƒã‚°ç”¨ã«å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
    console.log('PATCH /api/seat-types/[id] å—ä¿¡ãƒ‡ãƒ¼ã‚¿:', data);

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const price = data.price_per_unit;
    if (!data.display_name || price === undefined || price < 0 || !data.time_unit_minutes || data.time_unit_minutes <= 0) {
      return NextResponse.json(
        { error: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€ç„¡åŠ¹ãªå€¤ã§ã™' },
        { status: 400 }
      );
    }

    // æ—¢å­˜ã®å¸­ç¨®ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ä½¿ç”¨
    const supabase = await createServerSupabaseClient();

    // å¸­ç¨®ãŒå­˜åœ¨ã—ã€æ­£ã—ã„åº—èˆ—ã«å±ã—ã¦ã„ã‚‹ã‹ç¢ºèª
    const { data: existingSeatType, error: fetchError } = await supabase
      .from('seat_types')
      .select('*')
      .eq('seat_type_id', seatTypeId)
      .eq('store_id', storeId)
      .single();

    if (fetchError || !existingSeatType) {
      return NextResponse.json(
        { error: 'å¸­ç¨®ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã¯codeã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã—ãªã„ãŸã‚ã€ã“ã®å‡¦ç†ã¯ä¸è¦
    // data.code = existingSeatType.code;

    // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã¯codeã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã—ãªã„ãŸã‚ã€é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¯ä¸è¦

    // å¸­ç¨®ã‚’æ›´æ–°
    const { data: updatedSeatType, error: updateError } = await supabase
      .from('seat_types')
      .update({
        display_name: data.display_name,
        price_per_unit: data.price_per_unit,
        time_unit_minutes: data.time_unit_minutes || 30, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30åˆ†
        smaregi_product_id: data.smaregi_product_id || null
      })
      .eq('seat_type_id', seatTypeId)
      .eq('store_id', storeId)
      .select()
      .single();

    if (updateError) {
      console.error('å¸­ç¨®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'å¸­ç¨®ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ãƒ‡ãƒãƒƒã‚°ç”¨ã«æ›´æ–°çµæœã‚’ãƒ­ã‚°ã«å‡ºåŠ›
    console.log('å¸­ç¨®æ›´æ–°çµæœ:', updatedSeatType);

    return NextResponse.json(updatedSeatType);
  } catch (error) {
    console.error('å¸­ç¨®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/seat-types/route.ts">
import { createServerSupabaseClient } from '@/lib/supabase';
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';

export async function GET(request: NextRequest) {
  try {
    // URLã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
    const url = new URL(request.url);
    const storeIdFromQuery = url.searchParams.get('storeId');

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Cookieã‚’å–å¾—
    const requestCookies = request.headers.get('cookie');


    // Cookieã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚‚å–å¾—ï¼ˆæ¯”è¼ƒç”¨ï¼‰
    const cookieStore = await cookies();
    const storeIdFromStore = cookieStore.get('store-id')?.value;
    const storeIdFromStoreLegacy = cookieStore.get('storeId')?.value;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰store-idã‚’æŠ½å‡º
    const storeIdMatch = requestCookies?.match(/store-id=([^;]+)/);
    const storeIdFromHeader = storeIdMatch ? storeIdMatch[1] : null;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰storeIdã‚’æŠ½å‡ºï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ï¼‰
    const storeIdLegacyMatch = requestCookies?.match(/storeId=([^;]+)/);
    const storeIdLegacyFromHeader = storeIdLegacyMatch ? storeIdLegacyMatch[1] : null;



    // å„ªå…ˆé †ä½: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ > ãƒ˜ãƒƒãƒ€ãƒ¼ > Cookieã‚¹ãƒˆã‚¢ã€æ–°å½¢å¼ > ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼
    const storeId = storeIdFromQuery || storeIdFromHeader || storeIdLegacyFromHeader || storeIdFromStore || storeIdFromStoreLegacy;

    // const allCookies = cookieStore.getAll(); // æœªä½¿ç”¨ã®ãŸã‚å‰Šé™¤

    if (!storeId) {
      console.error('GET /api/seat-types: åº—èˆ—IDãŒCookieã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }



    const supabase = await createServerSupabaseClient();

    // åº—èˆ—ã«ç´ã¥ã„ãŸå¸­ç¨®ä¸€è¦§ã‚’å–å¾—
    const { data: seatTypes, error } = await supabase
      .from('seat_types')
      .select('*')
      .eq('store_id', storeId)
      .order('display_name');

    if (error) {
      console.error('å¸­ç¨®ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'å¸­ç¨®ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(seatTypes);
  } catch (error) {
    console.error('å¸­ç¨®ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const price = data.price_per_unit;
    if (!data.display_name || price === undefined || price < 0 || !data.time_unit_minutes || data.time_unit_minutes <= 0) {
      return NextResponse.json(
        { error: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€ç„¡åŠ¹ãªå€¤ã§ã™' },
        { status: 400 }
      );
    }

    // ã‚³ãƒ¼ãƒ‰ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
    // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆï¼ˆç·¨é›†æ™‚ãªã©ï¼‰ã¯ãã‚Œã‚’ä½¿ç”¨

    // store_idã‚’ç¢ºå®Ÿã«è¨­å®š
    data.store_id = storeId;

    const supabase = await createServerSupabaseClient();

    // ã‚³ãƒ¼ãƒ‰ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¯ä¸è¦

    // å¸­ç¨®ã‚’ä½œæˆï¼ˆcodeã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§è‡ªå‹•ç”Ÿæˆï¼‰
    const { data: newSeatType, error } = await supabase
      .from('seat_types')
      .insert({
        display_name: data.display_name,
        price_per_unit: data.price_per_unit,
        time_unit_minutes: data.time_unit_minutes || 30, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30åˆ†
        store_id: storeId,
        smaregi_product_id: data.smaregi_product_id || null
      })
      .select()
      .single();

    if (error) {
      console.error('å¸­ç¨®ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'å¸­ç¨®ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(newSeatType, { status: 201 });
  } catch (error) {
    console.error('å¸­ç¨®ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/sessions/[session_id]/move/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function POST(
  request: NextRequest,
  { params }: { params: { session_id: string } }
) {
  try {
    const { session_id } = params;
    const data = await request.json();
    const { target_table_id } = data;

    if (!target_table_id) {
      return NextResponse.json(
        { error: 'ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ç§»å‹•å…ƒã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    const { data: sourceSession, error: sessionError } = await supabase
      .from('sessions')
      .select(`
        session_id,
        store_id,
        table_id,
        start_at,
        charge_started_at,
        charge_paused_at,
        selected_cast_id,
        is_new_customer,
        tables (
          table_id,
          seat_type_id,
          seat_types (
            seat_type_id,
            display_name,
            price_per_unit,
            time_unit_minutes
          )
        )
      `)
      .eq('session_id', session_id)
      .single();

    if (sessionError || !sourceSession) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—
    const { data: targetTable, error: tableError } = await supabase
      .from('tables')
      .select(`
        table_id,
        store_id,
        seat_type_id,
        seat_types (
          seat_type_id,
          display_name,
          price_per_unit,
          time_unit_minutes
        )
      `)
      .eq('table_id', target_table_id)
      .single();

    if (tableError || !targetTable) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', tableError);
      return NextResponse.json(
        { error: 'ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // åŒã˜åº—èˆ—å†…ã§ã®ç§»å‹•ã‹ãƒã‚§ãƒƒã‚¯
    if (sourceSession.store_id !== targetTable.store_id) {
      return NextResponse.json(
        { error: 'ç•°ãªã‚‹åº—èˆ—ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ç§»å‹•ã§ãã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã«æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„ã‹ç¢ºèª
    const { data: existingTargetSession, error: targetSessionError } = await supabase
      .from('sessions')
      .select('session_id')
      .eq('table_id', target_table_id)
      .not('charge_started_at', 'is', null)
      .maybeSingle();

    if (existingTargetSession) {
      return NextResponse.json(
        { error: 'ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ—¢ã«ä½¿ç”¨ä¸­ã§ã™' },
        { status: 400 }
      );
    }

    // å¸­ç¨®ãŒå¤‰ã‚ã‚‹å ´åˆã®å‡¦ç†
    const sourceTableSeatTypeId = sourceSession.tables?.seat_type_id;
    const targetTableSeatTypeId = targetTable.seat_type_id;

    // ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
    const now = new Date();

    // ç§»å‹•å…ƒãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ»åœ¨æ™‚é–“ã«å¿œã˜ãŸæ–™é‡‘ã‚’è¨ˆç®—
    let currentTableCharge = 0;
    if (sourceSession.charge_started_at) {
      // ç§»å‹•å…ƒãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ»åœ¨æ™‚é–“ã«å¿œã˜ãŸæ–™é‡‘ã®ã¿ã‚’è¨ˆç®—
      // æ—¢å­˜ã®ç§»å‹•æ–™é‡‘ã‚’å«ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€ç›´æ¥è¨ˆç®—ã™ã‚‹

      // æœ€å¾Œã®session_seat_eventã‚’å–å¾—ï¼ˆé€šå¸¸ã®ã‚¤ãƒ™ãƒ³ãƒˆã€is_table_move_charge=falseã®ã‚‚ã®ï¼‰
      const { data: lastEvent, error: lastEventError } = await supabase
        .from('session_seat_events')
        .select('seat_type_id, price_snapshot, changed_at')
        .eq('session_id', session_id)
        .eq('is_table_move_charge', false)
        .order('changed_at', { ascending: false })
        .limit(1)
        .single();

      if (lastEventError) {
        console.error('æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', lastEventError);
        return NextResponse.json(
          { error: 'æ–™é‡‘è¨ˆç®—ã«å¿…è¦ãªæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
          { status: 500 }
        );
      }

      // å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
      const { data: seatType, error: seatTypeError } = await supabase
        .from('seat_types')
        .select('time_unit_minutes')
        .eq('seat_type_id', lastEvent.seat_type_id)
        .single();

      if (seatTypeError) {
        console.error('å¸­ç¨®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', seatTypeError);
        return NextResponse.json(
          { error: 'å¸­ç¨®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
          { status: 500 }
        );
      }

      // æ™‚é–“å˜ä½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30åˆ†ï¼‰
      const timeUnitMinutes = seatType.time_unit_minutes > 0 ? seatType.time_unit_minutes : 30;

      // æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
      const lastEventTime = new Date(lastEvent.changed_at);
      const elapsedMs = now.getTime() - lastEventTime.getTime();
      const elapsedMinutes = elapsedMs / (1000 * 60);

      // 0åˆ†æ™‚ç‚¹ã§ã®ç§»å‹•ã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†
      if (elapsedMinutes < 1) {
        // 0åˆ†æ™‚ç‚¹ã§ã®ç§»å‹•ã®å ´åˆã€æœ€ä½æ–™é‡‘ã‚’é©ç”¨ï¼ˆ1å˜ä½åˆ†ï¼‰
        currentTableCharge = lastEvent.price_snapshot;
        console.log('0åˆ†æ™‚ç‚¹ã§ã®ç§»å‹•: æœ€ä½æ–™é‡‘ã‚’é©ç”¨', currentTableCharge);
      } else {
        // é€šå¸¸ã®è¨ˆç®—ï¼ˆ1åˆ†ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆï¼‰
        // æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
        const roundedMinutes = Math.ceil(elapsedMinutes / timeUnitMinutes) * timeUnitMinutes;

        // æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
        const timeUnits = roundedMinutes / timeUnitMinutes;

        // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ã‚’è¨ˆç®—
        currentTableCharge = timeUnits * lastEvent.price_snapshot;
      }
    }

    // ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ã‚’å–å¾—
    const targetSeatPrice = targetTable.seat_types?.price_per_unit || 0;

    // ç¾åœ¨æ™‚åˆ»ã‹ã‚‰1ãƒŸãƒªç§’å‰ã®æ™‚åˆ»ã‚’è¨ˆç®—ï¼ˆç§»å‹•å…ƒãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–™é‡‘è¨˜éŒ²ç”¨ï¼‰
    const moveChargeTime = new Date(now.getTime() - 1);

    // ç§»å‹•å…ƒãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–™é‡‘ã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®session_seat_eventã‚’ä½œæˆï¼ˆæ–™é‡‘ãŒ0ã‚ˆã‚Šå¤§ãã„å ´åˆã®ã¿ï¼‰
    if (currentTableCharge > 0) {
      try {
        // ç‰¹åˆ¥ãªsession_seat_eventã‚’ä½œæˆï¼ˆç§»å‹•å‰ã®æ–™é‡‘ã‚’è¨˜éŒ²ï¼‰
        // is_table_move_chargeãƒ•ãƒ©ã‚°ã‚’trueã«è¨­å®šã—ã¦ç§»å‹•å‰ã®æ–™é‡‘ã‚’è¨˜éŒ²
        const { error: eventError } = await supabase
          .from('session_seat_events')
          .insert({
            session_id: session_id,
            seat_type_id: sourceTableSeatTypeId, // ç§»å‹•å…ƒã®å¸­ç¨®ID
            price_snapshot: currentTableCharge, // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ã®ã¿ã‚’è¨˜éŒ²
            changed_at: moveChargeTime.toISOString(), // ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå°‘ã—å‰ã®æ™‚åˆ»ã‚’è¨­å®š
            is_table_move_charge: true // å¸­ç§»å‹•æ–™é‡‘ãƒ•ãƒ©ã‚°ã‚’trueã«è¨­å®š
          });

        if (eventError) {
          console.error('ç§»å‹•å‰æ–™é‡‘è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', eventError);
          return NextResponse.json(
            { error: 'ç§»å‹•å‰æ–™é‡‘ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ' },
            { status: 500 }
          );
        }
      } catch (error) {
        console.error('ç§»å‹•å‰æ–™é‡‘è¨˜éŒ²ä¾‹å¤–:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
      }
    }

    // æ–°ã—ã„session_seat_eventã‚’ä½œæˆï¼ˆå¸­ç¨®ãŒå¤‰ã‚ã‚‹å ´åˆã‚‚å¤‰ã‚ã‚‰ãªã„å ´åˆã‚‚ï¼‰
    // å¿…ãšç§»å‹•å…ƒãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–™é‡‘è¨˜éŒ²ã®å¾Œã«ä½œæˆã™ã‚‹
    const { error: eventError } = await supabase
      .from('session_seat_events')
      .insert({
        session_id: session_id,
        seat_type_id: targetTableSeatTypeId, // ç§»å‹•å…ˆã®å¸­ç¨®ID
        price_snapshot: targetSeatPrice, // ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®ã®æ–™é‡‘
        changed_at: now.toISOString(), // ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®š
        is_table_move_charge: false // é€šå¸¸ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦è¨˜éŒ²
      });

    if (eventError) {
      console.error('å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', eventError);
      return NextResponse.json(
        { error: 'å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ†ãƒ¼ãƒ–ãƒ«IDã‚’æ›´æ–°ã—ã€èª²é‡‘é–‹å§‹æ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã«è¨­å®š
    const updateData: any = {
      table_id: target_table_id
    };

    // èª²é‡‘é–‹å§‹æ™‚é–“ã‚’è¨­å®šï¼ˆå…ƒã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§èª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªãã¦ã‚‚ã€ç§»å‹•å¾Œã¯èª²é‡‘ã‚’é–‹å§‹ã™ã‚‹ï¼‰
    updateData.charge_started_at = now.toISOString();

    // ä¸€æ™‚åœæ­¢ä¸­ã ã£ãŸå ´åˆã¯ã€ä¸€æ™‚åœæ­¢çŠ¶æ…‹ã‚’è§£é™¤
    if (sourceSession.charge_paused_at) {
      updateData.charge_paused_at = null;
    }

    const { data: updatedSession, error: updateError } = await supabase
      .from('sessions')
      .update(updateData)
      .eq('session_id', session_id)
      .select()
      .single();

    if (updateError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      message: 'å¸­ç§»å‹•ãŒå®Œäº†ã—ã¾ã—ãŸ',
      session: updatedSession,
      previous_charge: currentTableCharge
    });
  } catch (error) {
    console.error('å¸­ç§»å‹•ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/sessions/[session_id]/orders/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ session_id: string }> }
) {
  try {
    const { session_id } = await params;


    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const { data: session, error: sessionError } = await supabase
      .from('sessions')
      .select('session_id')
      .eq('session_id', session_id)
      .single();

    if (sessionError || !session) {
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆstatusãŒnewã®ã‚‚ã®ã®ã¿ï¼‰
    const { data: orders, error: ordersError } = await supabase
      .from('orders')
      .select(`
        order_id,
        status,
        created_at,
        order_items (
          order_item_id,
          product_id,
          product_name,
          quantity,
          price,
          target_cast_id
        )
      `)
      .eq('session_id', session_id)
      .eq('status', 'new')
      .order('created_at', { ascending: true });

    if (ordersError) {
      console.error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', ordersError);
      return NextResponse.json(
        { error: 'æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰åº—èˆ—IDã‚’å–å¾—
    const { data: sessionData, error: sessionStoreError } = await supabase
      .from('sessions')
      .select('store_id')
      .eq('session_id', session_id)
      .single();

    if (sessionStoreError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³åº—èˆ—IDå–å¾—ã‚¨ãƒ©ãƒ¼:', sessionStoreError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    const storeId = sessionData.store_id;

    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ£ã‚¹ãƒˆã®æƒ…å ±ã‚’å–å¾—
    const castIds = orders
      .flatMap(order => order.order_items)
      .filter(item => item.target_cast_id)
      .map(item => item.target_cast_id);

    // ã‚­ãƒ£ã‚¹ãƒˆIDã¨è¡¨ç¤ºåã®ãƒãƒƒãƒ”ãƒ³ã‚°
    interface CastMap {
      [key: string]: string;
    }

    let casts: CastMap = {};
    if (castIds.length > 0) {
      // é‡è¤‡ã‚’æ’é™¤ã™ã‚‹åˆ¥ã®æ–¹æ³•
      const uniqueCastIds = castIds.filter((id, index) => castIds.indexOf(id) === index);

      // store_usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
      // æ³¨: user_idã¯store_usersãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ ãªã®ã§ã€ãã®ã¾ã¾å–å¾—ã§ãã‚‹
      const { data: castsData, error: castsError } = await supabase
        .from('store_users')
        .select('*')
        .eq('store_id', storeId)
        .eq('role', 'cast')
        .in('user_id', uniqueCastIds);



      if (!castsError && castsData) {
        casts = castsData.reduce((acc, cast) => {
          // display_nameãŒnullã®å ´åˆã¯ã€Œã‚­ãƒ£ã‚¹ãƒˆã€ã¨ã„ã†åå‰ã‚’ä½¿ç”¨
          acc[cast.user_id] = cast.display_name || `ã‚­ãƒ£ã‚¹ãƒˆ${cast.id.substring(0, 4)}`;
          return acc;
        }, {});
      }
    }

    // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
    const formattedOrders = orders.flatMap(order =>
      order.order_items.map(item => {


        return {
          order_id: order.order_id,
          product_id: item.product_id,
          name: item.product_name,
          quantity: item.quantity,
          price: item.price,
          total: item.price * item.quantity,
          target_cast_id: item.target_cast_id,
          target_cast_name: item.target_cast_id ? casts[item.target_cast_id] || 'ä¸æ˜ãªã‚­ãƒ£ã‚¹ãƒˆ' : null
        };
      })
    );

    // åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
    const totalPrice = formattedOrders.reduce((sum, item) => sum + item.total, 0);

    return NextResponse.json({
      orders: formattedOrders,
      totalPrice
    });
  } catch (error) {
    console.error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/sessions/[session_id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

// ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤API
export async function DELETE(
  request: NextRequest,
  { params }: { params: { session_id: string } }
) {
  try {
    const { session_id } = params;
    console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤API: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡', { session_id });

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const { data: existingSession, error: sessionError } = await supabase
      .from('sessions')
      .select('*')
      .eq('session_id', session_id)
      .single();

    if (sessionError || !existingSession) {
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
    const { error: deleteError } = await supabase
      .from('sessions')
      .delete()
      .eq('session_id', session_id);

    if (deleteError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', deleteError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      success: true,
      message: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸ'
    });
  } catch (error) {
    console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/sessions/active/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { cookies } from 'next/headers';

export async function GET(request: NextRequest) {
  try {
    // URLã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
    const url = new URL(request.url);
    const storeIdFromQuery = url.searchParams.get('storeId');

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Cookieã‚’å–å¾—
    const requestCookies = request.headers.get('cookie');


    // Cookieã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚‚å–å¾—ï¼ˆæ¯”è¼ƒç”¨ï¼‰
    const cookieStore = await cookies();
    const storeIdFromStore = cookieStore.get('store-id')?.value;
    const storeIdFromStoreLegacy = cookieStore.get('storeId')?.value;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰store-idã‚’æŠ½å‡º
    const storeIdMatch = requestCookies?.match(/store-id=([^;]+)/);
    const storeIdFromHeader = storeIdMatch ? storeIdMatch[1] : null;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰storeIdã‚’æŠ½å‡ºï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ï¼‰
    const storeIdLegacyMatch = requestCookies?.match(/storeId=([^;]+)/);
    const storeIdLegacyFromHeader = storeIdLegacyMatch ? storeIdLegacyMatch[1] : null;



    // å„ªå…ˆé †ä½: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ > ãƒ˜ãƒƒãƒ€ãƒ¼ > Cookieã‚¹ãƒˆã‚¢ã€æ–°å½¢å¼ > ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼
    const storeId = storeIdFromQuery || storeIdFromHeader || storeIdLegacyFromHeader || storeIdFromStore || storeIdFromStoreLegacy;

    const allCookies = cookieStore.getAll();

    if (!storeId) {
      console.error('GET /api/sessions/active: åº—èˆ—IDãŒCookieã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }



    const supabase = await createServerSupabaseClient();

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ï¼ˆcharge_started_atãŒnullã§ãªã„ã‚‚ã®ã‚’å–å¾—ï¼‰
    const { data: sessions, error: sessionsError } = await supabase
      .from('sessions')
      .select(`
        session_id,
        table_id,
        start_at,
        charge_started_at,
        charge_paused_at
      `)
      .eq('store_id', storeId)
      .not('charge_started_at', 'is', null)
      .order('start_at', { ascending: false });

    if (sessionsError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionsError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(sessions);
  } catch (error) {
    console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/smaregi-sync/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient } from '@/lib/supabase';
import { getUserRoleInStore } from '@/lib/auth';
import { getSmaregiAccessToken, fetchSmaregiProducts, fetchSmaregiCategories, fetchSmaregiAllProductImages } from '@/lib/smaregi';

// ã‚¹ãƒãƒ¬ã‚¸APIã‹ã‚‰å•†å“æƒ…å ±ã‚’å–å¾—ã—ã¦æ•´å½¢ã™ã‚‹é–¢æ•°
async function getFormattedSmaregiProducts(storeId: string, clientId: string, clientSecret: string, contractId: string) {
  try {
    // ã‚¹ãƒãƒ¬ã‚¸APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const accessToken = await getSmaregiAccessToken(clientId, clientSecret, contractId);

    // ã‚¹ãƒãƒ¬ã‚¸APIã‹ã‚‰å•†å“æƒ…å ±ã¨éƒ¨é–€æƒ…å ±ã‚’å–å¾—
    const products = await fetchSmaregiProducts(accessToken, contractId);
    const categories = await fetchSmaregiCategories(accessToken, contractId);

    // ã‚¹ãƒãƒ¬ã‚¸APIã‹ã‚‰å…¨å•†å“ç”»åƒæƒ…å ±ã‚’ä¸€æ‹¬å–å¾—
    const allProductImages = await fetchSmaregiAllProductImages(accessToken, contractId);

    // å•†å“IDã¨ç”»åƒURLã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
    const productImageMap = new Map();
    allProductImages.forEach((image: any) => {
      // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ imageUrl ã¾ãŸã¯ url ã®ã©ã¡ã‚‰ã‹ã§ç”»åƒURLãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
      const imageUrl = image.imageUrl || image.url;
      if (image.productId && imageUrl) {
        // åŒã˜å•†å“IDã«è¤‡æ•°ã®ç”»åƒãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãã•ã‚Œã‚‹ãŒã€
        // ä»Šå›ã¯æœ€åˆã®ç”»åƒã‚’ä½¿ç”¨ã™ã‚‹ã®ã§å•é¡Œãªã„
        productImageMap.set(image.productId, imageUrl);
      }
    });

    // ç”»åƒãƒãƒƒãƒ”ãƒ³ã‚°çµæœã‚’ãƒ­ã‚°å‡ºåŠ›
    console.log(`å•†å“ç”»åƒãƒãƒƒãƒ”ãƒ³ã‚°ä½œæˆçµæœ: ${productImageMap.size}ä»¶ã®å•†å“ã«ç”»åƒURLã‚’ãƒãƒƒãƒ”ãƒ³ã‚°`);

    // éƒ¨é–€IDã¨éƒ¨é–€åã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
    const categoryMap = new Map();
    categories.forEach((category: any) => {
      categoryMap.set(category.categoryId, category.categoryName);
    });

    // ã‚¹ãƒãƒ¬ã‚¸ã®éƒ¨é–€æƒ…å ±ã‚’è¿”ã™
    const smaregiCategories = categories.map((category: any) => ({
      categoryId: category.categoryId,
      name: category.categoryName,
    }));

    // å•†å“æƒ…å ±ã‚’æ•´å½¢ï¼ˆç”»åƒæƒ…å ±ã‚’å«ã‚€ï¼‰
    const formattedProducts = [];

    // å„å•†å“ã®æƒ…å ±ã‚’æ•´å½¢
    for (const product of products) {
      const categoryName = categoryMap.get(product.categoryId) || null;
      const categoryId = product.categoryId || null;

      // å•†å“ç”»åƒã‚’å–å¾—
      let imageUrl = product.url || null;

      // å•†å“ç”»åƒãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰ç”»åƒURLã‚’å–å¾—
      if (product.productId && productImageMap.has(product.productId)) {
        imageUrl = productImageMap.get(product.productId);
      }

      formattedProducts.push({
        productId: product.productCode,
        name: product.productName,
        price: parseInt(product.price, 10),
        categoryName: categoryName,
        categoryId: categoryId,
        description: product.description || null,
        imageUrl: imageUrl,
      });
    }

    return {
      products: formattedProducts,
      categories: smaregiCategories
    };
  } catch (error) {
    console.error('ã‚¹ãƒãƒ¬ã‚¸å•†å“æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error('ã‚¹ãƒãƒ¬ã‚¸ã‹ã‚‰ã®å•†å“æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

export async function POST(request: NextRequest) {
  try {
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
      headers: {
        Cookie: request.headers.get('cookie') || ''
      }
    });

    if (!userResponse.ok) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    const { user } = await userResponse.json();

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (user.role !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store } = await supabase
      .from('stores')
      .select('enable_smaregi_integration, smaregi_client_id, smaregi_client_secret, smaregi_contract_id')
      .eq('store_id', storeId)
      .single();

    if (!store) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒç„¡åŠ¹ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!store.enable_smaregi_integration) {
      return NextResponse.json(
        { error: 'ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™' },
        { status: 403 }
      );
    }

    // ã‚¹ãƒãƒ¬ã‚¸APIã®èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!store.smaregi_client_id || !store.smaregi_client_secret || !store.smaregi_contract_id) {
      return NextResponse.json(
        { error: 'ã‚¹ãƒãƒ¬ã‚¸APIã®èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // å¥‘ç´„IDã‚’åº—èˆ—è¨­å®šã‹ã‚‰å–å¾—
    const contractId = store.smaregi_contract_id;

    // ã‚¹ãƒãƒ¬ã‚¸APIã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’å–å¾—
    const smaregiData = await getFormattedSmaregiProducts(
      storeId,
      store.smaregi_client_id,
      store.smaregi_client_secret,
      contractId
    );

    const { products: smaregiProducts, categories: smaregiCategories } = smaregiData;

    // 1. ã‚«ãƒ†ã‚´ãƒªã‚’åŒæœŸ
    // æ—¢å­˜ã®ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
    const { data: existingCategories } = await supabase
      .from('menu_categories')
      .select('category_id, name, smaregi_category_id')
      .eq('store_id', storeId);

    // ã‚¹ãƒãƒ¬ã‚¸ã‚«ãƒ†ã‚´ãƒªIDã§ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå„ªå…ˆï¼‰ã¨ã‚«ãƒ†ã‚´ãƒªåã§ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
    const existingCategoryMap = new Map();
    const existingCategoryNameMap = new Map();
    existingCategories?.forEach(category => {
      if (category.smaregi_category_id) {
        existingCategoryMap.set(category.smaregi_category_id, category.category_id);
      }
      existingCategoryNameMap.set(category.name, category.category_id);
    });

    // ã‚¹ãƒãƒ¬ã‚¸ã‹ã‚‰å–å¾—ã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’ç™»éŒ²
    const categoriesToUpsert = [];
    const categoryIdMap = new Map(); // ã‚¹ãƒãƒ¬ã‚¸ã‚«ãƒ†ã‚´ãƒªIDã¨DBã‚«ãƒ†ã‚´ãƒªIDã®ãƒãƒƒãƒ”ãƒ³ã‚°

    for (const category of smaregiCategories) {
      if (category.name && category.categoryId) {
        // æ—¢ã«ã‚¹ãƒãƒ¬ã‚¸ã‚«ãƒ†ã‚´ãƒªIDãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®IDã‚’ä½¿ç”¨
        if (existingCategoryMap.has(category.categoryId)) {
          categoryIdMap.set(category.categoryId, existingCategoryMap.get(category.categoryId));

          // ã‚«ãƒ†ã‚´ãƒªåãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
          const existingCategoryId = existingCategoryMap.get(category.categoryId);
          const existingCategory = existingCategories?.find(c => c.category_id === existingCategoryId);
          if (existingCategory && existingCategory.name !== category.name) {
            await supabase
              .from('menu_categories')
              .update({ name: category.name })
              .eq('category_id', existingCategoryId);
          }
        }
        // åŒã˜åå‰ã®ã‚«ãƒ†ã‚´ãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€ã‚¹ãƒãƒ¬ã‚¸ã‚«ãƒ†ã‚´ãƒªIDã‚’æ›´æ–°
        else if (existingCategoryNameMap.has(category.name)) {
          const existingCategoryId = existingCategoryNameMap.get(category.name);
          await supabase
            .from('menu_categories')
            .update({ smaregi_category_id: category.categoryId })
            .eq('category_id', existingCategoryId);

          categoryIdMap.set(category.categoryId, existingCategoryId);
        }
        // æ–°è¦ã‚«ãƒ†ã‚´ãƒªã®å ´åˆã¯è¿½åŠ 
        else {
          const { data: newCategory, error } = await supabase
            .from('menu_categories')
            .insert({
              store_id: storeId,
              name: category.name,
              smaregi_category_id: category.categoryId,
              display_order: categoriesToUpsert.length + 1
            })
            .select()
            .single();

          if (error) {
            console.error('ã‚«ãƒ†ã‚´ãƒªä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
          } else if (newCategory) {
            categoryIdMap.set(category.categoryId, newCategory.category_id);
          }
        }
      }
    }

    // 2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åŒæœŸ
    // ä¸€æ‹¬æ›´æ–°ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    const menusToUpsert = smaregiProducts.map(product => {
      // ã‚«ãƒ†ã‚´ãƒªIDã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
      const dbCategoryId = product.categoryId ? categoryIdMap.get(product.categoryId) : null;

      return {
        store_id: storeId,
        product_id: product.productId,
        name: product.name,
        description: product.description || null,
        price: product.price,
        image_url: product.imageUrl || null,
        category: product.categoryName || null, // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™
        category_id: dbCategoryId,
        is_available: true,
      };
    });

    // ç”»åƒURLè¨­å®šçµæœã‚’ãƒ­ã‚°å‡ºåŠ›
    const menusWithImage = menusToUpsert.filter(menu => menu.image_url).length;
    console.log(`ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒè¨­å®šçµæœ: åˆè¨ˆ${menusToUpsert.length}ä»¶ä¸­ã€ç”»åƒæœ‰ã‚Š${menusWithImage}ä»¶`);

    // ç”»åƒURLãŒè¨­å®šã•ã‚ŒãŸæœ€åˆã®5ä»¶ã‚’ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ãƒ­ã‚°å‡ºåŠ›
    const menuSamples = menusToUpsert.filter(menu => menu.image_url).slice(0, 5);
    if (menuSamples.length > 0) {
      console.log('ç”»åƒURLè¨­å®šã‚µãƒ³ãƒ—ãƒ«:');
      menuSamples.forEach(menu => {
        console.log(`- ${menu.name}: ${menu.image_url}`);
      });
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä¸€æ‹¬æ›´æ–°ï¼ˆupsertï¼‰
    const { error: upsertError } = await supabase
      .from('menus')
      .upsert(menusToUpsert, {
        onConflict: 'store_id,product_id',
        ignoreDuplicates: false,
      });

    if (upsertError) {
      console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€æ‹¬æ›´æ–°ã‚¨ãƒ©ãƒ¼:', upsertError);
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      success: true,
      count: menusToUpsert.length,
      message: `${menusToUpsert.length}ä»¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åŒæœŸã—ã¾ã—ãŸ`,
    });
  } catch (error) {
    console.error('ã‚¹ãƒãƒ¬ã‚¸åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/stores/[store_id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ store_id: string }> }
) {
  try {
    const { store_id } = await params;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—
    const { data: store, error: storeError } = await supabase
      .from('stores')
      .select('*')
      .eq('store_id', store_id)
      .single();

    if (storeError || !store) {
      return NextResponse.json(
        { error: 'åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    return NextResponse.json(store);
  } catch (error) {
    console.error('åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/stores/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(request: NextRequest) {
  try {
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // åº—èˆ—ä¸€è¦§ã‚’å–å¾—
    const { data: stores, error } = await supabase
      .from('stores')
      .select('store_id, store_code, name')
      .order('name');

    if (error) {
      console.error('åº—èˆ—ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'åº—èˆ—ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(stores);
  } catch (error) {
    console.error('åº—èˆ—ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/stores/settings/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient, createServerComponentClient } from '@/lib/supabase';
import { getUserRoleInStore } from '@/lib/auth';

export async function PATCH(request: NextRequest) {
  try {
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // èªè¨¼ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
    const authClient = await createServerComponentClient();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user } } = await authClient.auth.getUser();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    if (!user) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
    const userRole = await getUserRoleInStore(user.id, storeId);

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (userRole !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (typeof data.enable_smaregi_integration !== 'boolean') {
      return NextResponse.json(
        { error: 'ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™' },
        { status: 400 }
      );
    }

    // æ¶ˆè²»ç¨ç‡ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (data.tax_rate !== undefined) {
      const taxRate = parseFloat(data.tax_rate);
      if (isNaN(taxRate) || taxRate < 0 || taxRate > 100) {
        return NextResponse.json(
          { error: 'æ¶ˆè²»ç¨ç‡ã¯0ã€œ100ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„' },
          { status: 400 }
        );
      }
    }

    // ã‚¹ãƒãƒ¬ã‚¸é€£æºã‚­ãƒ¼ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (data.enable_smaregi_integration) {
      // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ãªå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€å¥‘ç´„IDãŒå¿…è¦
      if (!data.smaregi_client_id || !data.smaregi_client_secret || !data.smaregi_contract_id) {
        return NextResponse.json(
          { error: 'ã‚¹ãƒãƒ¬ã‚¸é€£æºã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€å¥‘ç´„IDãŒå¿…è¦ã§ã™' },
          { status: 400 }
        );
      }
    }

    // æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
    const updateData: any = {
      enable_smaregi_integration: data.enable_smaregi_integration
    };

    // æ¶ˆè²»ç¨ç‡ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
    if (data.tax_rate !== undefined) {
      updateData.tax_rate = parseFloat(data.tax_rate);
    }

    // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ãªå ´åˆã€ã‚­ãƒ¼æƒ…å ±ã‚‚æ›´æ–°
    if (data.enable_smaregi_integration) {
      updateData.smaregi_client_id = data.smaregi_client_id;
      updateData.smaregi_client_secret = data.smaregi_client_secret;
      updateData.smaregi_contract_id = data.smaregi_contract_id;
    }

    // åº—èˆ—è¨­å®šã‚’æ›´æ–°
    const { error: updateError } = await supabase
      .from('stores')
      .update(updateData)
      .eq('store_id', storeId);

    if (updateError) {
      console.error('åº—èˆ—è¨­å®šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'åº—èˆ—è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('åº—èˆ—è¨­å®šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/tables/[table_id]/menus/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ table_id: string }> }
) {
  try {
    const { table_id } = await params;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—ã—ã¦åº—èˆ—IDã‚’ç‰¹å®š
    const { data: table, error: tableError } = await supabase
      .from('tables')
      .select('store_id')
      .eq('table_id', table_id)
      .single();

    if (tableError || !table) {
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—
    const { data: categoryData, error: categoryError } = await supabase
      .from('menu_categories')
      .select('category_id, name, display_order, allow_treat_cast')
      .eq('store_id', table.store_id)
      .order('display_order', { ascending: true })
      .order('name', { ascending: true });

    if (categoryError) {
      console.error('ã‚«ãƒ†ã‚´ãƒªä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', categoryError);
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚«ãƒ†ã‚´ãƒªIDã¨ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
    const categoryMap = new Map();
    const categoryAllowTreatMap = new Map();
    categoryData?.forEach(category => {
      categoryMap.set(category.category_id, category.name);
      categoryAllowTreatMap.set(category.category_id, category.allow_treat_cast);
    });

    // åº—èˆ—IDã«ç´ã¥ããƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã‚’å–å¾—ï¼ˆåˆ©ç”¨å¯èƒ½ãªã‚‚ã®ã®ã¿ï¼‰
    const { data: menuData, error: menusError } = await supabase
      .from('menus')
      .select('menu_id, product_id, name, description, price, image_url, category, category_id, is_available')
      .eq('store_id', table.store_id)
      .eq('is_available', true)
      .order('name', { ascending: true });

    if (menusError) {
      console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', menusError);
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’æŠ½å‡ºã—ã¦æ–°ã—ã„é…åˆ—ã‚’ä½œæˆ
    const menus = (menuData || []).map(item => ({
      menu_id: item.menu_id,
      product_id: item.product_id,
      name: item.name,
      description: item.description,
      price: item.price,
      image_url: item.image_url,
      category: item.category_id ? categoryMap.get(item.category_id) || item.category || 'æœªåˆ†é¡' : (item.category || 'æœªåˆ†é¡'),
      category_id: item.category_id,
      is_available: item.is_available,
      allow_treat_cast: item.category_id ? categoryAllowTreatMap.get(item.category_id) || false : false
    }));

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const menusByCategory: Record<string, any[]> = {};

    // ã¾ãšã€ã‚«ãƒ†ã‚´ãƒªãƒ†ãƒ¼ãƒ–ãƒ«ã«åŸºã¥ã„ã¦ç©ºã®é…åˆ—ã‚’ä½œæˆï¼ˆè¡¨ç¤ºé †ã‚’ä¿æŒã™ã‚‹ãŸã‚ï¼‰
    const categoryInfoMap = new Map();
    categoryData?.forEach(category => {
      menusByCategory[category.name] = [];
      categoryInfoMap.set(category.name, {
        category_id: category.category_id,
        allow_treat_cast: category.allow_treat_cast
      });
    });

    // æœªåˆ†é¡ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
    if (!menusByCategory['æœªåˆ†é¡']) {
      menusByCategory['æœªåˆ†é¡'] = [];
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«æŒ¯ã‚Šåˆ†ã‘
    menus.forEach(menu => {
      const categoryName = menu.category;
      if (!menusByCategory[categoryName]) {
        menusByCategory[categoryName] = [];
      }
      menusByCategory[categoryName].push(menu);
    });

    return NextResponse.json({
      menus,
      menusByCategory,
      categories: categoryData || []
    });
  } catch (error) {
    console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/tables/[table_id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { cookies } from 'next/headers';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ table_id: string }> }
) {
  try {
    const { table_id } = await params;

    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—
    const { data: table, error: tableError } = await supabase
      .from('tables')
      .select(`
        table_id,
        name,
        store_id,
        seat_types (
          seat_type_id,
          display_name,
          price_per_unit,
          time_unit_minutes
        ),
        stores (
          store_id,
          name
        )
      `)
      .eq('table_id', table_id)
      .single();

    if (tableError || !table) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', tableError);
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // seat_typesã®å–å¾—æ–¹æ³•ã‚’ä¿®æ­£
    let seatType = null;

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®seat_type_idã‚’å–å¾—
    const { data: tableData, error: tableDataError } = await supabase
      .from('tables')
      .select('seat_type_id')
      .eq('table_id', table_id)
      .single();

    if (!tableDataError && tableData && tableData.seat_type_id) {
      // seat_type_idã‚’ä½¿ç”¨ã—ã¦seat_typesãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ç›´æ¥å–å¾—
      const { data: seatTypeData, error: seatTypeError } = await supabase
        .from('seat_types')
        .select('seat_type_id, display_name, price_per_unit, time_unit_minutes')
        .eq('seat_type_id', tableData.seat_type_id)
        .single();

      if (!seatTypeError && seatTypeData) {
        seatType = {
          ...seatTypeData,
          price_per_unit: seatTypeData.price_per_unit
        };
      }
    }

    // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’æŠ½å‡ºã—ã¦è¿”ã™
    return NextResponse.json({
      table_id: table.table_id,
      name: table.name,
      store_id: table.store_id,
      seat_type: seatType,
      store: table.stores ? (
        Array.isArray(table.stores) ? (
          table.stores.length > 0 ? {
            store_id: table.stores[0].store_id,
            name: table.stores[0].name
          } : null
        ) : {
          store_id: table.stores.store_id,
          name: table.stores.name
        }
      ) : null
    });
  } catch (error) {
    console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ table_id: string }> }
) {
  try {
    const { table_id } = await params;

    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
    const data = await request.json();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const { data: existingTable, error: checkError } = await supabase
      .from('tables')
      .select('table_id')
      .eq('table_id', table_id)
      .eq('store_id', storeId)
      .single();

    if (checkError || !existingTable) {
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.name || !data.seat_type_id) {
      return NextResponse.json(
        { error: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™' },
        { status: 400 }
      );
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’æ›´æ–°
    const { data: updatedTable, error: updateError } = await supabase
      .from('tables')
      .update({
        name: data.name,
        seat_type_id: data.seat_type_id
      })
      .eq('table_id', table_id)
      .eq('store_id', storeId)
      .select()
      .single();

    if (updateError) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(updatedTable);
  } catch (error) {
    console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/tables/[table_id]/sessions/[session_id]/pause/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ table_id: string; session_id: string }> }
) {
  try {
    const { table_id, session_id } = await params;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const { data: existingSession, error: sessionError } = await supabase
      .from('sessions')
      .select('session_id, table_id, charge_started_at, charge_paused_at')
      .eq('session_id', session_id)
      .eq('table_id', table_id)
      .single();

    if (sessionError || !existingSession) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ã™ã§ã«ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (existingSession.charge_paused_at) {
      return NextResponse.json(
        { error: 'ã™ã§ã«èª²é‡‘ãŒä¸€æ™‚åœæ­¢ã•ã‚Œã¦ã„ã¾ã™' },
        { status: 400 }
      );
    }

    // èª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!existingSession.charge_started_at) {
      return NextResponse.json(
        { error: 'èª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // èª²é‡‘ã‚’ä¸€æ™‚åœæ­¢
    const { data: updatedSession, error: updateError } = await supabase
      .from('sessions')
      .update({
        charge_paused_at: new Date().toISOString(),
      })
      .eq('session_id', session_id)
      .select()
      .single();

    if (updateError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'èª²é‡‘ã®ä¸€æ™‚åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      message: 'èª²é‡‘ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ',
      session: updatedSession,
    });
  } catch (error) {
    console.error('èª²é‡‘ä¸€æ™‚åœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/tables/[table_id]/sessions/[session_id]/resume/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ table_id: string; session_id: string }> }
) {
  try {
    const { table_id, session_id } = await params;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const { data: existingSession, error: sessionError } = await supabase
      .from('sessions')
      .select('session_id, table_id, charge_started_at, charge_paused_at')
      .eq('session_id', session_id)
      .eq('table_id', table_id)
      .single();

    if (sessionError || !existingSession) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ä¸€æ™‚åœæ­¢ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!existingSession.charge_paused_at) {
      return NextResponse.json(
        { error: 'èª²é‡‘ã¯ä¸€æ™‚åœæ­¢ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // èª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!existingSession.charge_started_at) {
      return NextResponse.json(
        { error: 'èª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // ä¸€æ™‚åœæ­¢ã—ã¦ã„ãŸæ™‚é–“ã‚’è¨ˆç®—
    const pauseStartTime = new Date(existingSession.charge_paused_at);
    const now = new Date();
    const pauseDurationMs = now.getTime() - pauseStartTime.getTime();

    // å…ƒã®èª²é‡‘é–‹å§‹æ™‚é–“
    const originalStartTime = new Date(existingSession.charge_started_at);

    // ä¸€æ™‚åœæ­¢ã—ã¦ã„ãŸæ™‚é–“åˆ†ã ã‘èª²é‡‘é–‹å§‹æ™‚é–“ã‚’èª¿æ•´ï¼ˆå¾Œã‚ã«ãšã‚‰ã™ï¼‰
    const newStartTime = new Date(originalStartTime.getTime() + pauseDurationMs);

    // èª²é‡‘ã‚’å†é–‹ï¼ˆcharge_paused_atã‚’nullã«è¨­å®šã—ã€charge_started_atã‚’èª¿æ•´ï¼‰
    const { data: updatedSession, error: updateError } = await supabase
      .from('sessions')
      .update({
        charge_paused_at: null,
        charge_started_at: newStartTime.toISOString(), // èª¿æ•´å¾Œã®æ–°ã—ã„é–‹å§‹æ™‚é–“
      })
      .eq('session_id', session_id)
      .select()
      .single();

    if (updateError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'èª²é‡‘ã®å†é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      message: 'èª²é‡‘ã‚’å†é–‹ã—ã¾ã—ãŸ',
      session: updatedSession,
    });
  } catch (error) {
    console.error('èª²é‡‘å†é–‹ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/tables/[table_id]/sessions/[session_id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ table_id: string; session_id: string }> }
) {
  try {
    const { table_id, session_id } = await params;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
    const data = await request.json();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const { data: existingSession, error: sessionError } = await supabase
      .from('sessions')
      .select('*')
      .eq('session_id', session_id)
      .eq('table_id', table_id)
      .single();

    if (sessionError || !existingSession) {
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ›´æ–°ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æº–å‚™
    const updateData: any = {};

    // charge_started_atã®æ›´æ–°
    if (data.charge_started_at !== undefined) {
      updateData.charge_started_at = data.charge_started_at;
    }

    // selected_cast_idã®æ›´æ–°
    if (data.selected_cast_id !== undefined) {
      updateData.selected_cast_id = data.selected_cast_id;
    }

    // is_new_customerã®æ›´æ–°
    if (data.is_new_customer !== undefined) {
      updateData.is_new_customer = data.is_new_customer;
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
    const { data: updatedSession, error: updateError } = await supabase
      .from('sessions')
      .update(updateData)
      .eq('session_id', session_id)
      .select()
      .single();

    if (updateError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      session_id: updatedSession.session_id,
      table_id: updatedSession.table_id,
      store_id: updatedSession.store_id,
      start_at: updatedSession.start_at,
      charge_started_at: updatedSession.charge_started_at,
      selected_cast_id: updatedSession.selected_cast_id,
      is_new_customer: updatedSession.is_new_customer
    });
  } catch (error) {
    console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/tables/[table_id]/sessions/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ table_id: string }> }
) {
  try {
    const { table_id } = await params;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—ã—ã¦åº—èˆ—IDã‚’ç‰¹å®š
    const { data: table, error: tableError } = await supabase
      .from('tables')
      .select('store_id')
      .eq('table_id', table_id)
      .single();

    if (tableError || !table) {
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆèª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¦ã„ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å„ªå…ˆï¼‰
    const { data: existingSession, error: sessionError } = await supabase
      .from('sessions')
      .select('*')
      .eq('table_id', table_id)
      .not('charge_started_at', 'is', null)
      .order('start_at', { ascending: false })
      .limit(1)
      .maybeSingle();

    // èª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¦ã„ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã¯ã€æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
    if (!existingSession) {
      const { data: latestSession, error: latestSessionError } = await supabase
        .from('sessions')
        .select('*')
        .eq('table_id', table_id)
        .order('start_at', { ascending: false })
        .limit(1)
        .maybeSingle();

      if (latestSessionError) {
        console.error('æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', latestSessionError);
      } else if (latestSession) {
        return NextResponse.json(latestSession);
      }
    }

    if (sessionError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’è¿”ã™
    if (existingSession) {
      return NextResponse.json({
        session_id: existingSession.session_id,
        table_id: existingSession.table_id,
        store_id: existingSession.store_id,
        start_at: existingSession.start_at,
        charge_started_at: existingSession.charge_started_at,
        charge_paused_at: existingSession.charge_paused_at,
        selected_cast_id: existingSession.selected_cast_id,
        is_new_customer: existingSession.is_new_customer
      });
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
    const { data: newSession, error: createError } = await supabase
      .from('sessions')
      .insert({
        table_id,
        store_id: table.store_id,
        start_at: new Date().toISOString(),
      })
      .select()
      .single();

    if (createError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼:', createError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      session_id: newSession.session_id,
      table_id: newSession.table_id,
      store_id: newSession.store_id,
      start_at: newSession.start_at,
      charge_started_at: newSession.charge_started_at,
      charge_paused_at: newSession.charge_paused_at,
      selected_cast_id: newSession.selected_cast_id,
      is_new_customer: newSession.is_new_customer
    });
  } catch (error) {
    console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/tables/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';
import { cookies } from 'next/headers';

export async function POST(request: NextRequest) {
  try {
    // URLã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
    const url = new URL(request.url);
    const storeIdFromQuery = url.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.name || !data.seat_type_id) {
      return NextResponse.json(
        { error: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™' },
        { status: 400 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
    const { data: newTable, error: createError } = await supabase
      .from('tables')
      .insert({
        name: data.name,
        seat_type_id: data.seat_type_id,
        store_id: storeId
      })
      .select()
      .single();

    if (createError) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼:', createError);
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(newTable, { status: 201 });
  } catch (error) {
    console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function GET(request: NextRequest) {
  try {
    // URLã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
    const url = new URL(request.url);
    const storeIdFromQuery = url.searchParams.get('storeId');

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰Cookieã‚’å–å¾—
    const requestCookies = request.headers.get('cookie');


    // Cookieã‚¹ãƒˆã‚¢ã‹ã‚‰ã‚‚å–å¾—ï¼ˆæ¯”è¼ƒç”¨ï¼‰
    const cookieStore = await cookies();
    const storeIdFromStore = cookieStore.get('store-id')?.value;
    const storeIdFromStoreLegacy = cookieStore.get('storeId')?.value;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰store-idã‚’æŠ½å‡º
    const storeIdMatch = requestCookies?.match(/store-id=([^;]+)/);
    const storeIdFromHeader = storeIdMatch ? storeIdMatch[1] : null;

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰storeIdã‚’æŠ½å‡ºï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼ï¼‰
    const storeIdLegacyMatch = requestCookies?.match(/storeId=([^;]+)/);
    const storeIdLegacyFromHeader = storeIdLegacyMatch ? storeIdLegacyMatch[1] : null;



    // å„ªå…ˆé †ä½: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ > ãƒ˜ãƒƒãƒ€ãƒ¼ > Cookieã‚¹ãƒˆã‚¢ã€æ–°å½¢å¼ > ãƒ¬ã‚¬ã‚·ãƒ¼å½¢å¼
    const storeId = storeIdFromQuery || storeIdFromHeader || storeIdLegacyFromHeader || storeIdFromStore || storeIdFromStoreLegacy;

    const allCookies = cookieStore.getAll();

    if (!storeId) {
      console.error('GET /api/tables: åº—èˆ—IDãŒCookieã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }



    const supabase = await createServerSupabaseClient();

    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å–å¾—
    const { data: tables, error: tablesError } = await supabase
      .from('tables')
      .select(`
        table_id,
        name,
        seat_types (
          seat_type_id,
          display_name,
          price_per_unit
        )
      `)
      .eq('store_id', storeId)
      .order('name');

    if (tablesError) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', tablesError);
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(tables);
  } catch (error) {
    console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/upload/menu-image/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient, createServerComponentClient } from '@/lib/supabase';
import { getUserRoleInStore } from '@/lib/auth';
import { v4 as uuidv4 } from 'uuid';

export async function POST(request: NextRequest) {
  try {
    const cookieStore = await cookies();
    const storeId = cookieStore.get('store-id')?.value;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // èªè¨¼ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
    const authClient = await createServerComponentClient();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user } } = await authClient.auth.getUser();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    if (!user) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
    const userRole = await getUserRoleInStore(user.id, storeId);

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (userRole !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // FormDataã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    const formData = await request.formData();
    const file = formData.get('file') as File;

    if (!file) {
      return NextResponse.json(
        { error: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
      return NextResponse.json(
        { error: 'è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚JPEGã€PNGã€WebPã€GIFå½¢å¼ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚' },
        { status: 400 }
      );
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®æ¤œè¨¼ï¼ˆ5MBä»¥ä¸‹ï¼‰
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
      return NextResponse.json(
        { error: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚5MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚' },
        { status: 400 }
      );
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«åã®ç”Ÿæˆï¼ˆUUIDã‚’ä½¿ç”¨ã—ã¦ä¸€æ„æ€§ã‚’ä¿è¨¼ï¼‰
    const fileExtension = file.name.split('.').pop();
    const uuid = uuidv4();
    const fileName = `${storeId}/${uuid}.${fileExtension}`;

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ArrayBufferã«å¤‰æ›
    const arrayBuffer = await file.arrayBuffer();
    const fileBuffer = new Uint8Array(arrayBuffer);

    // ãƒã‚±ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª
    const { data: buckets } = await supabase
      .storage
      .listBuckets();

    const bucketExists = buckets?.some(bucket => bucket.name === 'menu-images');

    // ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    if (!bucketExists) {
      console.log('ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚ä½œæˆã—ã¾ã™: menu-images');
      const { error: createBucketError } = await supabase
        .storage
        .createBucket('menu-images', {
          public: true,
          fileSizeLimit: 5 * 1024 * 1024, // 5MB
          allowedMimeTypes: ['image/jpeg', 'image/png', 'image/webp', 'image/gif']
        });

      if (createBucketError) {
        console.error('ãƒã‚±ãƒƒãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', createBucketError);
        return NextResponse.json(
          { error: `ãƒã‚±ãƒƒãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${createBucketError.message}` },
          { status: 500 }
        );
      }

      // æ³¨æ„: RLSãƒãƒªã‚·ãƒ¼ã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã§ã‚‚è‡ªå‹•è¨­å®šã§ããªã„ãŸã‚ã€
      // Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æ‰‹å‹•ã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
      console.log('ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚RLSãƒãƒªã‚·ãƒ¼ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚');
    }

    // Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    const { data, error } = await supabase
      .storage
      .from('menu-images')
      .upload(fileName, fileBuffer, {
        contentType: file.type,
        upsert: true
      });

    if (error) {
      console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: `ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}` },
        { status: 500 }
      );
    }

    // å…¬é–‹URLã‚’å–å¾—
    const { data: { publicUrl } } = supabase
      .storage
      .from('menu-images')
      .getPublicUrl(fileName);

    return NextResponse.json({ url: publicUrl });
  } catch (error) {
    console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;
</file>

<file path="app/layout.tsx">
import './globals.css';
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'QRã‚ªãƒ¼ãƒ€ãƒ¼ & ä¼šè¨ˆé€£æºã‚·ã‚¹ãƒ†ãƒ ',
  description: 'ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼å‘ã‘QRã‚ªãƒ¼ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja" suppressHydrationWarning>
      <body>{children}</body>
    </html>
  );
}
</file>

<file path="app/login/[store_code]/login-form.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { useState } from 'react';

// ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‹å®šç¾©
type LoginActionResult = 
  | { error: string }
  | { success: true; redirectTo: string };

// ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export default function LoginForm({ 
  storeCode, 
  storeName,
  loginAction
}: { 
  storeCode: string; 
  storeName: string;
  loginAction: (formData: FormData) => Promise<LoginActionResult>;
}) {
  const router = useRouter();
  const [error, setError] = useState<string | null>(null);
  
  const handleSubmit = async (formData: FormData) => {
    const result = await loginAction(formData);
    
    if ('error' in result) {
      setError(result.error);
    } else if (result.success && result.redirectTo) {
      router.push(result.redirectTo);
    }
  };
  
  return (
    <div className="max-w-md mx-auto p-6 bg-white rounded-lg shadow-md">
      <h1 className="text-2xl font-bold mb-6 text-center">{storeName}</h1>
      
      {error && (
        <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-md">
          {error}
        </div>
      )}
      
      <form action={handleSubmit}>
        <input type="hidden" name="store_code" value={storeCode} />
        
        <div className="mb-4">
          <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            className="w-full px-3 py-2 border border-gray-300 rounded-md"
          />
        </div>
        
        <div className="mb-6">
          <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            className="w-full px-3 py-2 border border-gray-300 rounded-md"
          />
        </div>
        
        <button
          type="submit"
          className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
        >
          ãƒ­ã‚°ã‚¤ãƒ³
        </button>
      </form>
    </div>
  );
}
</file>

<file path="app/login/[store_code]/page.tsx">
import { getStoreByCode } from '@/lib/auth';
import { redirect } from 'next/navigation';
import LoginForm from './login-form';

// ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
async function loginAction(formData: FormData) {
  'use server';

  try {
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;
    const storeCode = formData.get('store_code') as string;

    if (!email || !password || !storeCode) {
      return { error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€åº—èˆ—ã‚³ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™' };
    }

    // APIã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ
    const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        email,
        password,
        storeCode,
      }),
    });

    const result = await response.json();

    if (!response.ok) {
      console.error('Login error details:', result.error);
      return { error: result.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ' };
    }

    console.log('Login successful');

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    return { success: true as const, redirectTo: '/portal/dashboard' };
  } catch (error) {
    console.error('Login error:', error);
    return { error: 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' };
  }
}

// ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export default async function LoginPage({ params }: { params: Promise<{ store_code: string }> }) {
  const { store_code } = await params;

  // åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åº—èˆ—æƒ…å ±ã‚’å–å¾—
  const store = await getStoreByCode(store_code);

  // åº—èˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (!store) {
    redirect('/');
  }

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
      <div className="sm:mx-auto sm:w-full sm:max-w-md">
        <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
          {store.name}
        </h2>
        <p className="mt-2 text-center text-sm text-gray-600">
          ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³
        </p>
      </div>

      <div className="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
        <LoginForm
          storeCode={store_code}
          storeName={store.name}
          loginAction={loginAction}
        />
      </div>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/cart-context.tsx">
'use client';

import { createContext, useContext, useState, ReactNode, useEffect } from 'react';

// ã‚«ãƒ¼ãƒˆå†…ã®å•†å“ã‚¢ã‚¤ãƒ†ãƒ ã®å‹å®šç¾©
export interface CartItem {
  menu_id: string;
  product_id: string;
  name: string;
  price: number;
  quantity: number;
  target_cast_id?: string | null;
  target_cast_name?: string;
}

// ã‚«ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å‹å®šç¾©
interface CartContextType {
  items: CartItem[];
  addItem: (item: Omit<CartItem, 'quantity'>, quantity?: number) => void;
  removeItem: (menu_id: string, target_cast_id?: string | null) => void;
  updateQuantity: (menu_id: string, quantity: number, target_cast_id?: string | null) => void;
  updateTargetCast: (menu_id: string, cast_id: string, cast_name: string) => void;
  clearCart: () => void;
  totalItems: number;
  totalPrice: number;
}

// ã‚«ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä½œæˆ
const CartContext = createContext<CartContextType | undefined>(undefined);

// ã‚«ãƒ¼ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export function CartProvider({ children, table_id }: { children: ReactNode, table_id: string }) {
  // ã‚«ãƒ¼ãƒˆå†…ã®å•†å“ã‚¢ã‚¤ãƒ†ãƒ ã®çŠ¶æ…‹
  const [items, setItems] = useState<CartItem[]>([]);

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚«ãƒ¼ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã‚€
  useEffect(() => {
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ã¿å®Ÿè¡Œ
    if (typeof window !== 'undefined') {
      const storedCart = localStorage.getItem(`cart_${table_id}`);
      if (storedCart) {
        try {
          const parsedCart = JSON.parse(storedCart);
          setItems(parsedCart);
        } catch (error) {
          console.error('ã‚«ãƒ¼ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
      }
    }
  }, [table_id]);

  // ã‚«ãƒ¼ãƒˆæƒ…å ±ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
  useEffect(() => {
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ã¿å®Ÿè¡Œ
    if (typeof window !== 'undefined' && items.length > 0) {
      localStorage.setItem(`cart_${table_id}`, JSON.stringify(items));
    } else if (typeof window !== 'undefined') {
      localStorage.removeItem(`cart_${table_id}`);
    }
  }, [items, table_id]);

  // ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
  const addItem = (item: Omit<CartItem, 'quantity'>, quantity = 1) => {
    setItems(prevItems => {
      // æ—¢ã«åŒã˜å•†å“ãŒã‚«ãƒ¼ãƒˆã«ã‚ã‚‹ã‹ç¢ºèª
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼IDã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ£ã‚¹ãƒˆIDã®ä¸¡æ–¹ã§ä¸€è‡´ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢
      const existingItemIndex = prevItems.findIndex(i => {
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼IDãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
        if (i.menu_id !== item.menu_id) return false;

        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ£ã‚¹ãƒˆIDã®æ¯”è¼ƒ
        // ä¸¡æ–¹ã¨ã‚‚nullã®å ´åˆ
        if (i.target_cast_id === null && item.target_cast_id === null) return true;

        // ä¸¡æ–¹ã¨ã‚‚æ–‡å­—åˆ—ã§åŒã˜å€¤ã®å ´åˆ
        if (typeof i.target_cast_id === 'string' && typeof item.target_cast_id === 'string') {
          return i.target_cast_id === item.target_cast_id;
        }

        // ãã‚Œä»¥å¤–ã®å ´åˆã¯ä¸€è‡´ã—ãªã„
        return false;
      });

      if (existingItemIndex >= 0) {
        // æ—¢å­˜ã®å•†å“ã®æ•°é‡ã‚’å¢—ã‚„ã™
        const currentQuantity = prevItems[existingItemIndex].quantity;

        // æ–°ã—ã„é…åˆ—ã‚’ä½œæˆ
        const updatedItems = [...prevItems];

        // æŒ‡å®šã•ã‚ŒãŸæ•°é‡ã‚’è¿½åŠ 
        updatedItems[existingItemIndex] = {
          ...prevItems[existingItemIndex],
          quantity: currentQuantity + quantity
        };

        return updatedItems;
      } else {
        // æ–°ã—ã„å•†å“ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
        return [...prevItems, { ...item, quantity }];
      }
    });
  };

  // ã‚«ãƒ¼ãƒˆã‹ã‚‰å•†å“ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
  const removeItem = (menu_id: string, target_cast_id?: string | null) => {
    setItems(prevItems => prevItems.filter(item => {
      // menu_idãŒä¸€è‡´ã—ãªã„å ´åˆã¯æ®‹ã™
      if (item.menu_id !== menu_id) return true;

      // target_cast_idãŒæ–‡å­—åˆ—ã®å ´åˆã¯ã€ãã‚Œã‚‚ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿å‰Šé™¤
      if (typeof target_cast_id === 'string') {
        return item.target_cast_id !== target_cast_id;
      }

      // target_cast_idãŒnullã®å ´åˆã¯ã€item.target_cast_idãŒnullã®å•†å“ã®ã¿å‰Šé™¤
      if (target_cast_id === null) {
        return item.target_cast_id !== null;
      }

      // target_cast_idãŒundefinedã®å ´åˆã¯ã€ã™ã¹ã¦ã®item.target_cast_idã‚’å‰Šé™¤ï¼ˆå¤ã„å‹•ä½œã¨ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
      return false;
    }));
  };

  // å•†å“ã®æ•°é‡ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  const updateQuantity = (menu_id: string, quantity: number, target_cast_id?: string | null) => {
    if (quantity <= 0) {
      removeItem(menu_id, target_cast_id);
      return;
    }

    setItems(prevItems =>
      prevItems.map(item => {
        // menu_idãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
        if (item.menu_id !== menu_id) return item;

        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ£ã‚¹ãƒˆIDã®æ¯”è¼ƒ
        // ä¸¡æ–¹ã¨ã‚‚nullã®å ´åˆ
        if (item.target_cast_id === null && target_cast_id === null) {
          return { ...item, quantity };
        }

        // ä¸¡æ–¹ã¨ã‚‚æ–‡å­—åˆ—ã§åŒã˜å€¤ã®å ´åˆ
        if (typeof item.target_cast_id === 'string' && typeof target_cast_id === 'string') {
          if (item.target_cast_id === target_cast_id) {
            return { ...item, quantity };
          }
        }

        // target_cast_idãŒundefinedã®å ´åˆã¯ã€item.target_cast_idãŒnullã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°ï¼ˆå¤ã„å‹•ä½œã¨ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
        if (target_cast_id === undefined && item.target_cast_id === null) {
          return { ...item, quantity };
        }

        return item;
      })
    );
  };



  // ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
  const clearCart = () => {
    setItems([]);
  };

  // ã‚«ãƒ¼ãƒˆå†…ã®å•†å“ã®åˆè¨ˆæ•°
  const totalItems = items.reduce((total, item) => total + item.quantity, 0);

  // ã‚«ãƒ¼ãƒˆå†…ã®å•†å“ã®åˆè¨ˆé‡‘é¡
  const totalPrice = items.reduce((total, item) => total + (item.price * item.quantity), 0);

  // ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ£ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  const updateTargetCast = (menu_id: string, cast_id: string, cast_name: string) => {
    setItems(prevItems =>
      prevItems.map(item =>
        item.menu_id === menu_id
          ? { ...item, target_cast_id: cast_id, target_cast_name: cast_name }
          : item
      )
    );
  };

  // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å€¤
  const value = {
    items,
    addItem,
    removeItem,
    updateQuantity,
    updateTargetCast,
    clearCart,
    totalItems,
    totalPrice
  };

  return (
    <CartContext.Provider value={value}>
      {children}
    </CartContext.Provider>
  );
}

// ã‚«ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ãƒ•ãƒƒã‚¯
export function useCart() {
  const context = useContext(CartContext);
  if (context === undefined) {
    throw new Error('useCart must be used within a CartProvider');
  }
  return context;
}
</file>

<file path="app/menu/[table_id]/cart-display.tsx">
'use client';

import { useState } from 'react';
import { useCart, CartItem } from './cart-context';

interface CartDisplayProps {
  sessionId: string;
  tableId: string;
}

export default function CartDisplay({ sessionId, tableId }: CartDisplayProps) {
  const { items, removeItem, updateQuantity, clearCart, totalItems, totalPrice } = useCart();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [orderSuccess, setOrderSuccess] = useState(false);
  const [orderError, setOrderError] = useState<string | null>(null);

  // æ³¨æ–‡ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
  const submitOrder = async () => {
    if (items.length === 0) return;

    setIsSubmitting(true);
    setOrderError(null);

    try {
      // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
      const orderData = {
        session_id: sessionId,
        table_id: tableId,
        items: items.map(item => ({
          menu_id: item.menu_id,
          product_id: item.product_id,
          name: item.name,
          price: item.price,
          quantity: item.quantity,
          target_cast_id: item.target_cast_id
        }))
      };

      // æ³¨æ–‡APIã‚’å‘¼ã³å‡ºã—
      const response = await fetch('/api/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'æ³¨æ–‡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // æ³¨æ–‡æˆåŠŸ
      setOrderSuccess(true);

      // ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
      clearCart();

      // 2ç§’å¾Œã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
      setTimeout(() => {
        setOrderSuccess(false);
      }, 2000);

    } catch (err) {
      setOrderError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', err);
    } finally {
      setIsSubmitting(false);
    }
  };

  // æ•°é‡å¤‰æ›´ãƒœã‚¿ãƒ³
  const QuantityControl = ({ item }: { item: CartItem }) => (
    <div className="flex items-center">
      <button
        type="button"
        className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center"
        onClick={() => updateQuantity(item.menu_id, item.quantity - 1)}
      >
        <span>-</span>
      </button>
      <span className="mx-2">{item.quantity}</span>
      <button
        type="button"
        className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center"
        onClick={() => updateQuantity(item.menu_id, item.quantity + 1)}
      >
        <span>+</span>
      </button>
    </div>
  );

  if (orderSuccess) {
    return (
      <div className="text-center py-8">
        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
          <p>æ³¨æ–‡ãŒå®Œäº†ã—ã¾ã—ãŸï¼</p>
        </div>
      </div>
    );
  }

  if (items.length === 0) {
    return (
      <div className="text-center text-gray-500 py-8">
        ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
      </div>
    );
  }

  return (
    <div>
      {orderError && (
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
          <p>{orderError}</p>
        </div>
      )}

      <div className="divide-y">
        {items.map((item) => (
          <div key={item.menu_id} className="py-4 flex justify-between items-center">
            <div className="flex-1">
              <h3 className="text-lg font-medium">{item.name}</h3>
              <p className="text-sm text-gray-500">
                {item.price.toLocaleString()}å†† Ã— {item.quantity}
              </p>
              {item.target_cast_name && (
                <p className="text-sm text-blue-600">
                  {item.target_cast_name}ã«å¥¢ã‚‹
                </p>
              )}

            </div>

            <div className="flex items-center space-x-4">
              <QuantityControl item={item} />

              <button
                type="button"
                className="text-red-500"
                onClick={() => removeItem(item.menu_id)}
              >
                <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
        ))}
      </div>

      <div className="mt-6 border-t pt-4">
        <div className="flex justify-between mb-2">
          <span>å°è¨ˆ ({totalItems}ç‚¹)</span>
          <span>{totalPrice.toLocaleString()}å††</span>
        </div>

        <div className="mt-6 text-center">
          <button
            type="button"
            className={`bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 w-full ${
              isSubmitting ? 'opacity-50 cursor-not-allowed' : ''
            }`}
            onClick={submitOrder}
            disabled={isSubmitting}
          >
            {isSubmitting ? 'å‡¦ç†ä¸­...' : 'æ³¨æ–‡ã™ã‚‹'}
          </button>
          <p className="mt-2 text-sm text-gray-500">
            æ³¨æ–‡å¾Œã€å³å´ã®ä¼šè¨ˆç”»é¢ã‹ã‚‰ä¼šè¨ˆå‡¦ç†ãŒã§ãã¾ã™
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/cart-modal.tsx">
'use client';

import { useState } from 'react';
import Modal from './modal';
import { useCart, CartItem } from './cart-context';

interface CartModalProps {
  isOpen: boolean;
  onClose: () => void;
  sessionId: string;
  tableId: string;
}

export default function CartModal({
  isOpen,
  onClose,
  sessionId,
  tableId
}: CartModalProps) {
  const { items, removeItem, updateQuantity, clearCart, totalItems, totalPrice } = useCart();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [orderSuccess, setOrderSuccess] = useState(false);
  const [orderError, setOrderError] = useState<string | null>(null);

  // æ³¨æ–‡ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
  const submitOrder = async () => {
    if (items.length === 0) return;

    setIsSubmitting(true);
    setOrderError(null);

    try {
      // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
      const orderData = {
        session_id: sessionId,
        table_id: tableId,
        items: items.map(item => ({
          menu_id: item.menu_id,
          product_id: item.product_id,
          name: item.name,
          price: item.price,
          quantity: item.quantity,
          target_cast_id: item.target_cast_id
        }))
      };

      // æ³¨æ–‡APIã‚’å‘¼ã³å‡ºã—
      const response = await fetch('/api/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'æ³¨æ–‡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // æ³¨æ–‡æˆåŠŸ
      setOrderSuccess(true);

      // ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
      clearCart();

      // 2ç§’å¾Œã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
      setTimeout(() => {
        setOrderSuccess(false);
        onClose(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      }, 2000);

    } catch (err) {
      setOrderError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', err);
    } finally {
      setIsSubmitting(false);
    }
  };

  // æ•°é‡å¤‰æ›´ãƒœã‚¿ãƒ³
  const QuantityControl = ({ item }: { item: CartItem }) => (
    <div className="flex items-center">
      <button
        type="button"
        className="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 active:bg-gray-400 focus:bg-gray-200 flex items-center justify-center focus:outline-none"
        onClick={() => updateQuantity(item.menu_id, item.quantity - 1, item.target_cast_id || null)}
      >
        <span>-</span>
      </button>
      <span className="mx-2">{item.quantity}</span>
      <button
        type="button"
        className="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 active:bg-gray-400 focus:bg-gray-200 flex items-center justify-center focus:outline-none"
        onClick={() => updateQuantity(item.menu_id, item.quantity + 1, item.target_cast_id || null)}
      >
        <span>+</span>
      </button>
    </div>
  );

  const cartContent = () => {
    if (orderSuccess) {
      return (
        <div className="text-center py-8">
          <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
            <p>æ³¨æ–‡ãŒå®Œäº†ã—ã¾ã—ãŸï¼</p>
          </div>
        </div>
      );
    }

    if (items.length === 0) {
      return (
        <div className="text-center text-gray-500 py-8">
          ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
        </div>
      );
    }

    return (
      <div>
        {orderError && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <p>{orderError}</p>
          </div>
        )}

        <div className="divide-y">
          {items.map((item) => (
            <div key={`${item.menu_id}-${item.target_cast_id || 'self'}`} className="py-4 flex justify-between items-center">
              <div className="flex-1">
                <h3 className="text-lg font-medium">{item.name}</h3>
                <p className="text-sm text-gray-500">
                  {item.price.toLocaleString()}å†† Ã— {item.quantity}
                </p>
                {item.target_cast_name && (
                  <p className="text-sm text-blue-600">
                    {item.target_cast_name}ã«å¥¢ã‚‹
                  </p>
                )}
              </div>

              <div className="flex items-center space-x-4">
                <QuantityControl item={item} />

                <button
                  type="button"
                  className="text-red-500 hover:text-red-600 active:text-red-700 focus:text-red-500 focus:outline-none"
                  onClick={() => removeItem(item.menu_id, item.target_cast_id || null)}
                >
                  <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </div>
          ))}
        </div>

        <div className="mt-6 border-t pt-4">
          <div className="flex justify-between mb-2">
            <span>å°è¨ˆ ({totalItems}ç‚¹)</span>
            <span>{totalPrice.toLocaleString()}å††</span>
          </div>

          <div className="mt-6 text-center">
            <button
              type="button"
              className={`bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 active:bg-blue-800 focus:bg-blue-600 focus:outline-none w-full ${
                isSubmitting ? 'opacity-50 cursor-not-allowed' : ''
              }`}
              onClick={submitOrder}
              disabled={isSubmitting}
            >
              {isSubmitting ? 'å‡¦ç†ä¸­...' : 'æ³¨æ–‡ã™ã‚‹'}
            </button>
            <p className="mt-2 text-sm text-gray-500">
              æ³¨æ–‡å¾Œã€ãŠä¼šè¨ˆãƒœã‚¿ãƒ³ã‹ã‚‰ä¼šè¨ˆå‡¦ç†ãŒã§ãã¾ã™
            </p>
          </div>
        </div>
      </div>
    );
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title="æ³¨æ–‡ã‚«ãƒ¼ãƒˆ"
      maxWidth="max-w-lg"
    >
      {cartContent()}
    </Modal>
  );
}
</file>

<file path="app/menu/[table_id]/cast-select-modal.tsx">
'use client';

import { useState, useEffect } from 'react';

interface Cast {
  id: string;
  user_id: string;
  display_name: string;
}

interface CastSelectModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSelect: (castId: string, castName: string) => void;
  storeId: string;
}

export default function CastSelectModal({ isOpen, onClose, onSelect, storeId }: CastSelectModalProps) {
  const [casts, setCasts] = useState<Cast[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’å–å¾—
  useEffect(() => {
    if (!isOpen) return;

    const fetchCasts = async () => {
      setLoading(true);
      setError(null);
      
      try {
        const response = await fetch(`/api/casts?store_id=${storeId}`);
        
        if (!response.ok) {
          throw new Error('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const data = await response.json();
        setCasts(data);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        console.error('ã‚­ãƒ£ã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchCasts();
  }, [isOpen, storeId]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-semibold">ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ</h2>
          <button
            type="button"
            className="text-gray-400 hover:text-gray-500"
            onClick={onClose}
          >
            <span className="sr-only">é–‰ã˜ã‚‹</span>
            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {loading ? (
          <div className="py-8 text-center">
            <p className="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        ) : error ? (
          <div className="py-8 text-center">
            <p className="text-red-500">{error}</p>
            <button
              type="button"
              className="mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
              onClick={onClose}
            >
              é–‰ã˜ã‚‹
            </button>
          </div>
        ) : casts.length === 0 ? (
          <div className="py-8 text-center">
            <p className="text-gray-500">ã‚­ãƒ£ã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            <button
              type="button"
              className="mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
              onClick={onClose}
            >
              é–‰ã˜ã‚‹
            </button>
          </div>
        ) : (
          <div className="mt-4 grid grid-cols-1 gap-4">
            {casts.map((cast) => (
              <button
                key={cast.id}
                className="flex items-center p-3 border rounded-lg hover:bg-gray-50"
                onClick={() => onSelect(cast.user_id, cast.display_name)}
              >
                <div className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                  <span className="text-gray-500 text-sm">{cast.display_name.charAt(0)}</span>
                </div>
                <div className="flex-1 text-left">
                  <p className="font-medium">{cast.display_name}</p>
                </div>
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/cast-selection.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';

interface Cast {
  id: string;
  user_id: string;
  display_name: string;
}

interface CastSelectionProps {
  isOpen: boolean;
  onClose: () => void;
  tableId: string;
  sessionId: string;
  storeId: string;
}

export default function CastSelection({
  isOpen,
  onClose,
  tableId,
  sessionId,
  storeId
}: CastSelectionProps) {
  const [casts, setCasts] = useState<Cast[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const router = useRouter();

  // ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’å–å¾—
  useEffect(() => {
    if (!isOpen) return;

    const fetchCasts = async () => {
      setLoading(true);
      setError(null);

      try {
        const response = await fetch(`/api/casts?store_id=${storeId}`);

        if (!response.ok) {
          throw new Error('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();
        setCasts(data);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        console.error('ã‚­ãƒ£ã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchCasts();
  }, [isOpen, storeId]);

  // ã‚­ãƒ£ã‚¹ãƒˆé¸æŠå‡¦ç†
  const handleCastSelect = async (castId: string) => {
    try {
      setIsSubmitting(true);
      setError(null);

      // æŒ‡åã‚­ãƒ£ã‚¹ãƒˆã‚’è¨˜éŒ²
      const response = await fetch(`/api/tables/${tableId}/sessions/${sessionId}/`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          selected_cast_id: castId,
          is_new_customer: false,
        }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'æŒ‡åã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ç”»é¢ã‚’æ›´æ–°
      onClose();
      router.refresh();
    } catch (err) {
      console.error('ã‚­ãƒ£ã‚¹ãƒˆé¸æŠã‚¨ãƒ©ãƒ¼:', err);
      setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-semibold">ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ</h2>
          <button
            type="button"
            className="text-gray-400 hover:text-gray-500"
            onClick={onClose}
          >
            <span className="sr-only">é–‰ã˜ã‚‹</span>
            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
            {error}
          </div>
        )}

        {loading ? (
          <div className="py-8 text-center">
            <p className="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        ) : casts.length === 0 ? (
          <div className="py-8 text-center">
            <p className="text-gray-500">ã‚­ãƒ£ã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            <button
              type="button"
              className="mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
              onClick={onClose}
            >
              é–‰ã˜ã‚‹
            </button>
          </div>
        ) : (
          <div className="mt-4 grid grid-cols-1 gap-4">
            {casts.map((cast) => (
              <button
                key={cast.id}
                className="flex items-center p-3 border rounded-lg hover:bg-gray-50"
                onClick={() => handleCastSelect(cast.user_id)}
                disabled={isSubmitting}
              >
                <div className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                  <span className="text-gray-500 text-sm">{cast.display_name.charAt(0)}</span>
                </div>
                <div className="flex-1 text-left">
                  <p className="font-medium">{cast.display_name}</p>
                </div>
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/checkout-complete.tsx">
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';

interface CheckoutCompleteProps {
  storeName: string;
  tableName: string;
  totalAmount: number;
  subtotalAmount?: number;
  taxAmount?: number;
  taxRate?: number;
}

export default function CheckoutComplete({
  storeName,
  tableName,
  totalAmount,
  subtotalAmount = 0,
  taxAmount = 0,
  taxRate = 10.0
}: CheckoutCompleteProps) {
  const router = useRouter();

  // 30ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åˆæœŸç”»é¢ã«æˆ»ã‚‹
  useEffect(() => {
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ã¿å®Ÿè¡Œ
    if (typeof window !== 'undefined') {


      const timer = setTimeout(() => {

        // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
        window.location.href = window.location.pathname;
      }, 30000);

      return () => clearTimeout(timer);
    }
  }, [storeName, tableName, totalAmount]);

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4">
      <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
        <h1 className="text-2xl font-bold text-green-600 mb-6">
          ãŠä¼šè¨ˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ
        </h1>

        <div className="mb-6">
          <p className="text-gray-700 mb-2">
            {storeName}
          </p>
          <p className="text-gray-700 mb-4">
            ãƒ†ãƒ¼ãƒ–ãƒ«: {tableName}
          </p>

          <div className="mt-4 text-left">
            <div className="flex justify-between mb-1">
              <span className="text-gray-600">å°è¨ˆï¼ˆç¨æŠœï¼‰:</span>
              <span className="text-gray-600">{subtotalAmount.toLocaleString()}å††</span>
            </div>
            <div className="flex justify-between mb-1">
              <span className="text-gray-600">æ¶ˆè²»ç¨ï¼ˆ{taxRate}%ï¼‰:</span>
              <span className="text-gray-600">{taxAmount.toLocaleString()}å††</span>
            </div>
            <div className="flex justify-between text-xl font-semibold mt-2">
              <span>åˆè¨ˆé‡‘é¡ï¼ˆç¨è¾¼ï¼‰:</span>
              <span>{totalAmount.toLocaleString()}å††</span>
            </div>
          </div>
        </div>

        <div className="border-t border-gray-200 pt-6">
          <p className="text-gray-500 text-sm mb-4">
            ã¾ãŸã®ã”æ¥åº—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚
          </p>
          <p className="text-gray-400 text-xs">
            ã“ã®ç”»é¢ã¯30ç§’å¾Œã«è‡ªå‹•çš„ã«é–‰ã˜ã¾ã™ã€‚
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/checkout-display.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useCart } from './cart-context';
import { calculateElapsedMinutes, calculateCharge } from '@/lib/charge';

interface OrderItem {
  order_id: string;
  product_id: string;
  name: string;
  quantity: number;
  price: number;
  total: number;
  target_cast_id: string | null;
  target_cast_name: string | null;
}

interface CheckoutDisplayProps {
  sessionId: string;
  tableId: string;
  tableName: string;
  storeName: string;
  seatTypeName: string;
  pricePerHalfHour: number;
  chargeStartedAt: string | null;
  timeUnitMinutes?: number;
}

export default function CheckoutDisplay({
  sessionId,
  tableId,
  tableName,
  storeName,
  seatTypeName,
  pricePerHalfHour,
  chargeStartedAt,
  timeUnitMinutes = 30,
}: CheckoutDisplayProps) {
  const router = useRouter();
  const { clearCart } = useCart();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [checkoutSuccess, setCheckoutSuccess] = useState(false);
  const [checkoutError, setCheckoutError] = useState<string | null>(null);
  const [chargeAmount, setChargeAmount] = useState<number>(0);
  const [elapsedTime, setElapsedTime] = useState<string>('');
  const [checkoutData, setCheckoutData] = useState<any>(null);
  const [orderItems, setOrderItems] = useState<OrderItem[]>([]);
  const [orderTotalPrice, setOrderTotalPrice] = useState<number>(0);
  const [isLoadingOrders, setIsLoadingOrders] = useState<boolean>(true);



  // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã¨æœ€æ–°ã®æ–™é‡‘ã‚’å–å¾—
  useEffect(() => {
    const fetchData = async () => {
      try {
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        setIsLoadingOrders(true);
        const response = await fetch(`/api/sessions/${sessionId}/orders`);

        if (!response.ok) {
          throw new Error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();
        setOrderItems(data.orders);
        setOrderTotalPrice(data.totalPrice);

        // åˆæœŸè¡¨ç¤ºæ™‚ã«æœ€æ–°ã®æ–™é‡‘ã‚‚å–å¾—
        if (chargeStartedAt && sessionId) {
          console.log('åˆæœŸè¡¨ç¤ºæ™‚ã«æœ€æ–°ã®æ–™é‡‘ã‚’å–å¾—ã—ã¾ã™');
          await fetchChargeAmount();
        }
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        setIsLoadingOrders(false);
      }
    };

    if (sessionId) {
      fetchData();
    }
  }, [sessionId, chargeStartedAt]);

  // çµŒéæ™‚é–“ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  const updateElapsedTimeDisplay = () => {
    if (!chargeStartedAt) return;

    const startTime = new Date(chargeStartedAt);
    const now = new Date();

    // çµŒéæ™‚é–“ã‚’åˆ†å˜ä½ã§è¨ˆç®—
    const elapsedMinutes = calculateElapsedMinutes(startTime, now);

    // çµŒéæ™‚é–“ã®è¡¨ç¤ºå½¢å¼ã‚’è¨­å®š
    const hours = Math.floor(elapsedMinutes / 60);
    const minutes = elapsedMinutes % 60;
    const timeString = `${hours}æ™‚é–“${minutes}åˆ†`;

    setElapsedTime(timeString);
  };

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§æ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆAPIãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  const calculateClientSideCharge = () => {
    if (!chargeStartedAt) return 0;

    const startTime = new Date(chargeStartedAt);
    const now = new Date();

    // çµŒéæ™‚é–“ã‚’åˆ†å˜ä½ã§è¨ˆç®—
    const elapsedMinutes = calculateElapsedMinutes(startTime, now);

    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦æ–™é‡‘ã‚’è¨ˆç®—
    const charge = calculateCharge(elapsedMinutes, pricePerHalfHour, timeUnitMinutes);

    // è¨ˆç®—ã•ã‚ŒãŸæ–™é‡‘ã‚’è¨­å®š
    setChargeAmount(charge);

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    console.log('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—ã—ãŸæ–™é‡‘:', {
      startTime,
      now,
      elapsedMs: now.getTime() - startTime.getTime(),
      elapsedMinutes,
      pricePerHalfHour,
      timeUnitMinutes,
      charge
    });

    return charge;
  };

  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ­£ç¢ºãªæ–™é‡‘ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  const fetchChargeAmount = async () => {
    if (!chargeStartedAt || !sessionId) return 0;

    try {
      const response = await fetch(`/api/sessions/${sessionId}/calculate-charge`);

      if (!response.ok) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘å–å¾—ã‚¨ãƒ©ãƒ¼:', response.status);
        // APIãŒå¤±æ•—ã—ãŸå ´åˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—
        return calculateClientSideCharge();
      }

      const data = await response.json();
      console.log('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘å–å¾—æˆåŠŸ:', data);

      // å¸­ç§»å‹•æ–™é‡‘ã‚’å«ã‚€åˆè¨ˆæ–™é‡‘ã‚’è¨­å®š
      setChargeAmount(data.charge_amount || 0);

      // çµŒéæ™‚é–“ã®è¡¨ç¤ºå½¢å¼ã‚’è¨­å®šï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—ï¼‰
      updateElapsedTimeDisplay();

      return data.charge_amount || 0;
    } catch (error) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘å–å¾—ä¾‹å¤–:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—
      return calculateClientSideCharge();
    }
  };

  // ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ã‹ã‚‰çµŒéæ™‚é–“ã‚’è¨ˆç®—
  useEffect(() => {
    if (!chargeStartedAt || !sessionId) return;

    // åˆå›ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ–™é‡‘ã‚’å–å¾—
    fetchChargeAmount();

    // 1åˆ†ã”ã¨ã«å†è¨ˆç®—ï¼ˆçµŒéæ™‚é–“ã®è¡¨ç¤ºã®ã¿æ›´æ–°ã€æ–™é‡‘ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãªã„ï¼‰
    const interval = setInterval(updateElapsedTimeDisplay, 60 * 1000);

    return () => clearInterval(interval);
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [chargeStartedAt, pricePerHalfHour, timeUnitMinutes, sessionId]);

  // ä¼šè¨ˆå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
  const handleCheckout = async () => {
    if (orderItems.length === 0 && chargeAmount === 0) return;

    setIsSubmitting(true);
    setCheckoutError(null);

    try {
      // ä¼šè¨ˆå‡¦ç†ã®å‰ã«æœ€æ–°ã®æ–™é‡‘ã‚’å–å¾—
      console.log('ä¼šè¨ˆå‰ã«æœ€æ–°ã®æ–™é‡‘ã‚’å–å¾—ã—ã¾ã™');
      const latestChargeAmount = await fetchChargeAmount();
      console.log('æœ€æ–°ã®æ–™é‡‘:', latestChargeAmount);

      // æœ€æ–°ã®æ–™é‡‘ã‚’çŠ¶æ…‹ã«è¨­å®šï¼ˆè¡¨ç¤ºã‚’æ›´æ–°ï¼‰
      setChargeAmount(latestChargeAmount);

      // ä¼šè¨ˆAPIã‚’å‘¼ã³å‡ºã—
      const response = await fetch(`/api/checkout/${sessionId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          table_id: tableId,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const data = await response.json();
      setCheckoutData(data);

      // ä¼šè¨ˆæˆåŠŸ
      setCheckoutSuccess(true);
      clearCart();



      // ä¼šè¨ˆå®Œäº†ç”»é¢ã«é·ç§»ã™ã‚‹ãŸã‚ã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æº–å‚™
      // APIã‹ã‚‰è¿”ã•ã‚ŒãŸåˆè¨ˆé‡‘é¡ã‚’ä½¿ç”¨
      const params = new URLSearchParams({
        complete: 'true',
        total: data.total_amount.toString(), // APIã‹ã‚‰è¿”ã•ã‚ŒãŸåˆè¨ˆé‡‘é¡ã‚’ä½¿ç”¨
        store: storeName || 'ä¸æ˜ãªåº—èˆ—',
        table: tableName || 'ä¸æ˜ãªãƒ†ãƒ¼ãƒ–ãƒ«'
      });

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
      try {
        await fetch(`/api/sessions/${sessionId}`, {
          method: 'DELETE',
        });
      } catch (deleteError) {
        console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', deleteError);
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã«å¤±æ•—ã—ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
      }

      // 2ç§’å¾Œã«ä¼šè¨ˆå®Œäº†ç”»é¢ã«é·ç§»
      setTimeout(() => {
        window.location.href = `${window.location.pathname}?${params.toString()}`;
      }, 2000);
    } catch (error) {
      console.error('ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', error);
      setCheckoutError(error instanceof Error ? error.message : 'ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsSubmitting(false);
    }
  };

  // åˆè¨ˆé‡‘é¡ï¼ˆæ³¨æ–‡ + ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ï¼‰
  const totalAmount = orderTotalPrice + chargeAmount;

  return (
    <div className="bg-white rounded-lg shadow p-6">
      <h2 className="text-xl font-bold mb-4">ä¼šè¨ˆ</h2>

      {checkoutSuccess ? (
        <div className="bg-green-50 border border-green-200 text-green-700 p-4 rounded-md mb-4">
          ä¼šè¨ˆå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
        </div>
      ) : checkoutError ? (
        <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-md mb-4">
          {checkoutError}
        </div>
      ) : null}

      {pricePerHalfHour > 0 && (
        <div className="mb-6">
          <h3 className="font-semibold mb-2">ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘</h3>
          <div className="bg-gray-50 p-4 rounded-md">
            <div className="flex justify-between mb-2">
              <span>å¸­ç¨®:</span>
              <span>{seatTypeName}</span>
            </div>
            <div className="flex justify-between mb-2">
              <span>æ–™é‡‘:</span>
              <span>{pricePerHalfHour}å††/{timeUnitMinutes}åˆ†</span>
            </div>
            {chargeStartedAt && (
              <>
                <div className="flex justify-between mb-2">
                  <span>çµŒéæ™‚é–“:</span>
                  <span>{elapsedTime}</span>
                </div>
                <div className="flex justify-between font-semibold">
                  <span>ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘:</span>
                  <span>{chargeAmount.toLocaleString()}å††</span>
                </div>
              </>
            )}
          </div>
        </div>
      )}

      <div className="mb-6">
        <h3 className="font-semibold mb-2">æ³¨æ–‡æ˜ç´°</h3>
        {isLoadingOrders ? (
          <p className="text-gray-500">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        ) : orderItems.length > 0 ? (
          <div className="border-t border-gray-200">
            {orderItems.map((item, index) => (
              <div key={index} className="py-2 border-b border-gray-200 flex justify-between">
                <div>
                  <span className="font-medium">{item.name}</span>
                  {item.target_cast_name && (
                    <span className="ml-2 text-sm text-gray-500">
                      ({item.target_cast_name}ã¸)
                    </span>
                  )}
                  <span className="ml-2 text-sm text-gray-500">
                    Ã—{item.quantity}
                  </span>
                </div>
                <span>{item.total.toLocaleString()}å††</span>
              </div>
            ))}
          </div>
        ) : (
          <p className="text-gray-500 italic">æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</p>
        )}
      </div>

      <div className="border-t border-gray-200 pt-4">
        <div className="flex justify-between mb-2">
          <span>æ³¨æ–‡åˆè¨ˆ:</span>
          <span>{orderTotalPrice.toLocaleString()}å††</span>
        </div>
        {pricePerHalfHour > 0 && (
          <div className="flex justify-between mb-2">
            <span>ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘:</span>
            <span>{chargeAmount.toLocaleString()}å††</span>
          </div>
        )}
        <div className="flex justify-between font-bold text-lg">
          <span>åˆè¨ˆé‡‘é¡:</span>
          <span>{totalAmount.toLocaleString()}å††</span>
        </div>
      </div>

      <div className="mt-6">
        <button
          type="button"
          className={`bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 w-full ${
            isSubmitting ? 'opacity-50 cursor-not-allowed' : ''
          }`}
          onClick={handleCheckout}
          disabled={isSubmitting || (orderItems.length === 0 && chargeAmount === 0)}
        >
          {isSubmitting ? 'å‡¦ç†ä¸­...' : 'ä¼šè¨ˆã™ã‚‹'}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/checkout-modal.tsx">
'use client';

import { useState, useEffect } from 'react';
import Modal from './modal';
import { useCart } from './cart-context';
import { calculateElapsedMinutes, calculateCharge, calculateChargeWithPause } from '@/lib/charge';

interface OrderItem {
  order_id: string;
  product_id: string;
  name: string;
  quantity: number;
  price: number;
  total: number;
  target_cast_id: string | null;
  target_cast_name: string | null;
}

interface CheckoutModalProps {
  isOpen: boolean;
  onClose: () => void;
  sessionId: string;
  tableId: string;
  tableName: string;
  storeName: string;
  seatTypeName: string;
  pricePerHalfHour: number;
  chargeStartedAt: string | null;
  chargePausedAt?: string | null;
  timeUnitMinutes?: number;
}

export default function CheckoutModal({
  isOpen,
  onClose,
  sessionId,
  tableId,
  tableName,
  storeName,
  seatTypeName,
  pricePerHalfHour,
  chargeStartedAt,
  chargePausedAt,
  timeUnitMinutes = 30,
}: CheckoutModalProps) {
  const { clearCart } = useCart();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [checkoutSuccess, setCheckoutSuccess] = useState(false);
  const [checkoutError, setCheckoutError] = useState<string | null>(null);
  const [chargeAmount, setChargeAmount] = useState<number>(0);
  const [elapsedTime, setElapsedTime] = useState<string>('');
  const [checkoutData, setCheckoutData] = useState<any>(null);
  const [orderItems, setOrderItems] = useState<OrderItem[]>([]);
  const [orderTotalPrice, setOrderTotalPrice] = useState<number>(0);
  const [taxRate, setTaxRate] = useState<number>(10.0); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡10%
  const [taxAmount, setTaxAmount] = useState<number>(0);
  const [isLoadingOrders, setIsLoadingOrders] = useState<boolean>(true);

  // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã¨æœ€æ–°ã®æ–™é‡‘ã‚’å–å¾—
  useEffect(() => {
    const fetchData = async () => {
      if (!isOpen) return;

      try {
        // åº—èˆ—æƒ…å ±ã‚’å–å¾—ã—ã¦ç¨ç‡ã‚’è¨­å®š
        const storeResponse = await fetch(`/api/sessions/${sessionId}/store-info`);
        if (storeResponse.ok) {
          const storeData = await storeResponse.json();
          if (storeData.tax_rate !== undefined) {
            setTaxRate(storeData.tax_rate);
          }
        } else {
          console.error('åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', await storeResponse.text());
        }

        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹:', { sessionId });
        setIsLoadingOrders(true);
        const response = await fetch(`/api/sessions/${sessionId}/orders`);
        console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', { status: response.status, ok: response.ok });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorData);
          throw new Error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();
        console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', { orders: data.orders, totalPrice: data.totalPrice });
        setOrderItems(data.orders);
        setOrderTotalPrice(data.totalPrice);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚ŒãŸã¨ãã«æœ€æ–°ã®æ–™é‡‘ã‚‚å–å¾—
        if (chargeStartedAt && sessionId) {
          console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³æ™‚ã«æœ€æ–°ã®æ–™é‡‘ã‚’å–å¾—ã—ã¾ã™');
          await fetchChargeAmount();
        }
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        setIsLoadingOrders(false);
      }
    };

    if (sessionId && isOpen) {
      fetchData();
    }
  }, [sessionId, isOpen, chargeStartedAt]);

  // çµŒéæ™‚é–“ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  const updateElapsedTimeDisplay = () => {
    if (!chargeStartedAt) return;

    const startTime = new Date(chargeStartedAt);
    const now = new Date();
    const pauseTime = chargePausedAt ? new Date(chargePausedAt) : null;

    // çµŒéæ™‚é–“ã‚’åˆ†å˜ä½ã§è¨ˆç®—ï¼ˆä¸€æ™‚åœæ­¢ã‚’è€ƒæ…®ï¼‰
    const elapsedMinutes = calculateElapsedMinutes(startTime, now, pauseTime);

    // çµŒéæ™‚é–“ã®è¡¨ç¤ºå½¢å¼ã‚’è¨­å®š
    const hours = Math.floor(elapsedMinutes / 60);
    const minutes = elapsedMinutes % 60;
    const timeString = `${hours}æ™‚é–“${minutes}åˆ†${pauseTime ? ' (åœæ­¢ä¸­)' : ''}`;

    setElapsedTime(timeString);
  };

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§æ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆAPIãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  const calculateClientSideCharge = () => {
    if (!chargeStartedAt) return 0;

    const startTime = new Date(chargeStartedAt);
    const now = new Date();
    const pauseTime = chargePausedAt ? new Date(chargePausedAt) : null;

    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦æ–™é‡‘ã‚’è¨ˆç®—
    const charge = calculateChargeWithPause(
      startTime,
      now,
      pricePerHalfHour,
      timeUnitMinutes,
      pauseTime
    );

    // è¨ˆç®—ã•ã‚ŒãŸæ–™é‡‘ã‚’è¨­å®š
    setChargeAmount(charge);

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    console.log('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—ã—ãŸæ–™é‡‘:', {
      startTime,
      now,
      elapsedMs: now.getTime() - startTime.getTime(),
      elapsedMinutes: Math.floor((now.getTime() - startTime.getTime()) / (1000 * 60)),
      pricePerHalfHour,
      timeUnitMinutes,
      charge
    });

    return charge;
  };

  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ­£ç¢ºãªæ–™é‡‘ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  const fetchChargeAmount = async () => {
    if (!chargeStartedAt || !sessionId) return 0;

    try {
      const response = await fetch(`/api/sessions/${sessionId}/calculate-charge`);

      if (!response.ok) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘å–å¾—ã‚¨ãƒ©ãƒ¼:', response.status);
        // APIãŒå¤±æ•—ã—ãŸå ´åˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—
        return calculateClientSideCharge();
      }

      const data = await response.json();
      console.log('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘å–å¾—æˆåŠŸ:', data);

      // å¸­ç§»å‹•æ–™é‡‘ã‚’å«ã‚€åˆè¨ˆæ–™é‡‘ã‚’è¨­å®š
      setChargeAmount(data.charge_amount || 0);

      // çµŒéæ™‚é–“ã®è¡¨ç¤ºå½¢å¼ã‚’è¨­å®šï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—ï¼‰
      updateElapsedTimeDisplay();

      return data.charge_amount || 0;
    } catch (error) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘å–å¾—ä¾‹å¤–:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—
      return calculateClientSideCharge();
    }
  };

  // ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã®è¨ˆç®—
  useEffect(() => {
    if (!chargeStartedAt || !sessionId) return;

    // åˆå›ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ–™é‡‘ã‚’å–å¾—
    fetchChargeAmount();

    // 1åˆ†ã”ã¨ã«å†è¨ˆç®—ï¼ˆçµŒéæ™‚é–“ã®è¡¨ç¤ºã®ã¿æ›´æ–°ã€æ–™é‡‘ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãªã„ï¼‰
    const interval = setInterval(updateElapsedTimeDisplay, 60 * 1000);

    return () => clearInterval(interval);
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [chargeStartedAt, chargePausedAt, pricePerHalfHour, timeUnitMinutes, sessionId]);

  // ä¼šè¨ˆå‡¦ç†
  const handleCheckout = async (e?: React.MouseEvent | React.FormEvent) => {
    // ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã¨ãƒãƒ–ãƒªãƒ³ã‚°ã‚’é˜²æ­¢
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    if (orderItems.length === 0 && chargeAmount === 0) {
      return;
    }

    setIsSubmitting(true);
    setCheckoutError(null);

    try {
      // ä¼šè¨ˆå‡¦ç†ã®å‰ã«æœ€æ–°ã®æ–™é‡‘ã‚’å–å¾—
      console.log('ä¼šè¨ˆå‰ã«æœ€æ–°ã®æ–™é‡‘ã‚’å–å¾—ã—ã¾ã™');
      const latestChargeAmount = await fetchChargeAmount();
      console.log('æœ€æ–°ã®æ–™é‡‘:', latestChargeAmount);

      // æœ€æ–°ã®æ–™é‡‘ã‚’çŠ¶æ…‹ã«è¨­å®šï¼ˆè¡¨ç¤ºã‚’æ›´æ–°ï¼‰
      setChargeAmount(latestChargeAmount);

      // ä¼šè¨ˆAPIã‚’å‘¼ã³å‡ºã—
      const apiUrl = `/api/checkout/${sessionId}`;
      const requestBody = {
        table_id: tableId,
      };



      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody),
      });



      if (!response.ok) {
        let errorMessage = 'ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ';
        try {
          const errorData = await response.json();

          errorMessage = errorData.error || errorMessage;
        } catch (jsonError) {
          console.error('ä¼šè¨ˆAPIã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', jsonError);
        }
        throw new Error(errorMessage);
      }

      // ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const data = await response.json();
      setCheckoutData(data);

      // APIã‹ã‚‰è¿”ã•ã‚ŒãŸæ–™é‡‘ã‚’ä½¿ç”¨ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
      setChargeAmount(data.charge_amount || chargeAmount);

      // ä¼šè¨ˆæˆåŠŸ
      setCheckoutSuccess(true);
      clearCart();

      // ä¼šè¨ˆå®Œäº†ç”»é¢ã«é·ç§»ã™ã‚‹ãŸã‚ã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æº–å‚™
      // APIã‹ã‚‰ã®é‡‘é¡ã‚’ä½¿ç”¨
      const params = new URLSearchParams({
        complete: 'true',
        total: data.total_amount.toString(), // APIã‹ã‚‰è¿”ã•ã‚ŒãŸç¨è¾¼ã¿åˆè¨ˆé‡‘é¡ã‚’ä½¿ç”¨
        subtotal: data.subtotal_amount.toString(), // APIã‹ã‚‰è¿”ã•ã‚ŒãŸç¨æŠœãåˆè¨ˆé‡‘é¡ã‚’ä½¿ç”¨
        tax: data.tax_amount.toString(), // APIã‹ã‚‰è¿”ã•ã‚ŒãŸæ¶ˆè²»ç¨é¡ã‚’ä½¿ç”¨
        taxRate: data.tax_rate.toString(), // APIã‹ã‚‰è¿”ã•ã‚ŒãŸæ¶ˆè²»ç¨ç‡ã‚’ä½¿ç”¨
        store: encodeURIComponent(storeName || 'ä¸æ˜ãªåº—èˆ—'),
        table: encodeURIComponent(tableName || 'ä¸æ˜ãªãƒ†ãƒ¼ãƒ–ãƒ«')
      });

      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ã¿å®Ÿè¡Œ
      if (typeof window !== 'undefined') {

      }

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
      try {
        const deleteResponse = await fetch(`/api/sessions/${sessionId}`, {
          method: 'DELETE',
        });

        if (!deleteResponse.ok) {

        } else {

        }
      } catch (deleteError) {
        console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', deleteError);
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã«å¤±æ•—ã—ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
      }

      // 2ç§’å¾Œã«ä¼šè¨ˆå®Œäº†ç”»é¢ã«é·ç§»ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ã¿å®Ÿè¡Œï¼‰
      if (typeof window !== 'undefined') {

        const redirectUrl = `${window.location.pathname}?${params.toString()}`;

        setTimeout(() => {

          window.location.href = redirectUrl;
        }, 2000);
      }
    } catch (error) {
      console.error('ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šè©³ç´°ã«è¡¨ç¤º
      let errorMessage = 'ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ';
      if (error instanceof Error) {
        errorMessage = error.message;
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
      } else {
        console.error('ä¸æ˜ãªã‚¨ãƒ©ãƒ¼å½¢å¼:', typeof error, error);
      }
      setCheckoutError(errorMessage);


    } finally {
      setIsSubmitting(false);
    }
  };

  // ç¨æŠœãåˆè¨ˆé‡‘é¡ï¼ˆæ³¨æ–‡ + ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ï¼‰
  const subtotalAmount = orderTotalPrice + chargeAmount;

  // æ¶ˆè²»ç¨é¡ã‚’è¨ˆç®—
  const calculatedTaxAmount = Math.floor(subtotalAmount * (taxRate / 100));

  // useEffectã®å¤–ã§ã‚‚taxAmountã‚’æ›´æ–°
  useEffect(() => {
    setTaxAmount(calculatedTaxAmount);
  }, [calculatedTaxAmount]);

  // ç¨è¾¼ã¿åˆè¨ˆé‡‘é¡
  const totalAmount = subtotalAmount + calculatedTaxAmount;

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title="ãŠä¼šè¨ˆ"
      maxWidth="max-w-lg"
    >
      {checkoutSuccess ? (
        <div className="bg-green-50 border border-green-200 text-green-700 p-4 rounded-md mb-4">
          ä¼šè¨ˆå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
        </div>
      ) : checkoutError ? (
        <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-md mb-4">
          {checkoutError}
        </div>
      ) : null}

      <div className="mb-6">
        <div className="bg-gray-50 p-4 rounded-md mb-4">
          <div className="flex justify-between mb-2">
            <span className="text-gray-600">å¸­ã‚¿ã‚¤ãƒ—:</span>
            <span className="font-medium">{seatTypeName}</span>
          </div>
          {pricePerHalfHour > 0 && (
            <div className="flex justify-between mb-2">
              <span className="text-gray-600">æ–™é‡‘:</span>
              <span className="font-medium">{pricePerHalfHour.toLocaleString()}å†† / {timeUnitMinutes}åˆ†</span>
            </div>
          )}
          {chargeStartedAt && pricePerHalfHour > 0 && (
            <>
              <div className="flex justify-between mb-2">
                <span className="text-gray-600">çµŒéæ™‚é–“:</span>
                <span className="font-medium">{elapsedTime}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘:</span>
                <span className="font-medium">{chargeAmount.toLocaleString()}å††</span>
              </div>
            </>
          )}
        </div>

        <div className="mb-4">
          <h3 className="font-medium mb-2">æ³¨æ–‡å†…å®¹</h3>
          {isLoadingOrders ? (
            <p className="text-gray-500">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
          ) : orderItems.length === 0 ? (
            <p className="text-gray-500">æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</p>
          ) : (
            <ul className="divide-y">
              {orderItems.map((item, index) => (
                <li key={index} className="py-2 flex justify-between">
                  <div>
                    <span>{item.name}</span>
                    {item.target_cast_name && (
                      <span className="ml-2 text-sm text-blue-600">
                        ({item.target_cast_name}ã«å¥¢ã‚‹)
                      </span>
                    )}
                    <span className="ml-2 text-sm text-gray-500">
                      Ã—{item.quantity}
                    </span>
                  </div>
                  <span>
                    {item.total.toLocaleString()}å††
                  </span>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>

      <div className="border-t border-gray-200 pt-4">
        <div className="flex justify-between mb-2">
          <span>æ³¨æ–‡åˆè¨ˆ:</span>
          <span>{orderTotalPrice.toLocaleString()}å††</span>
        </div>
        {pricePerHalfHour > 0 && (
          <div className="flex justify-between mb-2">
            <span>ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘:</span>
            <span>{chargeAmount.toLocaleString()}å††</span>
          </div>
        )}
        <div className="flex justify-between mb-2">
          <span>å°è¨ˆï¼ˆç¨æŠœï¼‰:</span>
          <span>{subtotalAmount.toLocaleString()}å††</span>
        </div>
        <div className="flex justify-between mb-2">
          <span>æ¶ˆè²»ç¨ï¼ˆ{taxRate}%ï¼‰:</span>
          <span>{calculatedTaxAmount.toLocaleString()}å††</span>
        </div>
        <div className="flex justify-between font-bold text-lg">
          <span>åˆè¨ˆé‡‘é¡ï¼ˆç¨è¾¼ï¼‰:</span>
          <span>{totalAmount.toLocaleString()}å††</span>
        </div>
      </div>

      <div className="mt-6">
        <form onSubmit={(e) => {
          e.preventDefault();
          handleCheckout(e);
        }}>
          <button
            type="submit"
            className={`bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 w-full ${
              isSubmitting ? 'opacity-50 cursor-not-allowed' : ''
            }`}
            disabled={isSubmitting || (orderItems.length === 0 && chargeAmount === 0)}
          >
            {isSubmitting ? 'å‡¦ç†ä¸­...' : 'ä¼šè¨ˆã™ã‚‹'}
          </button>
        </form>


      </div>
    </Modal>
  );
}
</file>

<file path="app/menu/[table_id]/client-customer-selection.tsx">
'use client';

import { useState } from 'react';
import CustomerTypeSelection from './customer-type-selection';
import CastSelection from './cast-selection';

export default function ClientSideCustomerTypeSelection({ 
  tableId, 
  sessionId, 
  storeId 
}: { 
  tableId: string, 
  sessionId: string, 
  storeId: string 
}) {
  const [showCastModal, setShowCastModal] = useState(false);

  return (
    <>
      <CustomerTypeSelection
        tableId={tableId}
        sessionId={sessionId}
        storeId={storeId}
        onShowCastSelection={() => setShowCastModal(true)}
      />
      
      <CastSelection
        isOpen={showCastModal}
        onClose={() => setShowCastModal(false)}
        tableId={tableId}
        sessionId={sessionId}
        storeId={storeId}
      />
    </>
  );
}
</file>

<file path="app/menu/[table_id]/client-menu-page.tsx">
'use client';

import { useState } from 'react';
import MenuDisplay from './menu-display';
import CartModal from './cart-modal';
import CheckoutModal from './checkout-modal';

interface ClientMenuPageProps {
  sessionId: string;
  tableId: string;
  tableName: string;
  storeName: string;
  seatTypeName: string;
  pricePerHalfHour: number;
  chargeStartedAt: string | null;
  chargePausedAt?: string | null;
  timeUnitMinutes?: number;
  menus: any[];
  menusByCategory: Record<string, any[]>;
  storeId: string;
  categories: any[];
}

export default function ClientMenuPage({
  sessionId,
  tableId,
  tableName,
  storeName,
  seatTypeName,
  pricePerHalfHour,
  chargeStartedAt,
  chargePausedAt,
  timeUnitMinutes = 30,
  menus,
  menusByCategory,
  storeId,
  categories,
  isSideMenuOpen = true, // è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰å—ã‘å–ã‚‹
  onToggleSideMenu = () => {} // è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰å—ã‘å–ã‚‹
}: ClientMenuPageProps & {
  isSideMenuOpen?: boolean;
  onToggleSideMenu?: () => void;
}) {
  const [isCartModalOpen, setIsCartModalOpen] = useState(false);
  const [isCheckoutModalOpen, setIsCheckoutModalOpen] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);

  // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯æœ€åˆã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ
  const categoryList = Object.keys(menusByCategory);
  const currentCategory = selectedCategory || (categoryList.length > 0 ? categoryList[0] : null);

  return (
    <>

      <div className="flex h-full">
        {/* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‰ - é–‹é–‰å¯èƒ½ */}
        <div
          className={`${
            isSideMenuOpen ? 'w-1/5 min-w-[120px] max-w-[150px]' : 'w-0 min-w-0'
          } bg-white shadow-md h-screen sticky top-[57px] left-0 overflow-y-auto transition-all duration-300 ease-in-out`}
        >
          <div className="py-4">
            <div className="flex flex-col">
              {categoryList.map((category) => (
                <button
                  key={category}
                  onClick={() => setSelectedCategory(category)}
                  className={`py-4 px-2 text-center text-sm font-medium transition-colors border-l-4 focus:outline-none ${
                    currentCategory === category
                      ? 'border-amber-500 bg-amber-50 text-amber-500'
                      : 'border-transparent text-gray-700 hover:bg-gray-50 active:bg-gray-100 focus:bg-white'
                  } ${!isSideMenuOpen ? 'hidden' : ''}`}
                >
                  {category}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
        <div className={`w-full ${isSideMenuOpen ? 'pl-0' : 'pl-0'} transition-all duration-300 ease-in-out`}>
          <div className="bg-white p-4 md:p-6">
            <MenuDisplay
              menus={menus}
              menusByCategory={menusByCategory}
              storeId={storeId}
              categories={categories}
              selectedCategory={currentCategory}
              onCategoryChange={setSelectedCategory}
            />
          </div>
        </div>
      </div>

      {/* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */}
      <div className="fixed bottom-6 right-6 flex flex-col space-y-4">
        <button
          onClick={() => setIsCartModalOpen(true)}
          className="bg-amber-500 hover:bg-amber-600 active:bg-amber-700 focus:bg-amber-500 focus:outline-none text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg"
          aria-label="ã‚«ãƒ¼ãƒˆã‚’è¡¨ç¤º"
        >
          <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </button>

        <button
          onClick={() => setIsCheckoutModalOpen(true)}
          className="bg-green-600 hover:bg-green-700 active:bg-green-800 focus:bg-green-600 focus:outline-none text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg"
          aria-label="ãŠä¼šè¨ˆã‚’è¡¨ç¤º"
        >
          <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </button>
      </div>

      {/* ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      <CartModal
        isOpen={isCartModalOpen}
        onClose={() => setIsCartModalOpen(false)}
        sessionId={sessionId}
        tableId={tableId}
      />

      <CheckoutModal
        isOpen={isCheckoutModalOpen}
        onClose={() => setIsCheckoutModalOpen(false)}
        sessionId={sessionId}
        tableId={tableId}
        tableName={tableName}
        storeName={storeName}
        seatTypeName={seatTypeName}
        pricePerHalfHour={pricePerHalfHour}
        chargeStartedAt={chargeStartedAt}
        chargePausedAt={chargePausedAt}
        timeUnitMinutes={timeUnitMinutes}
      />
    </>
  );
}
</file>

<file path="app/menu/[table_id]/customer-type-selection.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

interface CustomerTypeSelectionProps {
  tableId: string;
  sessionId: string;
  storeId: string;
  onShowCastSelection: () => void;
}

export default function CustomerTypeSelection({
  tableId,
  sessionId,
  storeId,
  onShowCastSelection
}: CustomerTypeSelectionProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  const handleNewCustomer = async () => {
    try {
      setIsLoading(true);
      setError(null);

      // æ–°è¦å®¢ã¨ã—ã¦è¨˜éŒ²
      const response = await fetch(`/api/tables/${tableId}/sessions/${sessionId}/`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          is_new_customer: true,
        }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // ç”»é¢ã‚’æ›´æ–°ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã«é€²ã‚€
      router.refresh();
    } catch (err) {
      console.error('æ–°è¦å®¢é¸æŠã‚¨ãƒ©ãƒ¼:', err);
      setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  const handleDesignatedCustomer = () => {
    // ã‚­ãƒ£ã‚¹ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    onShowCastSelection();
  };

  return (
    <div className="bg-white shadow rounded-lg p-6 mb-6">
      <h2 className="text-xl font-bold mb-4">ã”åˆ©ç”¨ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h2>
      <p className="mb-6">
        ã”åˆ©ç”¨æ–¹æ³•ã‚’ãŠé¸ã³ãã ã•ã„
      </p>

      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
          {error}
        </div>
      )}

      <div className="grid grid-cols-1 gap-4">
        <button
          onClick={handleNewCustomer}
          disabled={isLoading}
          className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed"
        >
          {isLoading ? 'å‡¦ç†ä¸­...' : 'æ–°è¦ï¼ˆæŒ‡åãªã—ï¼‰'}
        </button>

        <button
          onClick={handleDesignatedCustomer}
          disabled={isLoading}
          className="w-full bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 disabled:bg-purple-300 disabled:cursor-not-allowed"
        >
          {isLoading ? 'å‡¦ç†ä¸­...' : 'æŒ‡åã‚ã‚Š'}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/header-with-menu-button.tsx">
'use client';

import { useState } from 'react';

interface HeaderWithMenuButtonProps {
  storeName: string;
  tableName: string;
  seatTypeName: string;
  pricePerUnit: number;
  timeUnitMinutes?: number;
  onToggleSideMenu: () => void;
}

export default function HeaderWithMenuButton({
  storeName,
  tableName,
  seatTypeName,
  pricePerUnit,
  timeUnitMinutes = 30,
  onToggleSideMenu
}: HeaderWithMenuButtonProps) {
  return (
    <header className="bg-white shadow-sm sticky top-0 z-10">
      <div className="max-w-full px-4 py-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-center">
          <div className="flex items-center space-x-3">
            {/* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */}
            <button
              onClick={onToggleSideMenu}
              className="bg-white hover:bg-gray-100 active:bg-gray-200 focus:bg-white focus:outline-none text-gray-700 p-2 rounded-md border border-gray-200"
              aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>

            <div>
              <h1 className="text-xl font-bold text-gray-900">
                {storeName}
              </h1>
              <p className="text-sm text-gray-500">
                ãƒ†ãƒ¼ãƒ–ãƒ«: {tableName} ({seatTypeName})
              </p>
            </div>
          </div>

          <div className="text-right">
            {pricePerUnit > 0 && (
              <p className="text-sm text-gray-500">
                æ–™é‡‘: {pricePerUnit}å††/{timeUnitMinutes}åˆ†
              </p>
            )}
          </div>
        </div>
      </div>
    </header>
  );
}
</file>

<file path="app/menu/[table_id]/menu-display.tsx">
'use client';

import { useState } from 'react';
import Image from 'next/image';
import { useCart } from './cart-context';
import CastSelectModal from './cast-select-modal';

interface Menu {
  menu_id: string;
  product_id: string;
  name: string;
  description: string | null;
  price: number;
  image_url: string | null;
  category: string | null;
  category_id: string | null;
  is_available: boolean;
  allow_treat_cast: boolean;
}

interface MenusByCategory {
  [category: string]: Menu[];
}

interface Category {
  category_id: string;
  name: string;
  display_order: number;
  allow_treat_cast: boolean;
}

interface MenuDisplayProps {
  menus: Menu[];
  menusByCategory: MenusByCategory;
  storeId: string;
  categories?: Category[];
  selectedCategory: string | null;
  onCategoryChange?: (category: string) => void;
}

export default function MenuDisplay({
  menus,
  menusByCategory,
  storeId,
  categories: categoryData,
  selectedCategory,
  onCategoryChange
}: MenuDisplayProps) {
  const [toast, setToast] = useState<{ visible: boolean; message: string }>({ visible: false, message: '' });
  const [selectedMenu, setSelectedMenu] = useState<Menu | null>(null);
  const [showCastModal, setShowCastModal] = useState(false);
  const { addItem } = useCart();

  // è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  const displayMenus = selectedCategory ? menusByCategory[selectedCategory] : [];

  // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  const showToast = (message: string) => {
    setToast({ visible: true, message });

    // 1ç§’å¾Œã«éè¡¨ç¤ºã«ã™ã‚‹
    setTimeout(() => {
      setToast({ visible: false, message: '' });
    }, 1000);
  };

  // ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
  const handleAddToCart = (menu: Menu, treatCast: boolean = false) => {
    if (treatCast) {
      // ã‚­ãƒ£ã‚¹ãƒˆã«å¥¢ã‚‹å ´åˆã€ã‚­ãƒ£ã‚¹ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      setSelectedMenu(menu);
      setShowCastModal(true);
    } else {
      // è‡ªåˆ†ã§æ³¨æ–‡ã™ã‚‹å ´åˆã€ãã®ã¾ã¾ã‚«ãƒ¼ãƒˆã«è¿½åŠ ï¼ˆtarget_cast_idã‚’æ˜ç¤ºçš„ã«nullã«è¨­å®šï¼‰
      addItem({
        menu_id: menu.menu_id,
        product_id: menu.product_id,
        name: menu.name,
        price: menu.price,
        target_cast_id: null
      }, 1); // æ•°é‡ã¯å¸¸ã«1
      showToast(`${menu.name}ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`);
    }
  };

  // ã‚­ãƒ£ã‚¹ãƒˆé¸æŠå¾Œã®å‡¦ç†
  const handleCastSelect = (castId: string, castName: string) => {
    if (selectedMenu) {
      addItem({
        menu_id: selectedMenu.menu_id,
        product_id: selectedMenu.product_id,
        name: selectedMenu.name,
        price: selectedMenu.price,
        target_cast_id: castId,
        target_cast_name: castName
      }, 1); // æ•°é‡ã¯å¸¸ã«1
      showToast(`${selectedMenu.name}ã‚’${castName}ã«å¥¢ã‚Šã¾ã—ãŸ`);
    }
    setShowCastModal(false);
    setSelectedMenu(null);
  };

  if (menus.length === 0) {
    return (
      <div className="text-center text-gray-500 py-8">
        ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
        <br />
        ç®¡ç†è€…ãŒã‚¹ãƒãƒ¬ã‚¸ã‹ã‚‰åŒæœŸã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
      </div>
    );
  }

  return (
    <div className="relative">
      {/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */}
      {toast.visible && (
        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-md shadow-md z-50 animate-fade-in-out">
          {toast.message}
        </div>
      )}

      {/* ã‚­ãƒ£ã‚¹ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showCastModal && (
        <CastSelectModal
          isOpen={showCastModal}
          onClose={() => setShowCastModal(false)}
          onSelect={handleCastSelect}
          storeId={storeId}
        />
      )}

      {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ */}
      <div className="divide-y divide-gray-100">
        {displayMenus.map((menu) => (
          <div
            key={menu.menu_id}
            className="py-3 flex items-center"
          >
            {/* å•†å“ç”»åƒ */}
            {menu.image_url ? (
              <div className="w-16 h-16 relative mr-3 flex-shrink-0">
                <Image
                  src={menu.image_url}
                  alt={menu.name}
                  fill
                  sizes="64px"
                  className="object-cover rounded"
                />
              </div>
            ) : null}

            {/* å•†å“æƒ…å ± */}
            <div className="flex-1 min-w-0">
              <h3 className="text-base font-medium text-gray-900 truncate">
                {menu.name}
              </h3>

              {menu.description ? (
                <p className="text-xs text-gray-500 mt-1 line-clamp-1">
                  {menu.description}
                </p>
              ) : null}

              <p className="text-base font-bold mt-1 text-gray-900">
                Â¥{menu.price.toLocaleString()}
              </p>
            </div>

            {/* æ³¨æ–‡ãƒœã‚¿ãƒ³ */}
            <div className="flex items-center ml-3">
              <button
                type="button"
                className="bg-amber-500 hover:bg-amber-600 active:bg-amber-700 focus:bg-amber-500 text-white py-1 px-3 rounded-md text-sm focus:outline-none"
                onClick={() => handleAddToCart(menu, false)}
              >
                æ³¨æ–‡
              </button>

              {menu.allow_treat_cast && (
                <button
                  type="button"
                  className="bg-pink-500 hover:bg-pink-600 active:bg-pink-700 focus:bg-pink-500 text-white py-1 px-3 rounded-md text-sm ml-1 focus:outline-none"
                  onClick={() => handleAddToCart(menu, true)}
                >
                  å¥¢ã‚‹
                </button>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/menu-page-wrapper.tsx">
'use client';

import { useState } from 'react';
import ClientMenuPage from './client-menu-page';
import HeaderWithMenuButton from './header-with-menu-button';

interface MenuPageWrapperProps {
  sessionId: string;
  tableId: string;
  tableName: string;
  storeName: string;
  seatTypeName: string;
  pricePerHalfHour: number;
  chargeStartedAt: string | null;
  chargePausedAt?: string | null;
  timeUnitMinutes?: number;
  menus: any[];
  menusByCategory: Record<string, any[]>;
  storeId: string;
  categories: any[];
}

export default function MenuPageWrapper(props: MenuPageWrapperProps) {
  // ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰çŠ¶æ…‹ã‚’ç®¡ç†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–‹ã„ãŸçŠ¶æ…‹ï¼‰
  const [isSideMenuOpen, setIsSideMenuOpen] = useState(true);

  // ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
  const toggleSideMenu = () => {
    setIsSideMenuOpen(!isSideMenuOpen);
  };

  return (
    <div className="min-h-screen bg-gray-100">
      <HeaderWithMenuButton
        storeName={props.storeName}
        tableName={props.tableName}
        seatTypeName={props.seatTypeName}
        pricePerUnit={props.pricePerHalfHour}
        timeUnitMinutes={props.timeUnitMinutes}
        onToggleSideMenu={toggleSideMenu}
      />

      <main className="w-full px-0 py-0 md:py-6 md:px-0">
        <ClientMenuPage
          {...props}
          isSideMenuOpen={isSideMenuOpen}
          onToggleSideMenu={toggleSideMenu}
        />
      </main>

      <footer className="bg-white shadow-inner py-4 mt-8">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <p className="text-center text-sm text-gray-500">
            Â© 2025 {props.storeName} - QRã‚ªãƒ¼ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
          </p>
        </div>
      </footer>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/modal.tsx">
'use client';

import { ReactNode } from 'react';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: ReactNode;
  maxWidth?: string;
}

export default function Modal({
  isOpen,
  onClose,
  title,
  children,
  maxWidth = 'max-w-md'
}: ModalProps) {
  if (!isOpen) return null;

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã®ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†
  const handleBackdropClick = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  return (
    <div
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      onClick={handleBackdropClick}
    >
      <div
        className={`bg-white rounded-lg p-6 w-full ${maxWidth} mx-auto max-h-[90vh] overflow-y-auto`}
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-semibold">{title}</h2>
          <button
            type="button"
            className="text-gray-400 hover:text-gray-500"
            onClick={onClose}
          >
            <span className="sr-only">é–‰ã˜ã‚‹</span>
            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div>
          {children}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/menu/[table_id]/page.tsx">
import { notFound } from 'next/navigation';
import { ReactNode } from 'react';
import CheckoutComplete from './checkout-complete';
import { CartProvider } from './cart-context';
import SeatSelection from './seat-selection';
import ClientSideCustomerTypeSelection from './client-customer-selection';
import MenuPageWrapper from './menu-page-wrapper';

interface TableData {
  table_id: string;
  name: string;
  store_id: string;
  seat_type: {
    seat_type_id: string; // UUIDãªã®ã§æ–‡å­—åˆ—å‹
    display_name: string;
    price_per_unit: number; // æ™‚é–“å˜ä½ã‚ãŸã‚Šã®æ–™é‡‘
    time_unit_minutes?: number; // æ™‚é–“å˜ä½ï¼ˆåˆ†ï¼‰
  } | null;
  store: {
    store_id: string;
    name: string;
  } | null;
}

interface MenuData {
  menu_id: string;
  product_id: string;
  name: string;
  description: string | null;
  price: number;
  image_url: string | null;
  category: string | null;
  category_id: string | null;
  is_available: boolean;
  allow_treat_cast: boolean;
}

interface MenuResponse {
  menus: MenuData[];
  menusByCategory: Record<string, MenuData[]>;
  categories: any[];
}

interface SessionData {
  session_id: string;
  table_id: string;
  store_id: string;
  start_at: string;
  charge_started_at: string | null;
  charge_paused_at: string | null;
  selected_cast_id: string | null;
  is_new_customer: boolean | null;
}

export default async function MenuPage({
  params,
  searchParams
}: {
  params: Promise<{ table_id: string }>;
  searchParams: Promise<{
    complete?: string;
    total?: string;
    subtotal?: string;
    tax?: string;
    taxRate?: string;
    store?: string;
    table?: string;
  }>
}) {
  const { table_id } = await params;
  const searchParamsData = await searchParams;

  // ä¼šè¨ˆå®Œäº†ç”»é¢ã®è¡¨ç¤ºåˆ¤å®š
  const isCheckoutComplete = searchParamsData.complete === 'true';



  if (isCheckoutComplete && searchParamsData.total) {
    const totalAmount = parseInt(searchParamsData.total, 10) || 0;
    const subtotalAmount = parseInt(searchParamsData.subtotal || '0', 10) || 0;
    const taxAmount = parseInt(searchParamsData.tax || '0', 10) || 0;
    const taxRate = parseFloat(searchParamsData.taxRate || '10.0') || 10.0;

    // å€¤ãŒç©ºæ–‡å­—åˆ—ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const storeName = searchParamsData.store ? decodeURIComponent(searchParamsData.store) : 'ä¸æ˜ãªåº—èˆ—';
    const tableName = searchParamsData.table ? decodeURIComponent(searchParamsData.table) : 'ä¸æ˜ãªãƒ†ãƒ¼ãƒ–ãƒ«';

    return (
      <CheckoutComplete
        storeName={storeName}
        tableName={tableName}
        totalAmount={totalAmount}
        subtotalAmount={subtotalAmount}
        taxAmount={taxAmount}
        taxRate={taxRate}
      />
    );
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—
  const origin = process.env.NEXT_PUBLIC_URL || 'http://localhost:3000';
  const tableResponse = await fetch(`${origin}/api/tables/${table_id}`, {
    cache: 'no-store'
  });

  if (!tableResponse.ok) {
    if (tableResponse.status === 404) {
      notFound();
    }
    throw new Error(`ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${tableResponse.statusText}`);
  }

  const table: TableData = await tableResponse.json();

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’å–å¾—
  const menuResponse = await fetch(`${origin}/api/tables/${table_id}/menus`, {
    cache: 'no-store'
  });

  if (!menuResponse.ok) {
    throw new Error(`ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${menuResponse.statusText}`);
  }

  const { menus: menuItems, menusByCategory, categories }: MenuResponse = await menuResponse.json();

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
  const sessionResponse = await fetch(`${origin}/api/tables/${table_id}/sessions`, {
    cache: 'no-store'
  });

  if (!sessionResponse.ok) {
    throw new Error(`ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${sessionResponse.statusText}`);
  }

  const session: SessionData = await sessionResponse.json();

  return (
    <CartProvider table_id={table_id}>
      <div className="min-h-screen bg-gray-100">

        {!session.charge_started_at ? (
          // ã‚¹ãƒ†ãƒƒãƒ—1: åº§å¸­é¸æŠ
          <main className="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <SeatSelection
              tableId={table_id}
              tableName={table.name}
              sessionId={session.session_id}
            />
          </main>
        ) : session.charge_started_at && session.is_new_customer === null && session.selected_cast_id === null ? (
          // ã‚¹ãƒ†ãƒƒãƒ—2: æ–°è¦/æŒ‡åé¸æŠ
          <main className="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <CustomerTypeSelectionWrapper
              tableId={table_id}
              sessionId={session.session_id}
              storeId={table.store_id}
            />
          </main>
        ) : (
          // ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º - ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ã«å¹…ã‚’æœ€å¤§ã«
          <MenuPageWrapper
            sessionId={session.session_id}
            tableId={table_id}
            tableName={table.name}
            storeName={table.store?.name || ''}
            seatTypeName={table.seat_type?.display_name || ''}
            pricePerHalfHour={table.seat_type?.price_per_unit || 0}
            chargeStartedAt={session.charge_started_at}
            chargePausedAt={session.charge_paused_at}
            timeUnitMinutes={table.seat_type?.time_unit_minutes || 30}
            menus={menuItems}
            menusByCategory={menusByCategory}
            storeId={table.store_id}
            categories={categories}
          />
        )}
      </div>
    </CartProvider>
  );
}

// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function CustomerTypeSelectionWrapper({ tableId, sessionId, storeId }: { tableId: string, sessionId: string, storeId: string }) {
  return (
    <ClientSideCustomerTypeSelection tableId={tableId} sessionId={sessionId} storeId={storeId} />
  );
}
</file>

<file path="app/menu/[table_id]/seat-selection.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

interface SeatSelectionProps {
  tableId: string;
  tableName: string;
  sessionId: string;
}

export default function SeatSelection({ tableId, tableName, sessionId }: SeatSelectionProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  const handleSeatSelection = async () => {
    try {
      setIsLoading(true);
      setError(null);

      // åº§å¸­é¸æŠæ™‚é–“ã‚’è¨˜éŒ²
      const response = await fetch(`/api/tables/${tableId}/sessions/${sessionId}/`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          charge_started_at: new Date().toISOString(),
        }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'åº§å¸­é¸æŠã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // ç”»é¢ã‚’æ›´æ–°ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ–°è¦/æŒ‡åé¸æŠï¼‰ã«é€²ã‚€
      router.refresh();
    } catch (err) {
      console.error('åº§å¸­é¸æŠã‚¨ãƒ©ãƒ¼:', err);
      setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="bg-white shadow rounded-lg p-6 mb-6">
      <h2 className="text-xl font-bold mb-4">ã‚ˆã†ã“ã</h2>
      <p className="mb-6">
        ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ{tableName}ã€ã«ãŠåº§ã‚Šã«ãªã‚Šã¾ã™ã‹ï¼Ÿ
      </p>

      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
          {error}
        </div>
      )}

      <button
        onClick={handleSeatSelection}
        disabled={isLoading}
        className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed"
      >
        {isLoading ? 'å‡¦ç†ä¸­...' : 'ã“ã®å¸­ã«åº§ã‚‹'}
      </button>
    </div>
  );
}
</file>

<file path="app/page.tsx">
import Link from 'next/link';

// åº—èˆ—ã®å‹å®šç¾©
interface Store {
  store_id: string;
  store_code: string;
  name: string;
}

export default async function HomePage() {
  // åº—èˆ—ä¸€è¦§ã‚’APIã‹ã‚‰å–å¾—
  const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/stores`, {
    cache: 'no-store'
  });

  let stores: Store[] = [];
  if (response.ok) {
    stores = await response.json();
  } else {
    console.error('åº—èˆ—ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await response.text());
  }

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
      <div className="sm:mx-auto sm:w-full sm:max-w-md">
        <h1 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
          QRã‚ªãƒ¼ãƒ€ãƒ¼ & ä¼šè¨ˆé€£æºã‚·ã‚¹ãƒ†ãƒ 
        </h1>
        <p className="mt-2 text-center text-sm text-gray-600">
          ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼å‘ã‘QRã‚ªãƒ¼ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
        </p>
      </div>

      <div className="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
        <div className="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
          <h2 className="text-lg font-medium text-gray-900 mb-4">
            åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„
          </h2>

          <div className="space-y-2">
            {stores && stores.length > 0 ? (
              stores.map((store) => (
                <Link
                  key={store.store_id}
                  href={`/login/${store.store_code}`}
                  className="w-full flex justify-between items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                >
                  <span>{store.name}</span>
                  <span className="text-gray-400">&rarr;</span>
                </Link>
              ))
            ) : (
              <p className="text-center text-gray-500">
                ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
              </p>
            )}
          </div>

          <div className="mt-6">
            <p className="text-center text-xs text-gray-500">
              â€» åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•å°‚ç”¨ãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚æ¥åº—å®¢ã¯åº—å†…ã®QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/casts/[id]/edit/page.tsx">
import { cookies } from 'next/headers';
import { redirect, notFound } from 'next/navigation';
import CastForm from '../../cast-form';

export default async function EditCastPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');

  console.log('EditCast: è»¢é€ã™ã‚‹Cookie:',
    allCookies.map(c => ({ name: c.name, value: c.name.includes('token') ? '***' : c.value }))
  );

  // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  if (!userResponse.ok) {
    redirect('/');
  }

  const { user } = await userResponse.json();

  // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (user.role !== 'admin') {
    redirect('/portal/dashboard');
  }

  // åº—èˆ—æƒ…å ±ã‚’APIã‹ã‚‰å–å¾—
  const storeResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/stores/${storeId}`, {
    cache: 'no-store'
  });

  if (!storeResponse.ok) {
    console.error('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await storeResponse.text());
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  const store = await storeResponse.json();

  // ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ãŒç„¡åŠ¹ã®å ´åˆã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (!store.enable_cast_management) {
    redirect('/portal/dashboard');
  }

  // APIã‹ã‚‰ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
  const castResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/casts/${id}`, {
    cache: 'no-store'
  });

  if (!castResponse.ok) {
    console.error('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await castResponse.text());
    notFound();
  }

  const storeUser = await castResponse.json();
  console.log('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±å–å¾—çµæœ:', { storeUser });

  return (
    <div className="py-6">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-2xl font-semibold text-gray-900">ã‚­ãƒ£ã‚¹ãƒˆã‚’ç·¨é›†</h1>
      </div>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div className="bg-white shadow overflow-hidden sm:rounded-lg">
          <div className="px-4 py-5 sm:p-6">
            <CastForm
              storeId={storeId}
              castId={storeUser.id}
              email={storeUser.email || ''}
              displayName={storeUser.display_name || ''}
              isEdit={true}
            />
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/casts/cast-form.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

interface CastFormProps {
  storeId: string;
  castId?: string;
  email?: string;
  displayName?: string;
  isEdit?: boolean;
}

export default function CastForm({
  storeId,
  castId,
  email = '',
  displayName = '',
  isEdit = false,
}: CastFormProps) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  const [formData, setFormData] = useState({
    email: email,
    displayName: displayName,
    password: '',
  });

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData({
      ...formData,
      [name]: value,
    });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);
    setSuccess(null);

    try {
      if (isEdit) {
        // ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®æ›´æ–°
        const response = await fetch(`/api/casts/${castId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: formData.email,
            display_name: formData.displayName,
            password: formData.password || undefined, // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã®å ´åˆã¯é€ä¿¡ã—ãªã„
          }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        setSuccess('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      } else {
        // æ–°è¦ã‚­ãƒ£ã‚¹ãƒˆã®è¿½åŠ 
        const response = await fetch('/api/casts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: formData.email,
            display_name: formData.displayName,
            password: formData.password,
            store_id: storeId,
          }),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'ã‚­ãƒ£ã‚¹ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        setSuccess('ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        setFormData({
          email: '',
          displayName: '',
          password: '',
        });
      }

      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãŸå¾Œã€ä¸€è¦§ç”»é¢ã«æˆ»ã‚‹
      setTimeout(() => {
        router.push('/portal/casts');
        router.refresh();
      }, 2000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  const handleDelete = async () => {
    if (!castId || !confirm('ã“ã®ã‚­ãƒ£ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }

    setIsLoading(true);
    setError(null);
    setSuccess(null);

    try {
      const response = await fetch(`/api/casts/${castId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'ã‚­ãƒ£ã‚¹ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      setSuccess('ã‚­ãƒ£ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãŸå¾Œã€ä¸€è¦§ç”»é¢ã«æˆ»ã‚‹
      setTimeout(() => {
        router.push('/portal/casts');
        router.refresh();
      }, 2000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <div className="space-y-6">
        {error && (
          <div className="bg-red-50 border-l-4 border-red-400 p-4">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-red-700">{error}</p>
              </div>
            </div>
          </div>
        )}

        {success && (
          <div className="bg-green-50 border-l-4 border-green-400 p-4">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-green-700">{success}</p>
              </div>
            </div>
          </div>
        )}

        <div>
          <label htmlFor="displayName" className="block text-sm font-medium text-gray-700">
            åå‰
          </label>
          <div className="mt-1">
            <input
              type="text"
              name="displayName"
              id="displayName"
              value={formData.displayName}
              onChange={handleChange}
              className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
              required
              placeholder="ã‚­ãƒ£ã‚¹ãƒˆã®åå‰"
            />
          </div>
        </div>

        <div>
          <label htmlFor="email" className="block text-sm font-medium text-gray-700">
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
          </label>
          <div className="mt-1">
            <input
              type="email"
              name="email"
              id="email"
              value={formData.email}
              onChange={handleChange}
              className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
              required
            />
          </div>
        </div>

        <div>
          <label htmlFor="password" className="block text-sm font-medium text-gray-700">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ {isEdit && '(å¤‰æ›´ã™ã‚‹å ´åˆã®ã¿å…¥åŠ›)'}
          </label>
          <div className="mt-1">
            <input
              type="password"
              name="password"
              id="password"
              value={formData.password}
              onChange={handleChange}
              className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
              required={!isEdit}
              minLength={8}
            />
          </div>
          <p className="mt-1 text-sm text-gray-500">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„
          </p>
        </div>

        <div className="flex justify-between">
          <div>
            <button
              type="button"
              onClick={() => router.back()}
              className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button
              type="submit"
              disabled={isLoading}
              className="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300"
            >
              {isLoading ? 'å‡¦ç†ä¸­...' : isEdit ? 'æ›´æ–°' : 'è¿½åŠ '}
            </button>
          </div>

          {isEdit && (
            <button
              type="button"
              onClick={handleDelete}
              disabled={isLoading}
              className="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-red-300"
            >
              å‰Šé™¤
            </button>
          )}
        </div>
      </div>
    </form>
  );
}
</file>

<file path="app/portal/casts/delete-button.tsx">
'use client';

import { useState } from 'react';

interface DeleteButtonProps {
  castId: string;
}

export default function DeleteButton({ castId }: DeleteButtonProps) {
  const [isDeleting, setIsDeleting] = useState(false);

  const handleDelete = async () => {
    // å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    if (!confirm('ã“ã®ã‚­ãƒ£ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }

    try {
      setIsDeleting(true);
      // å‰Šé™¤å‡¦ç†
      const response = await fetch(`/api/casts/${castId}`, {
        method: 'DELETE',
      });
      
      if (!response.ok) {
        const data = await response.json();
        alert(data.error || 'ã‚­ãƒ£ã‚¹ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }
      
      alert('ã‚­ãƒ£ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      window.location.reload();
    } catch (error) {
      console.error('ã‚­ãƒ£ã‚¹ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚­ãƒ£ã‚¹ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <button
      type="button"
      className="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200"
      onClick={handleDelete}
      disabled={isDeleting}
    >
      {isDeleting ? 'å‰Šé™¤ä¸­...' : 'å‰Šé™¤'}
    </button>
  );
}
</file>

<file path="app/portal/casts/new/page.tsx">
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';
import CastForm from '../cast-form';

export default async function NewCastPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');

  console.log('NewCast: è»¢é€ã™ã‚‹Cookie:',
    allCookies.map(c => ({ name: c.name, value: c.name.includes('token') ? '***' : c.value }))
  );

  // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  if (!userResponse.ok) {
    redirect('/');
  }

  const { user } = await userResponse.json();

  // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (user.role !== 'admin') {
    redirect('/portal/dashboard');
  }

  // åº—èˆ—æƒ…å ±ã‚’APIã‹ã‚‰å–å¾—
  const storeResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/stores/${storeId}`, {
    cache: 'no-store'
  });

  if (!storeResponse.ok) {
    console.error('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await storeResponse.text());
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  const store = await storeResponse.json();

  if (!store) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ãŒç„¡åŠ¹ã®å ´åˆã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (!store.enable_cast_management) {
    redirect('/portal/dashboard');
  }

  return (
    <div className="py-6">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-2xl font-semibold text-gray-900">ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ </h1>
      </div>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div className="bg-white shadow overflow-hidden sm:rounded-lg">
          <div className="px-4 py-5 sm:p-6">
            <CastForm storeId={storeId} />
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/casts/page.tsx">
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import DeleteButton from './delete-button';
import { createServerSupabaseClient } from '@/lib/supabase';

// ã‚­ãƒ£ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹å®šç¾©
interface StoreUser {
  id: string;
  user_id: string;
  display_name?: string;
  email?: string;
}

export default async function CastsPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');



  // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  if (!userResponse.ok) {
    redirect('/');
  }

  const { user } = await userResponse.json();

  // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (user.role !== 'admin') {
    redirect('/portal/dashboard');
  }

  // åº—èˆ—æƒ…å ±ã‚’APIã‹ã‚‰å–å¾—
  const storeResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/stores/${storeId}`, {
    cache: 'no-store'
  });

  if (!storeResponse.ok) {
    console.error('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await storeResponse.text());
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  const store = await storeResponse.json();

  // ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ãŒç„¡åŠ¹ã®å ´åˆã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (!store.enable_cast_management) {
    return (
      <div className="py-6">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-yellow-700">
                  ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†æ©Ÿèƒ½ã¯ç¾åœ¨ç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚
                  <Link href="/portal/settings" className="font-medium underline text-yellow-700 hover:text-yellow-600">
                    è¨­å®šç”»é¢
                  </Link>
                  ã‹ã‚‰æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’APIã‹ã‚‰å–å¾—
  const castsResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/casts?storeId=${storeId}`, {
    cache: 'no-store'
  });

  let storeUsers: StoreUser[] = [];
  let storeUsersError = null;
  if (castsResponse.ok) {
    storeUsers = await castsResponse.json();
  } else {
    storeUsersError = await castsResponse.text();
    console.error('ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', storeUsersError);
  }

  // ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ãŒå–å¾—ã§ããŸå ´åˆã€å„ã‚­ãƒ£ã‚¹ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
  if (storeUsers && storeUsers.length > 0) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®é…åˆ—ã‚’ä½œæˆ
    const userIds = storeUsers.map((user: StoreUser) => user.user_id);

    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
    const supabase = await createServerSupabaseClient();

    // auth.usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å¯¾å¿œã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
    // Supabaseã§ã¯ã€authã‚¹ã‚­ãƒ¼ãƒã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã¯ç‰¹åˆ¥ãªæ–¹æ³•ãŒå¿…è¦
    const { data: authUsers, error: authUsersError } = await supabase.auth.admin.listUsers();

    // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å¿…è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã ã‘ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    // Supabaseã®å‹å®šç¾©ã«åˆã‚ã›ã‚‹
    const filteredAuthUsers = authUsers?.users.filter((user) => {
      return userIds.includes(user.id);
    });



    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æƒ…å ±ã‚’ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã«è¿½åŠ 
    if (filteredAuthUsers && filteredAuthUsers.length > 0) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã‚­ãƒ¼ã¨ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
      interface EmailMap {
        [key: string]: string;
      }

      const emailMap: EmailMap = {};

      // æ‰‹å‹•ã§ãƒãƒƒãƒ—ã‚’ä½œæˆ
      filteredAuthUsers.forEach((user) => {
        if (user.id && user.email) {
          emailMap[user.id] = user.email;
        }
      });

      // ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ 
      storeUsers.forEach((user: StoreUser) => {
        if (user.user_id && emailMap[user.user_id]) {
          user.email = emailMap[user.user_id];
        } else {
          user.email = '';
        }
      });
    }
  }

  return (
    <div className="py-6">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-center">
          <h1 className="text-2xl font-semibold text-gray-900">ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</h1>
          <Link
            href="/portal/casts/new"
            className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"
          >
            ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ 
          </Link>
        </div>
      </div>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div className="bg-white shadow overflow-hidden sm:rounded-md">
          <ul className="divide-y divide-gray-200">
            {storeUsers && storeUsers.length > 0 ? (
              storeUsers.map((storeUser: StoreUser) => (
                <li key={storeUser.id}>
                  <div className="px-4 py-4 flex items-center justify-between sm:px-6">
                    <div>
                      <p className="text-sm font-medium text-blue-600 truncate">{storeUser.display_name || 'åå‰ãªã—'}</p>
                      <p className="mt-1 text-sm text-gray-500">{storeUser.email || ''}</p>
                    </div>
                    <div className="flex space-x-2">
                      <Link
                        href={`/portal/casts/${storeUser.id}/edit`}
                        className="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200"
                      >
                        ç·¨é›†
                      </Link>
                      <DeleteButton castId={storeUser.id} />
                    </div>
                  </div>
                </li>
              ))
            ) : (
              <li className="px-4 py-6 text-center text-gray-500">
                ã‚­ãƒ£ã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
              </li>
            )}
          </ul>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/components/header.tsx">
'use client';

interface HeaderProps {
  storeName: string;
  userEmail: string;
  onToggleSideMenu: () => void;
  isSideMenuOpen: boolean;
}

export default function Header({ 
  storeName, 
  userEmail, 
  onToggleSideMenu,
  isSideMenuOpen
}: HeaderProps) {
  return (
    <header className="bg-white shadow-sm sticky top-0 z-10">
      <div className="px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between h-16 items-center">
          <div className="flex items-center">
            {/* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ - ãƒ¢ãƒã‚¤ãƒ«ç”¨ */}
            <button
              onClick={onToggleSideMenu}
              className="md:hidden p-2 rounded-md text-gray-500 hover:bg-gray-100 focus:outline-none"
              aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
            
            <div className="flex-shrink-0 flex items-center ml-2 md:ml-0">
              <span className="text-lg font-bold">{storeName || 'åº—èˆ—'}</span>
            </div>
          </div>
          
          <div className="flex items-center">
            <div className="ml-3 relative">
              <div className="flex items-center">
                <span className="text-sm text-gray-500 mr-2">
                  {userEmail}
                </span>
                <form action="/api/logout" method="POST">
                  <button
                    type="submit"
                    className="bg-white p-1 rounded-full text-gray-400 hover:text-gray-500"
                  >
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
  );
}
</file>

<file path="app/portal/components/layout-wrapper.tsx">
'use client';

import { useState, useEffect } from 'react';
import Header from './header';
import SideMenu from './side-menu';

interface NavLink {
  href: string;
  label: string;
  roles: ('admin' | 'cast')[];
}

interface LayoutWrapperProps {
  children: React.ReactNode;
  navLinks: NavLink[];
  userRole: 'admin' | 'cast';
  storeName: string;
  userEmail: string;
}

export default function LayoutWrapper({
  children,
  navLinks,
  userRole,
  storeName,
  userEmail
}: LayoutWrapperProps) {
  // ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰çŠ¶æ…‹ã‚’ç®¡ç†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–‹ã„ãŸçŠ¶æ…‹ï¼‰
  const [isSideMenuOpen, setIsSideMenuOpen] = useState(true);

  // ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
  const toggleSideMenu = () => {
    setIsSideMenuOpen(!isSideMenuOpen);
  };

  // ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®çŠ¶æ…‹ã‚’èª¿æ•´
  useEffect(() => {
    const handleResize = () => {
      if (window.innerWidth < 768) {
        setIsSideMenuOpen(false);
      } else {
        setIsSideMenuOpen(true);
      }
    };

    // åˆæœŸåŒ–æ™‚ã«ä¸€åº¦å®Ÿè¡Œ
    handleResize();

    // ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    window.addEventListener('resize', handleResize);

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }, []);

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col">
      <Header 
        storeName={storeName} 
        userEmail={userEmail} 
        onToggleSideMenu={toggleSideMenu}
        isSideMenuOpen={isSideMenuOpen}
      />

      <div className="flex flex-1 relative">
        <SideMenu 
          navLinks={navLinks} 
          userRole={userRole} 
          isSideMenuOpen={isSideMenuOpen} 
          onToggleSideMenu={toggleSideMenu} 
        />

        <main className={`flex-1 transition-all duration-300 ease-in-out py-10 ${isSideMenuOpen ? 'md:ml-64' : 'md:ml-16'}`}>
          <div className="px-4 sm:px-6 lg:px-8">
            {children}
          </div>
        </main>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/components/side-menu.tsx">
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';

interface NavLink {
  href: string;
  label: string;
  roles: ('admin' | 'cast')[];
}

interface SideMenuProps {
  navLinks: NavLink[];
  userRole: 'admin' | 'cast';
  isSideMenuOpen: boolean;
  onToggleSideMenu: () => void;
}

export default function SideMenu({ 
  navLinks, 
  userRole, 
  isSideMenuOpen, 
  onToggleSideMenu 
}: SideMenuProps) {
  const pathname = usePathname();

  return (
    <>
      {/* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */}
      {isSideMenuOpen && (
        <div 
          className="fixed inset-0 bg-gray-600 bg-opacity-75 z-20 md:hidden" 
          onClick={onToggleSideMenu}
        />
      )}

      {/* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
      <div 
        className={`
          fixed md:sticky top-0 left-0 h-screen bg-white shadow-md z-30
          transition-all duration-300 ease-in-out
          ${isSideMenuOpen ? 'w-64' : 'w-0 md:w-16'} 
          overflow-hidden
        `}
      >
        <div className="h-full flex flex-col">
          {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div className="p-4 border-b">
            <div className="flex items-center justify-between">
              <h2 className={`font-bold text-lg ${!isSideMenuOpen && 'md:hidden'}`}>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
              <button
                onClick={onToggleSideMenu}
                className="p-2 rounded-md text-gray-500 hover:bg-gray-100 focus:outline-none"
                aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰"
              >
                {isSideMenuOpen ? (
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                ) : (
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                )}
              </button>
            </div>
          </div>

          {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ */}
          <nav className="flex-1 overflow-y-auto py-4">
            <ul className="space-y-1">
              {navLinks
                .filter(link => link.roles.includes(userRole))
                .map(link => {
                  const isActive = pathname === link.href;
                  return (
                    <li key={link.href}>
                      <Link
                        href={link.href}
                        className={`
                          flex items-center px-4 py-3 text-sm font-medium transition-colors
                          ${isActive 
                            ? 'bg-blue-50 text-blue-600 border-l-4 border-blue-600' 
                            : 'text-gray-700 hover:bg-gray-50 border-l-4 border-transparent'}
                        `}
                      >
                        <span className={!isSideMenuOpen ? 'md:hidden' : ''}>{link.label}</span>
                      </Link>
                    </li>
                  );
                })}
            </ul>
          </nav>
        </div>
      </div>
    </>
  );
}
</file>

<file path="app/portal/dashboard/dashboard-client.tsx">
'use client';

import { useEffect, useState } from 'react';
import { subscribeToSessions } from '@/lib/supabase-realtime';

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‹å®šç¾©
interface SeatType {
  seat_type_id: number;
  display_name: string;
  price_per_unit: number;
  time_unit_minutes?: number;
}

interface Table {
  table_id: string;
  name: string;
  seat_types: SeatType | null;
}

interface Session {
  session_id: string;
  start_at: string;
  charge_started_at: string | null;
  charge_paused_at: string | null;
  tables: Table | null;
}

interface DashboardClientProps {
  initialSessions: Session[];
  storeId: string;
}

export default function DashboardClient({ initialSessions, storeId }: DashboardClientProps) {
  const [sessions, setSessions] = useState<Session[]>(initialSessions);
  const [now, setNow] = useState(new Date());

  // ç¾åœ¨æ™‚åˆ»ã‚’1ç§’ã”ã¨ã«æ›´æ–°
  useEffect(() => {
    const timer = setInterval(() => {
      setNow(new Date());
    }, 1000);

    return () => clearInterval(timer);
  }, []);

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  useEffect(() => {
    if (!storeId) return;

    // æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    const fetchLatestSessions = async () => {
      try {
        const response = await fetch(`/api/dashboard/sessions?storeId=${storeId}`);
        if (response.ok) {
          const data = await response.json();
          setSessions(data);
        } else {
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', await response.text());
        }
      } catch (error) {
        console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    };

    // Supabaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    const unsubscribe = subscribeToSessions(storeId, (payload) => {
      console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ:', payload);
      fetchLatestSessions();
    });

    // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
    fetchLatestSessions();

    // å®šæœŸçš„ãªãƒãƒ¼ãƒªãƒ³ã‚°ã®è¨­å®šï¼ˆ30ç§’ã”ã¨ï¼‰- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦
    const pollingInterval = setInterval(fetchLatestSessions, 30000);

    // ç”»é¢ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸã¨ãã«ã‚‚æ›´æ–°
    const handleFocus = () => {
      fetchLatestSessions();
    };
    window.addEventListener('focus', handleFocus);

    return () => {
      unsubscribe();
      clearInterval(pollingInterval);
      window.removeEventListener('focus', handleFocus);
    };
  }, [storeId]);

  return (
    <div>
      <h1 className="text-2xl font-bold mb-6">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

      <div className="bg-white shadow overflow-hidden sm:rounded-md">
        <ul className="divide-y divide-gray-200">
          {sessions && sessions.length > 0 ? (
            sessions.map((session) => {
              const startTime = new Date(session.charge_started_at || session.start_at);
              
              // ä¸€æ™‚åœæ­¢ä¸­ã‹ã©ã†ã‹ã‚’ç¢ºèª
              const isPaused = !!session.charge_paused_at;

              // ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—
              const endTime = isPaused && session.charge_paused_at ? new Date(session.charge_paused_at) : now;

              const elapsedMinutes = Math.floor((endTime.getTime() - startTime.getTime()) / (1000 * 60));
              const hours = Math.floor(elapsedMinutes / 60);
              const minutes = elapsedMinutes % 60;

              return (
                <li key={session.session_id} className="px-6 py-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-lg font-medium text-gray-900">
                        {session.tables?.name || 'ä¸æ˜ãªãƒ†ãƒ¼ãƒ–ãƒ«'}
                        ({session.tables?.seat_types?.display_name || 'ä¸æ˜ãªå¸­ç¨®'})
                      </p>
                      <p className="text-sm text-gray-500">
                        é–‹å§‹: {new Date(session.charge_started_at || session.start_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                      </p>
                    </div>
                    <div className="flex flex-col items-end">
                      <div className={`text-xl font-bold ${isPaused ? 'text-gray-500' : 'text-blue-600'}`}>
                        {hours > 0 ? `${hours}æ™‚é–“${minutes}åˆ†` : `${minutes}åˆ†`}
                      </div>
                      {isPaused && (
                        <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">ä¸€æ™‚åœæ­¢ä¸­</span>
                      )}
                    </div>
                  </div>
                </li>
              );
            })
          ) : (
            <li className="px-6 py-4 text-center text-gray-500">
              ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“
            </li>
          )}
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/dashboard/page.tsx">
import { cookies } from 'next/headers';
import DashboardClient from './dashboard-client';

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‹å®šç¾©
interface SeatType {
  seat_type_id: number;
  display_name: string;
  price_per_unit: number;
  time_unit_minutes?: number;
}

interface Table {
  table_id: string;
  name: string;
  seat_types: SeatType | null;
}

interface Session {
  session_id: string;
  start_at: string;
  charge_started_at: string | null;
  charge_paused_at: string | null;
  tables: Table | null;
}

export default async function DashboardPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // APIã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');

  const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/dashboard/sessions?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  let sessions: Session[] = [];
  if (response.ok) {
    sessions = await response.json();
  } else {
    console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await response.text());
  }

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ãƒˆã‚¢IDã‚’æ¸¡ã™
  return <DashboardClient initialSessions={sessions} storeId={storeId} />;
}
</file>

<file path="app/portal/menus/[id]/edit/page.tsx">
import { cookies } from 'next/headers';
import { redirect, notFound } from 'next/navigation';
import MenuForm from '../../menu-form';

export default async function EditMenuPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');

  // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  if (!userResponse.ok) {
    redirect('/');
  }

  const { user } = await userResponse.json();

  // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (user.role !== 'admin') {
    redirect('/portal/dashboard');
  }

  // APIã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’å–å¾—
  const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/menus/${id}?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  if (!response.ok) {
    console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await response.text());
    notFound();
  }

  const menu = await response.json();

  return (
    <div className="py-6">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-2xl font-semibold text-gray-900">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç·¨é›†</h1>
      </div>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div className="bg-white shadow overflow-hidden sm:rounded-lg">
          <div className="px-4 py-5 sm:p-6">
            <MenuForm
              storeId={storeId}
              menuId={menu.menu_id}
              initialData={{
                product_id: menu.product_id,
                name: menu.name,
                description: menu.description,
                price: menu.price,
                image_url: menu.image_url,
                category: menu.category,
                category_id: menu.category_id,
                is_available: menu.is_available,
              }}
              isEdit={true}
            />
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/menus/menu-form.tsx">
'use client';

import { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { v4 as uuidv4 } from 'uuid';

interface Category {
  category_id: string;
  name: string;
  display_order: number;
}

interface MenuFormProps {
  storeId: string;
  menuId?: string;
  initialData?: {
    product_id: string;
    name: string;
    description: string | null;
    price: number;
    image_url: string | null;
    category: string | null;
    category_id: string | null;
    is_available: boolean;
  };
  isEdit?: boolean;
}

export default function MenuForm({
  storeId,
  menuId,
  initialData,
  isEdit = false,
}: MenuFormProps) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®çŠ¶æ…‹
  const [selectedImage, setSelectedImage] = useState<{
    file: File | null;
    previewUrl: string | null;
    resizedBlob: Blob | null;
    fileName: string | null;
  }>({
    file: null,
    previewUrl: null,
    resizedBlob: null,
    fileName: null
  });

  const [formData, setFormData] = useState({
    product_id: initialData?.product_id || '',
    name: initialData?.name || '',
    description: initialData?.description || '',
    price: initialData?.price || 0,
    image_url: initialData?.image_url || '',
    category_id: initialData?.category_id || '',
    is_available: initialData?.is_available !== false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯true
  });

  const [categories, setCategories] = useState<Category[]>([]);
  const [isLoadingCategories, setIsLoadingCategories] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;

    if (type === 'checkbox') {
      const checked = (e.target as HTMLInputElement).checked;
      setFormData({
        ...formData,
        [name]: checked,
      });
    } else if (type === 'number') {
      setFormData({
        ...formData,
        [name]: parseInt(value, 10) || 0,
      });
    } else {
      setFormData({
        ...formData,
        [name]: value,
      });
    }
  };

  // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã™ã‚‹é–¢æ•°
  const resizeImage = (file: File, maxWidth: number, maxHeight: number): Promise<Blob> => {
    return new Promise((resolve, reject) => {
      // ç”»åƒã‚’ãƒ­ãƒ¼ãƒ‰
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);

      img.onload = () => {
        // å…ƒã®ç”»åƒã‚µã‚¤ã‚ºã‚’å–å¾—
        const originalWidth = img.width;
        const originalHeight = img.height;

        // ãƒªã‚µã‚¤ã‚ºå¾Œã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
        let newWidth = originalWidth;
        let newHeight = originalHeight;

        // ç”»åƒãŒæŒ‡å®šã‚µã‚¤ã‚ºã‚ˆã‚Šå¤§ãã„å ´åˆã¯ãƒªã‚µã‚¤ã‚º
        if (originalWidth > maxWidth || originalHeight > maxHeight) {
          const aspectRatio = originalWidth / originalHeight;

          if (aspectRatio > 1) {
            // æ¨ªé•·ã®ç”»åƒ
            newWidth = maxWidth;
            newHeight = maxWidth / aspectRatio;

            // é«˜ã•ãŒæœ€å¤§å€¤ã‚’è¶…ãˆã‚‹å ´åˆã¯é«˜ã•ã‚’åŸºæº–ã«ã™ã‚‹
            if (newHeight > maxHeight) {
              newHeight = maxHeight;
              newWidth = maxHeight * aspectRatio;
            }
          } else {
            // ç¸¦é•·ã®ç”»åƒ
            newHeight = maxHeight;
            newWidth = maxHeight * aspectRatio;

            // å¹…ãŒæœ€å¤§å€¤ã‚’è¶…ãˆã‚‹å ´åˆã¯å¹…ã‚’åŸºæº–ã«ã™ã‚‹
            if (newWidth > maxWidth) {
              newWidth = maxWidth;
              newHeight = maxWidth / aspectRatio;
            }
          }
        }

        // Canvasã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’ãƒªã‚µã‚¤ã‚º
        const canvas = document.createElement('canvas');
        canvas.width = newWidth;
        canvas.height = newHeight;

        const ctx = canvas.getContext('2d');
        if (!ctx) {
          reject(new Error('Canvas 2D context not available'));
          return;
        }

        // ç”»åƒã‚’æç”»
        ctx.drawImage(img, 0, 0, newWidth, newHeight);

        // Blobã«å¤‰æ›
        canvas.toBlob(
          (blob) => {
            if (blob) {
              // ä½¿ç”¨æ¸ˆã¿ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’è§£æ”¾
              URL.revokeObjectURL(img.src);
              resolve(blob);
            } else {
              reject(new Error('Failed to convert canvas to blob'));
            }
          },
          file.type, // å…ƒã®ç”»åƒã¨åŒã˜å½¢å¼ã‚’ç¶­æŒ
          0.9 // å“è³ªï¼ˆJPEG/WebPã®å ´åˆï¼‰
        );
      };

      img.onerror = () => {
        URL.revokeObjectURL(img.src);
        reject(new Error('Failed to load image'));
      };
    });
  };

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
      setUploadError('è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚JPEGã€PNGã€WebPã€GIFå½¢å¼ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚');
      return;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®æ¤œè¨¼ï¼ˆ5MBä»¥ä¸‹ï¼‰
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
      setUploadError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚5MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    setIsUploading(true);
    setUploadError(null);

    try {
      // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºï¼ˆæœ€å¤§å¹…800pxã€æœ€å¤§é«˜ã•800pxï¼‰
      const resizedBlob = await resizeImage(file, 800, 800);

      // UUIDãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
      const fileExtension = file.name.split('.').pop() || '';
      const uuid = uuidv4();
      const resizedFileName = `${uuid}.${fileExtension}`;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®URLç”Ÿæˆ
      const previewUrl = URL.createObjectURL(resizedBlob);

      // é¸æŠã—ãŸç”»åƒæƒ…å ±ã‚’ä¿å­˜
      setSelectedImage({
        file,
        previewUrl,
        resizedBlob,
        fileName: resizedFileName
      });

      // æ—¢å­˜ã®ç”»åƒURLã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°ã—ã„ç”»åƒã‚’é¸æŠã—ãŸå ´åˆï¼‰
      if (formData.image_url) {
        setFormData(prev => ({
          ...prev,
          image_url: '',
        }));
      }
    } catch (err) {
      setUploadError(err instanceof Error ? err.message : 'ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsUploading(false);
    }
  };

  // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—
  useEffect(() => {
    const fetchCategories = async () => {
      setIsLoadingCategories(true);
      try {
        const response = await fetch(`/api/menu-categories?storeId=${storeId}`);
        if (!response.ok) {
          throw new Error('ã‚«ãƒ†ã‚´ãƒªã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        const data = await response.json();
        setCategories(data);
      } catch (err) {
        console.error('ã‚«ãƒ†ã‚´ãƒªå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      } finally {
        setIsLoadingCategories(false);
      }
    };

    fetchCategories();
  }, [storeId]);

  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’è§£æ”¾
  useEffect(() => {
    return () => {
      if (selectedImage.previewUrl) {
        URL.revokeObjectURL(selectedImage.previewUrl);
      }
    };
  }, [selectedImage.previewUrl]);

  // ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
  const uploadImage = async (): Promise<string | null> => {
    if (!selectedImage.resizedBlob || !selectedImage.fileName) {
      return null; // ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯nullã‚’è¿”ã™
    }

    try {
      // ãƒªã‚µã‚¤ã‚ºã—ãŸç”»åƒã‚’Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
      const resizedFile = new File(
        [selectedImage.resizedBlob],
        selectedImage.fileName,
        { type: selectedImage.file?.type || 'image/jpeg' }
      );

      // FormDataã‚’ä½œæˆã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      const formData = new FormData();
      formData.append('file', resizedFile);

      const response = await fetch('/api/upload/menu-image', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const data = await response.json();
      return data.url;
    } catch (err) {
      throw new Error(err instanceof Error ? err.message : 'ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);
    setSuccess(null);

    try {
      // æ–°ã—ã„ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      let imageUrl = formData.image_url;
      if (selectedImage.resizedBlob) {
        setIsUploading(true);
        imageUrl = await uploadImage();
        setIsUploading(false);
      }

      // æ›´æ–°ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
      const updatedData = {
        ...formData,
        image_url: imageUrl || formData.image_url,
        store_id: storeId,
      };

      if (isEdit && menuId) {
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®æ›´æ–°
        const response = await fetch(`/api/menus/${menuId}?storeId=${storeId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updatedData),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        setSuccess('ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      } else {
        // æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ 
        const response = await fetch(`/api/menus?storeId=${storeId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updatedData),
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        setSuccess('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ–°è¦è¿½åŠ ã®å ´åˆã®ã¿ï¼‰
        if (!isEdit) {
          setFormData({
            product_id: '',
            name: '',
            description: '',
            price: 0,
            image_url: '',
            category_id: '',
            is_available: true,
          });

          // ç”»åƒé¸æŠçŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
          setSelectedImage({
            file: null,
            previewUrl: null,
            resizedBlob: null,
            fileName: null
          });
        }
      }

      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãŸå¾Œã€ä¸€è¦§ç”»é¢ã«æˆ»ã‚‹
      setTimeout(() => {
        router.push('/portal/menus');
        router.refresh();
      }, 2000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  const handleDelete = async () => {
    if (!menuId || !confirm('ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }

    setIsLoading(true);
    setError(null);
    setSuccess(null);

    try {
      const response = await fetch(`/api/menus/${menuId}?storeId=${storeId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      setSuccess('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãŸå¾Œã€ä¸€è¦§ç”»é¢ã«æˆ»ã‚‹
      setTimeout(() => {
        router.push('/portal/menus');
        router.refresh();
      }, 2000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <div className="space-y-6">
        {error && (
          <div className="bg-red-50 border-l-4 border-red-400 p-4">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-red-700">{error}</p>
              </div>
            </div>
          </div>
        )}

        {success && (
          <div className="bg-green-50 border-l-4 border-green-400 p-4">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-green-700">{success}</p>
              </div>
            </div>
          </div>
        )}

        <div className="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <div>
            <label htmlFor="product_id" className="block text-sm font-medium text-gray-700">
              å•†å“ID
            </label>
            <div className="mt-1">
              <input
                type="text"
                name="product_id"
                id="product_id"
                value={formData.product_id}
                onChange={handleChange}
                className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                required
                disabled={isEdit} // ç·¨é›†æ™‚ã¯IDã‚’å¤‰æ›´ã§ããªã„ã‚ˆã†ã«
              />
            </div>
            {isEdit && (
              <p className="mt-1 text-xs text-gray-500">
                å•†å“IDã¯ç·¨é›†ã§ãã¾ã›ã‚“
              </p>
            )}
          </div>

          <div>
            <label htmlFor="name" className="block text-sm font-medium text-gray-700">
              å•†å“å
            </label>
            <div className="mt-1">
              <input
                type="text"
                name="name"
                id="name"
                value={formData.name}
                onChange={handleChange}
                className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                required
              />
            </div>
          </div>

          <div className="sm:col-span-2">
            <label htmlFor="description" className="block text-sm font-medium text-gray-700">
              å•†å“èª¬æ˜
            </label>
            <div className="mt-1">
              <textarea
                name="description"
                id="description"
                rows={3}
                value={formData.description || ''}
                onChange={handleChange}
                className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
              />
            </div>
          </div>

          <div>
            <label htmlFor="price" className="block text-sm font-medium text-gray-700">
              ä¾¡æ ¼ï¼ˆå††ï¼‰
            </label>
            <div className="mt-1">
              <input
                type="number"
                name="price"
                id="price"
                min="0"
                value={formData.price}
                onChange={handleChange}
                className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                required
              />
            </div>
          </div>

          <div>
            <label htmlFor="category_id" className="block text-sm font-medium text-gray-700">
              ã‚«ãƒ†ã‚´ãƒªãƒ¼
            </label>
            <div className="mt-1">
              <select
                name="category_id"
                id="category_id"
                value={formData.category_id || ''}
                onChange={handleChange}
                className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
              >
                <option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ</option>
                {categories.map((category) => (
                  <option key={category.category_id} value={category.category_id}>
                    {category.name}
                  </option>
                ))}
              </select>
            </div>
            <div className="mt-1 text-xs text-gray-500">
              <a href="/portal/menu-categories" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ç®¡ç†ã™ã‚‹
              </a>
            </div>
          </div>

          <div>
            <label htmlFor="image_upload" className="block text-sm font-medium text-gray-700">
              ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </label>
            <div className="mt-1 flex items-center space-x-2">
              <input
                type="file"
                id="image_upload"
                ref={fileInputRef}
                onChange={handleFileChange}
                accept="image/jpeg,image/png,image/webp,image/gif"
                className="hidden"
              />
              <button
                type="button"
                onClick={() => fileInputRef.current?.click()}
                className="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                disabled={isUploading}
              >
                {isUploading ? 'ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...' : 'ç”»åƒã‚’é¸æŠ'}
              </button>
              {uploadError && (
                <p className="text-sm text-red-600">{uploadError}</p>
              )}
            </div>
            {/* ç”»åƒURLã¯éè¡¨ç¤ºã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ä¿æŒ */}
            <input
              type="hidden"
              name="image_url"
              id="image_url"
              value={formData.image_url || ''}
            />
          </div>

          <div>
            {selectedImage.previewUrl ? (
              <div className="mt-2">
                <p className="block text-sm font-medium text-gray-700 mb-2">ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœªä¿å­˜ï¼‰</p>
                <div className="w-32 h-32 relative">
                  <Image
                    src={selectedImage.previewUrl}
                    alt="å•†å“ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"
                    fill
                    sizes="128px"
                    className="object-cover rounded"
                    unoptimized
                  />
                </div>
                <button
                  type="button"
                  onClick={() => {
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’è§£æ”¾
                    if (selectedImage.previewUrl) {
                      URL.revokeObjectURL(selectedImage.previewUrl);
                    }
                    // ç”»åƒé¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    setSelectedImage({
                      file: null,
                      previewUrl: null,
                      resizedBlob: null,
                      fileName: null
                    });
                  }}
                  className="mt-2 text-xs text-red-600 hover:text-red-800"
                >
                  ç”»åƒã‚’å‰Šé™¤
                </button>
              </div>
            ) : formData.image_url ? (
              <div className="mt-2">
                <p className="block text-sm font-medium text-gray-700 mb-2">ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆä¿å­˜æ¸ˆã¿ï¼‰</p>
                <div className="w-32 h-32 relative">
                  <Image
                    src={formData.image_url}
                    alt="å•†å“ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"
                    fill
                    sizes="128px"
                    className="object-cover rounded"
                    unoptimized
                  />
                </div>
                <button
                  type="button"
                  onClick={() => setFormData(prev => ({ ...prev, image_url: '' }))}
                  className="mt-2 text-xs text-red-600 hover:text-red-800"
                >
                  ç”»åƒã‚’å‰Šé™¤
                </button>
              </div>
            ) : (
              <div className="mt-2">
                <p className="block text-sm font-medium text-gray-700 mb-2">ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
                <div className="w-32 h-32 bg-gray-200 rounded flex items-center justify-center">
                  <span className="text-gray-400 text-sm">ç”»åƒãªã—</span>
                </div>
              </div>
            )}
          </div>

          <div className="sm:col-span-2">
            <div className="flex items-start">
              <div className="flex items-center h-5">
                <input
                  id="is_available"
                  name="is_available"
                  type="checkbox"
                  checked={formData.is_available}
                  onChange={handleChange}
                  className="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                />
                <label htmlFor="is_available" className="ml-2 block text-sm text-gray-700">
                  æä¾›å¯èƒ½
                </label>
              </div>
            </div>
          </div>
        </div>

        <div className="flex justify-between">
          <div>
            <button
              type="button"
              onClick={() => router.back()}
              className="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button
              type="submit"
              disabled={isLoading}
              className="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300"
            >
              {isLoading ? 'å‡¦ç†ä¸­...' : isEdit ? 'æ›´æ–°' : 'è¿½åŠ '}
            </button>
          </div>

          {isEdit && (
            <button
              type="button"
              onClick={handleDelete}
              disabled={isLoading}
              className="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-red-300"
            >
              å‰Šé™¤
            </button>
          )}
        </div>
      </div>
    </form>
  );
}
</file>

<file path="app/portal/menus/menu-list.tsx">
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import Image from 'next/image';

interface Category {
  category_id: string;
  name: string;
  display_order: number;
}

interface Menu {
  menu_id: string;
  product_id: string;
  name: string;
  description: string | null;
  price: number;
  image_url: string | null;
  category: string | null;
  category_id: string | null;
  is_available: boolean;
}

interface MenuListProps {
  menus: Menu[];
}

export default function MenuList({ menus }: MenuListProps) {
  const [filter, setFilter] = useState('');
  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);
  const [availableFilter, setAvailableFilter] = useState<boolean | null>(null);
  const [categories, setCategories] = useState<Category[]>([]);
  const [isLoadingCategories, setIsLoadingCategories] = useState(false);

  // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—
  useEffect(() => {
    const fetchCategories = async () => {
      setIsLoadingCategories(true);
      try {
        // URLã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const storeId = urlParams.get('storeId') || localStorage.getItem('store-id');

        const response = await fetch(`/api/menu-categories?storeId=${storeId}`);
        if (!response.ok) {
          throw new Error('ã‚«ãƒ†ã‚´ãƒªã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        const data = await response.json();
        setCategories(data);
      } catch (err) {
        console.error('ã‚«ãƒ†ã‚´ãƒªå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      } finally {
        setIsLoadingCategories(false);
      }
    };

    fetchCategories();
  }, []);

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å–å¾—
  const filteredMenus = menus.filter(menu => {
    // åå‰ã¾ãŸã¯IDã§æ¤œç´¢
    const nameMatch = menu.name.toLowerCase().includes(filter.toLowerCase()) ||
                     menu.product_id.toLowerCase().includes(filter.toLowerCase());

    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const categoryMatch = categoryFilter === null || menu.category_id === categoryFilter;

    // æä¾›å¯å¦ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const availableMatch = availableFilter === null || menu.is_available === availableFilter;

    return nameMatch && categoryMatch && availableMatch;
  });

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆ
  if (menus.length === 0) {
    return (
      <div className="bg-white shadow overflow-hidden sm:rounded-lg">
        <div className="px-4 py-5 sm:p-6 text-center">
          <p className="text-gray-500">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
          <p className="text-gray-500 mt-2">ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ–°ã—ã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã‹ã€ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ãªå ´åˆã¯ã€Œã‚¹ãƒãƒ¬ã‚¸åŒæœŸã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white shadow overflow-hidden sm:rounded-lg">
      <div className="px-4 py-5 sm:p-6">
        <div className="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-4">
          <div className="col-span-1 sm:col-span-2">
            <label htmlFor="filter" className="block text-sm font-medium text-gray-700">
              æ¤œç´¢
            </label>
            <input
              type="text"
              name="filter"
              id="filter"
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
              placeholder="ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã¾ãŸã¯ID"
              className="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
            />
          </div>

          <div>
            <label htmlFor="category" className="block text-sm font-medium text-gray-700">
              ã‚«ãƒ†ã‚´ãƒªãƒ¼
            </label>
            <select
              id="category"
              name="category"
              value={categoryFilter || ''}
              onChange={(e) => setCategoryFilter(e.target.value || null)}
              className="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            >
              <option value="">ã™ã¹ã¦</option>
              {categories.map((category) => (
                <option key={category.category_id} value={category.category_id}>
                  {category.name}
                </option>
              ))}
            </select>
          </div>

          <div className="flex space-x-4">
            <div>
              <label htmlFor="available" className="block text-sm font-medium text-gray-700">
                æä¾›çŠ¶æ…‹
              </label>
              <select
                id="available"
                name="available"
                value={availableFilter === null ? '' : availableFilter ? 'true' : 'false'}
                onChange={(e) => {
                  if (e.target.value === '') {
                    setAvailableFilter(null);
                  } else {
                    setAvailableFilter(e.target.value === 'true');
                  }
                }}
                className="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              >
                <option value="">ã™ã¹ã¦</option>
                <option value="true">æä¾›å¯</option>
                <option value="false">æä¾›ä¸å¯</option>
              </select>
            </div>


          </div>
        </div>

        <div className="mt-4">
          <p className="text-sm text-gray-500 mb-2">
            {filteredMenus.length} ä»¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
          </p>
          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {filteredMenus.map((menu) => (
              <div
                key={menu.menu_id}
                className={`border rounded-lg overflow-hidden shadow-sm ${
                  !menu.is_available ? 'bg-gray-50' : 'bg-white'
                }`}
              >
                <div className="p-4">
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="text-lg font-medium text-gray-900 truncate">
                        {menu.name}
                      </h3>
                      <p className="text-sm text-gray-500">ID: {menu.product_id}</p>
                    </div>
                    <div className="flex flex-col items-end">
                      <span className="text-lg font-medium text-gray-900">
                        {menu.price.toLocaleString()}å††
                      </span>
                      <div className="flex space-x-1 mt-1">
                        {!menu.is_available && (
                          <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                            æä¾›åœæ­¢
                          </span>
                        )}
                      </div>
                    </div>
                  </div>

                  <div className="mt-2 flex items-center">
                    {menu.image_url ? (
                      <div className="w-16 h-16 relative mr-3 flex-shrink-0">
                        <Image
                          src={menu.image_url}
                          alt={menu.name}
                          fill
                          sizes="64px"
                          className="object-cover rounded"
                        />
                      </div>
                    ) : (
                      <div className="w-16 h-16 bg-gray-200 rounded mr-3 flex items-center justify-center flex-shrink-0">
                        <span className="text-gray-400 text-xs">ç”»åƒãªã—</span>
                      </div>
                    )}
                    <div className="flex-1">
                      <p className="text-sm text-gray-500 line-clamp-2">
                        {menu.description || 'èª¬æ˜ãªã—'}
                      </p>
                      <p className="text-xs text-gray-400 mt-1">
                        ã‚«ãƒ†ã‚´ãƒªãƒ¼: {categories.find(c => c.category_id === menu.category_id)?.name || 'æœªåˆ†é¡'}
                      </p>
                    </div>
                  </div>

                  <div className="mt-4 flex justify-end">
                    <Link
                      href={`/portal/menus/${menu.menu_id}/edit`}
                      className="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200"
                    >
                      ç·¨é›†
                    </Link>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/menus/new/page.tsx">
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';
import MenuForm from '../menu-form';

export default async function NewMenuPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');



  // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  if (!userResponse.ok) {
    redirect('/');
  }

  const { user } = await userResponse.json();

  // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (user.role !== 'admin') {
    redirect('/portal/dashboard');
  }

  // åº—èˆ—æƒ…å ±ã‚’APIã‹ã‚‰å–å¾—
  const storeResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/stores/${storeId}`, {
    cache: 'no-store'
  });

  if (!storeResponse.ok) {
    console.error('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await storeResponse.text());
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  const store = await storeResponse.json();

  return (
    <div className="py-6">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-2xl font-semibold text-gray-900">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ </h1>
      </div>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div className="bg-white shadow overflow-hidden sm:rounded-lg">
          <div className="px-4 py-5 sm:p-6">
            <MenuForm storeId={storeId} />
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/menus/smaregi-sync-button.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

interface SmaregiSyncButtonProps {
  storeId: string;
  enableSmaregiIntegration: boolean;
}

export default function SmaregiSyncButton({
  storeId,
  enableSmaregiIntegration,
}: SmaregiSyncButtonProps) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  const handleSync = async () => {
    if (!enableSmaregiIntegration) {
      setError('ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚è¨­å®šç”»é¢ã‹ã‚‰æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    setIsLoading(true);
    setError(null);
    setSuccess(null);

    try {
      const response = await fetch('/api/smaregi-sync', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          store_id: storeId,
        }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'ã‚¹ãƒãƒ¬ã‚¸åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const data = await response.json();
      setSuccess(`ã‚¹ãƒãƒ¬ã‚¸åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸã€‚${data.count || 0}ä»¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`);
      
      // ç”»é¢ã‚’æ›´æ–°
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚¹ãƒãƒ¬ã‚¸åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div>
      <button
        type="button"
        onClick={handleSync}
        disabled={isLoading || !enableSmaregiIntegration}
        className={`inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white ${
          enableSmaregiIntegration
            ? 'bg-green-600 hover:bg-green-700'
            : 'bg-gray-400 cursor-not-allowed'
        }`}
      >
        {isLoading ? (
          <>
            <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            åŒæœŸä¸­...
          </>
        ) : (
          'ã‚¹ãƒãƒ¬ã‚¸åŒæœŸ'
        )}
      </button>

      {error && (
        <div className="mt-2 text-sm text-red-600">
          {error}
        </div>
      )}

      {success && (
        <div className="mt-2 text-sm text-green-600">
          {success}
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/portal/order-board/order-board-client.tsx">
'use client';

import { useState, useEffect, useMemo } from 'react';
import { subscribeToOrders, subscribeToOrderItems } from '@/lib/supabase-realtime';

// æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®å‹å®šç¾©
interface OrderItem {
  order_id: string;
  order_item_id: string;
  status: string;
  created_at: string;
  created_by_role: string;
  proxy: boolean;
  table_name: string;
  product_id: string;
  product_name: string;
  quantity: number;
  price: number;
  total: number;
  target_cast_id: string | null;
  target_cast_name: string | null;
}

// æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å®šç¾©
const ORDER_STATUSES = [
  { value: 'new', label: 'æ–°è¦', color: 'bg-green-500 text-white', nextStatus: 'ack' },
  { value: 'ack', label: 'ç¢ºèªæ¸ˆ', color: 'bg-pink-500 text-white', nextStatus: 'prep' },
  { value: 'prep', label: 'æº–å‚™ä¸­', color: 'bg-pink-500 text-white', nextStatus: 'served' },
  { value: 'served', label: 'æä¾›æ¸ˆ', color: 'bg-gray-400 text-white', nextStatus: 'closed' },
  { value: 'closed', label: 'å®Œäº†', color: 'bg-gray-500 text-white', nextStatus: 'closed' },
  { value: 'cancel', label: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', color: 'bg-red-500 text-white', nextStatus: 'cancel' },
];

interface OrderBoardClientProps {
  initialOrderItems: OrderItem[];
  storeId: string;
}

export default function OrderBoardClient({ initialOrderItems, storeId }: OrderBoardClientProps) {
  const [orderItems, setOrderItems] = useState<OrderItem[]>(initialOrderItems);

  // å®Œäº†ã¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–ã®æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦å¤ã„é †ã«ä¸¦ã¹ã‚‹
  const activeOrderItems = useMemo(() => {
    return orderItems
      .filter((item: OrderItem) => item.status !== 'closed' && item.status !== 'cancel')
      .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());
  }, [orderItems]);

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  useEffect(() => {
    if (!storeId) return;

    // æœ€æ–°ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    const fetchLatestOrders = async () => {
      try {
        console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
        const response = await fetch('/api/orders/active-items');
        if (response.ok) {
          const data = await response.json();
          console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data.length + 'ä»¶');
          setOrderItems(data);
        } else {
          console.error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', await response.text());
        }
      } catch (error) {
        console.error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    };

    // Broadcast Channelã®è¨­å®š
    const broadcastChannel = new BroadcastChannel('broadcast:orders');
    broadcastChannel.onmessage = function(event) {
      console.log('ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', event.data);
      // æ³¨æ–‡é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      if (
        event.data.type === 'order:update' ||
        event.data.type === 'order:new' ||
        event.data.type === 'order_item:update' ||
        event.data.type === 'order_item:delete'
      ) {
        fetchLatestOrders();
      }
    };

    // Supabaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    console.log('Supabaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®šä¸­...');
    
    // æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
    const unsubscribeOrders = subscribeToOrders(storeId, (payload) => {
      console.log('æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ:', payload);
      fetchLatestOrders();
    });
    
    // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
    const unsubscribeOrderItems = subscribeToOrderItems(storeId, (payload) => {
      console.log('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ:', payload);
      fetchLatestOrders();
    });

    // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
    fetchLatestOrders();

    // å®šæœŸçš„ãªãƒãƒ¼ãƒªãƒ³ã‚°ã®è¨­å®šï¼ˆ30ç§’ã”ã¨ï¼‰- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦
    const pollingInterval = setInterval(fetchLatestOrders, 30000);

    // ç”»é¢ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸã¨ãã«ã‚‚æ›´æ–°
    const handleFocus = () => {
      console.log('ç”»é¢ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™ã€‚');
      fetchLatestOrders();
    };
    window.addEventListener('focus', handleFocus);

    return () => {
      broadcastChannel.close();
      unsubscribeOrders();
      unsubscribeOrderItems();
      clearInterval(pollingInterval);
      window.removeEventListener('focus', handleFocus);
    };
  }, [storeId]);

  // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  const updateOrderItemStatus = async (orderItemId: string, newStatus: string) => {
    try {
      // å…ˆã«ãƒ­ãƒ¼ã‚«ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦å³æ™‚åæ˜ 
      setOrderItems(prevItems =>
        prevItems.map(orderItem =>
          orderItem.order_item_id === orderItemId
            ? { ...orderItem, status: newStatus }
            : orderItem
        )
      );

      console.log(`æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ  ${orderItemId} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ ${newStatus} ã«æ›´æ–°ä¸­...`);
      const formData = new FormData();
      formData.append('status', newStatus);

      const response = await fetch(`/api/order-items/${orderItemId}/status`, {
        method: 'PATCH',
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', errorData);
        // æ›´æ–°ã«å¤±æ•—ã—ãŸå ´åˆã¯æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const updatedResponse = await fetch('/api/orders/active-items');
        if (updatedResponse.ok) {
          const data = await updatedResponse.json();
          setOrderItems(data);
        }
      }
    } catch (error) {
      console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const updatedResponse = await fetch('/api/orders/active-items');
      if (updatedResponse.ok) {
        const data = await updatedResponse.json();
        setOrderItems(data);
      }
    }
  };

  // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«é€²ã‚ã‚‹é–¢æ•°
  const advanceOrderStatus = (item: OrderItem) => {
    const currentStatus = ORDER_STATUSES.find(s => s.value === item.status);
    if (currentStatus && currentStatus.nextStatus) {
      // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ å˜ä½ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      updateOrderItemStatus(item.order_item_id, currentStatus.nextStatus);
    }
  };

  // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
  const deleteOrderItem = async (item: OrderItem, e: React.MouseEvent) => {
    e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢

    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    if (!confirm(`${item.product_name}ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`)) {
      return;
    }

    // å…ˆã«ãƒ­ãƒ¼ã‚«ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦å³æ™‚åæ˜ 
    setOrderItems(prevItems =>
      prevItems.filter(orderItem => orderItem.order_item_id !== item.order_item_id)
    );

    // APIã‚’å‘¼ã³å‡ºã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’æ›´æ–°
    try {
      console.log(`æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ  ${item.order_item_id} ã‚’å‰Šé™¤ä¸­...`);
      // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤APIã‚’ä½¿ç”¨
      const response = await fetch(`/api/order-items/${item.order_item_id}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ', errorData);
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ãŸå ´åˆã¯æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const updatedResponse = await fetch('/api/orders/active-items');
        if (updatedResponse.ok) {
          const data = await updatedResponse.json();
          setOrderItems(data);
        }
      }
    } catch (error) {
      console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const updatedResponse = await fetch('/api/orders/active-items');
      if (updatedResponse.ok) {
        const data = await updatedResponse.json();
        setOrderItems(data);
      }
    }
  };

  // çµŒéæ™‚é–“ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
  const getElapsedTime = (createdAt: string) => {
    const orderTime = new Date(createdAt).getTime();
    const now = new Date().getTime();
    const diffMinutes = Math.floor((now - orderTime) / (1000 * 60));
    return `${diffMinutes}åˆ†çµŒé`;
  };

  return (
    <div>
      <h1 className="text-2xl font-bold mb-6">æ³¨æ–‡ãƒœãƒ¼ãƒ‰</h1>

      <div className="bg-gray-50 p-4 rounded-md">
        <h2 className="font-bold mb-4 px-2 py-1 border-b border-gray-200">
          ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ³¨æ–‡ ({activeOrderItems.length})
        </h2>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          {activeOrderItems.map((item) => {
            const statusInfo = ORDER_STATUSES.find(s => s.value === item.status);
            return (
              <div
                key={item.order_item_id}
                className="rounded-md shadow-sm overflow-hidden"
                onClick={() => advanceOrderStatus(item)}
              >
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† */}
                <div className={`flex justify-between items-center p-2 ${statusInfo?.color}`}>
                  <div className="flex items-center">
                    <span className="font-bold">{item.table_name}</span>
                    <span className="ml-2 text-xs">({item.order_item_id.substring(0, 4)})</span>
                  </div>
                  <span className="text-xs">{statusInfo?.label}</span>
                </div>

                {/* å•†å“æƒ…å ±éƒ¨åˆ† */}
                <div className="p-3 bg-white">
                  <div className="font-medium">{item.product_name}</div>

                  {/* æ•°é‡ã¨çµŒéæ™‚é–“ */}
                  <div className="flex justify-between items-center mt-2">
                    <div className="flex items-center">
                      <span className="text-sm">Ã—{item.quantity}</span>
                      <span className="ml-3 text-xs text-gray-500">{getElapsedTime(item.created_at)}</span>
                    </div>

                    {/* ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ */}
                    <button
                      className="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"
                      onClick={(e) => deleteOrderItem(item, e)}
                    >
                      Ã—
                    </button>
                  </div>

                  {/* ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ± */}
                  {item.target_cast_name && (
                    <div className="text-sm text-blue-600 mt-1">
                      {item.target_cast_name}ã¸
                    </div>
                  )}
                </div>
              </div>
            );
          })}

          {activeOrderItems.length === 0 && (
            <div className="col-span-full text-center text-gray-500 text-sm py-8">
              ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“
            </div>
          )}
        </div>
      </div>

      <div className="mt-8">
        <h2 className="text-lg font-bold mb-2">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</h2>
        <p className="text-sm text-gray-600">
          ã“ã®ãƒšãƒ¼ã‚¸ã¯è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´ã¯å³æ™‚ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
        </p>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/order-board/order-board.tsx">
'use client';

import { useState, useEffect, useMemo } from 'react';

// æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®å‹å®šç¾©
interface OrderItem {
  order_id: string;
  order_item_id: string;
  status: string;
  created_at: string;
  created_by_role: string;
  proxy: boolean;
  table_name: string;
  product_id: string;
  product_name: string;
  quantity: number;
  price: number;
  total: number;
  target_cast_id: string | null;
  target_cast_name: string | null;
}

// æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å®šç¾©
const ORDER_STATUSES = [
  { value: 'new', label: 'æ–°è¦', color: 'bg-green-500 text-white', nextStatus: 'ack' },
  { value: 'ack', label: 'ç¢ºèªæ¸ˆ', color: 'bg-pink-500 text-white', nextStatus: 'prep' },
  { value: 'prep', label: 'æº–å‚™ä¸­', color: 'bg-pink-500 text-white', nextStatus: 'served' },
  { value: 'served', label: 'æä¾›æ¸ˆ', color: 'bg-gray-400 text-white', nextStatus: 'closed' },
  { value: 'closed', label: 'å®Œäº†', color: 'bg-gray-500 text-white', nextStatus: 'closed' },
  { value: 'cancel', label: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', color: 'bg-red-500 text-white', nextStatus: 'cancel' },
];

interface OrderBoardProps {
  initialOrderItems: OrderItem[];
}

export default function OrderBoard({ initialOrderItems }: OrderBoardProps) {
  const [orderItems, setOrderItems] = useState<OrderItem[]>(initialOrderItems);

  // å®Œäº†ã¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–ã®æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦å¤ã„é †ã«ä¸¦ã¹ã‚‹
  const activeOrderItems = useMemo(() => {
    return orderItems
      .filter((item: OrderItem) => item.status !== 'closed' && item.status !== 'cancel')
      .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());
  }, [orderItems]);

  // å®šæœŸçš„ãªãƒãƒ¼ãƒªãƒ³ã‚°ã¨Broadcast Channelã®è¨­å®š
  useEffect(() => {
    // æœ€æ–°ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    const fetchLatestOrders = async () => {
      try {
        const response = await fetch('/api/orders/active-items');
        if (response.ok) {
          const data = await response.json();
          setOrderItems(data);
        } else {
          console.error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', await response.text());
        }
      } catch (error) {
        console.error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    };

    // Broadcast Channelã®è¨­å®š
    const broadcastChannel = new BroadcastChannel('broadcast:orders');
    broadcastChannel.onmessage = function(event) {
      // æ³¨æ–‡é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      if (
        event.data.type === 'order:update' ||
        event.data.type === 'order:new' ||
        event.data.type === 'order_item:update' ||
        event.data.type === 'order_item:delete'
      ) {
        fetchLatestOrders();
      }
    };

    // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
    fetchLatestOrders();

    // å®šæœŸçš„ãªãƒãƒ¼ãƒªãƒ³ã‚°ã®è¨­å®šï¼ˆ3ç§’ã”ã¨ï¼‰
    const pollingInterval = setInterval(fetchLatestOrders, 3000);

    // ç”»é¢ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸã¨ãã«ã‚‚æ›´æ–°
    const handleFocus = () => {
      fetchLatestOrders();
    };
    window.addEventListener('focus', handleFocus);

    return () => {
      broadcastChannel.close();
      clearInterval(pollingInterval);
      window.removeEventListener('focus', handleFocus);
    };
  }, []);



  // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  const updateOrderItemStatus = async (orderItemId: string, newStatus: string) => {
    try {
      // å…ˆã«ãƒ­ãƒ¼ã‚«ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦å³æ™‚åæ˜ 
      setOrderItems(prevItems =>
        prevItems.map(orderItem =>
          orderItem.order_item_id === orderItemId
            ? { ...orderItem, status: newStatus }
            : orderItem
        )
      );

      const formData = new FormData();
      formData.append('status', newStatus);

      const response = await fetch(`/api/order-items/${orderItemId}/status`, {
        method: 'PATCH',
        body: formData
      });

      if (response.ok) {
        // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«ãƒãƒ¼ãƒªãƒ³ã‚°ã§å–å¾—ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å–å¾—ã—ãªã„
      } else {
        const errorData = await response.json();
        console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', errorData);

        // æ›´æ–°ã«å¤±æ•—ã—ãŸå ´åˆã¯æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const updatedResponse = await fetch('/api/orders/active-items');
        if (updatedResponse.ok) {
          const data = await updatedResponse.json();
          setOrderItems(data);
        }
      }
    } catch (error) {
      console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);

      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      console.log('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿå¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
      const updatedResponse = await fetch('/api/orders/active-items');
      if (updatedResponse.ok) {
        const data = await updatedResponse.json();
        setOrderItems(data);
      }
    }
  };

  // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«é€²ã‚ã‚‹é–¢æ•°
  const advanceOrderStatus = (item: OrderItem) => {
    const currentStatus = ORDER_STATUSES.find(s => s.value === item.status);
    if (currentStatus && currentStatus.nextStatus) {
      // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ å˜ä½ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      updateOrderItemStatus(item.order_item_id, currentStatus.nextStatus);
    }
  };

  // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
  const deleteOrderItem = async (item: OrderItem, e: React.MouseEvent) => {
    e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢

    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    if (!confirm(`${item.product_name}ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`)) {
      return;
    }

    // å…ˆã«ãƒ­ãƒ¼ã‚«ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦å³æ™‚åæ˜ 
    setOrderItems(prevItems =>
      prevItems.filter(orderItem => orderItem.order_item_id !== item.order_item_id)
    );

    // APIã‚’å‘¼ã³å‡ºã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’æ›´æ–°
    try {
      // æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤APIã‚’ä½¿ç”¨
      const response = await fetch(`/api/order-items/${item.order_item_id}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«ãƒãƒ¼ãƒªãƒ³ã‚°ã§å–å¾—ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å–å¾—ã—ãªã„
      } else {
        const errorData = await response.json();
        console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ', errorData);

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ãŸå ´åˆã¯æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const updatedResponse = await fetch('/api/orders/active-items');
        if (updatedResponse.ok) {
          const data = await updatedResponse.json();
          setOrderItems(data);
        }
      }
    } catch (error) {
      console.error('æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);

      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const updatedResponse = await fetch('/api/orders/active-items');
      if (updatedResponse.ok) {
        const data = await updatedResponse.json();
        setOrderItems(data);
      }
    }
  };

  // çµŒéæ™‚é–“ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
  const getElapsedTime = (createdAt: string) => {
    const orderTime = new Date(createdAt).getTime();
    const now = new Date().getTime();
    const diffMinutes = Math.floor((now - orderTime) / (1000 * 60));
    return `${diffMinutes}åˆ†çµŒé`;
  };

  return (
    <div>
      <h1 className="text-2xl font-bold mb-6">æ³¨æ–‡ãƒœãƒ¼ãƒ‰</h1>

      <div className="bg-gray-50 p-4 rounded-md">
        <h2 className="font-bold mb-4 px-2 py-1 border-b border-gray-200">
          ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ³¨æ–‡ ({activeOrderItems.length})
        </h2>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          {activeOrderItems.map((item) => {
            const statusInfo = ORDER_STATUSES.find(s => s.value === item.status);
            return (
              <div
                key={item.order_item_id}
                className="rounded-md shadow-sm overflow-hidden"
                onClick={() => advanceOrderStatus(item)}
              >
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† */}
                <div className={`flex justify-between items-center p-2 ${statusInfo?.color}`}>
                  <div className="flex items-center">
                    <span className="font-bold">{item.table_name}</span>
                    <span className="ml-2 text-xs">({item.order_item_id.substring(0, 4)})</span>
                  </div>
                  <span className="text-xs">{statusInfo?.label}</span>
                </div>

                {/* å•†å“æƒ…å ±éƒ¨åˆ† */}
                <div className="p-3 bg-white">
                  <div className="font-medium">{item.product_name}</div>

                  {/* æ•°é‡ã¨çµŒéæ™‚é–“ */}
                  <div className="flex justify-between items-center mt-2">
                    <div className="flex items-center">
                      <span className="text-sm">Ã—{item.quantity}</span>
                      <span className="ml-3 text-xs text-gray-500">{getElapsedTime(item.created_at)}</span>
                    </div>

                    {/* ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ */}
                    <button
                      className="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"
                      onClick={(e) => deleteOrderItem(item, e)}
                    >
                      Ã—
                    </button>
                  </div>

                  {/* ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ± */}
                  {item.target_cast_name && (
                    <div className="text-sm text-blue-600 mt-1">
                      {item.target_cast_name}ã¸
                    </div>
                  )}
                </div>
              </div>
            );
          })}

          {activeOrderItems.length === 0 && (
            <div className="col-span-full text-center text-gray-500 text-sm py-8">
              ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“
            </div>
          )}
        </div>
      </div>

      <div className="mt-8">
        <h2 className="text-lg font-bold mb-2">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</h2>
        <p className="text-sm text-gray-600">
          ã“ã®ãƒšãƒ¼ã‚¸ã¯è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´ã¯å³æ™‚ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
        </p>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/order-board/page.tsx">
import { cookies } from 'next/headers';
import OrderBoardClient from './order-board-client';

// æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®å‹å®šç¾©
interface OrderItem {
  order_id: string;
  order_item_id: string;
  status: string;
  created_at: string;
  created_by_role: string;
  proxy: boolean;
  table_name: string;
  product_id: string;
  product_name: string;
  quantity: number;
  price: number;
  total: number;
  target_cast_id: string | null;
  target_cast_name: string | null;
}

export default async function OrderBoardPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');

  // APIã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
  const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/orders/active-items`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  let orderItems: OrderItem[] = [];
  if (response.ok) {
    orderItems = await response.json();
  } else {
    console.error('æ³¨æ–‡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await response.text());
  }

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ãƒˆã‚¢IDã‚’æ¸¡ã™
  return <OrderBoardClient initialOrderItems={orderItems} storeId={storeId} />;
}
</file>

<file path="app/portal/proxy-order/cart.tsx">
'use client';

import { useState } from 'react';

interface CartItem {
  menu_id: string;
  product_id: string;
  name: string;
  price: number;
  quantity: number;
  target_cast_id: string | null;
  from_user_id: string | null;
}

interface Cast {
  user_id: string;
  display_name: string;
}

interface CartProps {
  items: CartItem[];
  updateQuantity: (index: number, quantity: number) => void;
  clearCart: () => void;
  sessionId: string;
  tableId: string;
  tableName: string;
  casts: Cast[];
}

export default function Cart({
  items,
  updateQuantity,
  clearCart,
  sessionId,
  tableId,
  tableName,
  casts
}: CartProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [orderSuccess, setOrderSuccess] = useState(false);
  const [orderError, setOrderError] = useState<string | null>(null);

  // åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
  const totalPrice = items.reduce(
    (total, item) => total + item.price * item.quantity,
    0
  );

  // æ³¨æ–‡ã‚’é€ä¿¡
  const submitOrder = async () => {
    if (items.length === 0) return;

    try {
      setIsSubmitting(true);
      setOrderError(null);

      // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
      const orderData = {
        session_id: sessionId,
        table_id: tableId,
        items: items.map(item => ({
          menu_id: item.menu_id,
          product_id: item.product_id,
          name: item.name,
          price: item.price,
          quantity: item.quantity,
          target_cast_id: item.target_cast_id
        })),
        proxy: true,
        created_by_role: 'staff'
      };

      // æ³¨æ–‡APIã‚’å‘¼ã³å‡ºã—
      const response = await fetch('/api/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'æ³¨æ–‡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // æ³¨æ–‡æˆåŠŸ
      setOrderSuccess(true);
      clearCart();

      // 2ç§’å¾Œã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
      setTimeout(() => {
        setOrderSuccess(false);
      }, 2000);
    } catch (error) {
      console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', error);
      setOrderError(error instanceof Error ? error.message : 'æ³¨æ–‡å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsSubmitting(false);
    }
  };

  // ã‚­ãƒ£ã‚¹ãƒˆåã‚’å–å¾—
  const getCastName = (castId: string | null) => {
    if (!castId) return null;
    const cast = casts.find(c => c.user_id === castId);
    return cast ? cast.display_name : 'ä¸æ˜ãªã‚­ãƒ£ã‚¹ãƒˆ';
  };

  return (
    <div className="bg-gray-50 p-4 rounded-lg border sticky top-4">
      <h2 className="text-lg font-medium text-gray-900 mb-4">
        ã‚«ãƒ¼ãƒˆ - {tableName}
      </h2>

      {items.length === 0 ? (
        <p className="text-gray-500 text-center py-4">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</p>
      ) : (
        <>
          <div className="space-y-3 mb-4 max-h-[400px] overflow-y-auto">
            {items.map((item, index) => (
              <div key={`${item.menu_id}-${item.target_cast_id}-${index}`} className="flex justify-between border-b pb-2">
                <div>
                  <p className="font-medium">{item.name}</p>
                  <p className="text-sm text-gray-500">Â¥{item.price.toLocaleString()} Ã— {item.quantity}</p>
                  {item.target_cast_id && (
                    <p className="text-xs text-purple-600">
                      {getCastName(item.target_cast_id)}ã«å¥¢ã‚‹
                    </p>
                  )}
                </div>
                <div className="flex items-center">
                  <button
                    onClick={() => updateQuantity(index, item.quantity - 1)}
                    className="text-gray-500 hover:text-gray-700 px-2"
                  >
                    -
                  </button>
                  <span className="mx-1">{item.quantity}</span>
                  <button
                    onClick={() => updateQuantity(index, item.quantity + 1)}
                    className="text-gray-500 hover:text-gray-700 px-2"
                  >
                    +
                  </button>
                </div>
              </div>
            ))}
          </div>

          <div className="border-t pt-3">
            <div className="flex justify-between font-bold text-lg mb-4">
              <span>åˆè¨ˆ</span>
              <span>Â¥{totalPrice.toLocaleString()}</span>
            </div>

            <div className="space-y-2">
              <button
                onClick={submitOrder}
                disabled={isSubmitting}
                className="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 disabled:bg-blue-300"
              >
                {isSubmitting ? 'å‡¦ç†ä¸­...' : 'ä»£ç†æ³¨æ–‡ã‚’ç¢ºå®š'}
              </button>
              <button
                onClick={clearCart}
                className="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded hover:bg-gray-300"
              >
                ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
              </button>
            </div>
          </div>
        </>
      )}

      {orderSuccess && (
        <div className="mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
          æ³¨æ–‡ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸ
        </div>
      )}

      {orderError && (
        <div className="mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
          {orderError}
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/portal/proxy-order/cast-select-modal.tsx">
'use client';

import { useState, useEffect } from 'react';

interface Cast {
  id: string;
  user_id: string;
  display_name: string;
}

interface CastSelectModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSelect: (castId: string, castName: string) => void;
  storeId: string;
}

export default function CastSelectModal({ isOpen, onClose, onSelect, storeId }: CastSelectModalProps) {
  const [casts, setCasts] = useState<Cast[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’å–å¾—
  useEffect(() => {
    if (!isOpen) return;

    const fetchCasts = async () => {
      setLoading(true);
      setError(null);
      
      try {
        const response = await fetch(`/api/casts?store_id=${storeId}`);
        
        if (!response.ok) {
          throw new Error('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const data = await response.json();
        setCasts(data);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        console.error('ã‚­ãƒ£ã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchCasts();
  }, [isOpen, storeId]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-semibold">ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ</h2>
          <button
            type="button"
            className="text-gray-400 hover:text-gray-500"
            onClick={onClose}
          >
            <span className="sr-only">é–‰ã˜ã‚‹</span>
            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {loading ? (
          <div className="py-8 text-center">
            <p className="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        ) : error ? (
          <div className="py-8 text-center">
            <p className="text-red-500">{error}</p>
            <button
              type="button"
              className="mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
              onClick={onClose}
            >
              é–‰ã˜ã‚‹
            </button>
          </div>
        ) : casts.length === 0 ? (
          <div className="py-8 text-center">
            <p className="text-gray-500">ã‚­ãƒ£ã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            <button
              type="button"
              className="mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
              onClick={onClose}
            >
              é–‰ã˜ã‚‹
            </button>
          </div>
        ) : (
          <div className="mt-4 grid grid-cols-1 gap-4">
            {casts.map((cast) => (
              <button
                key={cast.id}
                className="flex items-center p-3 border rounded-lg hover:bg-gray-50"
                onClick={() => onSelect(cast.user_id, cast.display_name)}
              >
                <div className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                  <span className="text-gray-500 text-sm">{cast.display_name.charAt(0)}</span>
                </div>
                <div className="flex-1 text-left">
                  <p className="font-medium">{cast.display_name}</p>
                </div>
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/portal/proxy-order/menu-display.tsx">
'use client';

import { useState, useEffect } from 'react';
import Cart from './cart';
import CastSelectModal from './cast-select-modal';

interface MenuDisplayProps {
  tableId: string;
  sessionId: string;
  tableName: string;
}

interface MenuItem {
  menu_id: string;
  product_id: string;
  name: string;
  description: string | null;
  price: number;
  image_url: string | null;
  category_id: string | null;
  category: string | null;
  is_available: boolean;
}

interface Category {
  category_id: string;
  name: string;
  display_order: number;
  allow_treat_cast: boolean;
}

interface Cast {
  user_id: string;
  display_name: string;
}

interface CartItem {
  menu_id: string;
  product_id: string;
  name: string;
  price: number;
  quantity: number;
  target_cast_id: string | null;
  from_user_id: string | null;
}

export default function MenuDisplay({ tableId, sessionId, tableName }: MenuDisplayProps) {
  const [categories, setCategories] = useState<Category[]>([]);
  const [menuItems, setMenuItems] = useState<MenuItem[]>([]);
  const [casts, setCasts] = useState<Cast[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [addedMessage, setAddedMessage] = useState<string | null>(null);
  const [showCastModal, setShowCastModal] = useState(false);
  const [selectedMenu, setSelectedMenu] = useState<MenuItem | null>(null);
  const [storeId, setStoreId] = useState<string>('');

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
  useEffect(() => {
    const fetchMenuData = async () => {
      try {
        setLoading(true);
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’å–å¾—
        const menuResponse = await fetch(`/api/tables/${tableId}/menus`);
        if (!menuResponse.ok) {
          throw new Error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        const menuData = await menuResponse.json();

        setCategories(menuData.categories || []);
        setMenuItems(menuData.menus || []);

        // æœ€åˆã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ
        if (menuData.categories && menuData.categories.length > 0) {
          setSelectedCategory(menuData.categories[0].category_id);
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—ã—ã¦åº—èˆ—IDã‚’ç‰¹å®š
        const tableResponse = await fetch(`/api/tables/${tableId}`);
        if (!tableResponse.ok) {
          throw new Error('ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        const tableData = await tableResponse.json();
        const fetchedStoreId = tableData.store_id;
        setStoreId(fetchedStoreId);

        // ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—ï¼ˆstore_idã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šï¼‰
        const castsResponse = await fetch(`/api/casts?store_id=${fetchedStoreId}`);
        if (castsResponse.ok) {
          const castsData = await castsResponse.json();
          setCasts(castsData || []);
        } else {
          console.error('ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', await castsResponse.text());
        }
      } catch (err) {
        setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      } finally {
        setLoading(false);
      }
    };

    fetchMenuData();
  }, [tableId]);

  // ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ 
  const addToCart = (item: MenuItem, treatCast: boolean = false) => {
    if (treatCast) {
      // ã‚­ãƒ£ã‚¹ãƒˆã«å¥¢ã‚‹å ´åˆã€ã‚­ãƒ£ã‚¹ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      setSelectedMenu(item);
      setShowCastModal(true);
    } else {
      // è‡ªåˆ†ã§æ³¨æ–‡ã™ã‚‹å ´åˆã€ãã®ã¾ã¾ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
      const existingItemIndex = cartItems.findIndex(
        cartItem =>
          cartItem.menu_id === item.menu_id &&
          cartItem.target_cast_id === null
      );

      if (existingItemIndex !== -1) {
        // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æ•°é‡ã‚’å¢—ã‚„ã™
        const updatedItems = [...cartItems];
        updatedItems[existingItemIndex].quantity += 1;
        setCartItems(updatedItems);
      } else {
        // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
        setCartItems([
          ...cartItems,
          {
            menu_id: item.menu_id,
            product_id: item.product_id,
            name: item.name,
            price: item.price,
            quantity: 1,
            target_cast_id: null,
            from_user_id: null
          }
        ]);
      }

      // è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦1ç§’å¾Œã«æ¶ˆã™
      setAddedMessage(`${item.name}ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`);
      setTimeout(() => {
        setAddedMessage(null);
      }, 1000);
    }
  };

  // ã‚­ãƒ£ã‚¹ãƒˆé¸æŠå¾Œã®å‡¦ç†
  const handleCastSelect = (castId: string, castName: string) => {
    if (selectedMenu) {
      const existingItemIndex = cartItems.findIndex(
        cartItem =>
          cartItem.menu_id === selectedMenu.menu_id &&
          cartItem.target_cast_id === castId
      );

      if (existingItemIndex !== -1) {
        // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æ•°é‡ã‚’å¢—ã‚„ã™
        const updatedItems = [...cartItems];
        updatedItems[existingItemIndex].quantity += 1;
        setCartItems(updatedItems);
      } else {
        // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
        setCartItems([
          ...cartItems,
          {
            menu_id: selectedMenu.menu_id,
            product_id: selectedMenu.product_id,
            name: selectedMenu.name,
            price: selectedMenu.price,
            quantity: 1,
            target_cast_id: castId,
            from_user_id: null
          }
        ]);
      }

      // è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦1ç§’å¾Œã«æ¶ˆã™
      setAddedMessage(`${selectedMenu.name}ã‚’${castName}ã«å¥¢ã‚Šã¾ã—ãŸ`);
      setTimeout(() => {
        setAddedMessage(null);
      }, 1000);
    }
    setShowCastModal(false);
    setSelectedMenu(null);
  };

  // ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
  const clearCart = () => {
    setCartItems([]);
  };

  // ã‚«ãƒ¼ãƒˆå†…ã®ã‚¢ã‚¤ãƒ†ãƒ ã®æ•°é‡ã‚’å¤‰æ›´
  const updateQuantity = (index: number, newQuantity: number) => {
    if (newQuantity <= 0) {
      // æ•°é‡ãŒ0ä»¥ä¸‹ã®å ´åˆã¯ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
      const updatedItems = cartItems.filter((_, i) => i !== index);
      setCartItems(updatedItems);
    } else {
      // æ•°é‡ã‚’æ›´æ–°
      const updatedItems = [...cartItems];
      updatedItems[index].quantity = newQuantity;
      setCartItems(updatedItems);
    }
  };

  if (loading) {
    return <div className="text-center py-10">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>;
  }

  if (error) {
    return (
      <div className="bg-red-50 border-l-4 border-red-400 p-4">
        <div className="flex">
          <div className="ml-3">
            <p className="text-sm text-red-700">{error}</p>
          </div>
        </div>
      </div>
    );
  }

  const filteredItems = selectedCategory
    ? menuItems.filter(item => item.category_id === selectedCategory)
    : menuItems;

  const selectedCategoryData = categories.find(cat => cat.category_id === selectedCategory);
  const allowTreatCast = selectedCategoryData?.allow_treat_cast || false;

  return (
    <div className="flex flex-col md:flex-row gap-6">
      {/* ã‚­ãƒ£ã‚¹ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showCastModal && (
        <CastSelectModal
          isOpen={showCastModal}
          onClose={() => setShowCastModal(false)}
          onSelect={handleCastSelect}
          storeId={storeId}
        />
      )}

      {/* è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
      {addedMessage && (
        <div className="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50">
          {addedMessage}
        </div>
      )}

      <div className="md:w-2/3">
        {/* ã‚«ãƒ†ã‚´ãƒªé¸æŠ */}
        <div className="mb-6">
          <div className="flex flex-wrap gap-2">
            {categories.map(category => (
              <button
                key={category.category_id}
                onClick={() => setSelectedCategory(category.category_id)}
                className={`px-4 py-2 rounded-full text-sm font-medium ${
                  selectedCategory === category.category_id
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                {category.name}
              </button>
            ))}
          </div>
        </div>



        {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {filteredItems.map(item => (
            <div key={item.menu_id} className="border rounded-lg overflow-hidden shadow-sm">
              {item.image_url && (
                <div className="h-40 overflow-hidden">
                  <img
                    src={item.image_url}
                    alt={item.name}
                    className="w-full h-full object-cover"
                  />
                </div>
              )}
              <div className="p-4">
                <h3 className="font-medium">{item.name}</h3>
                {item.description && (
                  <p className="text-sm text-gray-500 mt-1">{item.description}</p>
                )}
                <p className="text-lg font-bold mt-2">Â¥{item.price.toLocaleString()}</p>

                <div className="mt-4 space-y-2">
                  <button
                    onClick={() => addToCart(item, false)}
                    className="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"
                  >
                    ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
                  </button>

                  {allowTreatCast && casts.length > 0 && (
                    <button
                      onClick={() => addToCart(item, true)}
                      className="w-full bg-pink-600 hover:bg-pink-700 text-white py-2 px-4 rounded-md"
                    >
                      ã‚­ãƒ£ã‚¹ãƒˆã«å¥¢ã‚‹
                    </button>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* ã‚«ãƒ¼ãƒˆ */}
      <div className="md:w-1/3">
        <Cart
          items={cartItems}
          updateQuantity={updateQuantity}
          clearCart={clearCart}
          sessionId={sessionId}
          tableId={tableId}
          tableName={tableName}
          casts={casts}
        />
      </div>
    </div>
  );
}
</file>

<file path="app/portal/proxy-order/page.tsx">
import { cookies } from 'next/headers';
import TableSelector from './table-selector';
import { Suspense } from 'react';

export default async function ProxyOrderPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');



  // APIã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—
  const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/proxy-order/active-tables?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  let activeTables = [];
  if (response.ok) {
    activeTables = await response.json();

  } else {
    console.error('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await response.text());
  }

  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ãƒ¼ãƒ–ãƒ«ãŒãªã„å ´åˆ
  if (!activeTables || activeTables.length === 0) {

    return (
      <div className="py-6">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h1 className="text-2xl font-semibold text-gray-900 mb-6">ä»£ç†æ³¨æ–‡</h1>

          <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div className="flex">
              <div className="ml-3">
                <p className="text-sm text-yellow-700">
                  ç¾åœ¨ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãŠå®¢æ§˜ãŒç€å¸­ã—ã¦ãƒãƒ£ãƒ¼ã‚¸ãŒé–‹å§‹ã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="py-6">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-2xl font-semibold text-gray-900 mb-6">ä»£ç†æ³¨æ–‡</h1>

        <Suspense fallback={<div>ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>}>
          <TableSelector tables={activeTables} />
        </Suspense>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/proxy-order/table-selector.tsx">
'use client';

import { useState } from 'react';
import MenuDisplay from './menu-display';

interface Table {
  table_id: string;
  name: string;
  session_id: string;
  seat_type: string;
}

interface TableSelectorProps {
  tables: Table[];
}

export default function TableSelector({ tables }: TableSelectorProps) {
  const [selectedTable, setSelectedTable] = useState<Table | null>(null);

  const handleTableSelect = (table: Table) => {
    setSelectedTable(table);
  };

  return (
    <div>
      {!selectedTable ? (
        <div>
          <h2 className="text-lg font-medium text-gray-900 mb-4">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {tables.map((table) => (
              <div
                key={table.table_id}
                className="border rounded-lg p-4 cursor-pointer hover:bg-gray-50"
                onClick={() => handleTableSelect(table)}
              >
                <h3 className="font-medium">{table.name}</h3>
                <p className="text-sm text-gray-500">å¸­ç¨®: {table.seat_type}</p>
              </div>
            ))}
          </div>
        </div>
      ) : (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-lg font-medium text-gray-900">
              {selectedTable.name} ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            </h2>
            <button
              onClick={() => setSelectedTable(null)}
              className="text-sm text-blue-600 hover:text-blue-800"
            >
              ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã«æˆ»ã‚‹
            </button>
          </div>
          <MenuDisplay 
            tableId={selectedTable.table_id} 
            sessionId={selectedTable.session_id}
            tableName={selectedTable.name}
          />
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/portal/seat-types/_components/seat-type-form.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';

// ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã¯codeã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å‹å®šç¾©ã‚’ä¿®æ­£
type SeatTypeInput = {
  display_name: string;
  price_per_unit: number;  // æ™‚é–“å˜ä½ã‚ãŸã‚Šã®æ–™é‡‘
  store_id: string;
  time_unit_minutes: number;
  smaregi_product_id?: string;
};

// ãƒ•ã‚©ãƒ¼ãƒ ã§ä½¿ç”¨ã™ã‚‹å‹ï¼ˆseat_type_idã‚’å«ã‚€ï¼‰
interface SeatTypeFormValues extends SeatTypeInput {
  seat_type_id?: string;
}

// ã‚¹ãƒãƒ¬ã‚¸å•†å“ã®å‹å®šç¾©
interface SmaregiProduct {
  productId: string;
  name: string;
  price: number;
}

export default function SeatTypeForm({
  defaultValues
}: {
  defaultValues: Partial<SeatTypeFormValues>;
}) {
  const router = useRouter();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [isSmaregiEnabled, setIsSmaregiEnabled] = useState(false);
  const [showSmaregiModal, setShowSmaregiModal] = useState(false);
  const [smaregiProducts, setSmaregiProducts] = useState<SmaregiProduct[]>([]);
  const [isLoadingProducts, setIsLoadingProducts] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');

  const [formValues, setFormValues] = useState<SeatTypeInput>({
    display_name: defaultValues.display_name || '',
    price_per_unit: defaultValues.price_per_unit || 0, // äº’æ›æ€§ã®ãŸã‚ä¸¡æ–¹ãƒã‚§ãƒƒã‚¯
    store_id: defaultValues.store_id || '',
    time_unit_minutes: defaultValues.time_unit_minutes || 30, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30åˆ†
    smaregi_product_id: defaultValues.smaregi_product_id || '',
  });

  // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã«ãªã£ãŸæ™‚ã«ä¾¡æ ¼ã‚’0ã«ãƒªã‚»ãƒƒãƒˆ
  useEffect(() => {
    if (isSmaregiEnabled && !defaultValues.seat_type_id) {
      setFormValues(prev => ({
        ...prev,
        price_per_unit: 0
      }));
    }
  }, [isSmaregiEnabled, defaultValues.seat_type_id]);

  // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’ç¢ºèª
  useEffect(() => {
    const checkSmaregiEnabled = async () => {
      try {
        const response = await fetch('/api/stores/settings/smaregi-status');
        if (response.ok) {
          const data = await response.json();
          setIsSmaregiEnabled(data.enabled);
        }
      } catch (error) {
        console.error('ã‚¹ãƒãƒ¬ã‚¸é€£æºçŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      }
    };

    checkSmaregiEnabled();
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;

    // æ›´æ–°ã•ã‚ŒãŸå€¤ã‚’å–å¾—
    let updatedValue;
    if (name === 'price_per_unit' || name === 'time_unit_minutes') {
      updatedValue = parseInt(value, 10) || 0;
    } else {
      updatedValue = value;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’æ›´æ–°
    setFormValues(prev => ({
      ...prev,
      [name]: updatedValue
    }));
  };

  // ã‚¹ãƒãƒ¬ã‚¸å•†å“ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  const fetchSmaregiProducts = async () => {
    setIsLoadingProducts(true);
    try {
      const response = await fetch('/api/smaregi-products');
      if (response.ok) {
        const data = await response.json();
        setSmaregiProducts(data.products);
      } else {
        console.error('ã‚¹ãƒãƒ¬ã‚¸å•†å“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('ã‚¹ãƒãƒ¬ã‚¸å•†å“ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    } finally {
      setIsLoadingProducts(false);
    }
  };

  // ã‚¹ãƒãƒ¬ã‚¸å•†å“é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  const openSmaregiModal = () => {
    if (smaregiProducts.length === 0) {
      fetchSmaregiProducts();
    }
    setShowSmaregiModal(true);
  };

  // ã‚¹ãƒãƒ¬ã‚¸å•†å“ã‚’é¸æŠ
  const selectSmaregiProduct = (product: SmaregiProduct) => {
    // å•†å“IDã‚’ãã®ã¾ã¾ä¿å­˜
    setFormValues({
      ...formValues,
      smaregi_product_id: product.productId,
      price_per_unit: isSmaregiEnabled ? product.price : formValues.price_per_unit
    });
    setShowSmaregiModal(false);
  };

  // ã‚¹ãƒãƒ¬ã‚¸å•†å“ã®é¸æŠã‚’è§£é™¤
  const clearSmaregiProduct = () => {
    setFormValues({
      ...formValues,
      smaregi_product_id: '',
      price_per_unit: 0
    });
    setShowSmaregiModal(false);
  };

  // æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹å•†å“ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const filteredProducts = smaregiProducts.filter(product =>
    product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    product.productId.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    setError(null);

    try {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!formValues.display_name || formValues.price_per_unit < 0 || formValues.time_unit_minutes <= 0) {
        throw new Error('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
      }

      // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã§å•†å“IDãŒæœªå…¥åŠ›ã®å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤ºã™ã‚‹ãŒã€ä¿å­˜ã¯å¯èƒ½
      if (isSmaregiEnabled && !formValues.smaregi_product_id) {
        console.warn('ã‚¹ãƒãƒ¬ã‚¸å•†å“IDãŒæœªå…¥åŠ›ã§ã™ã€‚ä¼šè¨ˆæ™‚ã«ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
      }

      // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ±ºå®šï¼ˆåº—èˆ—IDã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦å«ã‚ã‚‹ï¼‰
      const endpoint = defaultValues.seat_type_id
        ? `/api/seat-types/${defaultValues.seat_type_id}?storeId=${formValues.store_id}`
        : `/api/seat-types?storeId=${formValues.store_id}`;

      // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
      console.log('é€ä¿¡ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ å€¤:', formValues);

      // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      const method = defaultValues.seat_type_id ? 'PATCH' : 'POST';
      const response = await fetch(endpoint, {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formValues),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'å¸­ç¨®ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // æˆåŠŸã—ãŸã‚‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      router.push('/portal/seat-types');
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {error && (
        <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
          <p className="text-red-700">{error}</p>
        </div>
      )}

      {/* ã‚³ãƒ¼ãƒ‰ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã— */}

      <div>
        <label htmlFor="display_name" className="block text-sm font-medium text-gray-700 mb-1">
          è¡¨ç¤ºå
        </label>
        <input
          type="text"
          id="display_name"
          name="display_name"
          value={formValues.display_name}
          onChange={handleChange}
          className="w-full px-3 py-2 border border-gray-300 rounded-md"
          required
        />
        <p className="mt-1 text-sm text-gray-500">
          ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹å¸­ç¨®ã®åå‰ï¼ˆä¾‹: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­, ãƒ†ãƒ¼ãƒ–ãƒ«å¸­, VIPå¸­ï¼‰
        </p>
      </div>

      <div>
        <label htmlFor="time_unit_minutes" className="block text-sm font-medium text-gray-700 mb-1">
          æ™‚é–“å˜ä½
        </label>
        <div className="flex items-center">
          <select
            id="time_unit_minutes"
            name="time_unit_minutes"
            value={formValues.time_unit_minutes}
            onChange={handleChange}
            className="w-full px-3 py-2 border border-gray-300 rounded-md"
            required
          >
            <option value="10">10åˆ†</option>
            <option value="15">15åˆ†</option>
            <option value="20">20åˆ†</option>
            <option value="30">30åˆ†</option>
            <option value="60">60åˆ†ï¼ˆ1æ™‚é–“ï¼‰</option>
            <option value="90">90åˆ†ï¼ˆ1.5æ™‚é–“ï¼‰</option>
            <option value="120">120åˆ†ï¼ˆ2æ™‚é–“ï¼‰</option>
          </select>
        </div>
        <p className="mt-1 text-sm text-gray-500">
          æ–™é‡‘è¨ˆç®—ã®åŸºæœ¬å˜ä½ã¨ãªã‚‹æ™‚é–“
        </p>
      </div>

      <div>
        <label htmlFor="price_per_unit" className="block text-sm font-medium text-gray-700 mb-1">
          æ–™é‡‘ï¼ˆ{formValues.time_unit_minutes}åˆ†ã‚ãŸã‚Šï¼‰
        </label>
        <div className="flex items-center">
          <input
            type="number"
            id="price_per_unit"
            name="price_per_unit"
            value={formValues.price_per_unit}
            onChange={handleChange}
            min="0"
            step="100"
            className={`w-full px-3 py-2 border ${isSmaregiEnabled ? 'bg-gray-100' : ''} border-gray-300 rounded-md`}
            required
            readOnly={isSmaregiEnabled}
            disabled={isSmaregiEnabled}
          />
          <span className="ml-2">å††</span>
        </div>
        {isSmaregiEnabled && (
          <p className="mt-1 text-sm text-gray-500">
            ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ãªå ´åˆã€æ–™é‡‘ã¯é¸æŠã—ãŸå•†å“ã®ä¾¡æ ¼ã‹ã‚‰è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™
          </p>
        )}
      </div>

      {/* ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ãªå ´åˆã®ã¿è¡¨ç¤º */}
      {isSmaregiEnabled && (
        <div>
          <label htmlFor="smaregi_product_id" className="block text-sm font-medium text-gray-700 mb-1">
            ã‚¹ãƒãƒ¬ã‚¸å•†å“é€£æº
          </label>
          <div className="flex items-center space-x-2">
            <input
              type="text"
              id="smaregi_product_id"
              name="smaregi_product_id"
              value={formValues.smaregi_product_id || ''}
              onChange={handleChange}
              className="w-full px-3 py-2 border border-gray-300 rounded-md"
              placeholder="ã‚¹ãƒãƒ¬ã‚¸å•†å“ID"
              readOnly
            />
            <button
              type="button"
              onClick={openSmaregiModal}
              className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
            >
              å•†å“é¸æŠ
            </button>
            {formValues.smaregi_product_id && (
              <button
                type="button"
                onClick={() => {
                  setFormValues({
                    ...formValues,
                    smaregi_product_id: '',
                    price_per_unit: 0
                  });
                }}
                className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
              >
                è§£é™¤
              </button>
            )}
          </div>
          {formValues.smaregi_product_id ? (
            <div className="mt-2 p-2 bg-blue-50 border border-blue-200 rounded-md">
              <p className="text-sm text-blue-800">
                é¸æŠä¸­ã®å•†å“: <span className="font-semibold">{formValues.smaregi_product_id}</span>
              </p>
              <p className="text-sm text-blue-800">
                æ–™é‡‘: <span className="font-semibold">{formValues.price_per_unit}å††</span>
              </p>
            </div>
          ) : (
            <p className="mt-1 text-sm text-gray-500">
              ä¼šè¨ˆæ™‚ã«ã‚¹ãƒãƒ¬ã‚¸ã«é€£æºã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„
            </p>
          )}
        </div>
      )}

      <div className="flex justify-end space-x-4">
        <button
          type="button"
          onClick={() => router.back()}
          className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
          disabled={isSubmitting}
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button
          type="submit"
          className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-300"
          disabled={isSubmitting}
        >
          {isSubmitting ? 'ä¿å­˜ä¸­...' : defaultValues.seat_type_id ? 'æ›´æ–°' : 'ä½œæˆ'}
        </button>
      </div>

      {/* ã‚¹ãƒãƒ¬ã‚¸å•†å“é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showSmaregiModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <h3 className="text-lg font-medium mb-4">ã‚¹ãƒãƒ¬ã‚¸å•†å“é¸æŠ</h3>

            {/* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  */}
            <div className="mb-4">
              <input
                type="text"
                placeholder="å•†å“åã¾ãŸã¯å•†å“IDã§æ¤œç´¢"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md"
              />
            </div>

            {/* å•†å“ãƒªã‚¹ãƒˆ */}
            {isLoadingProducts ? (
              <div className="text-center py-4">
                <p>å•†å“ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
              </div>
            ) : filteredProducts.length > 0 ? (
              <div className="border border-gray-200 rounded-md overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å•†å“ID</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å•†å“å</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¾¡æ ¼</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {filteredProducts.map((product) => (
                      <tr key={product.productId}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          {product.productId}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{product.name}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{product.price}å††</td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                          <button
                            type="button"
                            onClick={() => selectSmaregiProduct(product)}
                            className="text-blue-600 hover:text-blue-900"
                          >
                            é¸æŠ
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <div className="text-center py-4">
                <p>å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
              </div>
            )}

            {/* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼ */}
            <div className="mt-6 flex justify-end space-x-2">
              <button
                type="button"
                onClick={clearSmaregiProduct}
                className="px-4 py-2 border border-red-300 rounded-md text-red-700 hover:bg-red-50"
              >
                é¸æŠè§£é™¤
              </button>
              <button
                type="button"
                onClick={() => setShowSmaregiModal(false)}
                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
              >
                é–‰ã˜ã‚‹
              </button>
            </div>
          </div>
        </div>
      )}
    </form>
  );
}
</file>

<file path="app/portal/seat-types/[id]/edit/page.tsx">
import { cookies } from 'next/headers';
import { notFound } from 'next/navigation';
import Link from 'next/link';
import SeatTypeForm from '../../_components/seat-type-form';

export default async function EditSeatTypePage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  // UUIDã¨ã—ã¦å‡¦ç†ï¼ˆæ•°å€¤å¤‰æ›ã¯ä¸è¦ï¼‰
  const seatTypeId = id;

  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // APIã‹ã‚‰å¸­ç¨®æƒ…å ±ã‚’å–å¾—ï¼ˆåº—èˆ—IDã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦å«ã‚ã‚‹ï¼‰
  const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/seat-types/${seatTypeId}?storeId=${storeId}`, {
    cache: 'no-store'
  });

  if (!response.ok) {
    console.error('å¸­ç¨®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await response.text());
    notFound();
  }

  const seatType = await response.json();

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">å¸­ç¨®ç·¨é›†: {seatType.display_name}</h1>
        <Link
          href="/portal/seat-types"
          className="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600"
        >
          æˆ»ã‚‹
        </Link>
      </div>

      <div className="bg-white shadow-md rounded-lg p-6">
        <SeatTypeForm defaultValues={seatType} />
      </div>
    </div>
  );
}
</file>

<file path="app/portal/seat-types/new/page.tsx">
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import SeatTypeForm from '../_components/seat-type-form';

export default async function NewSeatTypePage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // æ–°è¦ä½œæˆç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  const defaultValues = {
    display_name: '',
    price_per_unit: 0, // æ™‚é–“å˜ä½ã‚ãŸã‚Šã®æ–™é‡‘
    time_unit_minutes: 30, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30åˆ†
    store_id: storeId
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">æ–°è¦å¸­ç¨®ä½œæˆ</h1>
        <Link
          href="/portal/seat-types"
          className="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600"
        >
          æˆ»ã‚‹
        </Link>
      </div>

      <div className="bg-white shadow-md rounded-lg p-6">
        <SeatTypeForm defaultValues={defaultValues} />
      </div>
    </div>
  );
}
</file>

<file path="app/portal/seat-types/page.tsx">
import Link from 'next/link';
import { cookies } from 'next/headers';

// å¸­ç¨®ã®å‹å®šç¾©
interface SeatType {
  seat_type_id: string; // UUIDãªã®ã§æ–‡å­—åˆ—å‹
  display_name: string;
  price_per_unit: number; // æ™‚é–“å˜ä½ã‚ãŸã‚Šã®æ–™é‡‘
  time_unit_minutes: number;
  store_id: string;
  created_at: string;
}

export default async function SeatTypesPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // APIã‹ã‚‰å¸­ç¨®ä¸€è¦§ã‚’å–å¾—
  const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/seat-types?storeId=${storeId}`, {
    cache: 'no-store'
  });

  let seatTypes: SeatType[] = [];
  if (response.ok) {
    seatTypes = await response.json();
  } else {
    console.error('å¸­ç¨®ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await response.text());
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">å¸­ç¨®è¨­å®š</h1>
        <Link
          href="/portal/seat-types/new"
          className="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
        >
          æ–°è¦å¸­ç¨®ä½œæˆ
        </Link>
      </div>

      <div className="bg-white shadow overflow-hidden sm:rounded-md">
        <ul className="divide-y divide-gray-200">
          {seatTypes && seatTypes.length > 0 ? (
            seatTypes.map((seatType) => (
              <li key={seatType.seat_type_id} className="px-6 py-4">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-lg font-medium text-gray-900">
                      {seatType.display_name}
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="text-xl font-bold text-gray-900">
                      {seatType.price_per_unit}å††/{seatType.time_unit_minutes || 30}åˆ†
                    </p>
                    <Link
                      href={`/portal/seat-types/${seatType.seat_type_id}/edit`}
                      className="text-blue-600 hover:text-blue-800 text-sm"
                    >
                      ç·¨é›†
                    </Link>
                  </div>
                </div>
              </li>
            ))
          ) : (
            <li className="px-6 py-4 text-center text-gray-500">
              å¸­ç¨®ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œæ–°è¦å¸­ç¨®ä½œæˆã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
            </li>
          )}
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/tables/_components/charge-control-button.tsx">
'use client';

import { useState } from 'react';

interface ChargeControlButtonProps {
  tableId: string;
  sessionId: string;
  isPaused: boolean;
}

export default function ChargeControlButton({ tableId, sessionId, isPaused }: ChargeControlButtonProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [currentPauseState, setCurrentPauseState] = useState(isPaused);

  const handleToggleCharge = async () => {
    try {
      setIsLoading(true);
      setError(null);

      // èª²é‡‘åœæ­¢ã¾ãŸã¯å†é–‹ã®APIã‚’å‘¼ã³å‡ºã™
      const endpoint = currentPauseState
        ? `/api/tables/${tableId}/sessions/${sessionId}/resume`
        : `/api/tables/${tableId}/sessions/${sessionId}/pause`;

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // çŠ¶æ…‹ã‚’æ›´æ–°
      setCurrentPauseState(!currentPauseState);

      // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’åæ˜ 
      window.location.reload();
    } catch (err) {
      console.error('èª²é‡‘åˆ¶å¾¡ã‚¨ãƒ©ãƒ¼:', err);
      setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div>
      <button
        onClick={handleToggleCharge}
        disabled={isLoading}
        className={`w-full py-1 px-3 rounded-md text-sm ${
          currentPauseState
            ? 'bg-green-600 hover:bg-green-700 text-white'
            : 'bg-yellow-500 hover:bg-yellow-600 text-white'
        } ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
      >
        {isLoading ? 'å‡¦ç†ä¸­...' : currentPauseState ? 'èª²é‡‘å†é–‹' : 'èª²é‡‘ä¸€æ™‚åœæ­¢'}
      </button>
      {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
    </div>
  );
}
</file>

<file path="app/portal/tables/_components/table-form.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Database } from '@/lib/database.types';

type Table = Database['public']['Tables']['tables']['Row'];
type SeatType = Database['public']['Tables']['seat_types']['Row'];

// ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã§ä½¿ç”¨ã™ã‚‹å…¥åŠ›å€¤ã®å‹
type TableInput = {
  name: string;
  seat_type_id: string;
  store_id: string;
};

// ãƒ•ã‚©ãƒ¼ãƒ ã§ä½¿ç”¨ã™ã‚‹å‹ï¼ˆtable_idã‚’å«ã‚€ï¼‰
interface TableFormValues extends Partial<TableInput> {
  table_id?: string;
  seat_type?: {
    seat_type_id: string;
    display_name: string;
    price_per_unit: number;
  };
}

interface TableFormProps {
  defaultValues: TableFormValues;
  seatTypes?: SeatType[];
}

export default function TableForm({ defaultValues, seatTypes = [] }: TableFormProps) {
  const router = useRouter();
  // seat_type_idã®åˆæœŸå€¤ã‚’å–å¾—ï¼ˆseat_typeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å–å¾—ã™ã‚‹ã‹ã€ç›´æ¥æŒ‡å®šã•ã‚ŒãŸå€¤ã‚’ä½¿ç”¨ï¼‰
  const initialSeatTypeId = defaultValues.seat_type?.seat_type_id || defaultValues.seat_type_id || '';

  const [formValues, setFormValues] = useState<TableInput>({
    name: defaultValues.name || '',
    seat_type_id: initialSeatTypeId,
    store_id: defaultValues.store_id || '',
  });
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [availableSeatTypes, setAvailableSeatTypes] = useState<SeatType[]>(seatTypes);

  // å¸­ç¨®ä¸€è¦§ã‚’å–å¾—
  const fetchSeatTypes = async () => {
    try {
      const response = await fetch(`/api/seat-types?storeId=${formValues.store_id}`);
      if (!response.ok) {
        throw new Error('å¸­ç¨®ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      const data = await response.json();
      setAvailableSeatTypes(data);
    } catch (error) {
      console.error('å¸­ç¨®ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      setError('å¸­ç¨®ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒã‚¦ãƒ³ãƒˆæ™‚ã«å¸­ç¨®ä¸€è¦§ã‚’å–å¾—
  useEffect(() => {
    if (seatTypes.length === 0) {
      fetchSeatTypes();
    }
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormValues(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);

    try {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!formValues.name || !formValues.seat_type_id) {
        throw new Error('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }

      // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ±ºå®šï¼ˆåº—èˆ—IDã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦å«ã‚ã‚‹ï¼‰
      const endpoint = defaultValues.table_id
        ? `/api/tables/${defaultValues.table_id}?storeId=${formValues.store_id}`
        : `/api/tables?storeId=${formValues.store_id}`;

      // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      const response = await fetch(endpoint, {
        method: defaultValues.table_id ? 'PATCH' : 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formValues),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // æˆåŠŸæ™‚ã®å‡¦ç†
      router.push('/portal/tables');
      router.refresh();
    } catch (error) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      setError(error instanceof Error ? error.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-md mb-4">
          {error}
        </div>
      )}

      <div className="space-y-4">
        <div>
          <label htmlFor="name" className="block text-sm font-medium text-gray-700 mb-1">
            ãƒ†ãƒ¼ãƒ–ãƒ«å
          </label>
          <input
            type="text"
            id="name"
            name="name"
            value={formValues.name}
            onChange={handleChange}
            className="w-full px-3 py-2 border border-gray-300 rounded-md"
            required
          />
        </div>

        <div>
          <label htmlFor="seat_type_id" className="block text-sm font-medium text-gray-700 mb-1">
            å¸­ç¨®
          </label>
          <select
            id="seat_type_id"
            name="seat_type_id"
            value={formValues.seat_type_id}
            onChange={handleChange}
            className="w-full px-3 py-2 border border-gray-300 rounded-md"
            required
          >
            <option value="">å¸­ç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            {availableSeatTypes.map((seatType) => (
              <option key={seatType.seat_type_id} value={seatType.seat_type_id}>
                {seatType.display_name} ({seatType.price_per_unit}å††/{seatType.time_unit_minutes || 30}åˆ†)
              </option>
            ))}
          </select>
        </div>

        <div className="pt-4">
          <button
            type="submit"
            disabled={isLoading}
            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-300"
          >
            {isLoading ? 'ä¿å­˜ä¸­...' : defaultValues.table_id ? 'æ›´æ–°ã™ã‚‹' : 'ä½œæˆã™ã‚‹'}
          </button>
        </div>
      </div>
    </form>
  );
}
</file>

<file path="app/portal/tables/_components/table-move-button.tsx">
'use client';

import { useState } from 'react';
import { Database } from '@/lib/database.types';

// ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‹å®šç¾©ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
interface Table {
  table_id: string;
  name: string;
  seat_types?: {
    display_name: string;
    price_per_unit: number;
  } | null;
}

interface TableMoveButtonProps {
  tableId: string;
  tableName: string;
  sessionId: string;
  availableTables: Table[];
}

export default function TableMoveButton({
  tableId,
  tableName,
  sessionId,
  availableTables
}: TableMoveButtonProps) {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  // ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«å€™è£œï¼ˆç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é™¤å¤–ï¼‰
  const targetTables = availableTables.filter(table => table.table_id !== tableId);

  const handleMoveTable = async (targetTableId: string) => {
    try {
      setIsLoading(true);
      setError(null);
      setSuccess(null);

      const response = await fetch(`/api/sessions/${sessionId}/move`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          target_table_id: targetTableId,
        }),
      });

      const result = await response.json();
      console.log('å¸­ç§»å‹•APIå¿œç­”:', result);

      if (!response.ok) {
        throw new Error(result.error || 'å¸­ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const previousCharge = result.previous_charge || 0;

      // ç§»å‹•å‰ã®æ–™é‡‘ãŒã‚ã‚‹å ´åˆã¯ã€ãã®æƒ…å ±ã‚‚è¡¨ç¤º
      if (previousCharge > 0) {
        setSuccess(`å¸­ç§»å‹•ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ç§»å‹•å‰ã®æ–™é‡‘ ${previousCharge.toLocaleString()}å†† ã¯ä¼šè¨ˆæ™‚ã«åŠ ç®—ã•ã‚Œã¾ã™ã€‚`);
      } else {
        setSuccess('å¸­ç§»å‹•ãŒå®Œäº†ã—ã¾ã—ãŸ');
      }

      // 3ç§’å¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
      setTimeout(() => {
        window.location.reload();
      }, 3000);
    } catch (err) {
      console.error('å¸­ç§»å‹•ã‚¨ãƒ©ãƒ¼:', err);
      setError(err instanceof Error ? err.message : 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <>
      <button
        onClick={() => setIsModalOpen(true)}
        className="bg-indigo-600 text-white py-1 px-3 rounded-md text-sm hover:bg-indigo-700"
      >
        å¸­ç§»å‹•
      </button>

      {/* å¸­ç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
            <h3 className="text-lg font-medium mb-4">å¸­ç§»å‹•</h3>
            <p className="mb-4 text-sm text-gray-600">
              ã€Œ{tableName}ã€ã‹ã‚‰ç§»å‹•å…ˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
            </p>

            {error && (
              <div className="mb-4 p-2 bg-red-100 text-red-700 rounded-md text-sm">
                {error}
              </div>
            )}

            {success && (
              <div className="mb-4 p-2 bg-green-100 text-green-700 rounded-md text-sm">
                {success}
              </div>
            )}

            {targetTables.length === 0 ? (
              <p className="text-gray-500 italic">ç§»å‹•å…ˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</p>
            ) : (
              <div className="grid grid-cols-1 gap-2 mb-4">
                {targetTables.map((table) => (
                  <button
                    key={table.table_id}
                    onClick={() => handleMoveTable(table.table_id)}
                    disabled={isLoading}
                    className="flex justify-between items-center p-3 border rounded-md hover:bg-gray-50 disabled:opacity-50"
                  >
                    <span className="font-medium">{table.name}</span>
                    <span className="text-sm text-gray-500">
                      {table.seat_types?.display_name || 'ä¸æ˜ãªå¸­ç¨®'}
                    </span>
                  </button>
                ))}
              </div>
            )}

            <div className="flex justify-end">
              <button
                onClick={() => setIsModalOpen(false)}
                disabled={isLoading}
                className="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 disabled:opacity-50"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
</file>

<file path="app/portal/tables/[table_id]/edit/page.tsx">
import { cookies } from 'next/headers';
import { notFound } from 'next/navigation';
import Link from 'next/link';
import TableForm from '../../_components/table-form';

export default async function EditTablePage({ params }: { params: Promise<{ table_id: string }> }) {
  const { table_id } = await params;

  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // APIã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’å–å¾—ï¼ˆåº—èˆ—IDã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦å«ã‚ã‚‹ï¼‰
  const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/tables/${table_id}?storeId=${storeId}`, {
    cache: 'no-store'
  });

  if (!response.ok) {
    console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await response.text());
    notFound();
  }

  const table = await response.json();

  // APIã‹ã‚‰å¸­ç¨®ä¸€è¦§ã‚’å–å¾—
  const seatTypesResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/seat-types?storeId=${storeId}`, {
    cache: 'no-store'
  });

  let seatTypes = [];
  if (seatTypesResponse.ok) {
    seatTypes = await seatTypesResponse.json();
  } else {
    console.error('å¸­ç¨®ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await seatTypesResponse.text());
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†: {table.name}</h1>
        <Link
          href="/portal/tables"
          className="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600"
        >
          æˆ»ã‚‹
        </Link>
      </div>

      <div className="bg-white shadow-md rounded-lg p-6">
        <TableForm defaultValues={table} seatTypes={seatTypes} />
      </div>
    </div>
  );
}
</file>

<file path="app/portal/tables/new/page.tsx">
import { cookies } from 'next/headers';
import Link from 'next/link';
import TableForm from '../_components/table-form';

export default async function NewTablePage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // APIã‹ã‚‰å¸­ç¨®ä¸€è¦§ã‚’å–å¾—
  const seatTypesResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/seat-types?storeId=${storeId}`, {
    cache: 'no-store'
  });
  
  let seatTypes = [];
  if (seatTypesResponse.ok) {
    seatTypes = await seatTypesResponse.json();
  } else {
    console.error('å¸­ç¨®ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await seatTypesResponse.text());
  }

  // æ–°è¦ä½œæˆç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  const defaultValues = {
    name: '',
    store_id: storeId
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ</h1>
        <Link
          href="/portal/tables"
          className="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600"
        >
          æˆ»ã‚‹
        </Link>
      </div>

      <div className="bg-white shadow-md rounded-lg p-6">
        <TableForm defaultValues={defaultValues} seatTypes={seatTypes} />
      </div>
    </div>
  );
}
</file>

<file path="app/portal/tables/page.tsx">
import { cookies } from 'next/headers';
import QRCode from 'qrcode';
import TablesClient from './tables-client';

// ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‹å®šç¾©
interface SeatType {
  seat_type_id: number;
  display_name: string;
  price_per_unit: number;
  time_unit_minutes?: number;
}

interface Table {
  table_id: string;
  name: string;
  seat_types: SeatType | null;
}

interface Session {
  session_id: string;
  table_id: string;
  start_at: string;
  charge_started_at: string;
  charge_paused_at: string | null;
}

interface ElapsedTime {
  hours: number;
  minutes: number;
  totalMinutes: number;
}

interface TableWithDetails extends Table {
  qrCode: string;
  session?: Session;
  elapsedTime?: ElapsedTime;
  formattedStartTime?: string;
  isPaused: boolean;
}

// QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆé–¢æ•°
async function generateQRCode(tableId: string): Promise<string> {
  const url = `${process.env.PUBLIC_URL || 'http://localhost:3000'}/menu/${tableId}`;
  return await QRCode.toDataURL(url);
}

export default async function TablesPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // APIã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å–å¾—
  const tablesResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/tables?storeId=${storeId}`, {
    cache: 'no-store'
  });

  let tables: Table[] = [];
  if (tablesResponse.ok) {
    tables = await tablesResponse.json();
  } else {
    console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await tablesResponse.text());
  }

  // APIã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
  const sessionsResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/sessions/active?storeId=${storeId}`, {
    cache: 'no-store'
  });

  let sessions: Session[] = [];
  if (sessionsResponse.ok) {
    sessions = await sessionsResponse.json();
  } else {
    const sessionsError = await sessionsResponse.text();
    console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', sessionsError);
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«IDã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
  const sessionMap = new Map();
  if (sessions && sessions.length > 0) {
    sessions.forEach(session => {
      // ãƒ†ãƒ¼ãƒ–ãƒ«IDã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ä¿å­˜ï¼ˆå‹ã®ä¸ä¸€è‡´ã‚’é˜²ããŸã‚ï¼‰
      const tableIdStr = String(session.table_id);

      // åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«IDã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã€æœ€æ–°ã®ã‚‚ã®ã ã‘ã‚’ä¿æŒ
      if (!sessionMap.has(tableIdStr)) {
        sessionMap.set(tableIdStr, session);
      }
    });
  }

  // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¿½åŠ 
  const tablesWithQR: TableWithDetails[] = await Promise.all(
    (tables || []).map(async (table) => {
      const qrCode = await generateQRCode(table.table_id);
      // ãƒ†ãƒ¼ãƒ–ãƒ«IDã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦æ¤œç´¢ï¼ˆå‹ã®ä¸ä¸€è‡´ã‚’é˜²ããŸã‚ï¼‰
      const tableIdStr = String(table.table_id);
      const session = sessionMap.get(tableIdStr);

      // çµŒéæ™‚é–“ã®è¨ˆç®—
      let elapsedTime: ElapsedTime | undefined = undefined;
      let formattedStartTime: string | undefined = undefined;
      let isPaused = false;

      if (session && session.charge_started_at) {
        const startTime = new Date(session.charge_started_at);
        const now = new Date();

        // ä¸€æ™‚åœæ­¢ä¸­ã‹ã©ã†ã‹ã‚’ç¢ºèª
        isPaused = !!session.charge_paused_at;

        // ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—
        const endTime = isPaused ? new Date(session.charge_paused_at) : now;

        const elapsedMinutes = Math.floor((endTime.getTime() - startTime.getTime()) / (1000 * 60));
        const hours = Math.floor(elapsedMinutes / 60);
        const minutes = elapsedMinutes % 60;

        elapsedTime = {
          hours,
          minutes,
          totalMinutes: elapsedMinutes
        };

        // ç€å¸­æ™‚é–“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        formattedStartTime = startTime.toLocaleString('ja-JP', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      return {
        ...table,
        qrCode,
        session,
        elapsedTime,
        formattedStartTime,
        isPaused
      };
    })
  );

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ãƒˆã‚¢IDã‚’æ¸¡ã™
  return <TablesClient initialTables={tablesWithQR} storeId={storeId} />;
}
</file>

<file path="app/portal/tables/tables-client.tsx">
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { subscribeToSessions, subscribeToTables } from '@/lib/supabase-realtime';
import ChargeControlButton from './_components/charge-control-button';
import TableMoveButton from './_components/table-move-button';

// ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‹å®šç¾©
interface SeatType {
  seat_type_id: number;
  display_name: string;
  price_per_unit: number;
  time_unit_minutes?: number;
}

interface Table {
  table_id: string;
  name: string;
  seat_types: SeatType | null;
  qrCode: string;
}

interface Session {
  session_id: string;
  table_id: string;
  start_at: string;
  charge_started_at: string;
  charge_paused_at: string | null;
}

interface ElapsedTime {
  hours: number;
  minutes: number;
  totalMinutes: number;
}

interface TableWithDetails extends Table {
  session?: Session;
  elapsedTime?: ElapsedTime;
  formattedStartTime?: string;
  isPaused: boolean;
}

interface TablesClientProps {
  initialTables: TableWithDetails[];
  storeId: string;
}

export default function TablesClient({ initialTables, storeId }: TablesClientProps) {
  const [tables, setTables] = useState<TableWithDetails[]>(initialTables);
  const [now, setNow] = useState(new Date());

  // ç¾åœ¨æ™‚åˆ»ã‚’1ç§’ã”ã¨ã«æ›´æ–°
  useEffect(() => {
    const timer = setInterval(() => {
      setNow(new Date());
    }, 1000);

    return () => clearInterval(timer);
  }, []);

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  useEffect(() => {
    if (!storeId) return;

    // æœ€æ–°ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    const fetchLatestData = async () => {
      try {
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å–å¾—
        const tablesResponse = await fetch(`/api/tables?storeId=${storeId}`);
        let updatedTables: Table[] = [];
        if (tablesResponse.ok) {
          updatedTables = await tablesResponse.json();
        } else {
          console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await tablesResponse.text());
          return;
        }

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
        const sessionsResponse = await fetch(`/api/sessions/active?storeId=${storeId}`);
        let sessions: Session[] = [];
        if (sessionsResponse.ok) {
          sessions = await sessionsResponse.json();
        } else {
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await sessionsResponse.text());
          return;
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«IDã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
        const sessionMap = new Map<string, Session>();
        if (sessions && sessions.length > 0) {
          sessions.forEach(session => {
            const tableIdStr = String(session.table_id);
            if (!sessionMap.has(tableIdStr)) {
              sessionMap.set(tableIdStr, session);
            }
          });
        }

        // æ—¢å­˜ã®QRã‚³ãƒ¼ãƒ‰ã‚’ä¿æŒã—ã¤ã¤ã€æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°
        const updatedTablesWithDetails = updatedTables.map(table => {
          // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’æ¤œç´¢
          const existingTable = tables.find(t => t.table_id === table.table_id);
          const qrCode = existingTable?.qrCode || '';

          // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
          const tableIdStr = String(table.table_id);
          const session = sessionMap.get(tableIdStr);

          // çµŒéæ™‚é–“ã®è¨ˆç®—
          let elapsedTime = null;
          let formattedStartTime = null;
          let isPaused = false;

          if (session && session.charge_started_at) {
            const startTime = new Date(session.charge_started_at);
            
            // ä¸€æ™‚åœæ­¢ä¸­ã‹ã©ã†ã‹ã‚’ç¢ºèª
            isPaused = !!session.charge_paused_at;

            // ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—
            const endTime = isPaused && session.charge_paused_at ? new Date(session.charge_paused_at) : now;

            const elapsedMinutes = Math.floor((endTime.getTime() - startTime.getTime()) / (1000 * 60));
            const hours = Math.floor(elapsedMinutes / 60);
            const minutes = elapsedMinutes % 60;

            elapsedTime = {
              hours,
              minutes,
              totalMinutes: elapsedMinutes
            };

            // ç€å¸­æ™‚é–“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            formattedStartTime = startTime.toLocaleString('ja-JP', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });
          }

          return {
            ...table,
            qrCode,
            session,
            elapsedTime,
            formattedStartTime,
            isPaused
          };
        });

        setTables(updatedTablesWithDetails);
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    };

    // Supabaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    console.log('Supabaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®šä¸­...');
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
    const unsubscribeTables = subscribeToTables(storeId, (payload) => {
      console.log('ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ:', payload);
      fetchLatestData();
    });
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
    const unsubscribeSessions = subscribeToSessions(storeId, (payload) => {
      console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ:', payload);
      fetchLatestData();
    });

    // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
    fetchLatestData();

    // å®šæœŸçš„ãªãƒãƒ¼ãƒªãƒ³ã‚°ã®è¨­å®šï¼ˆ30ç§’ã”ã¨ï¼‰- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦
    const pollingInterval = setInterval(fetchLatestData, 30000);

    // ç”»é¢ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸã¨ãã«ã‚‚æ›´æ–°
    const handleFocus = () => {
      console.log('ç”»é¢ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™ã€‚');
      fetchLatestData();
    };
    window.addEventListener('focus', handleFocus);

    return () => {
      unsubscribeTables();
      unsubscribeSessions();
      clearInterval(pollingInterval);
      window.removeEventListener('focus', handleFocus);
    };
  }, [storeId, tables]);

  // çµŒéæ™‚é–“ã‚’æ›´æ–°
  useEffect(() => {
    // ç¾åœ¨æ™‚åˆ»ãŒå¤‰ã‚ã‚‹ãŸã³ã«çµŒéæ™‚é–“ã‚’å†è¨ˆç®—
    const updatedTables = tables.map(table => {
      if (table.session && table.session.charge_started_at) {
        const startTime = new Date(table.session.charge_started_at);
        
        // ä¸€æ™‚åœæ­¢ä¸­ã‹ã©ã†ã‹ã‚’ç¢ºèª
        const isPaused = !!table.session.charge_paused_at;

        // ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—
        const endTime = isPaused && table.session.charge_paused_at ? new Date(table.session.charge_paused_at) : now;

        const elapsedMinutes = Math.floor((endTime.getTime() - startTime.getTime()) / (1000 * 60));
        const hours = Math.floor(elapsedMinutes / 60);
        const minutes = elapsedMinutes % 60;

        return {
          ...table,
          elapsedTime: {
            hours,
            minutes,
            totalMinutes: elapsedMinutes
          }
        };
      }
      return table;
    });

    setTables(updatedTables);
  }, [now]);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†</h1>
        <Link
          href="/portal/tables/new"
          className="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
        >
          æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
        </Link>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {tables.map((table) => (
          <div key={table.table_id} className="bg-white shadow rounded-lg overflow-hidden">
            <div className="p-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">{table.name}</h2>
                <span className="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm">
                  {table.seat_types?.display_name || ''}
                </span>
              </div>

              <div className="mb-4 flex justify-center">
                <img
                  src={table.qrCode}
                  alt={`QR Code for ${table.name}`}
                  className="w-48 h-48"
                />
              </div>

              <div className="text-center mb-4">
                <p className="text-sm text-gray-500">
                  {table.seat_types?.price_per_unit || 0}å††/
                  {table.seat_types?.time_unit_minutes || 30}åˆ†
                </p>
              </div>

              {/* ç€å¸­æƒ…å ±ã¨çµŒéæ™‚é–“ */}
              <div className="border-t border-gray-200 pt-4 mb-4">
                <h3 className="text-sm font-medium text-gray-700 mb-2">ç€å¸­çŠ¶æ³</h3>
                {table.elapsedTime ? (
                  <div>
                    <div className="flex justify-between mb-1">
                      <span className="text-xs text-gray-500">ç€å¸­æ™‚é–“:</span>
                      <span className="text-xs font-medium">{table.formattedStartTime}</span>
                    </div>
                    <div className="flex justify-between mb-1">
                      <span className="text-xs text-gray-500">çµŒéæ™‚é–“:</span>
                      <span className={`text-xs font-medium ${table.isPaused ? 'text-orange-600' : 'text-red-600'}`}>
                        {table.elapsedTime.hours}æ™‚é–“{table.elapsedTime.minutes}åˆ†
                        {table.isPaused && <span className="ml-1">(åœæ­¢ä¸­)</span>}
                      </span>
                    </div>

                    {/* èª²é‡‘åœæ­¢/å†é–‹ãƒœã‚¿ãƒ³ */}
                    {table.session && (
                      <div className="mt-2">
                        <ChargeControlButton
                          tableId={table.table_id}
                          sessionId={table.session.session_id}
                          isPaused={table.isPaused}
                        />
                      </div>
                    )}

                    {/* å¸­ç§»å‹•ãƒœã‚¿ãƒ³ */}
                    {table.session && (
                      <div className="mt-2">
                        <TableMoveButton
                          tableId={table.table_id}
                          tableName={table.name}
                          sessionId={table.session.session_id}
                          availableTables={tables.map(t => ({
                            table_id: t.table_id,
                            name: t.name,
                            seat_types: t.seat_types
                          }))}
                        />
                      </div>
                    )}
                  </div>
                ) : (
                  <p className="text-xs text-gray-500 text-center italic">æœªç€å¸­</p>
                )}
              </div>

              <div className="flex justify-between">
                <a
                  href={table.qrCode}
                  download={`table-${table.name}-qr.png`}
                  className="bg-green-600 text-white py-1 px-3 rounded-md text-sm hover:bg-green-700"
                >
                  QRãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </a>
                <Link
                  href={`/portal/tables/${table.table_id}/edit`}
                  className="bg-gray-600 text-white py-1 px-3 rounded-md text-sm hover:bg-gray-700"
                >
                  ç·¨é›†
                </Link>
              </div>
            </div>
          </div>
        ))}
      </div>

      {tables.length === 0 && (
        <div className="bg-white shadow rounded-lg p-6 text-center text-gray-500">
          ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œæ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
        </div>
      )}
    </div>
  );
}
</file>

<file path="docs/migration-guide.md">
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€Supabaseã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## å‰ææ¡ä»¶

- Node.js ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- Supabase CLI ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `.env.local` ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã€ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨:
  - `SUPABASE_URL`
  - `SUPABASE_ANON_KEY`

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œæ–¹æ³•

### 1. package.jsonã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ 

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€package.jsonã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚

```bash
npm pkg set scripts.migrate="node scripts/run-migration.js"
```

ã¾ãŸã¯ã€package.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹å‹•ã§ç·¨é›†ã—ã¦ã€ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™:

```json
{
  "scripts": {
    "migrate": "node scripts/run-migration.js"
  }
}
```

### 2. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä½¿ç”¨ã™ã‚‹ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
npm install dotenv --save-dev
```

### 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
# æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿ã‚’é©ç”¨
npm run migrate

# ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
npm run migrate -- --debug

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å…¨ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
npm run migrate -- --reset

# ç‰¹å®šã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’é©ç”¨
npm run migrate -- --file=20250703000004_fix_sessions_foreign_key.sql
```

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `supabase/migrations` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã¯ `YYYYMMDD000000_description.sql` ã®å½¢å¼ã§ã€å®Ÿè¡Œé †åºã¯ãƒ•ã‚¡ã‚¤ãƒ«åã®æ˜‡é †ã§æ±ºã¾ã‚Šã¾ã™ã€‚

### ä»Šå›ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…å®¹

ä¾å­˜é–¢ä¿‚ã®å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã€ã‚ˆã‚Šç›´æ¥çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¡ç”¨ã—ã¾ã—ãŸï¼š

#### `20250703000003_recreate_seat_types_table.sql`

ã“ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§å¸­ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãã®é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆã—ã¾ã™ï¼š

1. æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
2. ä¾å­˜ã™ã‚‹ã™ã¹ã¦ã®ãƒ“ãƒ¥ãƒ¼ã¨ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤
3. é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`tables`ã€`session_seat_events`ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
4. é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ï¼ˆä¾å­˜é–¢ä¿‚ã‚’è§£æ¶ˆï¼‰
5. é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆï¼ˆ`seat_type_id`ã‚’UUIDå‹ã«å¤‰æ›´ï¼‰
6. å¸­ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆï¼ˆ`code`ã‚’`seat_type_id`ã«åå‰å¤‰æ›´ã—ã€ä¸»ã‚­ãƒ¼ã«è¨­å®šï¼‰
7. ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
8. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã¨RLSãƒãƒªã‚·ãƒ¼ã‚’å†ä½œæˆ

#### `20250703000004_fix_sessions_foreign_key.sql`

ã“ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã®ä¿®æ­£ã‚’è¡Œã„ã¾ã™ï¼š

1. `sessions`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`table_id`ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å†ä½œæˆ
2. é–¢é€£ã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ã‚’æ›´æ–°
3. ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å†ä½œæˆ

ã“ã‚Œã«ã‚ˆã‚Šã€`sessions`ãƒ†ãƒ¼ãƒ–ãƒ«ã¨`tables`ãƒ†ãƒ¼ãƒ–ãƒ«ã®é–“ã®é–¢ä¿‚ãŒæ­£ã—ãè¨­å®šã•ã‚Œã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€å¸­ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼ãŒUUIDå‹ã«ãªã‚Šã€ã‚ˆã‚ŠæŸ”è»Ÿãªãƒ‡ãƒ¼ã‚¿ç®¡ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€å¸­ç¨®IDã¯UUIDã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## æ³¨æ„äº‹é …

- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹å‰ã«ã€å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸€åº¦å®Ÿè¡Œã™ã‚‹ã¨å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚æ–°ã—ã„å¤‰æ›´ã‚’åŠ ãˆã‚‹å ´åˆã¯ã€æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
</file>

<file path="fix_next_event_after_move_null.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ï¼ˆã‚ˆã‚Šå …ç‰¢ãªå®Ÿè£…ï¼‰
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
  v_next_event_after_move record := NULL; -- æ˜ç¤ºçš„ã«NULLã§åˆæœŸåŒ–
  v_move_charge_count int := 0;
  v_session_start_time timestamptz;
  v_has_next_event boolean := false; -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ã®ãƒ•ãƒ©ã‚°
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT start_at, charge_started_at, charge_paused_at 
  INTO v_session_start_time, v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã¨ã—ã¦æ‰±ã†
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ã‚’å–å¾—
  SELECT COUNT(*) INTO v_move_charge_count
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- å¸­ç§»å‹•å¾Œã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹å‰ã«ã€ãã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
    
    -- å¸­ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    SELECT EXISTS (
      SELECT 1
      FROM public.session_seat_events
      WHERE 
        session_id = p_session_id AND 
        changed_at > v_last_move_charge_time AND
        is_table_move_charge = false
    ) INTO v_has_next_event;
    
    -- å¸­ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å–å¾—
    IF v_has_next_event THEN
      SELECT 
        event_id,
        seat_type_id,
        price_snapshot,
        changed_at,
        is_table_move_charge
      INTO v_next_event_after_move
      FROM public.session_seat_events
      WHERE 
        session_id = p_session_id AND 
        changed_at > v_last_move_charge_time AND
        is_table_move_charge = false
      ORDER BY changed_at ASC
      LIMIT 1;
    END IF;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’åˆè¨ˆã«åŠ ç®—
  SELECT COALESCE(SUM(price_snapshot), 0) INTO v_total_charge
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤ãï¼‰
  SELECT 
    seat_type_id,
    price_snapshot,
    changed_at
  INTO 
    v_seat_type_id,
    v_price_snapshot,
    v_last_event_time
  FROM public.session_seat_events
  WHERE 
    session_id = p_session_id AND 
    is_table_move_charge = false
  ORDER BY changed_at DESC
  LIMIT 1;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã§ã‚‚ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€ä½æ–™é‡‘ã‚’é©ç”¨
  -- v_next_event_after_moveãŒNULLã§ãªã„ã“ã¨ã‚’ç¢ºèª
  IF v_has_move_charge AND v_has_next_event AND v_next_event_after_move IS NOT NULL AND 
     v_last_event_time = v_next_event_after_move.changed_at THEN
    
    -- çµŒéæ™‚é–“ã«åŸºã¥ã„ã¦æ–™é‡‘ã‚’è¨ˆç®—
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æœ€ä½æ–™é‡‘ï¼ˆ1å˜ä½åˆ†ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_time_units := 1;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
      -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
      v_time_units := v_rounded_minutes / v_time_unit_minutes;
    END IF;
    
    -- ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    RETURN v_total_charge;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆå¸­ç§»å‹•ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;
</file>

<file path="fix_next_event_after_move_property_access.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
  v_next_event_after_move record := NULL; -- æ˜ç¤ºçš„ã«NULLã§åˆæœŸåŒ–
  v_move_charge_count int := 0;
  v_session_start_time timestamptz;
  v_has_next_event boolean := false; -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ã®ãƒ•ãƒ©ã‚°
  v_next_event_changed_at timestamptz := NULL; -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’åˆ¥å¤‰æ•°ã§ä¿æŒ
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT start_at, charge_started_at, charge_paused_at 
  INTO v_session_start_time, v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã¨ã—ã¦æ‰±ã†
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ã‚’å–å¾—
  SELECT COUNT(*) INTO v_move_charge_count
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- å¸­ç§»å‹•å¾Œã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹å‰ã«ã€ãã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
    
    -- å¸­ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    SELECT EXISTS (
      SELECT 1
      FROM public.session_seat_events
      WHERE 
        session_id = p_session_id AND 
        changed_at > v_last_move_charge_time AND
        is_table_move_charge = false
    ) INTO v_has_next_event;
    
    -- å¸­ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å–å¾—
    IF v_has_next_event THEN
      SELECT 
        event_id,
        seat_type_id,
        price_snapshot,
        changed_at,
        is_table_move_charge
      INTO v_next_event_after_move
      FROM public.session_seat_events
      WHERE 
        session_id = p_session_id AND 
        changed_at > v_last_move_charge_time AND
        is_table_move_charge = false
      ORDER BY changed_at ASC
      LIMIT 1;
      
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’åˆ¥å¤‰æ•°ã«ä¿å­˜ï¼ˆNULLãƒã‚§ãƒƒã‚¯ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
      IF v_next_event_after_move IS NOT NULL THEN
        v_next_event_changed_at := v_next_event_after_move.changed_at;
      END IF;
    END IF;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’åˆè¨ˆã«åŠ ç®—
  SELECT COALESCE(SUM(price_snapshot), 0) INTO v_total_charge
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤ãï¼‰
  SELECT 
    seat_type_id,
    price_snapshot,
    changed_at
  INTO 
    v_seat_type_id,
    v_price_snapshot,
    v_last_event_time
  FROM public.session_seat_events
  WHERE 
    session_id = p_session_id AND 
    is_table_move_charge = false
  ORDER BY changed_at DESC
  LIMIT 1;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã§ã‚‚ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€ä½æ–™é‡‘ã‚’é©ç”¨
  -- v_next_event_after_moveã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å‰ã«NULLãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
  -- v_next_event_changed_atã‚’ä½¿ç”¨ã—ã¦æ¯”è¼ƒ
  IF v_has_move_charge AND v_has_next_event AND v_next_event_after_move IS NOT NULL AND 
     v_next_event_changed_at IS NOT NULL AND v_last_event_time = v_next_event_changed_at THEN
    
    -- çµŒéæ™‚é–“ã«åŸºã¥ã„ã¦æ–™é‡‘ã‚’è¨ˆç®—
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æœ€ä½æ–™é‡‘ï¼ˆ1å˜ä½åˆ†ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_time_units := 1;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
      -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
      v_time_units := v_rounded_minutes / v_time_unit_minutes;
    END IF;
    
    -- ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    RETURN v_total_charge;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆå¸­ç§»å‹•ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;
</file>

<file path="lib/auth.ts">
import { createServerSupabaseClient, createServerComponentClient } from './supabase';

export type UserRole = 'admin' | 'cast';

export interface StoreUser {
  id: string;
  store_id: string;
  user_id: string;
  role: UserRole;
}

export interface Store {
  store_id: string;
  store_code: string;
  name: string;
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç‰¹å®šã®åº—èˆ—ã«æ‰€å±ã—ã¦ã„ã‚‹ã‹ç¢ºèª
export async function isUserMemberOfStore(userId: string, storeId: string): Promise<boolean> {
  const supabase = await createServerSupabaseClient();

  console.log('isUserMemberOfStore called with:', { userId, storeId });

  const { data, error } = await supabase
    .from('store_users')
    .select('id')
    .eq('user_id', userId)
    .eq('store_id', storeId)
    .single();

  if (error) {
    console.error('Error checking store membership:', error);
    console.error('Error details:', error);

    // å…¨ã¦ã®store_usersã‚’å–å¾—ã—ã¦ç¢ºèª
    const { data: allStoreUsers, error: allError } = await supabase
      .from('store_users')
      .select('*');

    if (!allError) {
      console.log('All store_users:', allStoreUsers);
    } else {
      console.error('Error fetching all store_users:', allError);
    }

    return false;
  }

  console.log('Store membership data:', data);
  return !!data;
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åº—èˆ—ã§ã®å½¹å‰²ã‚’å–å¾—
export async function getUserRoleInStore(userId: string, storeId: string): Promise<UserRole | null> {
  const supabase = await createServerSupabaseClient();

  const { data, error } = await supabase
    .from('store_users')
    .select('role')
    .eq('user_id', userId)
    .eq('store_id', storeId)
    .single();

  if (error || !data) {
    console.error('Error getting user role:', error);
    return null;
  }

  return data.role as UserRole;
}

// åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åº—èˆ—æƒ…å ±ã‚’å–å¾—
export async function getStoreByCode(storeCode: string): Promise<Store | null> {
  const supabase = await createServerSupabaseClient();

  const { data, error } = await supabase
    .from('stores')
    .select('*')
    .eq('store_code', storeCode)
    .single();

  if (error || !data) {
    console.error('Error getting store by code:', error);
    return null;
  }

  return data as Store;
}
</file>

<file path="lib/charge.ts">
/**
 * çµŒéæ™‚é–“ã‚’æŒ‡å®šã•ã‚ŒãŸæ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’ã‚‹é–¢æ•°
 * @param minutes çµŒéæ™‚é–“ï¼ˆåˆ†ï¼‰
 * @param timeUnitMinutes æ™‚é–“å˜ä½ï¼ˆåˆ†ï¼‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30åˆ†ï¼‰
 * @returns æŒ‡å®šã•ã‚ŒãŸæ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’ãŸæ™‚é–“ï¼ˆåˆ†ï¼‰
 */
export function roundUpToTimeUnit(minutes: number, timeUnitMinutes: number = 30): number {
  // æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  const validTimeUnit = timeUnitMinutes > 0 ? timeUnitMinutes : 30;

  // 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  // 0åˆ†ã ã‘ã§ãªãã€æ•°åç§’ãªã©1åˆ†æœªæº€ã®å ´åˆã‚‚æœ€ä½æ–™é‡‘ã‚’é©ç”¨
  if (minutes < 1) return validTimeUnit;

  return Math.ceil(minutes / validTimeUnit) * validTimeUnit;
}

/**
 * 2ã¤ã®æ—¥æ™‚ã®é–“ã®çµŒéæ™‚é–“ã‚’åˆ†å˜ä½ã§è¨ˆç®—ã™ã‚‹
 * @param startTime é–‹å§‹æ™‚é–“
 * @param endTime çµ‚äº†æ™‚é–“
 * @param pauseTime ä¸€æ™‚åœæ­¢æ™‚é–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns çµŒéæ™‚é–“ï¼ˆåˆ†ï¼‰
 */
export function calculateElapsedMinutes(
  startTime: Date,
  endTime: Date,
  pauseTime?: Date | null
): number {
  // æ—¥æ™‚ãŒç„¡åŠ¹ãªå ´åˆã¯0ã‚’è¿”ã™
  if (!startTime || !endTime || isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
    return 0;
  }

  // ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆ
  if (pauseTime && !isNaN(pauseTime.getTime())) {
    // ä¸€æ™‚åœæ­¢æ™‚é–“ãŒé–‹å§‹æ™‚é–“ã‚ˆã‚Šå‰ã®å ´åˆã¯0ã‚’è¿”ã™
    if (pauseTime.getTime() <= startTime.getTime()) {
      return 0;
    }

    // ä¸€æ™‚åœæ­¢æ™‚é–“ãŒçµ‚äº†æ™‚é–“ã‚ˆã‚Šå¾Œã®å ´åˆã¯é€šå¸¸è¨ˆç®—
    if (pauseTime.getTime() >= endTime.getTime()) {
      const diffMs = endTime.getTime() - startTime.getTime();
      return diffMs < 0 ? 0 : Math.floor(diffMs / (1000 * 60));
    }

    // ä¸€æ™‚åœæ­¢æ™‚é–“ãŒé–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“ã®é–“ã«ã‚ã‚‹å ´åˆ
    const diffMs = pauseTime.getTime() - startTime.getTime();
    return diffMs < 0 ? 0 : Math.floor(diffMs / (1000 * 60));
  }

  // é€šå¸¸ã®è¨ˆç®—
  const diffMs = endTime.getTime() - startTime.getTime();

  // è² ã®å€¤ã«ãªã‚‹å ´åˆã¯0ã‚’è¿”ã™ï¼ˆç•°å¸¸å€¤ï¼‰
  if (diffMs < 0) {
    return 0;
  }

  return Math.floor(diffMs / (1000 * 60));
}

/**
 * çµŒéæ™‚é–“ã¨å˜ä¾¡ã‹ã‚‰æ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹
 * @param elapsedMinutes çµŒéæ™‚é–“ï¼ˆåˆ†ï¼‰
 * @param pricePerUnit æ™‚é–“å˜ä½ã‚ãŸã‚Šã®å˜ä¾¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30åˆ†å˜ä½ï¼‰
 * @param timeUnitMinutes æ™‚é–“å˜ä½ï¼ˆåˆ†ï¼‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30åˆ†ï¼‰
 * @returns è¨ˆç®—ã•ã‚ŒãŸæ–™é‡‘
 */
export function calculateCharge(
  elapsedMinutes: number,
  pricePerUnit: number,
  timeUnitMinutes: number = 30
): number {
  // å˜ä¾¡ãŒç„¡åŠ¹ãªå ´åˆã¯0ã‚’è¿”ã™
  if (!pricePerUnit || pricePerUnit < 0) {
    return 0;
  }

  // æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  const validTimeUnit = timeUnitMinutes > 0 ? timeUnitMinutes : 30;

  // æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’ï¼ˆroundUpToTimeUnité–¢æ•°ã‚’ä½¿ç”¨ï¼‰
  const roundedMinutes = roundUpToTimeUnit(elapsedMinutes, validTimeUnit);

  // æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  const units = roundedMinutes / validTimeUnit;

  // æ–™é‡‘ã‚’è¨ˆç®—
  return units * pricePerUnit;
}

/**
 * é–‹å§‹æ™‚é–“ã€çµ‚äº†æ™‚é–“ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã‹ã‚‰æ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹
 * @param startTime é–‹å§‹æ™‚é–“
 * @param endTime çµ‚äº†æ™‚é–“
 * @param pricePerUnit æ™‚é–“å˜ä½ã‚ãŸã‚Šã®å˜ä¾¡
 * @param timeUnitMinutes æ™‚é–“å˜ä½ï¼ˆåˆ†ï¼‰
 * @param pauseTime ä¸€æ™‚åœæ­¢æ™‚é–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns è¨ˆç®—ã•ã‚ŒãŸæ–™é‡‘
 */
export function calculateChargeWithPause(
  startTime: Date,
  endTime: Date,
  pricePerUnit: number,
  timeUnitMinutes: number = 30,
  pauseTime?: Date | null
): number {
  // çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆä¸€æ™‚åœæ­¢ã‚’è€ƒæ…®ï¼‰
  const elapsedMinutes = calculateElapsedMinutes(startTime, endTime, pauseTime);

  // æ–™é‡‘ã‚’è¨ˆç®—
  return calculateCharge(elapsedMinutes, pricePerUnit, timeUnitMinutes);
}
</file>

<file path="lib/database.types.ts">
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export interface Database {
  public: {
    Tables: {
      stores: {
        Row: {
          store_id: string
          store_code: string
          name: string
        }
        Insert: {
          store_id?: string
          store_code: string
          name: string
        }
        Update: {
          store_id?: string
          store_code?: string
          name?: string
        }
      }
      store_users: {
        Row: {
          id: string
          store_id: string
          user_id: string
          role: string
        }
        Insert: {
          id?: string
          store_id: string
          user_id: string
          role: string
        }
        Update: {
          id?: string
          store_id?: string
          user_id?: string
          role?: string
        }
      }
      seat_types: {
        Row: {
          seat_type_id: string  // UUIDã ãŒTypeScriptã§ã¯æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
          store_id: string
          display_name: string
          price_per_unit: number  // æ™‚é–“å˜ä½ã‚ãŸã‚Šã®æ–™é‡‘
          time_unit_minutes: number
        }
        Insert: {
          seat_type_id?: string  // è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚çœç•¥å¯èƒ½
          store_id: string
          display_name: string
          price_per_unit: number  // æ™‚é–“å˜ä½ã‚ãŸã‚Šã®æ–™é‡‘
          time_unit_minutes?: number
        }
        Update: {
          seat_type_id?: string
          store_id?: string
          display_name?: string
          price_per_unit?: number  // æ™‚é–“å˜ä½ã‚ãŸã‚Šã®æ–™é‡‘
          time_unit_minutes?: number
        }
      }
      tables: {
        Row: {
          table_id: string
          store_id: string
          name: string
          seat_type_id: string
        }
        Insert: {
          table_id?: string
          store_id: string
          name: string
          seat_type_id: string
        }
        Update: {
          table_id?: string
          store_id?: string
          name?: string
          seat_type_id?: string
        }
      }
      sessions: {
        Row: {
          session_id: string
          store_id: string
          table_id: string
          start_at: string
          charge_started_at: string | null
        }
        Insert: {
          session_id?: string
          store_id: string
          table_id: string
          start_at?: string
          charge_started_at?: string | null
        }
        Update: {
          session_id?: string
          store_id?: string
          table_id?: string
          start_at?: string
          charge_started_at?: string | null
        }
      }
      session_seat_events: {
        Row: {
          event_id: string
          session_id: string
          seat_type_id: string
          price_snapshot: number
          changed_at: string
        }
        Insert: {
          event_id?: string
          session_id: string
          seat_type_id: string
          price_snapshot: number
          changed_at?: string
        }
        Update: {
          event_id?: string
          session_id?: string
          seat_type_id?: string
          price_snapshot?: number
          changed_at?: string
        }
      }
      orders: {
        Row: {
          order_id: string
          store_id: string
          session_id: string
          status: string
          created_by_role: string | null
          proxy: boolean
          created_at: string
        }
        Insert: {
          order_id?: string
          store_id: string
          session_id: string
          status: string
          created_by_role?: string | null
          proxy?: boolean
          created_at?: string
        }
        Update: {
          order_id?: string
          store_id?: string
          session_id?: string
          status?: string
          created_by_role?: string | null
          proxy?: boolean
          created_at?: string
        }
      }
    }
  }
}
</file>

<file path="lib/smaregi.ts">
import axios from 'axios';

/**
 * ã‚¹ãƒãƒ¬ã‚¸APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹
 * @param clientId ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
 * @param clientSecret ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
 * @param contractId å¥‘ç´„ID
 * @param scope APIã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'pos.products:read pos.transactions:write'ï¼‰
 * @param isSandbox ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‹ã©ã†ã‹
 * @returns ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
 */
export async function getSmaregiAccessToken(
  clientId: string,
  clientSecret: string,
  contractId: string,
  scope: string = 'pos.products:read pos.transactions:write',
  isSandbox: boolean = true
): Promise<string> {
  const baseUrl = isSandbox ? 'https://id.smaregi.dev' : 'https://id.smaregi.jp';
  const url = `${baseUrl}/app/${contractId}/token`;

  const auth = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');

  try {
    const response = await axios.post(
      url,
      new URLSearchParams({
        grant_type: 'client_credentials',
        scope: scope,
      }).toString(),
      {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Authorization': `Basic ${auth}`,
        },
      }
    );

    return response.data.access_token;
  } catch (error) {
    console.error('ã‚¹ãƒãƒ¬ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error('ã‚¹ãƒãƒ¬ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/**
 * ã‚¹ãƒãƒ¬ã‚¸APIã‹ã‚‰å•†å“æƒ…å ±ã‚’å–å¾—ã™ã‚‹ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
 * @param accessToken ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
 * @param contractId å¥‘ç´„ID
 * @param isSandbox ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‹ã©ã†ã‹
 * @returns å•†å“æƒ…å ±ã®é…åˆ—
 */
export async function fetchSmaregiProducts(
  accessToken: string,
  contractId: string,
  isSandbox: boolean = true
): Promise<any[]> {
  const baseUrl = isSandbox ? 'https://api.smaregi.dev' : 'https://api.smaregi.jp';
  const url = `${baseUrl}/${contractId}/pos/products`;
  const limit = 1000; // 1å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å–å¾—ã™ã‚‹æœ€å¤§ä»¶æ•°ï¼ˆAPIã®ä¸Šé™ã¯1000ï¼‰
  let page = 1;
  let allProducts: any[] = [];
  let hasMore = true;

  try {
    // å…¨ã¦ã®å•†å“ã‚’å–å¾—ã™ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
    while (hasMore) {


      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${accessToken}`
        },
        params: {
          limit,
          page
        }
      });

      const products = response.data;
      allProducts = [...allProducts, ...products];

      // å–å¾—ä»¶æ•°ãŒæŒ‡å®šã—ãŸä¸Šé™ã‚ˆã‚Šå°‘ãªã„å ´åˆã€å…¨ã¦ã®å•†å“ã‚’å–å¾—ã—ãŸã¨åˆ¤æ–­
      if (products.length < limit) {
        hasMore = false;
      } else {
        // æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸
        page++;
      }
    }


    return allProducts;
  } catch (error) {
    console.error('ã‚¹ãƒãƒ¬ã‚¸å•†å“æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error('ã‚¹ãƒãƒ¬ã‚¸ã‹ã‚‰ã®å•†å“æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/**
 * ã‚¹ãƒãƒ¬ã‚¸APIã‹ã‚‰å•†å“ç”»åƒæƒ…å ±ã‚’å–å¾—ã™ã‚‹ï¼ˆå€‹åˆ¥å•†å“ï¼‰
 * @param accessToken ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
 * @param contractId å¥‘ç´„ID
 * @param productId å•†å“ID
 * @param isSandbox ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‹ã©ã†ã‹
 * @returns å•†å“ç”»åƒæƒ…å ±ã®é…åˆ—
 * @deprecated ä»£ã‚ã‚Šã« fetchSmaregiAllProductImages ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
 */
export async function fetchSmaregiProductImages(
  accessToken: string,
  contractId: string,
  productId: string,
  isSandbox: boolean = true
): Promise<any[]> {
  const baseUrl = isSandbox ? 'https://api.smaregi.dev' : 'https://api.smaregi.jp';
  const url = `${baseUrl}/${contractId}/pos/products/${productId}/images`;

  try {
    const response = await axios.get(url, {
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    });

    return response.data;
  } catch (error) {
    console.error(`ã‚¹ãƒãƒ¬ã‚¸å•†å“ç”»åƒå–å¾—ã‚¨ãƒ©ãƒ¼ (productId: ${productId}):`, error);

    // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°æƒ…å ±ã‚’å‡ºåŠ›
    if (error && typeof error === 'object' && 'response' in error) {
      const axiosError = error as { response: { status: number; statusText: string; data: any } };
      console.error(`ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (productId: ${productId}):`, {
        status: axiosError.response.status,
        statusText: axiosError.response.statusText,
        data: axiosError.response.data
      });
    }

    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œã™ã‚‹ãŸã‚ã€ç©ºã®é…åˆ—ã‚’è¿”ã™
    return [];
  }
}

/**
 * ã‚¹ãƒãƒ¬ã‚¸APIã‹ã‚‰å…¨å•†å“ç”»åƒæƒ…å ±ã‚’ä¸€æ‹¬å–å¾—ã™ã‚‹
 * @param accessToken ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
 * @param contractId å¥‘ç´„ID
 * @param isSandbox ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‹ã©ã†ã‹
 * @returns å•†å“ç”»åƒæƒ…å ±ã®é…åˆ—
 */
export async function fetchSmaregiAllProductImages(
  accessToken: string,
  contractId: string,
  isSandbox: boolean = true
): Promise<any[]> {
  const baseUrl = isSandbox ? 'https://api.smaregi.dev' : 'https://api.smaregi.jp';
  const url = `${baseUrl}/${contractId}/pos/products/images`;
  const limit = 1000; // 1å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å–å¾—ã™ã‚‹æœ€å¤§ä»¶æ•°ï¼ˆAPIã®ä¸Šé™ã¯1000ï¼‰
  let page = 1;
  let allProductImages: any[] = [];
  let hasMore = true;

  try {
    // å…¨ã¦ã®å•†å“ç”»åƒã‚’å–å¾—ã™ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
    while (hasMore) {
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${accessToken}`
        },
        params: {
          limit,
          page
        }
      });

      const productImages = response.data;
      allProductImages = [...allProductImages, ...productImages];

      // å–å¾—ä»¶æ•°ãŒæŒ‡å®šã—ãŸä¸Šé™ã‚ˆã‚Šå°‘ãªã„å ´åˆã€å…¨ã¦ã®å•†å“ç”»åƒã‚’å–å¾—ã—ãŸã¨åˆ¤æ–­
      if (productImages.length < limit) {
        hasMore = false;
      } else {
        // æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸
        page++;
      }
    }

    // ç”»åƒå–å¾—çµæœã®ã‚µãƒãƒªãƒ¼ã‚’ãƒ­ã‚°å‡ºåŠ›
    const imageCount = allProductImages.length;
    const imagesWithUrl = allProductImages.filter(img => img.url || img.imageUrl).length;
    console.log(`ã‚¹ãƒãƒ¬ã‚¸å•†å“ç”»åƒå–å¾—çµæœ: åˆè¨ˆ${imageCount}ä»¶ã€URLæœ‰ã‚Š${imagesWithUrl}ä»¶`);

    // æœ€åˆã®5ä»¶ã®ç”»åƒæƒ…å ±ã‚’ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ãƒ­ã‚°å‡ºåŠ›
    if (allProductImages.length > 0) {
      const sampleImages = allProductImages.slice(0, 5);
      console.log('ç”»åƒã‚µãƒ³ãƒ—ãƒ«:', JSON.stringify(sampleImages));
    }

    return allProductImages;
  } catch (error) {
    console.error('ã‚¹ãƒãƒ¬ã‚¸å…¨å•†å“ç”»åƒå–å¾—ã‚¨ãƒ©ãƒ¼:', error);

    // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°æƒ…å ±ã‚’å‡ºåŠ›
    if (error && typeof error === 'object' && 'response' in error) {
      const axiosError = error as { response: { status: number; statusText: string; data: any } };
      console.error('ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', {
        status: axiosError.response.status,
        statusText: axiosError.response.statusText,
        data: axiosError.response.data
      });
    }

    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œã™ã‚‹ãŸã‚ã€ç©ºã®é…åˆ—ã‚’è¿”ã™
    return [];
  }
}

/**
 * ã‚¹ãƒãƒ¬ã‚¸APIã‹ã‚‰éƒ¨é–€æƒ…å ±ã‚’å–å¾—ã™ã‚‹ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
 * @param accessToken ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
 * @param contractId å¥‘ç´„ID
 * @param isSandbox ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‹ã©ã†ã‹
 * @returns éƒ¨é–€æƒ…å ±ã®é…åˆ—
 */
export async function fetchSmaregiCategories(
  accessToken: string,
  contractId: string,
  isSandbox: boolean = true
): Promise<any[]> {
  const baseUrl = isSandbox ? 'https://api.smaregi.dev' : 'https://api.smaregi.jp';
  const url = `${baseUrl}/${contractId}/pos/categories`;
  const limit = 1000; // 1å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å–å¾—ã™ã‚‹æœ€å¤§ä»¶æ•°ï¼ˆAPIã®ä¸Šé™ã¯1000ï¼‰
  let page = 1;
  let allCategories: any[] = [];
  let hasMore = true;

  try {
    // å…¨ã¦ã®éƒ¨é–€ã‚’å–å¾—ã™ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
    while (hasMore) {


      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${accessToken}`
        },
        params: {
          limit,
          page
        }
      });

      const categories = response.data;
      allCategories = [...allCategories, ...categories];

      // å–å¾—ä»¶æ•°ãŒæŒ‡å®šã—ãŸä¸Šé™ã‚ˆã‚Šå°‘ãªã„å ´åˆã€å…¨ã¦ã®éƒ¨é–€ã‚’å–å¾—ã—ãŸã¨åˆ¤æ–­
      if (categories.length < limit) {
        hasMore = false;
      } else {
        // æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸
        page++;
      }
    }


    return allCategories;
  } catch (error) {
    console.error('ã‚¹ãƒãƒ¬ã‚¸éƒ¨é–€æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error('ã‚¹ãƒãƒ¬ã‚¸ã‹ã‚‰ã®éƒ¨é–€æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/**
 * ã‚¹ãƒãƒ¬ã‚¸APIã«å–å¼•ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã™ã‚‹
 * @param accessToken ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
 * @param contractId å¥‘ç´„ID
 * @param transactionData å–å¼•ãƒ‡ãƒ¼ã‚¿
 * @param isSandbox ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‹ã©ã†ã‹
 * @returns ç™»éŒ²ã•ã‚ŒãŸå–å¼•æƒ…å ±
 */
export async function registerSmaregiTransaction(
  accessToken: string,
  contractId: string,
  transactionData: any,
  isSandbox: boolean = true
): Promise<any> {
  const baseUrl = isSandbox ? 'https://api.smaregi.dev' : 'https://api.smaregi.jp';
  const url = `${baseUrl}/${contractId}/pos/transactions`;

  try {
    const response = await axios.post(
      url,
      transactionData,
      {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        }
      }
    );

    return response.data;
  } catch (error) {
    console.error('ã‚¹ãƒãƒ¬ã‚¸å–å¼•ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);

    // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°æƒ…å ±ã‚’å‡ºåŠ›
    if (error && typeof error === 'object' && 'response' in error) {
      const axiosError = error as { response: { status: number; statusText: string; data: any } };
      console.error('ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', {
        status: axiosError.response.status,
        statusText: axiosError.response.statusText,
        data: axiosError.response.data
      });

      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚‚å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:', JSON.stringify(transactionData, null, 2));
    }

    throw new Error('ã‚¹ãƒãƒ¬ã‚¸ã¸ã®å–å¼•ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}
</file>

<file path="lib/supabase-realtime.ts">
import { createClient } from '@supabase/supabase-js';

// å…±é€šã®è¨­å®š
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const SUPABASE_ANON_KEY = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä½¿ç”¨ã™ã‚‹Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ç”¨ï¼‰
export const createRealtimeClient = () => {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    throw new Error('Supabase URL or Anon Key is missing');
  }

  return createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    realtime: {
      params: {
        eventsPerSecond: 10,
      },
    },
  });
};

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒ³ãƒãƒ«ã®ç¨®é¡
export enum RealtimeChannel {
  ORDERS = 'orders',
  SESSIONS = 'sessions',
  TABLES = 'tables',
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡
export enum RealtimeEvent {
  INSERT = 'INSERT',
  UPDATE = 'UPDATE',
  DELETE = 'DELETE',
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
export interface SubscriptionOptions {
  event?: RealtimeEvent | '*';
  filter?: string;
  callback: (payload: any) => void;
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹é–¢æ•°
export const subscribeToTable = (
  table: string,
  options: SubscriptionOptions,
  storeId?: string
) => {
  const supabase = createRealtimeClient();
  
  // ãƒãƒ£ãƒ³ãƒãƒ«åã‚’ç”Ÿæˆï¼ˆã‚¹ãƒˆã‚¢IDãŒã‚ã‚‹å ´åˆã¯å«ã‚ã‚‹ï¼‰
  const channelName = storeId 
    ? `realtime:${storeId}:${table}` 
    : `realtime:${table}`;
  
  // ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ä½œæˆ
  const channel = supabase
    .channel(channelName)
    .on(
      'postgres_changes',
      {
        event: options.event || '*',
        schema: 'public',
        table: table,
        filter: options.filter || undefined,
      },
      (payload) => {
        options.callback(payload);
      }
    )
    .subscribe();
  
  // ãƒãƒ£ãƒ³ãƒãƒ«ã®è§£é™¤é–¢æ•°ã‚’è¿”ã™
  return () => {
    supabase.removeChannel(channel);
  };
};

// æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
export const subscribeToOrders = (
  storeId: string,
  callback: (payload: any) => void
) => {
  return subscribeToTable(
    'orders',
    {
      event: '*',
      filter: `store_id=eq.${storeId}`,
      callback,
    },
    storeId
  );
};

// æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
export const subscribeToOrderItems = (
  storeId: string,
  callback: (payload: any) => void
) => {
  return subscribeToTable(
    'order_items',
    {
      event: '*',
      callback,
    },
    storeId
  );
};

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
export const subscribeToSessions = (
  storeId: string,
  callback: (payload: any) => void
) => {
  return subscribeToTable(
    'sessions',
    {
      event: '*',
      filter: `store_id=eq.${storeId}`,
      callback,
    },
    storeId
  );
};

// ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
export const subscribeToTables = (
  storeId: string,
  callback: (payload: any) => void
) => {
  return subscribeToTable(
    'tables',
    {
      event: '*',
      filter: `store_id=eq.${storeId}`,
      callback,
    },
    storeId
  );
};
</file>

<file path="lib/supabase.ts">
import { createClient } from '@supabase/supabase-js';
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { cookies } from 'next/headers';
import { NextRequest, NextResponse } from 'next/server';

// å…±é€šã®è¨­å®š
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const SUPABASE_ANON_KEY = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

// ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«æ¨©é™ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ï¼‰
export const createServerSupabaseClient = async () => {
  if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
    throw new Error('Supabase URL or Service Role Key is missing');
  }

  return createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  });
};

// ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
export const createServerComponentClient = async () => {
  const cookieStore = await cookies();

  return createServerClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) => {
              cookieStore.set(name, value, options);
            });
          } catch (error) {
            // ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã®å‘¼ã³å‡ºã—ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
            console.error('createServerComponentClient: Cookieè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
            // ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚Œã°å•é¡Œãªã„
          }
        },
      },
    }
  );
};

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
export const createMiddlewareClient = (request: NextRequest, response: NextResponse) => {
  return createServerClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          // ãƒªã‚¯ã‚¨ã‚¹ãƒˆCookieã‚’è¨­å®šï¼ˆNext.jsã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç”¨ï¼‰
          cookiesToSet.forEach(({ name, value }) => {
            request.cookies.set({
              name,
              value,
            });
          });

          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹Cookieã‚’è¨­å®šï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰
          cookiesToSet.forEach(({ name, value, options }) => {
            response.cookies.set({
              name,
              value,
              ...options,
            });
          });
        },
      },
    }
  );
};

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
export async function updateSession(request: NextRequest) {
  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½œæˆ
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  // ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
  const supabase = createMiddlewareClient(request, response);

  try {
    // getUser()ã‚’ç›´æ¥ä½¿ç”¨ã—ã¦èªè¨¼ã‚’ç¢ºèªï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã‹ã‚‰getSession()ã¯ä½¿ç”¨ã—ãªã„ï¼‰
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error) {
      console.error('Middleware: èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆåˆ¤å®šã®ãŸã‚ï¼‰
    }

    // ãƒãƒ¼ã‚¿ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯èªè¨¼ãŒå¿…è¦
    if (request.nextUrl.pathname.startsWith('/portal')) {
      if (!user) {
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        return NextResponse.redirect(new URL('/', request.url));
      }

      // åº—èˆ—IDã®å–å¾—
      const storeId = request.cookies.get('store-id')?.value;

      if (!storeId) {
        // åº—èˆ—IDãŒãªã„å ´åˆã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        await supabase.auth.signOut();
        return NextResponse.redirect(new URL('/', request.url));
      }
    }
  } catch (error) {
    console.error('Middleware: äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:', error);
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
  }

  return response;
}
</file>

<file path="middleware.ts">
import { NextRequest } from 'next/server';
import { updateSession } from '@/lib/supabase';

export async function middleware(request: NextRequest) {
  return await updateSession(request);
}

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’é©ç”¨ã™ã‚‹ãƒ‘ã‚¹ã‚’æŒ‡å®š
export const config = {
  matcher: [
    // èªè¨¼ãŒå¿…è¦ãªãƒ‘ã‚¹ã®ã¿ã‚’æŒ‡å®š
    '/portal/:path*',
  ],
};
</file>

<file path="next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  images: {
    domains: [
      'pos-cache.smaregi.dev', // ã‚¹ãƒãƒ¬ã‚¸ã®ç”»åƒãƒ‰ãƒ¡ã‚¤ãƒ³
      'pos-cache.smaregi.jp',  // æœ¬ç•ªç’°å¢ƒç”¨ã®ã‚¹ãƒãƒ¬ã‚¸ç”»åƒãƒ‰ãƒ¡ã‚¤ãƒ³
      'ooiajrjymsrmnxukmavb.supabase.co' // Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‰ãƒ¡ã‚¤ãƒ³
    ],
  },
}

module.exports = nextConfig
</file>

<file path="package.json">
{
  "name": "girls-bar-qr-menu-sys",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "test": "vitest",
    "test:coverage": "vitest run --coverage",
    "test:e2e": "playwright test",
    "seed": "ts-node --project tsconfig.scripts.json scripts/seed.ts"
  },
  "dependencies": {
    "@supabase/ssr": "^0.5.2",
    "@supabase/supabase-js": "^2.49.4",
    "axios": "^1.9.0",
    "next": "^15.3.1",
    "qrcode": "^1.5.3",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "uuid": "^11.1.0",
    "zustand": "^4.4.7"
  },
  "devDependencies": {
    "@playwright/test": "^1.40.1",
    "@types/node": "^20.10.6",
    "@types/qrcode": "^1.5.5",
    "@types/react": "^18.2.46",
    "@types/react-dom": "^18.2.18",
    "@types/uuid": "^10.0.0",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "dotenv": "^16.5.0",
    "eslint": "^8.56.0",
    "eslint-config-next": "^15.3.1",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.4.0",
    "ts-node": "^10.9.2",
    "typescript": "^5.3.3",
    "vitest": "^3.1.3"
  }
}
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="scripts/run-migration.js">
/**
 * Supabaseãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 *
 * ä½¿ç”¨æ–¹æ³•:
 * 1. .env.localãƒ•ã‚¡ã‚¤ãƒ«ã«SUPABASE_URLã¨SUPABASE_ANON_KEYã‚’è¨­å®š
 * 2. npm run migrate ã‚’å®Ÿè¡Œ
 */

const { execSync } = require('child_process');
const path = require('path');
const fs = require('fs');
const dotenv = require('dotenv');

// .env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
dotenv.config({ path: '.env.local' });

// å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
const { SUPABASE_URL, SUPABASE_ANON_KEY } = process.env;

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  console.error('ã‚¨ãƒ©ãƒ¼: SUPABASE_URLã¨SUPABASE_ANON_KEYã‚’.env.localãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
  process.exit(1);
}

// ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹
const migrationsDir = path.join(__dirname, '..', 'supabase', 'migrations');

// ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
if (!fs.existsSync(migrationsDir)) {
  console.error(`ã‚¨ãƒ©ãƒ¼: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${migrationsDir}`);
  process.exit(1);
}

try {
  console.log('Supabaseãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­...');

  // supabase CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  try {
    execSync('supabase --version', { stdio: 'ignore' });
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼: supabase CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    console.error('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: https://supabase.com/docs/guides/cli');
    process.exit(1);
  }

  // ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’å–å¾—
  const args = process.argv.slice(2);
  const isReset = args.includes('--reset');
  const isDebug = args.includes('--debug');
  const specificMigration = args.find(arg => arg.startsWith('--file='));

  let command = '';

  if (isReset) {
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å…¨ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
    command = 'supabase db reset';
    if (isDebug) {
      command += ' --debug';
    }
  } else if (specificMigration) {
    // ç‰¹å®šã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’é©ç”¨
    const migrationFile = specificMigration.replace('--file=', '');
    const migrationPath = path.join(migrationsDir, migrationFile);

    if (!fs.existsSync(migrationPath)) {
      console.error(`ã‚¨ãƒ©ãƒ¼: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${migrationPath}`);
      process.exit(1);
    }

    command = `supabase db push --db-only ${isDebug ? '--debug' : ''}`;
  } else {
    // æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿ã‚’é©ç”¨
    command = `supabase db push --db-only ${isDebug ? '--debug' : ''}`;
  }

  console.log(`å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: ${command}`);

  // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
  execSync(command, {
    stdio: 'inherit',
    env: {
      ...process.env,
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    }
  });

  console.log('ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼');
} catch (error) {
  console.error('ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error.message);
  process.exit(1);
}
</file>

<file path="scripts/seed.ts">
import { createServerSupabaseClient } from '../lib/supabase';
import * as dotenv from 'dotenv';

// .env.localãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
dotenv.config({ path: '.env.local' });

async function main() {
  // ç›£æŸ»ãƒ­ã‚°ãƒˆãƒªã‚¬ãƒ¼ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  const disableAuditTriggers = async (supabase: any) => {
    console.log('Temporarily disabling audit triggers...');
    await supabase.rpc('disable_audit_triggers');
  };

  // ç›£æŸ»ãƒ­ã‚°ãƒˆãƒªã‚¬ãƒ¼ã‚’å†åº¦æœ‰åŠ¹åŒ–
  const enableAuditTriggers = async (supabase: any) => {
    console.log('Re-enabling audit triggers...');
    await supabase.rpc('enable_audit_triggers');
  };
  console.log('Starting seed process...');

  const supabase = await createServerSupabaseClient();

  try {
    // ç›£æŸ»ãƒ­ã‚°ãƒˆãƒªã‚¬ãƒ¼ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    try {
      await disableAuditTriggers(supabase);
    } catch (error) {
      console.warn('Failed to disable audit triggers. This might be expected if they are not set up yet:', error);
    }
    // åº—èˆ—ã®ä½œæˆ
    console.log('Creating store...');
    const { data: store, error: storeError } = await supabase
      .from('stores')
      .insert({ store_code: 'GB001', name: 'GirlsBar One' })
      .select()
      .single();

    if (storeError) {
      throw storeError;
    }

    console.log('Store created:', store);

    // ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
    console.log('Creating admin user...');
    const { data: user, error: userError } = await supabase.auth.admin.createUser({
      email: 'test@test.com',
      password: 'testtest',
      email_confirm: true,
    });

    if (userError) {
      throw userError;
    }

    console.log('Admin user created:', user);

    // åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ä»˜ã‘ã®ä½œæˆ
    console.log('Creating store user association...');
    const { data: storeUser, error: storeUserError } = await supabase
      .from('store_users')
      .insert({
        store_id: store.store_id,
        user_id: user.user.id,
        role: 'admin'
      })
      .select()
      .single();

    if (storeUserError) {
      throw storeUserError;
    }

    console.log('Store user association created:', storeUser);

    // å¸­ç¨®ã®ä½œæˆ
    console.log('Creating seat types...');
    const seatTypes = [
      { code: 'COUNTER', display_name: 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­', price_per_unit: 1500 },
      { code: 'TABLE', display_name: 'ãƒ†ãƒ¼ãƒ–ãƒ«å¸­', price_per_unit: 2000 },
      { code: 'VIP', display_name: 'VIPå¸­', price_per_unit: 3000 }
    ];

    const { data: createdSeatTypes, error: seatTypeError } = await supabase
      .from('seat_types')
      .insert(seatTypes)
      .select();

    if (seatTypeError) {
      throw seatTypeError;
    }

    console.log('Seat types created:', createdSeatTypes);

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
    console.log('Creating tables...');
    const tables = [
      { store_id: store.store_id, name: 'C1', seat_type_id: createdSeatTypes[0].seat_type_id },
      { store_id: store.store_id, name: 'C2', seat_type_id: createdSeatTypes[0].seat_type_id },
      { store_id: store.store_id, name: 'T1', seat_type_id: createdSeatTypes[1].seat_type_id },
      { store_id: store.store_id, name: 'V1', seat_type_id: createdSeatTypes[2].seat_type_id }
    ];

    const { data: createdTables, error: tableError } = await supabase
      .from('tables')
      .insert(tables)
      .select();

    if (tableError) {
      throw tableError;
    }

    console.log('Tables created:', createdTables);

    console.log('Seed completed successfully!');

  } catch (error) {
    console.error('Error during seed process:', error);
    process.exit(1);
  } finally {
    // ç›£æŸ»ãƒ­ã‚°ãƒˆãƒªã‚¬ãƒ¼ã‚’å†åº¦æœ‰åŠ¹åŒ–
    try {
      await enableAuditTriggers(supabase);
    } catch (error) {
      console.warn('Failed to re-enable audit triggers:', error);
    }
  }
}

main();
</file>

<file path="supabase/.temp/cli-latest">
v2.22.12
</file>

<file path="supabase/.temp/gotrue-version">
v2.171.0
</file>

<file path="supabase/.temp/pooler-url">
postgresql://postgres.ooiajrjymsrmnxukmavb:[YOUR-PASSWORD]@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres
</file>

<file path="supabase/.temp/postgres-version">
15.8.1.073
</file>

<file path="supabase/.temp/project-ref">
ooiajrjymsrmnxukmavb
</file>

<file path="supabase/.temp/rest-version">
v12.2.3
</file>

<file path="supabase/.temp/storage-version">
custom-metadata
</file>

<file path="supabase/config.toml">
# A string used to distinguish different Supabase projects on the same host. Defaults to the working
# directory name when running `supabase init`.
project_id = "girls-bar-qr-menu-sys"

[api]
# Port to use for the API URL.
port = 54321
# Schemas to expose in your API. Tables, views and stored procedures in this schema will get API
# endpoints. public and storage are always included.
schemas = ["public", "storage", "auth"]
# Extra schemas to add to the search_path of every request. public is always included.
extra_search_path = ["public", "extensions"]
# The maximum number of rows returns from a view, table, or stored procedure. Limits payload size
# for accidental or malicious requests.
max_rows = 1000

[db]
# Port to use for the local database URL.
port = 54322
# The database major version to use. This has to be the same as your remote database's. Run `SHOW
# server_version;` on the remote database to check.
major_version = 15

[studio]
# Port to use for Supabase Studio.
port = 54323

# Email testing server. Emails sent with the local dev setup are not actually sent - rather, they
# are monitored, and you can view the emails that would have been sent from the web interface.
[inbucket]
# Port to use for the email testing server web interface.
port = 54324
smtp_port = 54325
pop3_port = 54326

[storage]
# The maximum file size allowed (e.g. "5MB", "500KB").
file_size_limit = "50MiB"

[auth]
# The base URL of your website. Used as an allow-list for redirects and for constructing URLs used
# in emails.
site_url = "http://localhost:3000"
# A list of *exact* URLs that auth providers are permitted to redirect to post authentication.
additional_redirect_urls = ["https://localhost:3000"]
# How long tokens are valid for, in seconds. Defaults to 3600 (1 hour), maximum 604,800 seconds (one
# week).
jwt_expiry = 3600
# Allow/disallow new user signups to your project.
enable_signup = true

[auth.email]
# Allow/disallow new user signups via email to your project.
enable_signup = true
# If enabled, a user will be required to confirm any email change on both the old, and new email
# addresses. If disabled, only the new email is required to confirm.
double_confirm_changes = true
# If enabled, users need to confirm their email address before signing in.
enable_confirmations = false

# Use an external OAuth provider. The full list of providers are: "apple", "azure", "bitbucket",
# "discord", "facebook", "github", "gitlab", "google", "keycloak", "linkedin", "notion", "twitch",
# "twitter", "slack", "spotify", "workos", "zoom".
[auth.external.apple]
enabled = false
client_id = ""
secret = ""
# Overrides the default auth redirectUrl.
redirect_uri = ""
# Overrides the default auth provider URL. Used to support self-hosted gitlab, single-tenant Azure,
# or any other third-party OIDC providers.
url = ""

[analytics]
enabled = false
port = 54327
vector_port = 54328
# Setup BigQuery project to enable log viewer on local development stack.
# See: https://supabase.com/docs/guides/getting-started/local-development#enabling-local-logging
gcp_project_id = ""
gcp_project_number = ""
gcp_jwt_path = "supabase/gcloud.json"
</file>

<file path="supabase/migrations/20250428000000_initial_schema.sql">
-- åˆæœŸã‚¹ã‚­ãƒ¼ãƒä½œæˆ
-- åº—èˆ—ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.stores (
  store_id uuid primary key default gen_random_uuid(),
  store_code text unique not null,
  name text not null,
  created_at timestamptz default now()
);

-- å¸­ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.seat_types (
  seat_type_id serial primary key,
  code text unique not null,
  display_name text not null,
  price_per_30min int not null,
  created_at timestamptz default now()
);

-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.tables (
  table_id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores on delete cascade not null,
  name text not null,
  seat_type_id int references public.seat_types not null,
  created_at timestamptz default now()
);

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.sessions (
  session_id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores on delete cascade not null,
  table_id uuid references public.tables on delete cascade not null,
  start_at timestamptz default now(),
  charge_started_at timestamptz,
  created_at timestamptz default now()
);

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.session_seat_events (
  event_id uuid primary key default gen_random_uuid(),
  session_id uuid references public.sessions on delete cascade not null,
  seat_type_id int references public.seat_types not null,
  price_snapshot int not null,
  changed_at timestamptz default now(),
  created_at timestamptz default now()
);

-- æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.orders (
  order_id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores on delete cascade not null,
  session_id uuid references public.sessions on delete cascade not null,
  status text check (status in ('new','ack','prep','served','closed','cancel')) not null,
  created_by_role text,
  proxy boolean default false,
  created_at timestamptz default now()
);

-- æ³¨æ–‡æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.order_items (
  order_item_id uuid primary key default gen_random_uuid(),
  order_id uuid references public.orders on delete cascade not null,
  product_id text not null,
  product_name text not null,
  quantity int not null,
  price int not null,
  target_cast_id uuid references auth.users,
  created_at timestamptz default now()
);

-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.menus (
  menu_id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores on delete cascade not null,
  product_id text not null,
  name text not null,
  description text,
  price int not null,
  image_url text,
  category text,
  is_staff_drink boolean default false,
  is_available boolean default true,
  created_at timestamptz default now(),
  unique(store_id, product_id)
);

-- åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.store_users (
  id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores on delete cascade not null,
  user_id uuid references auth.users on delete cascade not null,
  role text check (role in ('admin','cast')) not null,
  created_at timestamptz default now(),
  unique(store_id, user_id)
);

-- ä¼šè¨ˆå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.checkouts (
  checkout_id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores on delete cascade not null,
  session_id uuid references public.sessions on delete cascade not null,
  total_amount int not null,
  charge_amount int not null,
  order_amount int not null,
  smaregi_receipt_id text,
  status text check (status in ('pending','completed','failed')) not null default 'pending',
  created_at timestamptz default now()
);

-- ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ç”¨ï¼‰
create table if not exists public.broadcast (
  id uuid primary key default gen_random_uuid(),
  channel text not null,
  payload jsonb not null,
  created_at timestamptz default now()
);

-- ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
create table if not exists public.audit_logs (
  log_id uuid primary key default gen_random_uuid(),
  store_id uuid references public.stores on delete cascade not null,
  user_id uuid references auth.users,
  action text not null,
  table_name text not null,
  record_id uuid not null,
  old_data jsonb,
  new_data jsonb,
  created_at timestamptz default now()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
create index if not exists idx_tables_store_id on public.tables(store_id);
create index if not exists idx_sessions_store_id on public.sessions(store_id);
create index if not exists idx_sessions_table_id on public.sessions(table_id);
create index if not exists idx_orders_store_id on public.orders(store_id);
create index if not exists idx_orders_session_id on public.orders(session_id);
create index if not exists idx_orders_status on public.orders(status);
create index if not exists idx_order_items_order_id on public.order_items(order_id);
create index if not exists idx_menus_store_id on public.menus(store_id);
create index if not exists idx_store_users_store_id on public.store_users(store_id);
create index if not exists idx_store_users_user_id on public.store_users(user_id);
create index if not exists idx_session_seat_events_session_id on public.session_seat_events(session_id);
create index if not exists idx_checkouts_store_id on public.checkouts(store_id);
create index if not exists idx_checkouts_session_id on public.checkouts(session_id);
create index if not exists idx_audit_logs_store_id on public.audit_logs(store_id);
create index if not exists idx_audit_logs_created_at on public.audit_logs(created_at);
</file>

<file path="supabase/migrations/20250428000001_rls_policies.sql">
-- RLSã‚’æœ‰åŠ¹åŒ–
alter table public.stores enable row level security;
alter table public.seat_types enable row level security;
alter table public.tables enable row level security;
alter table public.sessions enable row level security;
alter table public.session_seat_events enable row level security;
alter table public.orders enable row level security;
alter table public.order_items enable row level security;
alter table public.menus enable row level security;
alter table public.store_users enable row level security;
alter table public.checkouts enable row level security;
alter table public.broadcast enable row level security;
alter table public.audit_logs enable row level security;

-- åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ãƒãƒªã‚·ãƒ¼
-- åº—èˆ—æƒ…å ±ã¯åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚é–²è¦§å¯èƒ½
create policy "åº—èˆ—æƒ…å ±ã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½" on public.stores
  for select using (true);

-- ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã¯åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚é–²è¦§å¯èƒ½
create policy "ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½" on public.tables
  for select using (true);

-- å¸­ç¨®æƒ…å ±ã¯åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚é–²è¦§å¯èƒ½
create policy "å¸­ç¨®æƒ…å ±ã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½" on public.seat_types
  for select using (true);

-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã¯åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚é–²è¦§å¯èƒ½
create policy "ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½" on public.menus
  for select using (true);

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã¯åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚é–²è¦§å¯èƒ½ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«IDã§çµã‚Šè¾¼ã¿ï¼‰
create policy "ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½" on public.sessions
  for select using (true);

-- åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ³¨æ–‡ã‚’ä½œæˆå¯èƒ½
create policy "åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ³¨æ–‡ã‚’ä½œæˆå¯èƒ½" on public.orders
  for insert with check (created_by_role = 'customer');

-- åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ³¨æ–‡æ˜ç´°ã‚’ä½œæˆå¯èƒ½
create policy "åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ³¨æ–‡æ˜ç´°ã‚’ä½œæˆå¯èƒ½" on public.order_items
  for insert with check (
    order_id in (
      select order_id from public.orders where created_by_role = 'customer'
    )
  );

-- èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ãƒãƒªã‚·ãƒ¼
-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®æƒ…å ±ã®ã¿é–²è¦§å¯èƒ½" on public.stores
  for all using (
    store_id in (
      select store_id from public.store_users where user_id = auth.uid()
    )
  );

-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½" on public.tables
  for all using (
    store_id in (
      select store_id from public.store_users where user_id = auth.uid()
    )
  );

-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½" on public.sessions
  for all using (
    store_id in (
      select store_id from public.store_users where user_id = auth.uid()
    )
  );

-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½" on public.session_seat_events
  for all using (
    session_id in (
      select session_id from public.sessions where store_id in (
        select store_id from public.store_users where user_id = auth.uid()
      )
    )
  );

-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®æ³¨æ–‡æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®æ³¨æ–‡æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½" on public.orders
  for all using (
    store_id in (
      select store_id from public.store_users where user_id = auth.uid()
    )
  );

-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®æ³¨æ–‡æ˜ç´°æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®æ³¨æ–‡æ˜ç´°æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½" on public.order_items
  for all using (
    order_id in (
      select order_id from public.orders where store_id in (
        select store_id from public.store_users where user_id = auth.uid()
      )
    )
  );

-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½" on public.menus
  for all using (
    store_id in (
      select store_id from public.store_users where user_id = auth.uid()
    )
  );

-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ä¼šè¨ˆæƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ä¼šè¨ˆæƒ…å ±ã®ã¿é–²è¦§ãƒ»ç·¨é›†å¯èƒ½" on public.checkouts
  for all using (
    store_id in (
      select store_id from public.store_users where user_id = auth.uid()
    )
  );

-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ç›£æŸ»ãƒ­ã‚°ã®ã¿é–²è¦§å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ç›£æŸ»ãƒ­ã‚°ã®ã¿é–²è¦§å¯èƒ½" on public.audit_logs
  for select using (
    store_id in (
      select store_id from public.store_users where user_id = auth.uid()
    )
  );

-- åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã¯è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ã¿é–²è¦§å¯èƒ½
create policy "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã®ã¿é–²è¦§å¯èƒ½" on public.store_users
  for select using (
    store_id in (
      select store_id from public.store_users where user_id = auth.uid()
    )
  );

-- ç®¡ç†è€…ã®ã¿åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã‚’ç·¨é›†å¯èƒ½
create policy "ç®¡ç†è€…ã®ã¿åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã‚’ç·¨é›†å¯èƒ½" on public.store_users
  for insert with check (
    exists (
      select 1 from public.store_users 
      where user_id = auth.uid() and store_id = store_users.store_id and role = 'admin'
    )
  );

create policy "ç®¡ç†è€…ã®ã¿åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã‚’æ›´æ–°å¯èƒ½" on public.store_users
  for update using (
    exists (
      select 1 from public.store_users 
      where user_id = auth.uid() and store_id = store_users.store_id and role = 'admin'
    )
  );

create policy "ç®¡ç†è€…ã®ã¿åº—èˆ—ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã‚’å‰Šé™¤å¯èƒ½" on public.store_users
  for delete using (
    exists (
      select 1 from public.store_users 
      where user_id = auth.uid() and store_id = store_users.store_id and role = 'admin'
    )
  );

-- å¸­ç¨®ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½
create policy "å¸­ç¨®ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½" on public.seat_types
  for insert with check (
    exists (
      select 1 from public.store_users where user_id = auth.uid() and role = 'admin'
    )
  );

create policy "å¸­ç¨®ã¯ç®¡ç†è€…ã®ã¿æ›´æ–°å¯èƒ½" on public.seat_types
  for update using (
    exists (
      select 1 from public.store_users where user_id = auth.uid() and role = 'admin'
    )
  );

create policy "å¸­ç¨®ã¯ç®¡ç†è€…ã®ã¿å‰Šé™¤å¯èƒ½" on public.seat_types
  for delete using (
    exists (
      select 1 from public.store_users where user_id = auth.uid() and role = 'admin'
    )
  );

-- ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½
create policy "ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½" on public.broadcast
  for select using (true);

-- ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã¯èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ä½œæˆå¯èƒ½
create policy "ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã¯èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ä½œæˆå¯èƒ½" on public.broadcast
  for insert with check (auth.role() = 'authenticated');
</file>

<file path="supabase/migrations/20250428000002_charge_functions.sql">
-- ãƒãƒ£ãƒ¼ã‚¸è¨ˆç®—ç”¨ã®é–¢æ•°
create or replace function public.fn_calc_total_charge(p_session_id uuid)
returns int
language plpgsql
security definer
as $$
declare
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes int;
  v_rounded_minutes int;
  v_half_hour_units int;
  v_event_charge int;
begin
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã‚’å–å¾—
  select charge_started_at into v_charge_start_time
  from public.sessions
  where session_id = p_session_id;

  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  if v_charge_start_time is null then
    return 0;
  end if;

  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  for v_event in (
    select
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at
    from public.session_seat_events
    where session_id = p_session_id
    order by changed_at asc
  ) loop
    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    if v_last_event_time is null then
      v_last_event_time := v_charge_start_time;
    end if;

    -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch from (v_event.changed_at - v_last_event_time)) / 60;

    -- 30åˆ†å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := ceiling(v_elapsed_minutes::numeric / 30) * 30;

    -- 30åˆ†å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_half_hour_units := v_rounded_minutes / 30;

    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_half_hour_units * (
      select price_per_unit
      from public.seat_types
      where seat_type_id = v_event.seat_type_id
    );

    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;

    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
  end loop;

  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—
  if v_last_event_time is null then
    -- ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯é–‹å§‹æ™‚é–“ã‹ã‚‰ç¾åœ¨ã¾ã§ã‚’è¨ˆç®—
    v_last_event_time := v_charge_start_time;
  end if;

  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch from (v_current_time - v_last_event_time)) / 60;

  -- 30åˆ†å˜ä½ã§åˆ‡ã‚Šä¸Šã’
  v_rounded_minutes := ceiling(v_elapsed_minutes::numeric / 30) * 30;

  -- 30åˆ†å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_half_hour_units := v_rounded_minutes / 30;

  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_half_hour_units * (
    select price_per_unit
    from public.seat_types
    where seat_type_id = (
      select seat_type_id
      from public.session_seat_events
      where session_id = p_session_id
      order by changed_at desc
      limit 1
    )
  );

  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;

  return v_total_charge;
end;
$$;

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°
create or replace function public.fn_create_session_seat_snapshot()
returns trigger
language plpgsql
security definer
as $$
begin
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚ã«å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
  if new.charge_started_at is not null and (old.charge_started_at is null or old.charge_started_at <> new.charge_started_at) then
    insert into public.session_seat_events (
      session_id,
      seat_type_id,
      price_snapshot,
      changed_at
    )
    select
      new.session_id,
      t.seat_type_id,
      st.price_per_unit,
      new.charge_started_at
    from
      public.tables t
      join public.seat_types st on t.seat_type_id = st.seat_type_id
    where
      t.table_id = new.table_id;
  end if;

  return new;
end;
$$;

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼
create trigger trg_session_update
after update on public.sessions
for each row
execute function public.fn_create_session_seat_snapshot();

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®å¤‰æ›´æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°
create or replace function public.fn_create_table_seat_change_snapshot()
returns trigger
language plpgsql
security definer
as $$
begin
  -- å¸­ç¨®ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
  if new.seat_type_id <> old.seat_type_id then
    -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
    insert into public.session_seat_events (
      session_id,
      seat_type_id,
      price_snapshot,
      changed_at
    )
    select
      s.session_id,
      new.seat_type_id,
      st.price_per_unit,
      now()
    from
      public.sessions s
      join public.seat_types st on st.seat_type_id = new.seat_type_id
    where
      s.table_id = new.table_id
      and s.charge_started_at is not null;
  end if;

  return new;
end;
$$;

-- ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼
create trigger trg_table_update
after update on public.tables
for each row
execute function public.fn_create_table_seat_change_snapshot();
</file>

<file path="supabase/migrations/20250428000003_audit_triggers.sql">
-- ç›£æŸ»ãƒ­ã‚°ç”¨ã®ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°
create or replace function public.fn_audit_log()
returns trigger
language plpgsql
security definer
as $$
declare
  v_store_id uuid;
  v_user_id uuid := auth.uid();
  v_action text;
  v_record_id uuid;
begin
  -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã‚’è¨­å®š
  if TG_OP = 'INSERT' then
    v_action := 'insert';
    v_record_id := new.id;
    
    -- ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«åº—èˆ—IDã‚’å–å¾—
    if TG_TABLE_NAME = 'stores' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'tables' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'sessions' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'orders' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'menus' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'store_users' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'checkouts' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'order_items' then
      select store_id into v_store_id from public.orders where order_id = new.order_id;
    elsif TG_TABLE_NAME = 'session_seat_events' then
      select store_id into v_store_id from public.sessions where session_id = new.session_id;
    end if;
    
    -- ç›£æŸ»ãƒ­ã‚°ã‚’æŒ¿å…¥
    insert into public.audit_logs (
      store_id,
      user_id,
      action,
      table_name,
      record_id,
      new_data
    ) values (
      v_store_id,
      v_user_id,
      v_action,
      TG_TABLE_NAME,
      v_record_id,
      to_jsonb(new)
    );
    
  elsif TG_OP = 'UPDATE' then
    v_action := 'update';
    v_record_id := new.id;
    
    -- ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«åº—èˆ—IDã‚’å–å¾—
    if TG_TABLE_NAME = 'stores' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'tables' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'sessions' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'orders' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'menus' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'store_users' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'checkouts' then
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'order_items' then
      select store_id into v_store_id from public.orders where order_id = new.order_id;
    elsif TG_TABLE_NAME = 'session_seat_events' then
      select store_id into v_store_id from public.sessions where session_id = new.session_id;
    end if;
    
    -- ç›£æŸ»ãƒ­ã‚°ã‚’æŒ¿å…¥
    insert into public.audit_logs (
      store_id,
      user_id,
      action,
      table_name,
      record_id,
      old_data,
      new_data
    ) values (
      v_store_id,
      v_user_id,
      v_action,
      TG_TABLE_NAME,
      v_record_id,
      to_jsonb(old),
      to_jsonb(new)
    );
    
  elsif TG_OP = 'DELETE' then
    v_action := 'delete';
    v_record_id := old.id;
    
    -- ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«åº—èˆ—IDã‚’å–å¾—
    if TG_TABLE_NAME = 'stores' then
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'tables' then
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'sessions' then
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'orders' then
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'menus' then
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'store_users' then
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'checkouts' then
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'order_items' then
      select store_id into v_store_id from public.orders where order_id = old.order_id;
    elsif TG_TABLE_NAME = 'session_seat_events' then
      select store_id into v_store_id from public.sessions where session_id = old.session_id;
    end if;
    
    -- ç›£æŸ»ãƒ­ã‚°ã‚’æŒ¿å…¥
    insert into public.audit_logs (
      store_id,
      user_id,
      action,
      table_name,
      record_id,
      old_data
    ) values (
      v_store_id,
      v_user_id,
      v_action,
      TG_TABLE_NAME,
      v_record_id,
      to_jsonb(old)
    );
  end if;
  
  return null;
end;
$$;

-- ç›£æŸ»ãƒ­ã‚°ãƒˆãƒªã‚¬ãƒ¼ã‚’å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«é©ç”¨
create trigger trg_audit_stores
after insert or update or delete on public.stores
for each row execute function public.fn_audit_log();

create trigger trg_audit_tables
after insert or update or delete on public.tables
for each row execute function public.fn_audit_log();

create trigger trg_audit_sessions
after insert or update or delete on public.sessions
for each row execute function public.fn_audit_log();

create trigger trg_audit_orders
after insert or update or delete on public.orders
for each row execute function public.fn_audit_log();

create trigger trg_audit_order_items
after insert or update or delete on public.order_items
for each row execute function public.fn_audit_log();

create trigger trg_audit_menus
after insert or update or delete on public.menus
for each row execute function public.fn_audit_log();

create trigger trg_audit_store_users
after insert or update or delete on public.store_users
for each row execute function public.fn_audit_log();

create trigger trg_audit_checkouts
after insert or update or delete on public.checkouts
for each row execute function public.fn_audit_log();

-- 90æ—¥ä»¥ä¸ŠçµŒéã—ãŸç›£æŸ»ãƒ­ã‚°ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
create or replace function public.fn_cleanup_audit_logs()
returns void
language plpgsql
security definer
as $$
begin
  delete from public.audit_logs
  where created_at < now() - interval '90 days';
end;
$$;
</file>

<file path="supabase/migrations/20250428000004_report_views.sql">
-- æ—¥æ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆç”¨ãƒ“ãƒ¥ãƒ¼
create or replace view public.v_daily_sales as
select
  c.store_id,
  s.name as store_name,
  date_trunc('day', c.created_at) as sales_date,
  count(distinct c.checkout_id) as checkout_count,
  sum(c.total_amount) as total_sales,
  sum(c.charge_amount) as charge_sales,
  sum(c.order_amount) as order_sales
from
  public.checkouts c
  join public.stores s on c.store_id = s.store_id
where
  c.status = 'completed'
group by
  c.store_id,
  s.name,
  date_trunc('day', c.created_at);

-- ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯é›†è¨ˆç”¨ãƒ“ãƒ¥ãƒ¼
create or replace view public.v_staff_drinks as
select
  o.store_id,
  s.name as store_name,
  date_trunc('day', o.created_at) as sales_date,
  oi.target_cast_id,
  u.email as cast_email,
  count(oi.order_item_id) as drink_count,
  sum(oi.price * oi.quantity) as drink_sales
from
  public.order_items oi
  join public.orders o on oi.order_id = o.order_id
  join public.stores s on o.store_id = s.store_id
  left join auth.users u on oi.target_cast_id = u.id
where
  oi.target_cast_id is not null
  and o.status not in ('cancel')
group by
  o.store_id,
  s.name,
  date_trunc('day', o.created_at),
  oi.target_cast_id,
  u.email;

-- ãƒ†ãƒ¼ãƒ–ãƒ«åˆ©ç”¨çŠ¶æ³ãƒ“ãƒ¥ãƒ¼
create or replace view public.v_table_usage as
select
  s.store_id,
  st.name as store_name,
  t.table_id,
  t.name as table_name,
  st2.display_name as seat_type,
  st2.price_per_30min,
  s.session_id,
  s.start_at,
  s.charge_started_at,
  case
    when s.charge_started_at is not null then
      extract(epoch from (now() - s.charge_started_at)) / 60
    else
      0
  end as elapsed_minutes,
  case
    when s.charge_started_at is not null then
      ceiling(extract(epoch from (now() - s.charge_started_at)) / 60 / 30) * 30
    else
      0
  end as rounded_minutes,
  case
    when s.charge_started_at is not null then
      ceiling(extract(epoch from (now() - s.charge_started_at)) / 60 / 30) * st2.price_per_30min
    else
      0
  end as current_charge
from
  public.sessions s
  join public.tables t on s.table_id = t.table_id
  join public.stores st on s.store_id = st.store_id
  join public.seat_types st2 on t.seat_type_id = st2.seat_type_id
where
  s.charge_started_at is not null
  and not exists (
    select 1 from public.checkouts c
    where c.session_id = s.session_id and c.status = 'completed'
  );

-- æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆãƒ“ãƒ¥ãƒ¼
create or replace view public.v_order_status as
select
  o.store_id,
  s.name as store_name,
  o.status,
  count(*) as order_count
from
  public.orders o
  join public.stores s on o.store_id = s.store_id
where
  o.created_at > now() - interval '24 hours'
group by
  o.store_id,
  s.name,
  o.status;
</file>

<file path="supabase/migrations/20250428000007_audit_triggers_fix.sql">
-- ç›£æŸ»ãƒ­ã‚°ç”¨ã®ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ã‚’ä¿®æ­£
create or replace function public.fn_audit_log()
returns trigger
language plpgsql
security definer
as $$
declare
  v_store_id uuid;
  v_user_id uuid := auth.uid();
  v_action text;
  v_record_id uuid;
begin
  -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã‚’è¨­å®š
  if TG_OP = 'INSERT' then
    v_action := 'insert';
    
    -- ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«ä¸»ã‚­ãƒ¼ã‚’å–å¾—
    if TG_TABLE_NAME = 'stores' then
      v_record_id := new.store_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'tables' then
      v_record_id := new.table_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'sessions' then
      v_record_id := new.session_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'orders' then
      v_record_id := new.order_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'menus' then
      v_record_id := new.menu_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'store_users' then
      v_record_id := new.id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'checkouts' then
      v_record_id := new.checkout_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'order_items' then
      v_record_id := new.item_id;
      select store_id into v_store_id from public.orders where order_id = new.order_id;
    elsif TG_TABLE_NAME = 'session_seat_events' then
      v_record_id := new.event_id;
      select store_id into v_store_id from public.sessions where session_id = new.session_id;
    end if;
    
    -- ç›£æŸ»ãƒ­ã‚°ã‚’æŒ¿å…¥
    insert into public.audit_logs (
      store_id,
      user_id,
      action,
      table_name,
      record_id,
      new_data
    ) values (
      v_store_id,
      v_user_id,
      v_action,
      TG_TABLE_NAME,
      v_record_id,
      to_jsonb(new)
    );
    
  elsif TG_OP = 'UPDATE' then
    v_action := 'update';
    
    -- ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«ä¸»ã‚­ãƒ¼ã‚’å–å¾—
    if TG_TABLE_NAME = 'stores' then
      v_record_id := new.store_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'tables' then
      v_record_id := new.table_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'sessions' then
      v_record_id := new.session_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'orders' then
      v_record_id := new.order_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'menus' then
      v_record_id := new.menu_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'store_users' then
      v_record_id := new.id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'checkouts' then
      v_record_id := new.checkout_id;
      v_store_id := new.store_id;
    elsif TG_TABLE_NAME = 'order_items' then
      v_record_id := new.item_id;
      select store_id into v_store_id from public.orders where order_id = new.order_id;
    elsif TG_TABLE_NAME = 'session_seat_events' then
      v_record_id := new.event_id;
      select store_id into v_store_id from public.sessions where session_id = new.session_id;
    end if;
    
    -- ç›£æŸ»ãƒ­ã‚°ã‚’æŒ¿å…¥
    insert into public.audit_logs (
      store_id,
      user_id,
      action,
      table_name,
      record_id,
      old_data,
      new_data
    ) values (
      v_store_id,
      v_user_id,
      v_action,
      TG_TABLE_NAME,
      v_record_id,
      to_jsonb(old),
      to_jsonb(new)
    );
    
  elsif TG_OP = 'DELETE' then
    v_action := 'delete';
    
    -- ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«ä¸»ã‚­ãƒ¼ã‚’å–å¾—
    if TG_TABLE_NAME = 'stores' then
      v_record_id := old.store_id;
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'tables' then
      v_record_id := old.table_id;
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'sessions' then
      v_record_id := old.session_id;
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'orders' then
      v_record_id := old.order_id;
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'menus' then
      v_record_id := old.menu_id;
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'store_users' then
      v_record_id := old.id;
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'checkouts' then
      v_record_id := old.checkout_id;
      v_store_id := old.store_id;
    elsif TG_TABLE_NAME = 'order_items' then
      v_record_id := old.item_id;
      select store_id into v_store_id from public.orders where order_id = old.order_id;
    elsif TG_TABLE_NAME = 'session_seat_events' then
      v_record_id := old.event_id;
      select store_id into v_store_id from public.sessions where session_id = old.session_id;
    end if;
    
    -- ç›£æŸ»ãƒ­ã‚°ã‚’æŒ¿å…¥
    insert into public.audit_logs (
      store_id,
      user_id,
      action,
      table_name,
      record_id,
      old_data
    ) values (
      v_store_id,
      v_user_id,
      v_action,
      TG_TABLE_NAME,
      v_record_id,
      to_jsonb(old)
    );
  end if;
  
  return null;
end;
$$;
</file>

<file path="supabase/migrations/20250428000008_audit_triggers_toggle.sql">
-- ç›£æŸ»ãƒ­ã‚°ãƒˆãƒªã‚¬ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹RPCé–¢æ•°
create or replace function public.disable_audit_triggers()
returns void
language plpgsql
security definer
as $$
begin
  alter table public.stores disable trigger trg_audit_stores;
  alter table public.tables disable trigger trg_audit_tables;
  alter table public.sessions disable trigger trg_audit_sessions;
  alter table public.orders disable trigger trg_audit_orders;
  alter table public.order_items disable trigger trg_audit_order_items;
  alter table public.menus disable trigger trg_audit_menus;
  alter table public.store_users disable trigger trg_audit_store_users;
  alter table public.checkouts disable trigger trg_audit_checkouts;
end;
$$;

-- ç›£æŸ»ãƒ­ã‚°ãƒˆãƒªã‚¬ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹RPCé–¢æ•°
create or replace function public.enable_audit_triggers()
returns void
language plpgsql
security definer
as $$
begin
  alter table public.stores enable trigger trg_audit_stores;
  alter table public.tables enable trigger trg_audit_tables;
  alter table public.sessions enable trigger trg_audit_sessions;
  alter table public.orders enable trigger trg_audit_orders;
  alter table public.order_items enable trigger trg_audit_order_items;
  alter table public.menus enable trigger trg_audit_menus;
  alter table public.store_users enable trigger trg_audit_store_users;
  alter table public.checkouts enable trigger trg_audit_checkouts;
end;
$$;
</file>

<file path="supabase/migrations/20250430000000_add_store_id_to_seat_types.sql">
-- seat_typesãƒ†ãƒ¼ãƒ–ãƒ«ã«store_idã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.seat_types
ADD COLUMN store_id uuid REFERENCES public.stores(store_id) ON DELETE CASCADE;

-- æ—¢å­˜ã®å¸­ç¨®ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã™ã‚‹ãŸã‚ã®ä¸€æ™‚çš„ãªå‡¦ç†
-- æ—¢å­˜ã®ã™ã¹ã¦ã®å¸­ç¨®ã‚’æœ€åˆã®åº—èˆ—ã«ç´ã¥ã‘ã‚‹
UPDATE public.seat_types
SET store_id = (SELECT store_id FROM public.stores LIMIT 1)
WHERE store_id IS NULL;

-- store_idã‚«ãƒ©ãƒ ã‚’NOT NULLã«è¨­å®š
ALTER TABLE public.seat_types
ALTER COLUMN store_id SET NOT NULL;

-- åº—èˆ—IDã¨ã‚³ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’è¨­å®š
ALTER TABLE public.seat_types
DROP CONSTRAINT seat_types_code_key;

ALTER TABLE public.seat_types
ADD CONSTRAINT seat_types_store_id_code_key UNIQUE (store_id, code);

-- RLSãƒãƒªã‚·ãƒ¼ã®è¿½åŠ 
ALTER TABLE public.seat_types ENABLE ROW LEVEL SECURITY;

-- åº—èˆ—ç®¡ç†è€…ã®ã¿ãŒå¸­ç¨®ã‚’ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ãã‚‹ãƒãƒªã‚·ãƒ¼
CREATE POLICY seat_type_store_admin_all ON public.seat_types
  USING (store_id IN (
    SELECT store_id FROM public.store_users 
    WHERE user_id = auth.uid() AND role = 'admin'
  ));

-- åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã¯å¸­ç¨®ã‚’é–²è¦§ã®ã¿å¯èƒ½
CREATE POLICY seat_type_store_cast_select ON public.seat_types
  FOR SELECT
  USING (store_id IN (
    SELECT store_id FROM public.store_users 
    WHERE user_id = auth.uid()
  ));
</file>

<file path="supabase/migrations/20250501000000_add_store_settings.sql">
-- storesãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨­å®šã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.stores
ADD COLUMN enable_cast_management boolean NOT NULL DEFAULT true,
ADD COLUMN enable_smaregi_integration boolean NOT NULL DEFAULT true;

-- æ—¢å­˜ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
UPDATE public.stores
SET enable_cast_management = true,
    enable_smaregi_integration = true;

-- æ–°ã—ã„ã‚«ãƒ©ãƒ ã«å¯¾ã™ã‚‹RLSãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ 
CREATE POLICY "ç®¡ç†è€…ã®ã¿åº—èˆ—è¨­å®šã‚’æ›´æ–°å¯èƒ½" ON public.stores
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM public.store_users
      WHERE user_id = auth.uid()
      AND store_id = stores.store_id
      AND role = 'admin'
    )
  );
</file>

<file path="supabase/migrations/20250502000000_add_display_name_to_store_users.sql">
-- store_usersãƒ†ãƒ¼ãƒ–ãƒ«ã«display_nameã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.store_users
ADD COLUMN display_name text;

-- æ—¢å­˜ã®ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®@å‰ã®éƒ¨åˆ†ã‚’åå‰ã¨ã—ã¦è¨­å®š
UPDATE public.store_users su
SET display_name = (
  SELECT split_part(email, '@', 1)
  FROM auth.users
  WHERE id = su.user_id
)
WHERE role = 'cast';

-- RLSãƒãƒªã‚·ãƒ¼ã¯æ—¢ã«æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ›´æ–°ã¯ä¸è¦
</file>

<file path="supabase/migrations/20250503000000_add_smaregi_keys.sql">
-- storesãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¹ãƒãƒ¬ã‚¸é€£æºã‚­ãƒ¼ã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.stores
ADD COLUMN smaregi_client_id text,
ADD COLUMN smaregi_client_secret text;

-- æ—¢å­˜ã®RLSãƒãƒªã‚·ãƒ¼ã¯æ—¢ã«ç®¡ç†è€…ã®ã¿ãŒåº—èˆ—è¨­å®šã‚’æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€
-- è¿½åŠ ã®ãƒãƒªã‚·ãƒ¼ã¯ä¸è¦
</file>

<file path="supabase/migrations/20250504000000_add_smaregi_contract_id.sql">
-- storesãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¹ãƒãƒ¬ã‚¸å¥‘ç´„IDã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.stores
ADD COLUMN smaregi_contract_id text;

-- æ—¢å­˜ã®RLSãƒãƒªã‚·ãƒ¼ã¯æ—¢ã«ç®¡ç†è€…ã®ã¿ãŒåº—èˆ—è¨­å®šã‚’æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€
-- è¿½åŠ ã®ãƒãƒªã‚·ãƒ¼ã¯ä¸è¦
</file>

<file path="supabase/migrations/20250601000000_add_menu_categories.sql">
-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
CREATE TABLE IF NOT EXISTS public.menu_categories (
  category_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  store_id UUID REFERENCES public.stores ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  display_order INT NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(store_id, name)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ
CREATE INDEX IF NOT EXISTS idx_menu_categories_store_id ON public.menu_categories(store_id);

-- RLSã®æœ‰åŠ¹åŒ–
ALTER TABLE public.menu_categories ENABLE ROW LEVEL SECURITY;

-- RLSãƒãƒªã‚·ãƒ¼ã®ä½œæˆ
-- åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚é–²è¦§å¯èƒ½
CREATE POLICY "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½" ON public.menu_categories
  FOR SELECT USING (true);

-- è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã®ã¿ç·¨é›†å¯èƒ½
CREATE POLICY "è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹åº—èˆ—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã®ã¿ç·¨é›†å¯èƒ½" ON public.menu_categories
  FOR ALL USING (
    store_id IN (
      SELECT store_id FROM public.store_users WHERE user_id = auth.uid()
    )
  );

-- menusãƒ†ãƒ¼ãƒ–ãƒ«ã«category_idã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.menus ADD COLUMN category_id UUID REFERENCES public.menu_categories(category_id);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ
CREATE INDEX IF NOT EXISTS idx_menus_category_id ON public.menus(category_id);
</file>

<file path="supabase/migrations/20250601000001_migrate_menu_categories.sql">
-- æ—¢å­˜ã®ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ã‚’æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»è¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

-- ä¸€æ™‚çš„ã«å„åº—èˆ—ã”ã¨ã®ä¸€æ„ãªã‚«ãƒ†ã‚´ãƒªåã‚’æŠ½å‡ºã—ã¦æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥
INSERT INTO public.menu_categories (store_id, name, display_order)
SELECT DISTINCT m.store_id, 
                COALESCE(m.category, 'æœªåˆ†é¡') AS name, 
                ROW_NUMBER() OVER (PARTITION BY m.store_id ORDER BY MIN(m.created_at)) AS display_order
FROM public.menus m
GROUP BY m.store_id, COALESCE(m.category, 'æœªåˆ†é¡');

-- æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®category_idã‚’æ›´æ–°
UPDATE public.menus m
SET category_id = mc.category_id
FROM public.menu_categories mc
WHERE m.store_id = mc.store_id 
AND COALESCE(m.category, 'æœªåˆ†é¡') = mc.name;
</file>

<file path="supabase/migrations/20250602000000_remove_staff_drink.sql">
-- ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯æ©Ÿèƒ½ã®å‰Šé™¤

-- ä¾å­˜é–¢ä¿‚ã®ã‚ã‚‹ãƒ“ãƒ¥ãƒ¼ã‚’å…ˆã«å‰Šé™¤
DROP VIEW IF EXISTS public.v_staff_drinks;

-- menusãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰is_staff_drinkã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
ALTER TABLE public.menus DROP COLUMN IF EXISTS is_staff_drink;

-- order_itemsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰target_cast_idã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
ALTER TABLE public.order_items DROP COLUMN IF EXISTS target_cast_id;
</file>

<file path="supabase/migrations/20250603000000_add_smaregi_category_id.sql">
-- menu_categoriesãƒ†ãƒ¼ãƒ–ãƒ«ã«smaregi_category_idã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.menu_categories ADD COLUMN IF NOT EXISTS smaregi_category_id TEXT;

-- smaregi_category_idã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
CREATE INDEX IF NOT EXISTS idx_menu_categories_smaregi_category_id ON public.menu_categories(smaregi_category_id);

-- store_idã¨smaregi_category_idã®çµ„ã¿åˆã‚ã›ã«ä¸€æ„åˆ¶ç´„ã‚’è¿½åŠ 
ALTER TABLE public.menu_categories ADD CONSTRAINT unique_store_smaregi_category_id UNIQUE (store_id, smaregi_category_id) DEFERRABLE INITIALLY DEFERRED;
</file>

<file path="supabase/migrations/20250604000000_add_category_treat_cast_flag.sql">
-- menu_categoriesãƒ†ãƒ¼ãƒ–ãƒ«ã«allow_treat_castã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.menu_categories ADD COLUMN IF NOT EXISTS allow_treat_cast BOOLEAN NOT NULL DEFAULT false;

-- order_itemsãƒ†ãƒ¼ãƒ–ãƒ«ã«target_cast_idã‚«ãƒ©ãƒ ã‚’å†è¿½åŠ ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯æ©Ÿèƒ½å‰Šé™¤ã§å‰Šé™¤ã•ã‚Œã¦ã„ãŸå ´åˆï¼‰
ALTER TABLE public.order_items ADD COLUMN IF NOT EXISTS target_cast_id UUID REFERENCES auth.users(id);
</file>

<file path="supabase/migrations/20250610000000_add_menu_images_bucket.sql">
-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒç”¨ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ
INSERT INTO storage.buckets (id, name, public, avif_autodetection, file_size_limit, allowed_mime_types)
VALUES ('menu-images', 'menu-images', true, false, 5242880, '{image/jpeg,image/png,image/webp,image/gif}')
ON CONFLICT (id) DO NOTHING;

-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒãƒã‚±ãƒƒãƒˆã®RLSãƒãƒªã‚·ãƒ¼ã‚’è¨­å®š
-- èª°ã§ã‚‚é–²è¦§å¯èƒ½
CREATE POLICY "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½" ON storage.objects
  FOR SELECT
  USING (bucket_id = 'menu-images');

-- ç®¡ç†è€…ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½
CREATE POLICY "ç®¡ç†è€…ã®ã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½" ON storage.objects
  FOR INSERT
  WITH CHECK (
    bucket_id = 'menu-images' AND
    EXISTS (
      SELECT 1 FROM public.store_users
      WHERE user_id = auth.uid()
      AND role = 'admin'
    )
  );

-- ç®¡ç†è€…ã®ã¿æ›´æ–°å¯èƒ½
CREATE POLICY "ç®¡ç†è€…ã®ã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚’æ›´æ–°å¯èƒ½" ON storage.objects
  FOR UPDATE
  USING (
    bucket_id = 'menu-images' AND
    EXISTS (
      SELECT 1 FROM public.store_users
      WHERE user_id = auth.uid()
      AND role = 'admin'
    )
  );

-- ç®¡ç†è€…ã®ã¿å‰Šé™¤å¯èƒ½
CREATE POLICY "ç®¡ç†è€…ã®ã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚’å‰Šé™¤å¯èƒ½" ON storage.objects
  FOR DELETE
  USING (
    bucket_id = 'menu-images' AND
    EXISTS (
      SELECT 1 FROM public.store_users
      WHERE user_id = auth.uid()
      AND role = 'admin'
    )
  );
</file>

<file path="supabase/migrations/20250701000000_add_status_to_order_items.sql">
-- order_itemsãƒ†ãƒ¼ãƒ–ãƒ«ã«statusã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE public.order_items
ADD COLUMN status TEXT CHECK (status IN ('new', 'ack', 'prep', 'served', 'closed', 'cancel'));

-- æ—¢å­˜ã®æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¦ªæ³¨æ–‡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åˆã‚ã›ã‚‹
UPDATE public.order_items oi
SET status = o.status
FROM public.orders o
WHERE oi.order_id = o.order_id;

-- statusã‚«ãƒ©ãƒ ã‚’NOT NULLã«è¨­å®š
ALTER TABLE public.order_items
ALTER COLUMN status SET NOT NULL;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
CREATE INDEX IF NOT EXISTS idx_order_items_status ON public.order_items(status);
</file>

<file path="supabase/migrations/20250702000000_update_seat_types_code_to_uuid.sql">
-- UUIDæ‹¡å¼µæ©Ÿèƒ½ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚çš„ã«ä¿å­˜ã™ã‚‹ãŸã‚ã®ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
CREATE TEMP TABLE temp_seat_types AS
SELECT * FROM public.seat_types;

-- æ—¢å­˜ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’å‰Šé™¤
ALTER TABLE public.seat_types
DROP CONSTRAINT IF EXISTS seat_types_store_id_code_key;

-- codeã‚«ãƒ©ãƒ ã®å‹ã‚’UUIDã«å¤‰æ›´ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
-- ã¾ãšæ—¢å­˜ã®codeã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
ALTER TABLE public.seat_types
DROP COLUMN code;

-- æ¬¡ã«UUIDå‹ã®codeã‚«ãƒ©ãƒ ã‚’è¿½åŠ ï¼ˆsessionsãƒ†ãƒ¼ãƒ–ãƒ«ã¨åŒæ§˜ã«gen_random_uuid()ã‚’ä½¿ç”¨ï¼‰
ALTER TABLE public.seat_types
ADD COLUMN code UUID DEFAULT gen_random_uuid() NOT NULL;

-- æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¯ãã®ã¾ã¾ä¿æŒã§ããªã„ãŸã‚ã€æ–°ã—ã„UUIDã‚’ç”Ÿæˆï¼‰
UPDATE public.seat_types st
SET code = gen_random_uuid()
FROM temp_seat_types tt
WHERE st.seat_type_id = tt.seat_type_id;

-- åº—èˆ—IDã¨ã‚³ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’å†è¨­å®š
ALTER TABLE public.seat_types
ADD CONSTRAINT seat_types_store_id_code_key UNIQUE (store_id, code);

-- ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
DROP TABLE temp_seat_types;

-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‹å®šç¾©ã®æ›´æ–°ã«é–¢ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON COLUMN public.seat_types.code IS 'ã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨ã§ä½¿ç”¨ã™ã‚‹ä¸€æ„ã®ã‚³ãƒ¼ãƒ‰ï¼ˆUUIDè‡ªå‹•ç”Ÿæˆï¼‰';
</file>

<file path="supabase/migrations/20250703000003_recreate_seat_types_table.sql">
-- å¸­ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
-- ä¾å­˜é–¢ä¿‚ã®å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆã™ã‚‹æ–¹æ³•

-- æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
CREATE TEMP TABLE temp_seat_types AS
SELECT
  seat_type_id AS old_seat_type_id,
  code AS new_seat_type_id,
  store_id,
  display_name,
  price_per_30min,
  created_at
FROM public.seat_types;

-- ä¾å­˜ã™ã‚‹ãƒ“ãƒ¥ãƒ¼ã‚’ç‰¹å®šã—ã¦å‰Šé™¤
DO $$
DECLARE
  view_record RECORD;
BEGIN
  -- ä¾å­˜ã™ã‚‹ãƒ“ãƒ¥ãƒ¼ã‚’æ¤œç´¢ã—ã¦å‰Šé™¤
  FOR view_record IN
    SELECT viewname, schemaname
    FROM pg_views
    WHERE schemaname = 'public'
  LOOP
    EXECUTE 'DROP VIEW IF EXISTS ' || view_record.schemaname || '.' || view_record.viewname || ' CASCADE';
    RAISE NOTICE 'Dropped view: %.%', view_record.schemaname, view_record.viewname;
  END LOOP;
END $$;

-- ä¾å­˜ã™ã‚‹ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚’ç‰¹å®šã—ã¦å‰Šé™¤
DO $$
DECLARE
  mview_record RECORD;
BEGIN
  -- ä¾å­˜ã™ã‚‹ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚’æ¤œç´¢ã—ã¦å‰Šé™¤
  FOR mview_record IN
    SELECT matviewname, schemaname
    FROM pg_matviews
    WHERE schemaname = 'public'
  LOOP
    EXECUTE 'DROP MATERIALIZED VIEW IF EXISTS ' || mview_record.schemaname || '.' || mview_record.matviewname || ' CASCADE';
    RAISE NOTICE 'Dropped materialized view: %.%', mview_record.schemaname, mview_record.matviewname;
  END LOOP;
END $$;

-- é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤
ALTER TABLE public.tables DROP CONSTRAINT IF EXISTS tables_seat_type_id_fkey;
ALTER TABLE public.session_seat_events DROP CONSTRAINT IF EXISTS session_seat_events_seat_type_id_fkey;

-- æ—¢å­˜ã®RLSãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤
DROP POLICY IF EXISTS seat_type_store_admin_all ON public.seat_types;
DROP POLICY IF EXISTS seat_type_store_cast_select ON public.seat_types;

-- æ–°ã—ã„å¸­ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆï¼ˆä¸€æ™‚çš„ãªåå‰ï¼‰
CREATE TABLE public.seat_types_new (
  seat_type_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  store_id UUID REFERENCES public.stores(store_id) ON DELETE CASCADE NOT NULL,
  display_name TEXT NOT NULL,
  price_per_30min INTEGER NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- åº—èˆ—IDã¨å¸­ç¨®IDã®çµ„ã¿åˆã‚ã›ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’è¨­å®š
ALTER TABLE public.seat_types_new
ADD CONSTRAINT seat_types_new_store_id_seat_type_id_key UNIQUE (store_id, seat_type_id);

-- æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»è¡Œ
INSERT INTO public.seat_types_new (seat_type_id, store_id, display_name, price_per_30min, created_at)
SELECT
  new_seat_type_id AS seat_type_id,
  store_id,
  display_name,
  price_per_30min,
  created_at
FROM temp_seat_types;

-- æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
CREATE TEMP TABLE temp_tables AS
SELECT * FROM public.tables;

CREATE TEMP TABLE temp_session_seat_events AS
SELECT * FROM public.session_seat_events;

-- é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤ï¼ˆä¾å­˜é–¢ä¿‚ã‚’è§£æ¶ˆï¼‰
DROP TABLE IF EXISTS public.tables CASCADE;
DROP TABLE IF EXISTS public.session_seat_events CASCADE;

-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆï¼ˆseat_type_idã‚’UUIDå‹ã«å¤‰æ›´ï¼‰
CREATE TABLE public.tables (
  table_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  store_id UUID REFERENCES public.stores(store_id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  seat_type_id UUID NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆï¼ˆseat_type_idã‚’UUIDå‹ã«å¤‰æ›´ï¼‰
CREATE TABLE public.session_seat_events (
  event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES public.sessions(session_id) ON DELETE CASCADE NOT NULL,
  seat_type_id UUID NULL,
  price_snapshot INTEGER NOT NULL,
  changed_at TIMESTAMPTZ DEFAULT now(),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- å¤ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã€æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒªãƒãƒ¼ãƒ 
DROP TABLE public.seat_types CASCADE;
ALTER TABLE public.seat_types_new RENAME TO seat_types;

-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
INSERT INTO public.tables (table_id, store_id, name, seat_type_id, created_at)
SELECT
  tt.table_id,
  tt.store_id,
  tt.name,
  ts.new_seat_type_id,
  tt.created_at
FROM temp_tables tt
LEFT JOIN temp_seat_types ts ON tt.seat_type_id::text = ts.old_seat_type_id::text;

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
INSERT INTO public.session_seat_events (event_id, session_id, seat_type_id, price_snapshot, changed_at, created_at)
SELECT
  tsse.event_id,
  tsse.session_id,
  ts.new_seat_type_id,
  tsse.price_snapshot,
  tsse.changed_at,
  tsse.created_at
FROM temp_session_seat_events tsse
LEFT JOIN temp_seat_types ts ON tsse.seat_type_id::text = ts.old_seat_type_id::text;

-- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å†ä½œæˆ
ALTER TABLE public.tables
ADD CONSTRAINT tables_seat_type_id_fkey
FOREIGN KEY (seat_type_id) REFERENCES public.seat_types(seat_type_id);

ALTER TABLE public.session_seat_events
ADD CONSTRAINT session_seat_events_seat_type_id_fkey
FOREIGN KEY (seat_type_id) REFERENCES public.seat_types(seat_type_id);

-- RLSãƒãƒªã‚·ãƒ¼ã®å†ä½œæˆ
ALTER TABLE public.seat_types ENABLE ROW LEVEL SECURITY;

-- åº—èˆ—ç®¡ç†è€…ã®ã¿ãŒå¸­ç¨®ã‚’ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ãã‚‹ãƒãƒªã‚·ãƒ¼
CREATE POLICY seat_type_store_admin_all ON public.seat_types
  USING (store_id IN (
    SELECT store_id FROM public.store_users
    WHERE user_id = auth.uid() AND role = 'admin'
  ));

-- åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã¯å¸­ç¨®ã‚’é–²è¦§ã®ã¿å¯èƒ½
CREATE POLICY seat_type_store_cast_select ON public.seat_types
  FOR SELECT
  USING (store_id IN (
    SELECT store_id FROM public.store_users
    WHERE user_id = auth.uid()
  ));

-- ä¸€æ™‚ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
DROP TABLE temp_seat_types;

-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‹å®šç¾©ã®æ›´æ–°ã«é–¢ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON COLUMN public.seat_types.seat_type_id IS 'ã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨ã§ä½¿ç”¨ã™ã‚‹ä¸€æ„ã®IDï¼ˆUUIDè‡ªå‹•ç”Ÿæˆï¼‰';
</file>

<file path="supabase/migrations/20250703000004_fix_sessions_foreign_key.sql">
-- sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å†ä½œæˆã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

-- sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã®table_idã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å†ä½œæˆ
ALTER TABLE public.sessions
DROP CONSTRAINT IF EXISTS sessions_table_id_fkey;

ALTER TABLE public.sessions
ADD CONSTRAINT sessions_table_id_fkey
FOREIGN KEY (table_id) REFERENCES public.tables(table_id) ON DELETE CASCADE;

-- é–¢é€£ã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°ã‚’æ›´æ–°
CREATE OR REPLACE FUNCTION public.fn_create_session_seat_snapshot()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚ã«å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
  IF NEW.charge_started_at IS NOT NULL AND (OLD.charge_started_at IS NULL OR OLD.charge_started_at <> NEW.charge_started_at) THEN
    INSERT INTO public.session_seat_events (
      session_id,
      seat_type_id,
      price_snapshot,
      changed_at
    )
    SELECT
      NEW.session_id,
      t.seat_type_id,
      st.price_per_30min,
      NEW.charge_started_at
    FROM
      public.tables t
      JOIN public.seat_types st ON t.seat_type_id = st.seat_type_id
    WHERE
      t.table_id = NEW.table_id;
  END IF;
  
  RETURN NEW;
END;
$$;

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®å¤‰æ›´æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°
CREATE OR REPLACE FUNCTION public.fn_create_table_seat_change_snapshot()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- å¸­ç¨®ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
  IF NEW.seat_type_id <> OLD.seat_type_id THEN
    -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
    INSERT INTO public.session_seat_events (
      session_id,
      seat_type_id,
      price_snapshot,
      changed_at
    )
    SELECT
      s.session_id,
      NEW.seat_type_id,
      st.price_per_30min,
      NOW()
    FROM
      public.sessions s
      JOIN public.seat_types st ON st.seat_type_id = NEW.seat_type_id
    WHERE
      s.table_id = NEW.table_id
      AND s.charge_started_at IS NOT NULL;
  END IF;
  
  RETURN NEW;
END;
$$;

-- ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å†ä½œæˆ
DROP TRIGGER IF EXISTS trg_table_update ON public.tables;

CREATE TRIGGER trg_table_update
AFTER UPDATE ON public.tables
FOR EACH ROW
EXECUTE FUNCTION public.fn_create_table_seat_change_snapshot();
</file>

<file path="supabase/migrations/20250704000000_add_time_unit_minutes_to_seat_types.sql">
-- Add time_unit_minutes column to seat_types table
ALTER TABLE seat_types ADD COLUMN IF NOT EXISTS time_unit_minutes INTEGER DEFAULT 30 NOT NULL;

-- Update existing records to have the default value
UPDATE seat_types SET time_unit_minutes = 30 WHERE time_unit_minutes IS NULL;
</file>

<file path="supabase/migrations/20250705000000_rename_price_per_30min_to_price_per_unit.sql">
-- Rename price_per_30min column to price_per_unit
ALTER TABLE seat_types RENAME COLUMN price_per_30min TO price_per_unit;
</file>

<file path="supabase/migrations/20250706000000_update_charge_functions.sql">
-- ãƒãƒ£ãƒ¼ã‚¸è¨ˆç®—ç”¨ã®é–¢æ•°ã‚’æ›´æ–°ï¼ˆprice_per_30minã‚’price_per_unitã«å¤‰æ›´ï¼‰
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes int;
  v_rounded_minutes int;
  v_half_hour_units int;
  v_event_charge int;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã‚’å–å¾—
  SELECT charge_started_at INTO v_charge_start_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  FOR v_event IN (
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at ASC
  ) LOOP
    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    IF v_last_event_time IS NULL THEN
      v_last_event_time := v_charge_start_time;
    END IF;
    
    -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_event.changed_at - v_last_event_time)) / 60;
    
    -- 30åˆ†å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := ceiling(v_elapsed_minutes::numeric / 30) * 30;
    
    -- 30åˆ†å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_half_hour_units := v_rounded_minutes / 30;
    
    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_half_hour_units * v_event.price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
  END LOOP;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- 30åˆ†å˜ä½ã§åˆ‡ã‚Šä¸Šã’
  v_rounded_minutes := ceiling(v_elapsed_minutes::numeric / 30) * 30;
  
  -- 30åˆ†å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_half_hour_units := v_rounded_minutes / 30;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_half_hour_units * (
    SELECT price_snapshot 
    FROM public.session_seat_events 
    WHERE session_id = p_session_id 
    ORDER BY changed_at DESC 
    LIMIT 1
  );
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°ã‚’æ›´æ–°
CREATE OR REPLACE FUNCTION public.fn_create_session_seat_snapshot()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚ã«å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
  IF NEW.charge_started_at IS NOT NULL AND (OLD.charge_started_at IS NULL OR OLD.charge_started_at <> NEW.charge_started_at) THEN
    INSERT INTO public.session_seat_events (
      session_id,
      seat_type_id,
      price_snapshot,
      changed_at
    )
    SELECT
      NEW.session_id,
      t.seat_type_id,
      st.price_per_unit,
      NEW.charge_started_at
    FROM
      public.tables t
      JOIN public.seat_types st ON t.seat_type_id = st.seat_type_id
    WHERE
      t.table_id = NEW.table_id;
  END IF;
  
  RETURN NEW;
END;
$$;

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®å¤‰æ›´æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°ã‚’æ›´æ–°
CREATE OR REPLACE FUNCTION public.fn_create_table_seat_change_snapshot()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- å¸­ç¨®ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
  IF NEW.seat_type_id <> OLD.seat_type_id THEN
    -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å¸­ç¨®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
    INSERT INTO public.session_seat_events (
      session_id,
      seat_type_id,
      price_snapshot,
      changed_at
    )
    SELECT
      s.session_id,
      NEW.seat_type_id,
      st.price_per_unit,
      NOW()
    FROM
      public.sessions s
      JOIN public.seat_types st ON st.seat_type_id = NEW.seat_type_id
    WHERE
      s.table_id = NEW.table_id
      AND s.charge_started_at IS NOT NULL;
  END IF;
  
  RETURN NEW;
END;
$$;
</file>

<file path="supabase/migrations/20250707000000_update_charge_functions_time_unit.sql">
-- ãƒãƒ£ãƒ¼ã‚¸è¨ˆç®—ç”¨ã®é–¢æ•°ã‚’æ›´æ–°ï¼ˆtime_unit_minutesã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ï¼‰
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes int;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã‚’å–å¾—
  SELECT charge_started_at INTO v_charge_start_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  FOR v_event IN (
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at ASC
  ) LOOP
    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    IF v_last_event_time IS NULL THEN
      v_last_event_time := v_charge_start_time;
    END IF;
    
    -- å¸­ç¨®IDã‚’ä¿å­˜
    v_seat_type_id := v_event.seat_type_id;
    
    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_seat_type_id;
    
    -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;
    
    -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_event.changed_at - v_last_event_time)) / 60;
    
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := ceiling(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
    
    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;
    
    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
  END LOOP;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯é–‹å§‹æ™‚é–“ã‹ã‚‰ç¾åœ¨ã¾ã§ã‚’è¨ˆç®—
  IF v_last_event_time IS NULL THEN
    v_last_event_time := v_charge_start_time;
    
    -- æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å¸­ç¨®IDã‚’å–å¾—
    SELECT seat_type_id INTO v_seat_type_id
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;
    
    -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å¸­ç¨®IDã‚’å–å¾—
    IF v_seat_type_id IS NULL THEN
      SELECT t.seat_type_id INTO v_seat_type_id
      FROM public.sessions s
      JOIN public.tables t ON s.table_id = t.table_id
      WHERE s.session_id = p_session_id;
    END IF;
  ELSE
    -- æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å¸­ç¨®IDã‚’å–å¾—
    SELECT seat_type_id INTO v_seat_type_id
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;
  END IF;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
  v_rounded_minutes := ceiling(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * (
    SELECT price_snapshot 
    FROM public.session_seat_events 
    WHERE session_id = p_session_id 
    ORDER BY changed_at DESC 
    LIMIT 1
  );
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;
</file>

<file path="supabase/migrations/20250707000001_update_table_usage_view.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«åˆ©ç”¨çŠ¶æ³ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ï¼ˆtime_unit_minutesã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ï¼‰
CREATE OR REPLACE VIEW public.v_table_usage AS
SELECT
  s.store_id,
  st.name AS store_name,
  t.table_id,
  t.name AS table_name,
  st2.display_name AS seat_type,
  st2.price_per_unit,
  st2.time_unit_minutes,
  s.session_id,
  s.start_at,
  s.charge_started_at,
  CASE
    WHEN s.charge_started_at IS NOT NULL THEN
      EXTRACT(epoch FROM (now() - s.charge_started_at)) / 60
    ELSE
      0
  END AS elapsed_minutes,
  CASE
    WHEN s.charge_started_at IS NOT NULL THEN
      CEILING(EXTRACT(epoch FROM (now() - s.charge_started_at)) / 60 / st2.time_unit_minutes) * st2.time_unit_minutes
    ELSE
      0
  END AS rounded_minutes,
  CASE
    WHEN s.charge_started_at IS NOT NULL THEN
      CEILING(EXTRACT(epoch FROM (now() - s.charge_started_at)) / 60 / st2.time_unit_minutes) * st2.price_per_unit
    ELSE
      0
  END AS current_charge
FROM
  public.sessions s
  JOIN public.tables t ON s.table_id = t.table_id
  JOIN public.stores st ON s.store_id = st.store_id
  JOIN public.seat_types st2 ON t.seat_type_id = st2.seat_type_id
WHERE
  s.charge_started_at IS NOT NULL
  AND NOT EXISTS (
    SELECT 1 FROM public.checkouts c
    WHERE c.session_id = s.session_id AND c.status = 'completed'
  );
</file>

<file path="supabase/migrations/20250708000000_update_sessions_table.sql">
-- sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
ALTER TABLE public.sessions ADD COLUMN IF NOT EXISTS selected_cast_id UUID REFERENCES auth.users(id);
ALTER TABLE public.sessions ADD COLUMN IF NOT EXISTS is_new_customer BOOLEAN;
</file>

<file path="supabase/migrations/20250801000000_add_charge_pause.sql">
-- sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã«charge_paused_atãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
ALTER TABLE public.sessions ADD COLUMN IF NOT EXISTS charge_paused_at TIMESTAMPTZ;

-- ãƒãƒ£ãƒ¼ã‚¸è¨ˆç®—ç”¨ã®é–¢æ•°ã‚’æ›´æ–°ï¼ˆcharge_paused_atã‚’è€ƒæ…®ï¼‰
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes int;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT charge_started_at, charge_paused_at INTO v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  FOR v_event IN (
    SELECT
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at ASC
  ) LOOP
    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    IF v_last_event_time IS NULL THEN
      v_last_event_time := v_charge_start_time;
    END IF;
    
    -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã€è¨ˆç®—çµ‚äº†æ™‚é–“ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«ã™ã‚‹
    IF v_charge_pause_time IS NOT NULL AND v_charge_pause_time > v_last_event_time AND v_charge_pause_time < v_event.changed_at THEN
      -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰- ä¸€æ™‚åœæ­¢æ™‚é–“ã¾ã§
      v_elapsed_minutes := EXTRACT(epoch FROM (v_charge_pause_time - v_last_event_time)) / 60;
    ELSE
      -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
      v_elapsed_minutes := EXTRACT(epoch FROM (v_event.changed_at - v_last_event_time)) / 60;
    END IF;
    
    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_event.seat_type_id;
    
    -- æ™‚é–“å˜ä½ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ30åˆ†ï¼‰ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;
    
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
    
    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;
    
    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
    
    -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã€ãã‚Œä»¥é™ã®è¨ˆç®—ã¯è¡Œã‚ãªã„
    IF v_charge_pause_time IS NOT NULL AND v_charge_pause_time <= v_event.changed_at THEN
      RETURN v_total_charge;
    END IF;
  END LOOP;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ï¼ˆã¾ãŸã¯ä¸€æ™‚åœæ­¢æ™‚é–“ï¼‰ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—
  IF v_last_event_time IS NULL THEN
    -- ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯é–‹å§‹æ™‚é–“ã‹ã‚‰è¨ˆç®—
    v_last_event_time := v_charge_start_time;
  END IF;
  
  -- æœ€å¾Œã®å¸­ç¨®IDã‚’å–å¾—
  SELECT seat_type_id INTO v_seat_type_id
  FROM public.session_seat_events
  WHERE session_id = p_session_id
  ORDER BY changed_at DESC
  LIMIT 1;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ30åˆ†ï¼‰ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã€è¨ˆç®—çµ‚äº†æ™‚é–“ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«ã™ã‚‹
  IF v_charge_pause_time IS NOT NULL THEN
    -- ä¸€æ™‚åœæ­¢æ™‚é–“ãŒæœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚ˆã‚Šå‰ã®å ´åˆã¯è¨ˆç®—ã—ãªã„
    IF v_charge_pause_time <= v_last_event_time THEN
      RETURN v_total_charge;
    END IF;
    
    -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ä¸€æ™‚åœæ­¢æ™‚é–“ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := EXTRACT(epoch FROM (v_charge_pause_time - v_last_event_time)) / 60;
  ELSE
    -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := EXTRACT(epoch FROM (v_current_time - v_last_event_time)) / 60;
  END IF;
  
  -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
  v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * (
    SELECT price_snapshot
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1
  );
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;
</file>

<file path="supabase/migrations/20250802000000_add_table_move_charge.sql">
-- session_seat_eventsãƒ†ãƒ¼ãƒ–ãƒ«ã«is_table_move_chargeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ï¼‰
DO $$
BEGIN
  -- ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿è¿½åŠ 
  IF NOT EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema = 'public'
    AND table_name = 'session_seat_events'
    AND column_name = 'is_table_move_charge'
  ) THEN
    ALTER TABLE public.session_seat_events
    ADD COLUMN is_table_move_charge boolean DEFAULT false;

    -- æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯falseã«è¨­å®š
    UPDATE public.session_seat_events
    SET is_table_move_charge = false
    WHERE is_table_move_charge IS NULL;
  END IF;
END $$;

-- fn_calc_total_chargeé–¢æ•°ã‚’æ›´æ–°ã—ã¦ã€is_table_move_chargeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è€ƒæ…®ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes int;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT charge_started_at, charge_paused_at INTO v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;

  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;

  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«è¨­å®š
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;

  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  FOR v_event IN (
    SELECT
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at ASC
  ) LOOP
    -- å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã®å ´åˆã¯ã€ãã®ã¾ã¾åˆè¨ˆã«åŠ ç®—
    IF v_event.is_table_move_charge THEN
      v_total_charge := v_total_charge + v_event.price_snapshot;
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
      v_last_event_time := v_event.changed_at;
      CONTINUE;
    END IF;

    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    IF v_last_event_time IS NULL THEN
      v_last_event_time := v_charge_start_time;
    END IF;

    -- å¸­ç¨®IDã‚’å–å¾—
    v_seat_type_id := v_event.seat_type_id;

    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_seat_type_id;

    -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;

    -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_event.changed_at - v_last_event_time)) / 60;

    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;

    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;

    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;

    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;

    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
  END LOOP;

  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®æ–™é‡‘ã‚’è¨ˆç®—ï¼ˆå¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã‹ã©ã†ã‹ã«é–¢ã‚ã‚‰ãšï¼‰
  IF v_last_event_time IS NOT NULL THEN
    -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—
    SELECT
      seat_type_id,
      price_snapshot,
      is_table_move_charge
    INTO
      v_seat_type_id,
      v_event.price_snapshot,
      v_event.is_table_move_charge
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;

    -- å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã®å ´åˆã¯ã€æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ï¼‰ã‚’å–å¾—
    IF v_event.is_table_move_charge THEN
      -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ï¼‰ã‚’å–å¾—
      SELECT
        seat_type_id,
        price_snapshot
      INTO
        v_seat_type_id,
        v_event.price_snapshot
      FROM public.session_seat_events
      WHERE
        session_id = p_session_id AND
        changed_at > v_last_event_time
      ORDER BY changed_at ASC
      LIMIT 1;
    END IF;

    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_seat_type_id;

    -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;

    -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;

    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;

    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;

    -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;

    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
  END IF;

  RETURN v_total_charge;
END;
$$;
</file>

<file path="supabase/migrations/20250803000000_fix_table_move_charge_calculation.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®æ–™é‡‘è¨ˆç®—ã‚’ä¿®æ­£ã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

-- fn_calc_total_chargeé–¢æ•°ã‚’æ›´æ–°ã—ã¦ã€å¸­ç§»å‹•å¾Œã‚‚æ™‚é–“æ¯ã«æ–™é‡‘ãŒåŠ ç®—ã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes int;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT charge_started_at, charge_paused_at INTO v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«è¨­å®š
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  FOR v_event IN (
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at ASC
  ) LOOP
    -- å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã®å ´åˆã¯ã€ãã®ã¾ã¾åˆè¨ˆã«åŠ ç®—
    IF v_event.is_table_move_charge THEN
      v_total_charge := v_total_charge + v_event.price_snapshot;
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
      v_last_event_time := v_event.changed_at;
      CONTINUE;
    END IF;
    
    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    IF v_last_event_time IS NULL THEN
      v_last_event_time := v_charge_start_time;
    END IF;
    
    -- å¸­ç¨®IDã‚’å–å¾—
    v_seat_type_id := v_event.seat_type_id;
    
    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_seat_type_id;
    
    -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;
    
    -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_event.changed_at - v_last_event_time)) / 60;
    
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
    
    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;
    
    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
  END LOOP;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®æ–™é‡‘ã‚’è¨ˆç®—ï¼ˆå¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã‹ã©ã†ã‹ã«é–¢ã‚ã‚‰ãšï¼‰
  IF v_last_event_time IS NOT NULL THEN
    -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—
    SELECT 
      seat_type_id,
      price_snapshot,
      is_table_move_charge
    INTO 
      v_seat_type_id,
      v_event.price_snapshot,
      v_event.is_table_move_charge
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;
    
    -- å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã®å ´åˆã¯ã€æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ï¼‰ã‚’å–å¾—
    IF v_event.is_table_move_charge THEN
      -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ï¼‰ã‚’å–å¾—
      SELECT 
        seat_type_id,
        price_snapshot
      INTO 
        v_seat_type_id,
        v_event.price_snapshot
      FROM public.session_seat_events
      WHERE 
        session_id = p_session_id AND 
        changed_at > v_last_event_time
      ORDER BY changed_at ASC
      LIMIT 1;
    END IF;
    
    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_seat_type_id;
    
    -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;
    
    -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
    
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
    
    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;
    
    -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
  END IF;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'å¸­ç§»å‹•å¾Œã‚‚æ™‚é–“æ¯ã«æ–™é‡‘ãŒåŠ ç®—ã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£ï¼ˆ2025/08/03ï¼‰';
</file>

<file path="supabase/migrations/20250804000000_fix_charge_calculation_for_short_time.sql">
-- çŸ­æ™‚é–“ï¼ˆ1åˆ†æœªæº€ï¼‰ã®å ´åˆã§ã‚‚ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ãŒ0å††ã«ãªã‚‰ãªã„ã‚ˆã†ã«ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT charge_started_at, charge_paused_at INTO v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«è¨­å®š
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  FOR v_event IN (
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at ASC
  ) LOOP
    -- å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã®å ´åˆã¯ã€ãã®ã¾ã¾åˆè¨ˆã«åŠ ç®—
    IF v_event.is_table_move_charge THEN
      v_total_charge := v_total_charge + v_event.price_snapshot;
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
      v_last_event_time := v_event.changed_at;
      CONTINUE;
    END IF;
    
    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    IF v_last_event_time IS NULL THEN
      v_last_event_time := v_charge_start_time;
    END IF;
    
    -- å¸­ç¨®IDã‚’å–å¾—
    v_seat_type_id := v_event.seat_type_id;
    
    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_seat_type_id;
    
    -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;
    
    -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_event.changed_at - v_last_event_time)) / 60;
    
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_rounded_minutes := v_time_unit_minutes;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
    END IF;
    
    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;
    
    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
  END LOOP;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯é–‹å§‹æ™‚é–“ã‚’ä½¿ç”¨
  IF v_last_event_time IS NULL THEN
    v_last_event_time := v_charge_start_time;
    
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¸­ç¨®IDã‚’å–å¾—
    SELECT t.seat_type_id INTO v_seat_type_id
    FROM public.sessions s
    JOIN public.tables t ON s.table_id = t.table_id
    WHERE s.session_id = p_session_id;
  END IF;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * (
    SELECT price_snapshot 
    FROM public.session_seat_events 
    WHERE session_id = p_session_id 
    ORDER BY changed_at DESC 
    LIMIT 1
  );
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'çŸ­æ™‚é–“ï¼ˆ1åˆ†æœªæº€ï¼‰ã®å ´åˆã§ã‚‚ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ãŒ0å††ã«ãªã‚‰ãªã„ã‚ˆã†ã«ä¿®æ­£ï¼ˆ2025/08/04ï¼‰';
</file>

<file path="supabase/migrations/20250805000000_fix_table_move_charge_calculation.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•æ™‚ã®æ–™é‡‘è¨ˆç®—ãŒé‡è¤‡ã—ã¦åŠ ç®—ã•ã‚Œã‚‹å•é¡Œã‚’ä¿®æ­£
-- fn_calc_total_chargeé–¢æ•°ã¯æ—¢ã«ä¿®æ­£æ¸ˆã¿ã®ãŸã‚ã€å¤‰æ›´ãªã—

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•æ™‚ã®æ–™é‡‘è¨ˆç®—ãŒé‡è¤‡ã—ã¦åŠ ç®—ã•ã‚Œã‚‹å•é¡Œã‚’ä¿®æ­£ï¼ˆ2025/08/05ï¼‰';
</file>

<file path="supabase/migrations/20250806000000_fix_double_charge_calculation.sql">
-- 0åˆ†ã®æ™‚ç‚¹ã§äºŒé‡ã«æ–™é‡‘ãŒè¨ˆç®—ã•ã‚Œã‚‹å•é¡Œã‚’ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT charge_started_at, charge_paused_at INTO v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«è¨­å®š
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  FOR v_event IN (
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at ASC
  ) LOOP
    -- å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã®å ´åˆã¯ã€ãã®ã¾ã¾åˆè¨ˆã«åŠ ç®—
    IF v_event.is_table_move_charge THEN
      v_total_charge := v_total_charge + v_event.price_snapshot;
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
      v_last_event_time := v_event.changed_at;
      CONTINUE;
    END IF;
    
    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    IF v_last_event_time IS NULL THEN
      v_last_event_time := v_charge_start_time;
    END IF;
    
    -- å¸­ç¨®IDã‚’å–å¾—
    v_seat_type_id := v_event.seat_type_id;
    
    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_seat_type_id;
    
    -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;
    
    -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_event.changed_at - v_last_event_time)) / 60;
    
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_rounded_minutes := v_time_unit_minutes;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
    END IF;
    
    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;
    
    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
  END LOOP;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯é–‹å§‹æ™‚é–“ã‚’ä½¿ç”¨
  IF v_last_event_time IS NULL THEN
    v_last_event_time := v_charge_start_time;
    
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¸­ç¨®IDã‚’å–å¾—
    SELECT t.seat_type_id INTO v_seat_type_id
    FROM public.sessions s
    JOIN public.tables t ON s.table_id = t.table_id
    WHERE s.session_id = p_session_id;
    
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¾¡æ ¼ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
    SELECT price_snapshot INTO v_price_snapshot
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;
  ELSE
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¾¡æ ¼ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
    SELECT price_snapshot INTO v_price_snapshot
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;
  END IF;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- é‡è¦ãªä¿®æ­£: é–‹å§‹ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã¯ã€æœ€ä½æ–™é‡‘ã‚’1å›ã ã‘é©ç”¨ã™ã‚‹
  -- é–‹å§‹æ™‚é–“ã¨æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ãŒåŒã˜ï¼ˆã¤ã¾ã‚Šã€ã¾ã ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¦ã„ãªã„ï¼‰å ´åˆ
  IF v_charge_start_time = v_last_event_time THEN
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_rounded_minutes := v_time_unit_minutes;
      v_time_units := 1;
      v_event_charge := v_time_units * v_price_snapshot;
      RETURN v_event_charge; -- æœ€ä½æ–™é‡‘ã®ã¿ã‚’è¿”ã™ï¼ˆä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã¾ã ãªã„ï¼‰
    END IF;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆé–‹å§‹ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS '0åˆ†ã®æ™‚ç‚¹ã§äºŒé‡ã«æ–™é‡‘ãŒè¨ˆç®—ã•ã‚Œã‚‹å•é¡Œã‚’ä¿®æ­£ï¼ˆ2025/08/06ï¼‰';
</file>

<file path="supabase/migrations/20250807000000_fix_table_move_zero_minute_charge.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•æ™‚ã®0åˆ†æ™‚ç‚¹ã§ã®æ–™é‡‘è¨ˆç®—å•é¡Œã‚’ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT charge_started_at, charge_paused_at INTO v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«è¨­å®š
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
  END IF;
  
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  FOR v_event IN (
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at ASC
  ) LOOP
    -- å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã®å ´åˆã¯ã€ãã®ã¾ã¾åˆè¨ˆã«åŠ ç®—
    IF v_event.is_table_move_charge THEN
      v_total_charge := v_total_charge + v_event.price_snapshot;
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
      v_last_event_time := v_event.changed_at;
      CONTINUE;
    END IF;
    
    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    IF v_last_event_time IS NULL THEN
      v_last_event_time := v_charge_start_time;
    END IF;
    
    -- å¸­ç¨®IDã‚’å–å¾—
    v_seat_type_id := v_event.seat_type_id;
    
    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_seat_type_id;
    
    -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;
    
    -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_event.changed_at - v_last_event_time)) / 60;
    
    -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ã€æ–™é‡‘ã‚’è¨ˆç®—ã—ãªã„
    -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®ç›´å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã€çµŒéæ™‚é–“ãŒ1åˆ†æœªæº€ã®å ´åˆ
    IF v_has_move_charge AND v_last_event_time = v_last_move_charge_time AND v_elapsed_minutes < 1 THEN
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®šã—ã€æ–™é‡‘ã¯åŠ ç®—ã—ãªã„
      v_last_event_time := v_event.changed_at;
      CONTINUE;
    END IF;
    
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_rounded_minutes := v_time_unit_minutes;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
    END IF;
    
    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;
    
    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
  END LOOP;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯é–‹å§‹æ™‚é–“ã‚’ä½¿ç”¨
  IF v_last_event_time IS NULL THEN
    v_last_event_time := v_charge_start_time;
    
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¸­ç¨®IDã‚’å–å¾—
    SELECT t.seat_type_id INTO v_seat_type_id
    FROM public.sessions s
    JOIN public.tables t ON s.table_id = t.table_id
    WHERE s.session_id = p_session_id;
    
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¾¡æ ¼ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
    SELECT price_snapshot INTO v_price_snapshot
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;
  ELSE
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¾¡æ ¼ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
    SELECT price_snapshot INTO v_price_snapshot
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;
  END IF;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã¯ã€æ–™é‡‘ã‚’è¨ˆç®—ã—ãªã„
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã§ã€çµŒéæ™‚é–“ãŒ1åˆ†æœªæº€ã®å ´åˆ
  IF v_has_move_charge AND v_last_event_time = v_last_move_charge_time AND v_elapsed_minutes < 1 THEN
    RETURN v_total_charge; -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’è¿”ã™
  END IF;
  
  -- é‡è¦ãªä¿®æ­£: é–‹å§‹ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã¯ã€æœ€ä½æ–™é‡‘ã‚’1å›ã ã‘é©ç”¨ã™ã‚‹
  -- é–‹å§‹æ™‚é–“ã¨æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ãŒåŒã˜ï¼ˆã¤ã¾ã‚Šã€ã¾ã ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¦ã„ãªã„ï¼‰å ´åˆ
  IF v_charge_start_time = v_last_event_time THEN
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_rounded_minutes := v_time_unit_minutes;
      v_time_units := 1;
      v_event_charge := v_time_units * v_price_snapshot;
      RETURN v_event_charge; -- æœ€ä½æ–™é‡‘ã®ã¿ã‚’è¿”ã™ï¼ˆä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã¾ã ãªã„ï¼‰
    END IF;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆé–‹å§‹ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•æ™‚ã®0åˆ†æ™‚ç‚¹ã§ã®æ–™é‡‘è¨ˆç®—å•é¡Œã‚’ä¿®æ­£ï¼ˆ2025/08/07ï¼‰';
</file>

<file path="supabase/migrations/20250808000000_fix_table_move_immediate_charge.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†æ™‚ç‚¹ï¼‰ã®æ–™é‡‘è¨ˆç®—å•é¡Œã‚’ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
  v_next_event_after_move record;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT charge_started_at, charge_paused_at INTO v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«è¨­å®š
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
    
    -- å¸­ç§»å‹•å¾Œã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ï¼‰ã‚’å–å¾—
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    INTO v_next_event_after_move
    FROM public.session_seat_events
    WHERE 
      session_id = p_session_id AND 
      changed_at > v_last_move_charge_time
    ORDER BY changed_at ASC
    LIMIT 1;
  END IF;
  
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³å¸­ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«å–å¾—
  FOR v_event IN (
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at ASC
  ) LOOP
    -- å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘è¨˜éŒ²ã®å ´åˆã¯ã€ãã®ã¾ã¾åˆè¨ˆã«åŠ ç®—
    IF v_event.is_table_move_charge THEN
      v_total_charge := v_total_charge + v_event.price_snapshot;
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
      v_last_event_time := v_event.changed_at;
      CONTINUE;
    END IF;
    
    -- æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
    IF v_last_event_time IS NULL THEN
      v_last_event_time := v_charge_start_time;
    END IF;
    
    -- å¸­ç¨®IDã‚’å–å¾—
    v_seat_type_id := v_event.seat_type_id;
    
    -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
    SELECT time_unit_minutes INTO v_time_unit_minutes
    FROM public.seat_types
    WHERE seat_type_id = v_seat_type_id;
    
    -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
    IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
      v_time_unit_minutes := 30;
    END IF;
    
    -- ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_event.changed_at - v_last_event_time)) / 60;
    
    -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ã€æ–™é‡‘ã‚’è¨ˆç®—ã—ãªã„
    -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®ç›´å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã€çµŒéæ™‚é–“ãŒ1åˆ†æœªæº€ã®å ´åˆ
    IF v_has_move_charge AND v_last_event_time = v_last_move_charge_time AND v_elapsed_minutes < 1 THEN
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®šã—ã€æ–™é‡‘ã¯åŠ ç®—ã—ãªã„
      v_last_event_time := v_event.changed_at;
      CONTINUE;
    END IF;
    
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_rounded_minutes := v_time_unit_minutes;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
    END IF;
    
    -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
    v_time_units := v_rounded_minutes / v_time_unit_minutes;
    
    -- åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_event.price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ã¨ã—ã¦ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã‚’è¨­å®š
    v_last_event_time := v_event.changed_at;
  END LOOP;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯é–‹å§‹æ™‚é–“ã‚’ä½¿ç”¨
  IF v_last_event_time IS NULL THEN
    v_last_event_time := v_charge_start_time;
    
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¸­ç¨®IDã‚’å–å¾—
    SELECT t.seat_type_id INTO v_seat_type_id
    FROM public.sessions s
    JOIN public.tables t ON s.table_id = t.table_id
    WHERE s.session_id = p_session_id;
    
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¾¡æ ¼ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
    SELECT price_snapshot INTO v_price_snapshot
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;
  ELSE
    -- æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¾¡æ ¼ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
    SELECT price_snapshot INTO v_price_snapshot
    FROM public.session_seat_events
    WHERE session_id = p_session_id
    ORDER BY changed_at DESC
    LIMIT 1;
  END IF;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã¯ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–™é‡‘ã‚’è¨ˆç®—ã—ãªã„
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå¸­ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã€çµŒéæ™‚é–“ãŒ1åˆ†æœªæº€ã®å ´åˆ
  IF v_has_move_charge AND v_next_event_after_move IS NOT NULL AND 
     v_last_event_time = v_next_event_after_move.changed_at AND v_elapsed_minutes < 1 THEN
    RETURN v_total_charge; -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’è¿”ã™ï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–™é‡‘ã¯åŠ ç®—ã—ãªã„ï¼‰
  END IF;
  
  -- é‡è¦ãªä¿®æ­£: é–‹å§‹ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã¯ã€æœ€ä½æ–™é‡‘ã‚’1å›ã ã‘é©ç”¨ã™ã‚‹
  -- é–‹å§‹æ™‚é–“ã¨æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ãŒåŒã˜ï¼ˆã¤ã¾ã‚Šã€ã¾ã ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¦ã„ãªã„ï¼‰å ´åˆ
  IF v_charge_start_time = v_last_event_time THEN
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_rounded_minutes := v_time_unit_minutes;
      v_time_units := 1;
      v_event_charge := v_time_units * v_price_snapshot;
      RETURN v_event_charge; -- æœ€ä½æ–™é‡‘ã®ã¿ã‚’è¿”ã™ï¼ˆä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã¾ã ãªã„ï¼‰
    END IF;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆé–‹å§‹ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†æ™‚ç‚¹ï¼‰ã®æ–™é‡‘è¨ˆç®—å•é¡Œã‚’ä¿®æ­£ï¼ˆ2025/08/08ï¼‰';
</file>

<file path="supabase/migrations/20250809000000_fix_table_move_charge_calculation_final.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•æ™‚ã®æ–™é‡‘è¨ˆç®—å•é¡Œã‚’æœ€çµ‚çš„ã«ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
  v_next_event_after_move record;
  v_move_charge_count int := 0;
  v_session_start_time timestamptz;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT start_at, charge_started_at, charge_paused_at 
  INTO v_session_start_time, v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«è¨­å®š
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ã‚’å–å¾—
  SELECT COUNT(*) INTO v_move_charge_count
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
    
    -- å¸­ç§»å‹•å¾Œã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ï¼‰ã‚’å–å¾—
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    INTO v_next_event_after_move
    FROM public.session_seat_events
    WHERE 
      session_id = p_session_id AND 
      changed_at > v_last_move_charge_time AND
      is_table_move_charge = false
    ORDER BY changed_at ASC
    LIMIT 1;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’åˆè¨ˆã«åŠ ç®—
  SELECT COALESCE(SUM(price_snapshot), 0) INTO v_total_charge
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤ãï¼‰
  SELECT 
    seat_type_id,
    price_snapshot,
    changed_at
  INTO 
    v_seat_type_id,
    v_price_snapshot,
    v_last_event_time
  FROM public.session_seat_events
  WHERE 
    session_id = p_session_id AND 
    is_table_move_charge = false
  ORDER BY changed_at DESC
  LIMIT 1;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã¯ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–™é‡‘ã‚’è¨ˆç®—ã—ãªã„
  IF v_has_move_charge AND v_next_event_after_move IS NOT NULL AND 
     v_last_event_time = v_next_event_after_move.changed_at THEN
    -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
    
    -- 1åˆ†æœªæº€ã®å ´åˆã¯ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–™é‡‘ã‚’åŠ ç®—ã—ãªã„
    IF v_elapsed_minutes < 1 THEN
      RETURN v_total_charge; -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’è¿”ã™
    END IF;
  END IF;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•æ™‚ã®æ–™é‡‘è¨ˆç®—å•é¡Œã‚’æœ€çµ‚çš„ã«ä¿®æ­£ï¼ˆ2025/08/09ï¼‰';
</file>

<file path="supabase/migrations/20250810000000_fix_table_move_minimum_charge.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•æ™‚ã®æœ€ä½æ–™é‡‘è¨ˆç®—ã‚’ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
  v_next_event_after_move record;
  v_move_charge_count int := 0;
  v_session_start_time timestamptz;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT start_at, charge_started_at, charge_paused_at 
  INTO v_session_start_time, v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«è¨­å®š
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ã‚’å–å¾—
  SELECT COUNT(*) INTO v_move_charge_count
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
    
    -- å¸­ç§»å‹•å¾Œã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ï¼‰ã‚’å–å¾—
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    INTO v_next_event_after_move
    FROM public.session_seat_events
    WHERE 
      session_id = p_session_id AND 
      changed_at > v_last_move_charge_time AND
      is_table_move_charge = false
    ORDER BY changed_at ASC
    LIMIT 1;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’åˆè¨ˆã«åŠ ç®—
  SELECT COALESCE(SUM(price_snapshot), 0) INTO v_total_charge
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤ãï¼‰
  SELECT 
    seat_type_id,
    price_snapshot,
    changed_at
  INTO 
    v_seat_type_id,
    v_price_snapshot,
    v_last_event_time
  FROM public.session_seat_events
  WHERE 
    session_id = p_session_id AND 
    is_table_move_charge = false
  ORDER BY changed_at DESC
  LIMIT 1;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã§ã‚‚ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€ä½æ–™é‡‘ã‚’é©ç”¨
  IF v_has_move_charge AND v_next_event_after_move IS NOT NULL AND 
     v_last_event_time = v_next_event_after_move.changed_at THEN
    -- æœ€ä½æ–™é‡‘ã‚’é©ç”¨ï¼ˆ1å˜ä½åˆ†ï¼‰
    v_event_charge := v_price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    RETURN v_total_charge;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆå¸­ç§»å‹•ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•æ™‚ã®æœ€ä½æ–™é‡‘è¨ˆç®—ã‚’ä¿®æ­£ï¼ˆ2025/08/10ï¼‰';
</file>

<file path="supabase/migrations/20250811000000_fix_table_move_time_progression.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®æ™‚é–“çµŒéã«ä¼´ã†æ–™é‡‘è¨ˆç®—ã‚’ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
  v_next_event_after_move record;
  v_move_charge_count int := 0;
  v_session_start_time timestamptz;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT start_at, charge_started_at, charge_paused_at 
  INTO v_session_start_time, v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚’ä¸€æ™‚åœæ­¢æ™‚é–“ã«è¨­å®š
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ã‚’å–å¾—
  SELECT COUNT(*) INTO v_move_charge_count
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
    
    -- å¸­ç§»å‹•å¾Œã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ï¼‰ã‚’å–å¾—
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    INTO v_next_event_after_move
    FROM public.session_seat_events
    WHERE 
      session_id = p_session_id AND 
      changed_at > v_last_move_charge_time AND
      is_table_move_charge = false
    ORDER BY changed_at ASC
    LIMIT 1;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’åˆè¨ˆã«åŠ ç®—
  SELECT COALESCE(SUM(price_snapshot), 0) INTO v_total_charge
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤ãï¼‰
  SELECT 
    seat_type_id,
    price_snapshot,
    changed_at
  INTO 
    v_seat_type_id,
    v_price_snapshot,
    v_last_event_time
  FROM public.session_seat_events
  WHERE 
    session_id = p_session_id AND 
    is_table_move_charge = false
  ORDER BY changed_at DESC
  LIMIT 1;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- çµŒéæ™‚é–“ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  RAISE NOTICE 'Elapsed minutes: %, Current time: %, Last event time: %', 
    v_elapsed_minutes, v_current_time, v_last_event_time;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã§ã‚‚ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€ä½æ–™é‡‘ã‚’é©ç”¨
  IF v_has_move_charge AND v_next_event_after_move IS NOT NULL AND 
     v_last_event_time = v_next_event_after_move.changed_at THEN
    
    -- çµŒéæ™‚é–“ã«åŸºã¥ã„ã¦æ–™é‡‘ã‚’è¨ˆç®—
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æœ€ä½æ–™é‡‘ï¼ˆ1å˜ä½åˆ†ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_time_units := 1;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
      -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
      v_time_units := v_rounded_minutes / v_time_unit_minutes;
    END IF;
    
    -- ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    -- ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    RAISE NOTICE 'Table move case: time_units=%, price_snapshot=%, event_charge=%, total_charge=%', 
      v_time_units, v_price_snapshot, v_event_charge, v_total_charge;
    
    RETURN v_total_charge;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆå¸­ç§»å‹•ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- ãƒ‡ãƒãƒƒã‚°æƒ…å ±
  RAISE NOTICE 'Normal case: time_units=%, price_snapshot=%, event_charge=%, total_charge=%', 
    v_time_units, v_price_snapshot, v_event_charge, v_total_charge;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®æ™‚é–“çµŒéã«ä¼´ã†æ–™é‡‘è¨ˆç®—ã‚’ä¿®æ­£ï¼ˆ2025/08/11ï¼‰';
</file>

<file path="supabase/migrations/20250812000000_fix_next_event_after_move_null.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
  v_next_event_after_move record;
  v_move_charge_count int := 0;
  v_session_start_time timestamptz;
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT start_at, charge_started_at, charge_paused_at 
  INTO v_session_start_time, v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã¨ã—ã¦æ‰±ã†
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ã‚’å–å¾—
  SELECT COUNT(*) INTO v_move_charge_count
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
    
    -- å¸­ç§»å‹•å¾Œã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å¸­ç¨®æƒ…å ±ï¼‰ã‚’å–å¾—
    SELECT 
      event_id,
      seat_type_id,
      price_snapshot,
      changed_at,
      is_table_move_charge
    INTO v_next_event_after_move
    FROM public.session_seat_events
    WHERE 
      session_id = p_session_id AND 
      changed_at > v_last_move_charge_time AND
      is_table_move_charge = false
    ORDER BY changed_at ASC
    LIMIT 1;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’åˆè¨ˆã«åŠ ç®—
  SELECT COALESCE(SUM(price_snapshot), 0) INTO v_total_charge
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤ãï¼‰
  SELECT 
    seat_type_id,
    price_snapshot,
    changed_at
  INTO 
    v_seat_type_id,
    v_price_snapshot,
    v_last_event_time
  FROM public.session_seat_events
  WHERE 
    session_id = p_session_id AND 
    is_table_move_charge = false
  ORDER BY changed_at DESC
  LIMIT 1;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã§ã‚‚ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€ä½æ–™é‡‘ã‚’é©ç”¨
  -- v_next_event_after_moveãŒNULLã®å ´åˆã®ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
  IF v_has_move_charge AND v_next_event_after_move IS NOT NULL AND 
     v_last_event_time = v_next_event_after_move.changed_at THEN
    
    -- çµŒéæ™‚é–“ã«åŸºã¥ã„ã¦æ–™é‡‘ã‚’è¨ˆç®—
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æœ€ä½æ–™é‡‘ï¼ˆ1å˜ä½åˆ†ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_time_units := 1;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
      -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
      v_time_units := v_rounded_minutes / v_time_unit_minutes;
    END IF;
    
    -- ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    RETURN v_total_charge;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆå¸­ç§»å‹•ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ï¼ˆ2025/08/12ï¼‰';
</file>

<file path="supabase/migrations/20250813000000_fix_next_event_after_move_null_robust.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ï¼ˆã‚ˆã‚Šå …ç‰¢ãªå®Ÿè£…ï¼‰
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
  v_next_event_after_move record := NULL; -- æ˜ç¤ºçš„ã«NULLã§åˆæœŸåŒ–
  v_move_charge_count int := 0;
  v_session_start_time timestamptz;
  v_has_next_event boolean := false; -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ã®ãƒ•ãƒ©ã‚°
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT start_at, charge_started_at, charge_paused_at 
  INTO v_session_start_time, v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã¨ã—ã¦æ‰±ã†
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ã‚’å–å¾—
  SELECT COUNT(*) INTO v_move_charge_count
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- å¸­ç§»å‹•å¾Œã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹å‰ã«ã€ãã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
    
    -- å¸­ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    SELECT EXISTS (
      SELECT 1
      FROM public.session_seat_events
      WHERE 
        session_id = p_session_id AND 
        changed_at > v_last_move_charge_time AND
        is_table_move_charge = false
    ) INTO v_has_next_event;
    
    -- å¸­ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å–å¾—
    IF v_has_next_event THEN
      SELECT 
        event_id,
        seat_type_id,
        price_snapshot,
        changed_at,
        is_table_move_charge
      INTO v_next_event_after_move
      FROM public.session_seat_events
      WHERE 
        session_id = p_session_id AND 
        changed_at > v_last_move_charge_time AND
        is_table_move_charge = false
      ORDER BY changed_at ASC
      LIMIT 1;
    END IF;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’åˆè¨ˆã«åŠ ç®—
  SELECT COALESCE(SUM(price_snapshot), 0) INTO v_total_charge
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤ãï¼‰
  SELECT 
    seat_type_id,
    price_snapshot,
    changed_at
  INTO 
    v_seat_type_id,
    v_price_snapshot,
    v_last_event_time
  FROM public.session_seat_events
  WHERE 
    session_id = p_session_id AND 
    is_table_move_charge = false
  ORDER BY changed_at DESC
  LIMIT 1;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã§ã‚‚ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€ä½æ–™é‡‘ã‚’é©ç”¨
  -- v_next_event_after_moveãŒNULLã§ãªã„ã“ã¨ã‚’ç¢ºèª
  IF v_has_move_charge AND v_has_next_event AND v_next_event_after_move IS NOT NULL AND 
     v_last_event_time = v_next_event_after_move.changed_at THEN
    
    -- çµŒéæ™‚é–“ã«åŸºã¥ã„ã¦æ–™é‡‘ã‚’è¨ˆç®—
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æœ€ä½æ–™é‡‘ï¼ˆ1å˜ä½åˆ†ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_time_units := 1;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
      -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
      v_time_units := v_rounded_minutes / v_time_unit_minutes;
    END IF;
    
    -- ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    RETURN v_total_charge;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆå¸­ç§»å‹•ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ï¼ˆã‚ˆã‚Šå …ç‰¢ãªå®Ÿè£…ï¼‰ï¼ˆ2025/08/13ï¼‰';
</file>

<file path="supabase/migrations/20250814000000_fix_next_event_after_move_property_access.sql">
-- ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
CREATE OR REPLACE FUNCTION public.fn_calc_total_charge(p_session_id uuid)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_total_charge int := 0;
  v_current_time timestamptz := now();
  v_charge_start_time timestamptz;
  v_charge_pause_time timestamptz;
  v_last_event_time timestamptz;
  v_event record;
  v_elapsed_minutes numeric;
  v_rounded_minutes int;
  v_time_units int;
  v_event_charge int;
  v_time_unit_minutes int;
  v_seat_type_id uuid;
  v_price_snapshot int;
  v_last_move_charge_time timestamptz;
  v_has_move_charge boolean := false;
  v_next_event_after_move record := NULL; -- æ˜ç¤ºçš„ã«NULLã§åˆæœŸåŒ–
  v_move_charge_count int := 0;
  v_session_start_time timestamptz;
  v_has_next_event boolean := false; -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ã®ãƒ•ãƒ©ã‚°
  v_next_event_changed_at timestamptz := NULL; -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’åˆ¥å¤‰æ•°ã§ä¿æŒ
BEGIN
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚é–“ã¨ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å–å¾—
  SELECT start_at, charge_started_at, charge_paused_at 
  INTO v_session_start_time, v_charge_start_time, v_charge_pause_time
  FROM public.sessions
  WHERE session_id = p_session_id;
  
  -- ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
  IF v_charge_start_time IS NULL THEN
    RETURN 0;
  END IF;
  
  -- ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã¯ã€ä¸€æ™‚åœæ­¢æ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã¨ã—ã¦æ‰±ã†
  IF v_charge_pause_time IS NOT NULL THEN
    v_current_time := v_charge_pause_time;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ã‚’å–å¾—
  SELECT COUNT(*) INTO v_move_charge_count
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®å¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’å–å¾—ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
  SELECT MAX(changed_at) INTO v_last_move_charge_time
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- å¸­ç§»å‹•å¾Œã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹å‰ã«ã€ãã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  IF v_last_move_charge_time IS NOT NULL THEN
    v_has_move_charge := true;
    
    -- å¸­ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    SELECT EXISTS (
      SELECT 1
      FROM public.session_seat_events
      WHERE 
        session_id = p_session_id AND 
        changed_at > v_last_move_charge_time AND
        is_table_move_charge = false
    ) INTO v_has_next_event;
    
    -- å¸­ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å–å¾—
    IF v_has_next_event THEN
      SELECT 
        event_id,
        seat_type_id,
        price_snapshot,
        changed_at,
        is_table_move_charge
      INTO v_next_event_after_move
      FROM public.session_seat_events
      WHERE 
        session_id = p_session_id AND 
        changed_at > v_last_move_charge_time AND
        is_table_move_charge = false
      ORDER BY changed_at ASC
      LIMIT 1;
      
      -- æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’åˆ¥å¤‰æ•°ã«ä¿å­˜ï¼ˆNULLãƒã‚§ãƒƒã‚¯ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
      IF v_next_event_after_move IS NOT NULL THEN
        v_next_event_changed_at := v_next_event_after_move.changed_at;
      END IF;
    END IF;
  END IF;
  
  -- å¸­ç§»å‹•æ–™é‡‘ã®ã¿ã‚’åˆè¨ˆã«åŠ ç®—
  SELECT COALESCE(SUM(price_snapshot), 0) INTO v_total_charge
  FROM public.session_seat_events
  WHERE session_id = p_session_id AND is_table_move_charge = true;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤ãï¼‰
  SELECT 
    seat_type_id,
    price_snapshot,
    changed_at
  INTO 
    v_seat_type_id,
    v_price_snapshot,
    v_last_event_time
  FROM public.session_seat_events
  WHERE 
    session_id = p_session_id AND 
    is_table_move_charge = false
  ORDER BY changed_at DESC
  LIMIT 1;
  
  -- å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
  SELECT time_unit_minutes INTO v_time_unit_minutes
  FROM public.seat_types
  WHERE seat_type_id = v_seat_type_id;
  
  -- æ™‚é–“å˜ä½ãŒç„¡åŠ¹ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30åˆ†ã‚’ä½¿ç”¨
  IF v_time_unit_minutes IS NULL OR v_time_unit_minutes <= 0 THEN
    v_time_unit_minutes := 30;
  END IF;
  
  -- æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç¾åœ¨ã¾ã§ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  v_elapsed_minutes := extract(epoch FROM (v_current_time - v_last_event_time)) / 60;
  
  -- å¸­ç§»å‹•ç›´å¾Œï¼ˆ0åˆ†ï¼‰ã®å ´åˆã§ã‚‚ã€ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€ä½æ–™é‡‘ã‚’é©ç”¨
  -- v_next_event_after_moveã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å‰ã«NULLãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
  -- v_next_event_changed_atã‚’ä½¿ç”¨ã—ã¦æ¯”è¼ƒ
  IF v_has_move_charge AND v_has_next_event AND v_next_event_after_move IS NOT NULL AND 
     v_next_event_changed_at IS NOT NULL AND v_last_event_time = v_next_event_changed_at THEN
    
    -- çµŒéæ™‚é–“ã«åŸºã¥ã„ã¦æ–™é‡‘ã‚’è¨ˆç®—
    -- 1åˆ†æœªæº€ã®å ´åˆã¯æœ€ä½æ–™é‡‘ï¼ˆ1å˜ä½åˆ†ï¼‰
    IF v_elapsed_minutes < 1 THEN
      v_time_units := 1;
    ELSE
      -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
      v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
      -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
      v_time_units := v_rounded_minutes / v_time_unit_minutes;
    END IF;
    
    -- ç§»å‹•å…ˆãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ã‚’è¨ˆç®—
    v_event_charge := v_time_units * v_price_snapshot;
    
    -- åˆè¨ˆã«åŠ ç®—
    v_total_charge := v_total_charge + v_event_charge;
    
    RETURN v_total_charge;
  END IF;
  
  -- é€šå¸¸ã®è¨ˆç®—ï¼ˆå¸­ç§»å‹•ç›´å¾Œã§ãªã„å ´åˆï¼‰
  -- 1åˆ†æœªæº€ã®å ´åˆã¯æ™‚é–“å˜ä½ã¨ã—ã¦æ‰±ã†ï¼ˆæœ€ä½æ–™é‡‘ï¼‰
  IF v_elapsed_minutes < 1 THEN
    v_rounded_minutes := v_time_unit_minutes;
  ELSE
    -- æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    v_rounded_minutes := CEILING(v_elapsed_minutes::numeric / v_time_unit_minutes) * v_time_unit_minutes;
  END IF;
  
  -- æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
  v_time_units := v_rounded_minutes / v_time_unit_minutes;
  
  -- æœ€å¾Œã®åŒºé–“ã®ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ã‚’è¨ˆç®—
  v_event_charge := v_time_units * v_price_snapshot;
  
  -- åˆè¨ˆã«åŠ ç®—
  v_total_charge := v_total_charge + v_event_charge;
  
  RETURN v_total_charge;
END;
$$;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON FUNCTION public.fn_calc_total_charge(uuid) IS 'ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ï¼ˆ2025/08/14ï¼‰';
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './app/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      animation: {
        'fade-in-out': 'fadeInOut 1s ease-in-out',
      },
      keyframes: {
        fadeInOut: {
          '0%': { opacity: 0 },
          '10%': { opacity: 1 },
          '90%': { opacity: 1 },
          '100%': { opacity: 0 },
        },
      },
    },
  },
  plugins: [],
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

<file path="tsconfig.scripts.json">
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "module": "CommonJS",
    "moduleResolution": "node",
    "esModuleInterop": true
  },
  "ts-node": {
    "transpileOnly": true
  }
}
</file>

<file path="vitest.config.ts">
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import { resolve } from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'node',
    globals: true,
    include: ['**/__tests__/**/*.test.ts', '**/__tests__/**/*.test.tsx'],
  },
  resolve: {
    alias: {
      '@': resolve(__dirname, './'),
    },
  },
});
</file>

<file path="app/api/menu-categories/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient, createServerComponentClient } from '@/lib/supabase';
import { getUserRoleInStore } from '@/lib/auth';

// ã‚«ãƒ†ã‚´ãƒªä¸€è¦§å–å¾—API
export async function GET(request: NextRequest) {
  try {
    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—
    const { data: categories, error } = await supabase
      .from('menu_categories')
      .select('*')
      .eq('store_id', storeId)
      .order('display_order', { ascending: true })
      .order('name', { ascending: true });

    if (error) {
      console.error('ã‚«ãƒ†ã‚´ãƒªä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(categories);
  } catch (error) {
    console.error('ã‚«ãƒ†ã‚´ãƒªä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

// ã‚«ãƒ†ã‚´ãƒªä½œæˆAPI
export async function POST(request: NextRequest) {
  try {
    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // èªè¨¼ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
    const authClient = await createServerComponentClient();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user } } = await authClient.auth.getUser();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    if (!user) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
    const userRole = await getUserRoleInStore(user.id, storeId);

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (userRole !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¹ãƒãƒ¬ã‚¸é€£æºã®ç¢ºèªï¼‰
    const { data: store, error: storeError } = await supabase
      .from('stores')
      .select('enable_smaregi_integration')
      .eq('store_id', storeId)
      .single();

    if (storeError) {
      console.error('åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', storeError);
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (store.enable_smaregi_integration) {
      return NextResponse.json(
        { error: 'ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã‚«ãƒ†ã‚´ãƒªã®è¿½åŠ ã¯ã§ãã¾ã›ã‚“ã€‚ã‚¹ãƒãƒ¬ã‚¸ã§éƒ¨é–€ã‚’ç™»éŒ²ã—ãŸå¾Œã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ç”»é¢ã§ã€Œã‚¹ãƒãƒ¬ã‚¸ã¨åŒæœŸã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚' },
        { status: 403 }
      );
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.name) {
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªåã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    // å…¨ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
    const { data: allCategories, error: categoriesError } = await supabase
      .from('menu_categories')
      .select('category_id, name, display_order')
      .eq('store_id', storeId)
      .order('display_order', { ascending: true });

    if (categoriesError) {
      console.error('ã‚«ãƒ†ã‚´ãƒªä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', categoriesError);
    }

    console.log('æ—¢å­˜ã‚«ãƒ†ã‚´ãƒª:', allCategories);

    // æ–°è¦ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºé †ã‚’è¨­å®šï¼ˆæ—¢å­˜ã‚«ãƒ†ã‚´ãƒªã®æ•° + 1ï¼‰
    const newDisplayOrder = allCategories && allCategories.length > 0 ? allCategories.length + 1 : 1;
    console.log('æ–°è¦ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºé †:', newDisplayOrder);

    // æ–°è¦ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆ
    const { data: newCategory, error: createError } = await supabase
      .from('menu_categories')
      .insert({
        store_id: storeId,
        name: data.name,
        display_order: newDisplayOrder,
        smaregi_category_id: data.smaregi_category_id || null,
        allow_treat_cast: data.allow_treat_cast || false
      })
      .select()
      .single();

    if (createError) {
      // ä¸€æ„åˆ¶ç´„é•åã®å ´åˆ
      if (createError.code === '23505') {
        return NextResponse.json(
          { error: 'åŒã˜åå‰ã®ã‚«ãƒ†ã‚´ãƒªãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™' },
          { status: 400 }
        );
      }

      console.error('ã‚«ãƒ†ã‚´ãƒªä½œæˆã‚¨ãƒ©ãƒ¼:', createError);
      return NextResponse.json(
        { error: 'ã‚«ãƒ†ã‚´ãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    console.log('ä½œæˆã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒª:', newCategory);

    // ä½œæˆå¾Œã®å…¨ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—ã—ã¦ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    const { data: updatedCategories } = await supabase
      .from('menu_categories')
      .select('category_id, name, display_order')
      .eq('store_id', storeId)
      .order('display_order', { ascending: true });

    console.log('æ›´æ–°å¾Œã®ã‚«ãƒ†ã‚´ãƒªä¸€è¦§:', updatedCategories);

    return NextResponse.json(newCategory, { status: 201 });
  } catch (error) {
    console.error('ã‚«ãƒ†ã‚´ãƒªä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/menus/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import { createServerSupabaseClient, createServerComponentClient } from '@/lib/supabase';
import { getUserRoleInStore } from '@/lib/auth';

export async function GET(request: NextRequest) {
  try {
    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // èªè¨¼ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
    const authClient = await createServerComponentClient();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user } } = await authClient.auth.getUser();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    if (!user) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
    const userRole = await getUserRoleInStore(user.id, storeId);

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (userRole !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã‚’å–å¾—
    const { data: menus, error } = await supabase
      .from('menus')
      .select('*')
      .eq('store_id', storeId)
      .order('category', { ascending: true })
      .order('name', { ascending: true });

    if (error) {
      console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(menus);
  } catch (error) {
    console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

export async function POST(request: NextRequest) {
  try {
    // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰store-idã‚’å–å¾—
    const storeIdFromQuery = request.nextUrl.searchParams.get('storeId');

    // "null"æ–‡å­—åˆ—ã®å ´åˆã¯nullã¨ã—ã¦æ‰±ã†
    const validStoreIdFromQuery = storeIdFromQuery === 'null' ? null : storeIdFromQuery;

    // Cookieã‹ã‚‰store-idã‚’å–å¾—
    const cookieStore = await cookies();
    const storeIdFromCookie = cookieStore.get('store-id')?.value;

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°Cookieã‹ã‚‰å–å¾—
    const storeId = validStoreIdFromQuery || storeIdFromCookie;

    if (!storeId) {
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // èªè¨¼ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
    const authClient = await createServerComponentClient();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const { data: { user } } = await authClient.auth.getUser();

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    if (!user) {
      return NextResponse.json(
        { error: 'èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 401 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å–å¾—
    const userRole = await getUserRoleInStore(user.id, storeId);

    // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
    if (userRole !== 'admin') {
      return NextResponse.json(
        { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // åº—èˆ—æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¹ãƒãƒ¬ã‚¸é€£æºã®ç¢ºèªï¼‰
    const { data: store, error: storeError } = await supabase
      .from('stores')
      .select('enable_smaregi_integration')
      .eq('store_id', storeId)
      .single();

    if (storeError) {
      console.error('åº—èˆ—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', storeError);
      return NextResponse.json(
        { error: 'åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (store.enable_smaregi_integration) {
      return NextResponse.json(
        { error: 'ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ ã¯ã§ãã¾ã›ã‚“ã€‚ã‚¹ãƒãƒ¬ã‚¸ã§å•†å“ã‚’ç™»éŒ²ã—ãŸå¾Œã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ç”»é¢ã§ã€Œã‚¹ãƒãƒ¬ã‚¸ã¨åŒæœŸã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚' },
        { status: 403 }
      );
    }

    const data = await request.json();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.product_id || !data.name || data.price < 0) {
      return NextResponse.json(
        { error: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€ç„¡åŠ¹ãªå€¤ã§ã™' },
        { status: 400 }
      );
    }

    // store_idã‚’ç¢ºå®Ÿã«è¨­å®š
    data.store_id = storeId;

    // åŒã˜åº—èˆ—å†…ã§åŒã˜product_idãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const { data: existingMenu } = await supabase
      .from('menus')
      .select('menu_id')
      .eq('store_id', storeId)
      .eq('product_id', data.product_id)
      .maybeSingle();

    if (existingMenu) {
      return NextResponse.json(
        { error: 'ã“ã®å•†å“IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™' },
        { status: 409 }
      );
    }

    // æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ
    const { data: newMenu, error: createError } = await supabase
      .from('menus')
      .insert({
        store_id: data.store_id,
        product_id: data.product_id,
        name: data.name,
        description: data.description || null,
        price: data.price,
        image_url: data.image_url || null,
        category: data.category || null,
        category_id: data.category_id || null,
        is_available: data.is_available !== false,
      })
      .select()
      .single();

    if (createError) {
      console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', createError);
      return NextResponse.json(
        { error: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    return NextResponse.json(newMenu, { status: 201 });
  } catch (error) {
    console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/sessions/[session_id]/calculate-charge/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createServerSupabaseClient } from '@/lib/supabase';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ session_id: string }> }
) {
  try {
    const { session_id } = await params;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = await createServerSupabaseClient();

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    const { data: session, error: sessionError } = await supabase
      .from('sessions')
      .select(`
        session_id,
        store_id,
        charge_started_at,
        charge_paused_at
      `)
      .eq('session_id', session_id)
      .single();

    if (sessionError || !session) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionError);
      return NextResponse.json(
        { error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // èª²é‡‘ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã‚’è¿”ã™
    if (!session.charge_started_at) {
      return NextResponse.json({ charge_amount: 0 });
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã‚’è¨ˆç®—ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
    // fn_calc_total_chargeé–¢æ•°ã¯æ—¢ã«is_table_move_charge=trueã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ–™é‡‘ã‚’å«ã‚ã¦è¨ˆç®—ã—ã¦ã„ã‚‹
    const { data: totalChargeData, error: chargeError } = await supabase
      .rpc('fn_calc_total_charge', { p_session_id: session_id });

    if (chargeError) {
      console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', chargeError);

      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä»£æ›¿ã®è¨ˆç®—æ–¹æ³•ã‚’ä½¿ç”¨
      // å¸­ç§»å‹•æ–™é‡‘ã‚’å–å¾—
      let moveChargeAmount = 0;
      try {
        const { data: moveCharges, error: moveChargeError } = await supabase
          .from('session_seat_events')
          .select('price_snapshot')
          .eq('session_id', session_id)
          .eq('is_table_move_charge', true);

        if (!moveChargeError && moveCharges && moveCharges.length > 0) {
          for (const charge of moveCharges) {
            moveChargeAmount += charge.price_snapshot;
          }
        }
      } catch (error) {
        console.error('å¸­ç§»å‹•æ–™é‡‘å–å¾—ä¾‹å¤–:', error);
      }

      // æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’å–å¾—ï¼ˆå¸­ç§»å‹•æ–™é‡‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é™¤ãï¼‰
      try {
        const { data: lastEvent, error: lastEventError } = await supabase
          .from('session_seat_events')
          .select('seat_type_id, price_snapshot, changed_at')
          .eq('session_id', session_id)
          .eq('is_table_move_charge', false)
          .order('changed_at', { ascending: false })
          .limit(1)
          .single();

        if (!lastEventError && lastEvent) {
          // å¸­ç¨®ã®æ™‚é–“å˜ä½ã‚’å–å¾—
          const { data: seatType, error: seatTypeError } = await supabase
            .from('seat_types')
            .select('time_unit_minutes')
            .eq('seat_type_id', lastEvent.seat_type_id)
            .single();

          const timeUnitMinutes = seatType && seatType.time_unit_minutes > 0
            ? seatType.time_unit_minutes
            : 30;

          // æœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
          const now = session.charge_paused_at
            ? new Date(session.charge_paused_at)
            : new Date();
          const lastEventTime = new Date(lastEvent.changed_at);
          const elapsedMs = now.getTime() - lastEventTime.getTime();
          const elapsedMinutes = elapsedMs / (1000 * 60);

          // æ™‚é–“å˜ä½ã§åˆ‡ã‚Šä¸Šã’
          const roundedMinutes = Math.ceil(elapsedMinutes / timeUnitMinutes) * timeUnitMinutes;

          // æ™‚é–“å˜ä½ã®æ•°ã‚’è¨ˆç®—
          const timeUnits = roundedMinutes / timeUnitMinutes;

          // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ã‚’è¨ˆç®—
          const currentTableCharge = timeUnits * lastEvent.price_snapshot;

          // åˆè¨ˆæ–™é‡‘ã‚’è¨ˆç®—
          const totalCharge = moveChargeAmount + currentTableCharge;

          // è¨ˆç®—çµæœã‚’è¿”ã™
          return NextResponse.json({
            charge_amount: totalCharge,
            table_charge: currentTableCharge > 0 ? currentTableCharge : 0,
            move_charge: moveChargeAmount,
            calculated_by: 'fallback'
          });
        }
      } catch (error) {
        console.error('ä»£æ›¿è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
      }

      // ä»£æ›¿è¨ˆç®—ã‚‚å¤±æ•—ã—ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
      return NextResponse.json(
        { error: 'ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // å¸­ç§»å‹•ã«ã‚ˆã‚‹æ–™é‡‘ã®å†…è¨³ã‚’å–å¾—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
    let moveChargeAmount = 0;
    try {
      // is_table_move_chargeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
      const { data: moveCharges, error: moveChargeError } = await supabase
        .from('session_seat_events')
        .select('price_snapshot')
        .eq('session_id', session_id)
        .eq('is_table_move_charge', true);

      if (!moveChargeError && moveCharges && moveCharges.length > 0) {
        for (const charge of moveCharges) {
          moveChargeAmount += charge.price_snapshot;
        }
      }
    } catch (error) {
      console.error('å¸­ç§»å‹•æ–™é‡‘å–å¾—ä¾‹å¤–:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
    }

    // é€šå¸¸ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘ï¼ˆç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®æ–™é‡‘ï¼‰ã‚’è¨ˆç®—
    const currentTableCharge = (totalChargeData || 0) - moveChargeAmount;

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
    console.log('æ–™é‡‘è¨ˆç®—çµæœ:', {
      totalChargeData,
      moveChargeAmount,
      currentTableCharge
    });

    return NextResponse.json({
      charge_amount: totalChargeData || 0,
      table_charge: currentTableCharge > 0 ? currentTableCharge : 0,
      move_charge: moveChargeAmount
    });
  } catch (error) {
    console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ–™é‡‘è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/portal/layout.tsx">
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';
import LayoutWrapper from './components/layout-wrapper';

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯
interface NavLink {
  href: string;
  label: string;
  roles: ('admin' | 'cast')[];
}

const navLinks: NavLink[] = [
  { href: '/portal/dashboard', label: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', roles: ['admin', 'cast'] },
  { href: '/portal/order-board', label: 'æ³¨æ–‡ãƒœãƒ¼ãƒ‰', roles: ['admin', 'cast'] },
  { href: '/portal/proxy-order', label: 'ä»£ç†æ³¨æ–‡', roles: ['admin', 'cast'] },
  { href: '/portal/tables', label: 'ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†', roles: ['admin'] },
  { href: '/portal/seat-types', label: 'å¸­ç¨®è¨­å®š', roles: ['admin'] },
  { href: '/portal/casts', label: 'ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†', roles: ['admin'] },
  { href: '/portal/menus', label: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†', roles: ['admin'] },
  { href: '/portal/menu-categories', label: 'ã‚«ãƒ†ã‚´ãƒªç®¡ç†', roles: ['admin'] },
  { href: '/portal/reports', label: 'ãƒ¬ãƒãƒ¼ãƒˆ', roles: ['admin'] },
  { href: '/portal/store-settings', label: 'åº—èˆ—è¨­å®š', roles: ['admin'] },
];

export default async function PortalLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    redirect('/');
  }

  // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();

  // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¨store-idï¼ˆä¸¡æ–¹ã®å½¢å¼ï¼‰ã‚’ç¢ºå®Ÿã«è»¢é€
  const authCookies = allCookies.filter(c => c.name.includes('-auth-token') || c.name === 'sb-refresh-token' || c.name === 'sb-access-token');
  const storeIdCookie = allCookies.find(c => c.name === 'store-id');
  const storeIdLegacyCookie = allCookies.find(c => c.name === 'storeId');

  // å¿…è¦ãªCookieã®ã¿ã‚’è»¢é€
  const essentialCookies = [];

  // èªè¨¼é–¢é€£ã®Cookieã‚’è¿½åŠ 
  authCookies.forEach(cookie => {
    essentialCookies.push(`${cookie.name}=${cookie.value}`);
  });

  // åº—èˆ—IDé–¢é€£ã®Cookieã‚’è¿½åŠ ï¼ˆä¸¡æ–¹ã®å½¢å¼ï¼‰
  if (storeIdCookie) essentialCookies.push(`${storeIdCookie.name}=${storeIdCookie.value}`);
  if (storeIdLegacyCookie) essentialCookies.push(`${storeIdLegacyCookie.name}=${storeIdLegacyCookie.value}`);

  const cookieHeader = essentialCookies.join('; ');



  const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  if (!userResponse.ok) {
    const errorText = await userResponse.text();
    console.error('Portal layout: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', {
      status: userResponse.status,
      statusText: userResponse.statusText,
      error: errorText
    });
    redirect('/');
  }



  const { user } = await userResponse.json();
  const userRole = user.role;



  // åº—èˆ—æƒ…å ±ã‚’APIã‹ã‚‰å–å¾—
  const storeResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/stores/${storeId}`, {
    cache: 'no-store'
  });

  if (!storeResponse.ok) {
    console.error('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await storeResponse.text());
    redirect('/');
  }

  const store = await storeResponse.json();

  return (
    <LayoutWrapper
      navLinks={navLinks}
      userRole={userRole}
      storeName={store?.name || 'åº—èˆ—'}
      userEmail={user.email}
    >
      {children}
    </LayoutWrapper>
  );
}
</file>

<file path="app/portal/menu-categories/category-list.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';

interface Category {
  category_id: string;
  name: string;
  display_order: number;
  smaregi_category_id?: string;
  allow_treat_cast: boolean;
}

interface CategoryListProps {
  categories: Category[];
  enableSmaregiIntegration: boolean;
}

export default function CategoryList({ categories: initialCategories, enableSmaregiIntegration }: CategoryListProps) {
  const router = useRouter();
  const [categories, setCategories] = useState<Category[]>(initialCategories);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [editingCategory, setEditingCategory] = useState<Category | null>(null);

  // ã‚«ãƒ†ã‚´ãƒªä½œæˆ
  const handleCreateCategory = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newCategoryName.trim()) return;

    setIsLoading(true);
    setError(null);
    setSuccess(null);

    try {
      const response = await fetch('/api/menu-categories', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: newCategoryName.trim(),
        }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'ã‚«ãƒ†ã‚´ãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const newCategory = await response.json();
      setCategories([...categories, newCategory]);
      setNewCategoryName('');
      setSuccess('ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆã—ã¾ã—ãŸ');
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚«ãƒ†ã‚´ãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  // ã‚«ãƒ†ã‚´ãƒªæ›´æ–°
  const handleUpdateCategory = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!editingCategory || !editingCategory.name.trim()) return;

    setIsLoading(true);
    setError(null);
    setSuccess(null);

    try {
      const response = await fetch(`/api/menu-categories/${editingCategory.category_id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: editingCategory.name.trim(),
          display_order: editingCategory.display_order,
          allow_treat_cast: editingCategory.allow_treat_cast,
        }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const updatedCategory = await response.json();
      setCategories(
        categories.map((cat) =>
          cat.category_id === updatedCategory.category_id ? updatedCategory : cat
        )
      );
      setEditingCategory(null);
      setSuccess('ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  // ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤
  const handleDeleteCategory = async (categoryId: string) => {
    if (!confirm('ã“ã®ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

    setIsLoading(true);
    setError(null);
    setSuccess(null);

    try {
      const response = await fetch(`/api/menu-categories/${categoryId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'ã‚«ãƒ†ã‚´ãƒªã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // å‰Šé™¤å¾Œã«æœ€æ–°ã®ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—
      const refreshResponse = await fetch('/api/menu-categories');
      if (refreshResponse.ok) {
        const updatedCategories = await refreshResponse.json();
        // æœ€æ–°ã®ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã§çŠ¶æ…‹ã‚’æ›´æ–°
        setCategories(updatedCategories);
      } else {
        // APIã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å‰Šé™¤ã ã‘åæ˜ 
        setCategories(categories.filter((cat) => cat.category_id !== categoryId));
      }

      setSuccess('ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚«ãƒ†ã‚´ãƒªã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  // è¡¨ç¤ºé †ã®å¤‰æ›´
  const handleMoveCategory = async (categoryId: string, direction: 'up' | 'down') => {
    const currentIndex = categories.findIndex((cat) => cat.category_id === categoryId);
    if (currentIndex === -1) return;

    const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
    if (newIndex < 0 || newIndex >= categories.length) return;

    const newCategories = [...categories];
    const currentCategory = { ...newCategories[currentIndex] };
    const targetCategory = { ...newCategories[newIndex] };

    // è¡¨ç¤ºé †ã‚’å…¥ã‚Œæ›¿ãˆ
    const tempOrder = currentCategory.display_order;
    currentCategory.display_order = targetCategory.display_order;
    targetCategory.display_order = tempOrder;

    newCategories[currentIndex] = currentCategory;
    newCategories[newIndex] = targetCategory;

    setIsLoading(true);
    setError(null);

    try {
      // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºé †ã‚’æ›´æ–°
      const response1 = await fetch(`/api/menu-categories/${currentCategory.category_id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: currentCategory.name,
          display_order: currentCategory.display_order,
          allow_treat_cast: currentCategory.allow_treat_cast,
        }),
      });

      if (!response1.ok) {
        const data = await response1.json();
        throw new Error(data.error || 'ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // å…¥ã‚Œæ›¿ãˆå…ˆã®ã‚«ãƒ†ã‚´ãƒªã®è¡¨ç¤ºé †ã‚’æ›´æ–°
      const response2 = await fetch(`/api/menu-categories/${targetCategory.category_id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: targetCategory.name,
          display_order: targetCategory.display_order,
          allow_treat_cast: targetCategory.allow_treat_cast,
        }),
      });

      if (!response2.ok) {
        const data = await response2.json();
        throw new Error(data.error || 'ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆ
      setCategories([...newCategories].sort((a, b) => a.display_order - b.display_order));
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="space-y-6">
      <div className="bg-white shadow rounded-lg p-6">
        <h2 className="text-lg font-medium text-gray-900 mb-4">ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</h2>

        {error && (
          <div className="mb-4 p-4 text-sm text-red-700 bg-red-100 rounded-lg">
            {error}
          </div>
        )}

        {success && (
          <div className="mb-4 p-4 text-sm text-green-700 bg-green-100 rounded-lg">
            {success}
          </div>
        )}

        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  è¡¨ç¤ºé †
                </th>
                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ã‚«ãƒ†ã‚´ãƒªå
                </th>
                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ã‚¹ãƒãƒ¬ã‚¸ID
                </th>
                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ã‚­ãƒ£ã‚¹ãƒˆã«å¥¢ã‚Œã‚‹
                </th>
                <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {categories.length === 0 ? (
                <tr>
                  <td colSpan={5} className="px-6 py-4 text-center text-sm text-gray-500">
                    ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“
                  </td>
                </tr>
              ) : (
                categories.map((category, index) => (
                  <tr key={category.category_id}>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      <div className="flex items-center space-x-2">
                        <span>{category.display_order}</span>
                        <div className="flex flex-col">
                          <button
                            onClick={() => handleMoveCategory(category.category_id, 'up')}
                            disabled={index === 0 || isLoading}
                            className="text-gray-400 hover:text-gray-600 disabled:opacity-50"
                          >
                            â–²
                          </button>
                          <button
                            onClick={() => handleMoveCategory(category.category_id, 'down')}
                            disabled={index === categories.length - 1 || isLoading}
                            className="text-gray-400 hover:text-gray-600 disabled:opacity-50"
                          >
                            â–¼
                          </button>
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {editingCategory?.category_id === category.category_id ? (
                        <input
                          type="text"
                          value={editingCategory.name}
                          onChange={(e) =>
                            setEditingCategory({ ...editingCategory, name: e.target.value })
                          }
                          className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                        />
                      ) : (
                        category.name
                      )}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {category.smaregi_category_id || '-'}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {editingCategory?.category_id === category.category_id ? (
                        <input
                          type="checkbox"
                          checked={editingCategory.allow_treat_cast}
                          onChange={(e) =>
                            setEditingCategory({ ...editingCategory, allow_treat_cast: e.target.checked })
                          }
                          className="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                        />
                      ) : (
                        <span className={category.allow_treat_cast ? "text-green-600" : "text-red-600"}>
                          {category.allow_treat_cast ? "å¯èƒ½" : "ä¸å¯"}
                        </span>
                      )}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      {editingCategory?.category_id === category.category_id ? (
                        <div className="flex justify-end space-x-2">
                          <button
                            onClick={handleUpdateCategory}
                            disabled={isLoading}
                            className="text-blue-600 hover:text-blue-900"
                          >
                            ä¿å­˜
                          </button>
                          <button
                            onClick={() => setEditingCategory(null)}
                            className="text-gray-600 hover:text-gray-900"
                          >
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                          </button>
                        </div>
                      ) : (
                        <div className="flex justify-end space-x-2">
                          <button
                            onClick={() => setEditingCategory(category)}
                            className="text-blue-600 hover:text-blue-900"
                          >
                            ç·¨é›†
                          </button>
                          <button
                            onClick={() => handleDeleteCategory(category.category_id)}
                            className="text-red-600 hover:text-red-900"
                          >
                            å‰Šé™¤
                          </button>
                        </div>
                      )}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {!enableSmaregiIntegration && (
        <div className="bg-white shadow rounded-lg p-6">
          <h2 className="text-lg font-medium text-gray-900 mb-4">æ–°è¦ã‚«ãƒ†ã‚´ãƒªä½œæˆ</h2>
          <form onSubmit={handleCreateCategory} className="space-y-4">
            <div>
              <label htmlFor="name" className="block text-sm font-medium text-gray-700">
                ã‚«ãƒ†ã‚´ãƒªå
              </label>
              <div className="mt-1">
                <input
                  type="text"
                  name="name"
                  id="name"
                  value={newCategoryName}
                  onChange={(e) => setNewCategoryName(e.target.value)}
                  className="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"
                  required
                />
              </div>
            </div>
            <div>
              <button
                type="submit"
                disabled={isLoading || !newCategoryName.trim()}
                className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
              >
                {isLoading ? 'ä½œæˆä¸­...' : 'ä½œæˆ'}
              </button>
            </div>
          </form>
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/portal/menu-categories/page.tsx">
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';
import CategoryList from './category-list';

export const metadata = {
  title: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªç®¡ç†',
};

export default async function MenuCategoriesPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    redirect('/login');
  }

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');

  // åº—èˆ—æƒ…å ±ã‚’å–å¾—
  const storeResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/stores/${storeId}`, {
    cache: 'no-store'
  });

  if (!storeResponse.ok) {
    console.error('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await storeResponse.text());
    throw new Error('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }

  const store = await storeResponse.json();

  // APIã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—
  const response = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/menu-categories?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  if (!response.ok) {
    throw new Error('ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }

  const categories = await response.json();

  return (
    <div className="py-6">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-2xl font-semibold text-gray-900">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h1>
        <p className="mt-2 text-sm text-gray-700">
          ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚«ãƒ†ã‚´ãƒªã‚’ç®¡ç†ã—ã¾ã™ã€‚ã‚«ãƒ†ã‚´ãƒªã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚ã®ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
        </p>

        {store.enable_smaregi_integration && (
          <div className="mt-4">
            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4">
              <div className="flex">
                <div className="flex-shrink-0">
                  <svg className="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                  </svg>
                </div>
                <div className="ml-3">
                  <p className="text-sm text-yellow-700">
                    ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã‚«ãƒ†ã‚´ãƒªã®è¿½åŠ ã¯ã§ãã¾ã›ã‚“ã€‚ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€ã‚¹ãƒãƒ¬ã‚¸ã§éƒ¨é–€ã‚’ç™»éŒ²ã—ãŸå¾Œã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ç”»é¢ã§ã€Œã‚¹ãƒãƒ¬ã‚¸ã¨åŒæœŸã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        <div className="mt-6">
          <CategoryList
            categories={categories}
            enableSmaregiIntegration={store.enable_smaregi_integration}
          />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/portal/menus/page.tsx">
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import MenuList from './menu-list';
import SmaregiSyncButton from './smaregi-sync-button';

export default async function MenusPage() {
  const cookieStore = await cookies();
  const storeId = cookieStore.get('store-id')?.value;

  if (!storeId) {
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Cookieã‚’ã™ã¹ã¦å–å¾—ã—ã¦è»¢é€
  const allCookies = cookieStore.getAll();
  const cookieHeader = allCookies
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ');



  // APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const userResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/auth/user?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  if (!userResponse.ok) {
    redirect('/');
  }

  const { user } = await userResponse.json();

  // ç®¡ç†è€…ã§ãªã‘ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  if (user.role !== 'admin') {
    redirect('/portal/dashboard');
  }

  // åº—èˆ—æƒ…å ±ã‚’å–å¾—
  const storeResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/stores/${storeId}`, {
    cache: 'no-store'
  });

  if (!storeResponse.ok) {
    console.error('åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await storeResponse.text());
    return <div>åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }

  const store = await storeResponse.json();

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã‚’APIã‹ã‚‰å–å¾—
  const menusResponse = await fetch(`${process.env.NEXT_PUBLIC_URL || ''}/api/menus?storeId=${storeId}`, {
    cache: 'no-store',
    headers: {
      'Cookie': cookieHeader
    }
  });

  let menus = [];
  if (menusResponse.ok) {
    menus = await menusResponse.json();
  } else {
    console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', await menusResponse.text());
  }

  return (
    <div className="py-6">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between items-center">
          <h1 className="text-2xl font-semibold text-gray-900">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</h1>
          <div className="flex space-x-4">
            {store.enable_smaregi_integration && (
              <SmaregiSyncButton
                storeId={storeId}
                enableSmaregiIntegration={store.enable_smaregi_integration}
              />
            )}
            {!store.enable_smaregi_integration ? (
              <Link
                href="/portal/menus/new"
                className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"
              >
                ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
              </Link>
            ) : null}
          </div>
        </div>
      </div>
      {store.enable_smaregi_integration && (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
          <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-yellow-700">
                  ã‚¹ãƒãƒ¬ã‚¸é€£æºãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ ã¯ã§ãã¾ã›ã‚“ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€ã‚¹ãƒãƒ¬ã‚¸ã§å•†å“ã‚’ç™»éŒ²ã—ãŸå¾Œã€ã€Œã‚¹ãƒãƒ¬ã‚¸ã¨åŒæœŸã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
                </p>
              </div>
            </div>
          </div>
        </div>
      )}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <MenuList menus={menus || []} />
      </div>
    </div>
  );
}
</file>

</files>
